<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RNG Trader - Spin & Trade Empire</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0e27;
            --bg-medium: #1a1f3a;
            --bg-light: #2a3154;
            --accent-primary: #00ffcc;
            --accent-secondary: #ff00aa;
            --accent-gold: #ffd700;
            --text-primary: #ffffff;
            --text-secondary: #a0a8c0;
            --success: #00ff88;
            --danger: #ff3366;
            --warning: #ffaa00;
            
            --rarity-common: #b0b0b0;
            --rarity-uncommon: #5eff5e;
            --rarity-rare: #5e9eff;
            --rarity-epic: #b45eff;
            --rarity-legendary: #ffaa00;
            --rarity-mythic: #ff3366;
            --rarity-exotic: #00ffcc;
            --rarity-celestial: #ffe4f5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Space Mono', monospace;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1535 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Animated background stars */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent),
                radial-gradient(1px 1px at 80% 10%, white, transparent),
                radial-gradient(2px 2px at 90% 60%, white, transparent),
                radial-gradient(1px 1px at 33% 80%, white, transparent);
            background-size: 200% 200%;
            animation: stars 120s linear infinite;
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes stars {
            from { background-position: 0 0; }
            to { background-position: 200% 200%; }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        header {
            font-family: 'Press Start 2P', cursive;
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            text-shadow: 0 0 20px rgba(0, 255, 204, 0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { filter: drop-shadow(0 0 5px var(--accent-primary)); }
            to { filter: drop-shadow(0 0 20px var(--accent-secondary)); }
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--bg-medium), var(--bg-light));
            border: 2px solid var(--accent-primary);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 255, 204, 0.2);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 255, 204, 0.4);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-primary);
            margin-top: 5px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .tab-button {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            padding: 15px 25px;
            background: var(--bg-medium);
            border: 2px solid var(--accent-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }
        
        .tab-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 204, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .tab-button:hover::before {
            left: 100%;
        }
        
        .tab-button:hover {
            background: var(--bg-light);
            transform: translateY(-2px);
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-dark);
            border-color: var(--accent-gold);
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.6);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .spin-section {
            background: var(--bg-medium);
            border: 3px solid var(--accent-primary);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0, 255, 204, 0.3);
            margin-bottom: 30px;
        }
        
        .spin-button {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2rem;
            padding: 25px 50px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: var(--bg-dark);
            cursor: pointer;
            border-radius: 15px;
            transition: all 0.3s;
            box-shadow: 0 8px 25px rgba(255, 0, 170, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .spin-button:hover {
            transform: scale(1.1) rotate(-2deg);
            box-shadow: 0 12px 35px rgba(255, 0, 170, 0.6);
        }
        
        .spin-button:active {
            transform: scale(0.95);
        }
        
        .spin-button.spinning {
            animation: spin-pulse 0.5s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes spin-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .result-display {
            margin-top: 30px;
            padding: 30px;
            background: var(--bg-light);
            border-radius: 15px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--accent-primary);
        }
        
        .item-display {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
            padding: 15px 30px;
            border-radius: 10px;
            animation: itemAppear 0.5s ease-out;
        }
        
        @keyframes itemAppear {
            from { transform: scale(0) rotate(-180deg); opacity: 0; }
            to { transform: scale(1) rotate(0); opacity: 1; }
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .inventory-item {
            background: var(--bg-light);
            border: 2px solid;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .inventory-item:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 255, 204, 0.4);
        }
        
        .inventory-item.flexed {
            border-width: 4px;
            animation: flex-glow 1s ease-in-out infinite;
        }
        
        @keyframes flex-glow {
            0%, 100% { box-shadow: 0 0 10px currentColor; }
            50% { box-shadow: 0 0 25px currentColor; }
        }
        
        .item-name {
            font-weight: bold;
            margin: 10px 0 5px;
        }
        
        .item-value {
            color: var(--accent-gold);
            font-size: 0.9rem;
        }
        
        .item-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--accent-secondary);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .npc-container {
            background: var(--bg-medium);
            border: 2px solid var(--accent-secondary);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }
        
        .npc-card {
            background: var(--bg-light);
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .npc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .npc-name {
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            color: var(--accent-primary);
        }
        
        .npc-type {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.7rem;
            text-transform: uppercase;
        }
        
        .npc-type.honest { background: var(--success); color: var(--bg-dark); }
        .npc-type.scammer { background: var(--danger); color: white; }
        .npc-type.fair { background: var(--warning); color: var(--bg-dark); }
        
        .trade-offer {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: var(--bg-medium);
            border-radius: 10px;
        }
        
        .trade-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 12px 25px;
            border: 2px solid;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        
        .btn-accept {
            background: var(--success);
            border-color: var(--success);
            color: var(--bg-dark);
        }
        
        .btn-accept:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.5);
        }
        
        .btn-decline {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }
        
        .btn-decline:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 51, 102, 0.5);
        }
        
        .crafting-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .recipe-card {
            background: var(--bg-light);
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 204, 0.3);
        }
        
        .recipe-requirements {
            margin: 15px 0;
            padding: 15px;
            background: var(--bg-medium);
            border-radius: 8px;
        }
        
        .achievement-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .achievement-card {
            background: var(--bg-light);
            border: 2px solid var(--text-secondary);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            opacity: 0.6;
        }
        
        .achievement-card.unlocked {
            border-color: var(--accent-gold);
            opacity: 1;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }
        
        .achievement-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .battlepass-tier {
            background: var(--bg-light);
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .battlepass-tier.unlocked {
            background: linear-gradient(135deg, var(--bg-light), var(--bg-medium));
            border-color: var(--accent-gold);
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--bg-light);
            border: 2px solid var(--accent-primary);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .event-banner {
            background: linear-gradient(135deg, #ff0000, #00ff00);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            font-family: 'Press Start 2P', cursive;
            animation: rainbow 3s linear infinite;
        }
        
        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-medium);
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 255, 204, 0.5);
            animation: slideInRight 0.5s ease-out;
            z-index: 1000;
            max-width: 350px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .enchant-slots {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .enchant-slot {
            padding: 15px 25px;
            background: var(--bg-light);
            border: 2px dashed var(--accent-primary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .enchant-slot:hover {
            background: var(--bg-medium);
            border-style: solid;
        }
        
        .enchant-slot.filled {
            border-color: var(--accent-gold);
            border-style: solid;
            background: var(--accent-primary);
            color: var(--bg-dark);
        }
        
        @media (max-width: 768px) {
            header {
                font-size: 1.2rem;
            }
            
            .tab-button {
                font-size: 0.6rem;
                padding: 12px 18px;
            }
            
            .spin-button {
                font-size: 0.9rem;
                padding: 18px 35px;
            }
        }
        
        /* Epic Animations for Ultra-Rare Pulls */
        .ultra-rare-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
        }
        
        /* Cosmic (1/1024) - Purple sparkles */
        @keyframes cosmic-sparkle {
            0% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: scale(2) rotate(360deg); }
        }
        
        /* Infinite (1/2048) - Rainbow waves */
        @keyframes infinite-wave {
            0% { transform: translateX(-100%) scale(1); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: translateX(100%) scale(1.5); opacity: 0; }
        }
        
        /* Transcendent (1/4096) - Cyan lightning */
        @keyframes transcendent-lightning {
            0%, 100% { opacity: 0; }
            10%, 30%, 50% { opacity: 1; }
            20%, 40%, 60% { opacity: 0.3; }
        }
        
        /* Ethereal (1/8192) - Ghost wisps */
        @keyframes ethereal-wisp {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            20% { opacity: 0.8; }
            80% { opacity: 0.8; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }
        
        /* Primordial (1/16384) - Fire explosion */
        @keyframes primordial-explosion {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(3); opacity: 0.8; }
            100% { transform: scale(6); opacity: 0; }
        }
        
        /* Omega (1/32768) - Black hole vortex */
        @keyframes omega-vortex {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(2) rotate(1800deg); opacity: 1; }
            100% { transform: scale(0) rotate(3600deg); opacity: 0; }
        }
        
        /* Supreme (1/65536) - Golden rays */
        @keyframes supreme-rays {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(4) rotate(180deg); opacity: 0; }
        }
        
        /* Godlike (1/131072) - Divine pillars */
        @keyframes godlike-pillar {
            0% { transform: translateY(100vh) scaleY(0); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-100vh) scaleY(2); opacity: 0; }
        }
        
        /* Universal (1/262144) - Galaxy spiral */
        @keyframes universal-spiral {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(5) rotate(1080deg); opacity: 1; }
            100% { transform: scale(10) rotate(2160deg); opacity: 0; }
        }
        
        /* Multiversal (1/524288) - Reality fracture */
        @keyframes multiversal-fracture {
            0%, 100% { opacity: 0; }
            10%, 30%, 50%, 70%, 90% { opacity: 1; }
            20%, 40%, 60%, 80% { opacity: 0; }
        }
        
        /* Omnipotent (1/1048576) - World shake */
        @keyframes omnipotent-shake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-10px, -10px); }
            20% { transform: translate(10px, 10px); }
            30% { transform: translate(-10px, 10px); }
            40% { transform: translate(10px, -10px); }
            50% { transform: translate(-10px, -10px); }
            60% { transform: translate(10px, 10px); }
            70% { transform: translate(-10px, 10px); }
            80% { transform: translate(10px, -10px); }
            90% { transform: translate(-5px, 5px); }
        }
        
        /* Infinite Absolute (1/2097152) - Dual infinity spirals */
        @keyframes infinite-absolute-spiral {
            0% { transform: scale(1) rotate(0deg); opacity: 0.8; }
            50% { transform: scale(3) rotate(1800deg); opacity: 1; }
            100% { transform: scale(1) rotate(3600deg); opacity: 0.8; }
        }
        
        /* Eternal (1/4194304) - Time ripples */
        @keyframes eternal-ripple {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(2); opacity: 0.8; }
            100% { transform: scale(4); opacity: 0; }
        }
        
        /* Immortal (1/8388608) - Phoenix rebirth */
        @keyframes immortal-rebirth {
            0% { transform: scale(0) rotate(0deg); filter: hue-rotate(0deg); }
            50% { transform: scale(2) rotate(180deg); filter: hue-rotate(180deg); }
            100% { transform: scale(0) rotate(360deg); filter: hue-rotate(360deg); }
        }
        
        /* Ascended (1/16777216) - Heavenly ascension */
        @keyframes ascended-rise {
            0% { transform: translateY(100vh) scale(0.5); opacity: 0; }
            50% { transform: translateY(0) scale(2); opacity: 1; }
            100% { transform: translateY(-100vh) scale(0.5); opacity: 0; }
        }
        
        /* Transcendental (1/33554432) - Reality layers */
        @keyframes transcendental-layers {
            0% { transform: translateZ(0) scale(1); opacity: 0.5; }
            50% { transform: translateZ(100px) scale(3); opacity: 1; }
            100% { transform: translateZ(0) scale(1); opacity: 0.5; }
        }
        
        /* Boundless (1/67108864) - Expanding boundaries */
        @keyframes boundless-expand {
            0% { transform: scale(0.1); border-radius: 50%; }
            50% { transform: scale(5); border-radius: 0%; }
            100% { transform: scale(0.1); border-radius: 50%; }
        }
        
        /* Limitless (1/134217728) - Breaking limits */
        @keyframes limitless-break {
            0% { transform: scale(1); filter: brightness(1); }
            25% { transform: scale(0.1); filter: brightness(5); }
            50% { transform: scale(10); filter: brightness(10); }
            75% { transform: scale(0.1); filter: brightness(5); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        
        /* Absolute (1/268435456) - Universe explosion */
        @keyframes absolute-big-bang {
            0% { transform: scale(0); opacity: 1; filter: brightness(10); }
            50% { transform: scale(20); opacity: 1; filter: brightness(5); }
            100% { transform: scale(50); opacity: 0; filter: brightness(1); }
        }
        
        /* Beyond (1/536870912) - Dimension tear */
        @keyframes beyond-tear {
            0%, 100% { clip-path: inset(0 0 0 0); }
            25% { clip-path: inset(25% 0 25% 0); }
            50% { clip-path: inset(0 25% 0 25%); }
            75% { clip-path: inset(25% 25% 25% 25%); }
        }
        
        /* Incomprehensible (1/1073741824) - Reality distortion */
        @keyframes incomprehensible-distort {
            0% { filter: blur(0px) hue-rotate(0deg); transform: scale(1); }
            25% { filter: blur(20px) hue-rotate(90deg); transform: scale(1.5); }
            50% { filter: blur(40px) hue-rotate(180deg); transform: scale(0.5); }
            75% { filter: blur(20px) hue-rotate(270deg); transform: scale(1.5); }
            100% { filter: blur(0px) hue-rotate(360deg); transform: scale(1); }
        }
        
        /* Unimaginable (1/2147483648) - Kaleidoscope */
        @keyframes unimaginable-kaleidoscope {
            0% { transform: rotate(0deg) scale(1); filter: saturate(1); }
            50% { transform: rotate(1800deg) scale(10); filter: saturate(10); }
            100% { transform: rotate(3600deg) scale(1); filter: saturate(1); }
        }
        
        /* Impossible (1/4294967296) - THE ULTIMATE */
        @keyframes impossible-ultimate {
            0% { transform: scale(1) rotate(0deg); opacity: 1; filter: brightness(1) contrast(1); }
            10% { transform: scale(0); opacity: 0; }
            20% { transform: scale(100) rotate(3600deg); opacity: 1; filter: brightness(100) contrast(10); }
            40% { transform: scale(0.1); opacity: 0.5; }
            60% { transform: scale(50); opacity: 1; }
            80% { transform: scale(0.01); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 0; filter: brightness(1) contrast(1); }
        }
        
        /* Paradox (1/8589934592) - Reality breaks */
        @keyframes paradox-break {
            0% { transform: scale(1); filter: invert(0); }
            20% { transform: scale(3) scaleX(-1); filter: invert(1); }
            40% { transform: scale(0.5) scaleY(-1); filter: invert(0); }
            60% { transform: scale(5) scaleX(-1) scaleY(-1); filter: invert(1); }
            80% { transform: scale(0.1); filter: invert(0); }
            100% { transform: scale(1); filter: invert(0); }
        }
        
        /* Singularity (1/17179869184) - Black hole collapse */
        @keyframes singularity-collapse {
            0% { transform: scale(10); opacity: 1; }
            50% { transform: scale(0.001) rotate(7200deg); opacity: 1; filter: brightness(100); }
            51% { transform: scale(100); opacity: 1; filter: brightness(0.1); }
            100% { transform: scale(0); opacity: 0; }
        }
        
        /* Void (1/34359738368) - Consume everything */
        @keyframes void-consume {
            0% { background: transparent; }
            50% { background: rgba(0,0,0,1); }
            100% { background: transparent; }
        }
        
        /* Nothingness (1/68719476736) - Erase reality */
        @keyframes nothingness-erase {
            0% { opacity: 1; filter: blur(0px); }
            50% { opacity: 0; filter: blur(100px); }
            100% { opacity: 1; filter: blur(0px); }
        }
        
        /* Everything (1/137438953472) - Create universe */
        @keyframes everything-create {
            0% { transform: scale(0); filter: brightness(0); }
            50% { transform: scale(1000); filter: brightness(100); }
            100% { transform: scale(0); filter: brightness(0); }
        }
        
        /* The End (1/274877906944) - Time stops */
        @keyframes end-timestop {
            0%, 30%, 60%, 90% { filter: grayscale(0); }
            15%, 45%, 75% { filter: grayscale(1); }
        }
        
        /* The Beginning (1/549755813888) - Big Bang */
        @keyframes beginning-bigbang {
            0% { transform: scale(0.001); filter: brightness(1000); }
            50% { transform: scale(500); filter: brightness(100); }
            100% { transform: scale(0); filter: brightness(0); }
        }
        
        /* Alpha Omega (1/1099511627776) - Start and End merge */
        @keyframes alphaomega-merge {
            0% { clip-path: circle(0% at 0% 0%); }
            25% { clip-path: circle(100% at 0% 0%); }
            50% { clip-path: circle(0% at 100% 100%); }
            75% { clip-path: circle(100% at 100% 100%); }
            100% { clip-path: circle(0% at 50% 50%); }
        }
        
        /* True Infinity (1/2199023255552) - Endless recursion */
        @keyframes infinity-recursion {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(100) rotate(1800deg); }
            50% { transform: scale(0.01) rotate(3600deg); }
            75% { transform: scale(100) rotate(5400deg); }
            100% { transform: scale(1) rotate(7200deg); }
        }
        
        /* The One (1/4398046511104) - EXISTENCE ITSELF - OPTIMIZED */
        @keyframes theone-existence {
            0% { transform: scale(0); opacity: 0; filter: brightness(0) saturate(0); }
            25% { transform: scale(50); opacity: 1; filter: brightness(20) saturate(5); }
            50% { transform: scale(0); opacity: 0; filter: brightness(0) saturate(0); }
            75% { transform: scale(50); opacity: 1; filter: brightness(20) saturate(5); }
            100% { transform: scale(0); opacity: 0; filter: brightness(0) saturate(0); }
        }
        
        /* Admin - Forbidden access */
        @keyframes admin-scan {
            0% { opacity: 0; transform: translateY(-100%); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: translateY(100%); }
        }
        
        @keyframes admin-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.5; }
        }
        
        /* Primeval - Ancient swirling energy */
        @keyframes primeval-swirl {
            0% { transform: rotate(0deg) scale(1); filter: sepia(0); }
            50% { transform: rotate(360deg) scale(3); filter: sepia(1); }
            100% { transform: rotate(720deg) scale(1); filter: sepia(0); }
        }
        
        @keyframes primeval-ancient {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(2) rotate(180deg); opacity: 1; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }
        
        /* Celestial Prime - Star burst */
        @keyframes celestial-burst {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(10); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }
        
        @keyframes celestial-prime-burst {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(3); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        }
        
        /* Quantum - Wave collapse */
        @keyframes quantum-wave {
            0%, 100% { transform: scale(1); opacity: 1; filter: blur(0px); }
            25% { transform: scale(0.1); opacity: 0.5; filter: blur(10px); }
            50% { transform: scale(5); opacity: 1; filter: blur(0px); }
            75% { transform: scale(0.1); opacity: 0.5; filter: blur(10px); }
        }
        
        @keyframes quantum-flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        /* Dimensional - Portal effect */
        @keyframes dimensional-portal {
            0% { clip-path: circle(0% at 50% 50%); }
            50% { clip-path: circle(75% at 50% 50%); }
            100% { clip-path: circle(0% at 50% 50%); }
        }
        
        @keyframes dimensional-shift {
            0% { opacity: 0; transform: translateZ(0); }
            50% { opacity: 1; transform: translateZ(100px); }
            100% { opacity: 0; transform: translateZ(0); }
        }
        
        /* Hyperversal - Reality layers */
        @keyframes hyperversal-layers {
            0% { transform: translateZ(0); opacity: 1; }
            50% { transform: translateZ(200px); opacity: 0.5; }
            100% { transform: translateZ(0); opacity: 1; }
        }
        
        @keyframes hyper-warp {
            0% { opacity: 0; transform: skew(0deg); }
            50% { opacity: 1; transform: skew(45deg, 45deg); }
            100% { opacity: 0; transform: skew(0deg); }
        }
        
        /* Divine presence */
        @keyframes divine-presence {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(3); opacity: 0; }
        }
        
        /* Beyond Infinity */
        @keyframes beyond-infinity-explosion {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(20); opacity: 0.5; }
            100% { transform: scale(0); opacity: 0; }
        }
        
        /* Outerversal - Edge fade */
        @keyframes outerversal-edge {
            0% { opacity: 1; box-shadow: inset 0 0 100px rgba(0,255,0,1); }
            50% { opacity: 0.3; box-shadow: inset 0 0 200px rgba(0,255,0,0.3); }
            100% { opacity: 1; box-shadow: inset 0 0 100px rgba(0,255,0,1); }
        }
        
        /* Boundaryless - Expanding infinity */
        @keyframes boundaryless-expand {
            0% { transform: scale(0.5); border-radius: 50%; }
            50% { transform: scale(20); border-radius: 0%; }
            100% { transform: scale(0.5); border-radius: 50%; }
        }
        
        /* Formless - Dissolve */
        @keyframes formless-dissolve {
            0%, 100% { opacity: 1; filter: blur(0px); }
            50% { opacity: 0.2; filter: blur(50px); }
        }
        
        /* Abstract - Concept shift */
        @keyframes abstract-shift {
            0% { transform: skew(0deg); }
            25% { transform: skew(30deg, 30deg); }
            50% { transform: skew(-30deg, -30deg); }
            75% { transform: skew(30deg, -30deg); }
            100% { transform: skew(0deg); }
        }
        
        /* Conceptual - Thought pulse */
        @keyframes conceptual-pulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(3); filter: brightness(5); }
        }
        
        /* Metaphysical - Being flicker */
        @keyframes metaphysical-flicker {
            0%, 100% { opacity: 1; }
            10%, 30%, 50%, 70%, 90% { opacity: 0; }
            20%, 40%, 60%, 80% { opacity: 1; }
        }
        
        /* The Source - Origin explosion */
        @keyframes source-explosion {
            0% { transform: scale(0.01); filter: brightness(100); }
            50% { transform: scale(100); filter: brightness(10); }
            100% { transform: scale(0); filter: brightness(0); }
        }
        
        /* The Eternal - Time loop */
        @keyframes eternal-loop {
            0% { transform: rotate(0deg) scale(1); }
            100% { transform: rotate(3600deg) scale(1); }
        }
        
        /* The Absolute Infinity - Infinity symbol */
        @keyframes absolute-infinity {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(20) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }
        
        /* Beyond Infinity - Transcendence */
        @keyframes beyond-transcend {
            0% { transform: scale(0); opacity: 0; filter: brightness(0) hue-rotate(0deg); }
            25% { transform: scale(50); opacity: 1; filter: brightness(100) hue-rotate(90deg); }
            50% { transform: scale(0); opacity: 0; filter: brightness(0) hue-rotate(180deg); }
            75% { transform: scale(50); opacity: 1; filter: brightness(100) hue-rotate(270deg); }
            100% { transform: scale(0); opacity: 0; filter: brightness(0) hue-rotate(360deg); }
        }
        
        /* Animation result display */
        .animation-result {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            background: rgba(0, 0, 0, 0.95);
            padding: 40px 60px;
            border-radius: 20px;
            border: 4px solid var(--accent-primary);
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
            text-align: center;
            animation: resultFadeIn 1s ease-out, resultGlow 2s ease-in-out infinite;
            transition: transform 0.3s ease;
        }
        
        .animation-result:hover {
            transform: translate(-50%, -50%) scale(1.05);
            box-shadow: 0 0 80px rgba(0, 255, 255, 0.8);
        }
        
        @keyframes resultFadeIn {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes resultGlow {
            0%, 100% { box-shadow: 0 0 50px rgba(0, 255, 255, 0.5); }
            50% { box-shadow: 0 0 100px rgba(0, 255, 255, 1), 0 0 150px rgba(255, 0, 255, 0.5); }
        }
        
        .animation-result-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: var(--accent-gold);
            text-shadow: 0 0 10px var(--accent-gold);
        }
        
        .animation-result-item {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 0 0 20px currentColor;
            animation: textPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes textPulse {
            0%, 100% { text-shadow: 0 0 20px currentColor; }
            50% { text-shadow: 0 0 40px currentColor, 0 0 60px currentColor; }
        }
        
        .animation-result-rarity {
            font-size: 1.5rem;
            margin: 15px 0;
        }
        
        .animation-result-chance {
            font-size: 1.3rem;
            color: var(--text-secondary);
            margin-top: 10px;
        }
        
        /* ===== MOBILE SUPPORT ===== */
        
        /* Prevent text selection on interactive elements */
        button, .inventory-item, .tab-button, .trade-card {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Touch-friendly tap targets (minimum 44x44px) */
        @media (max-width: 768px) {
            /* Mobile navigation - hamburger menu */
            .mobile-menu-toggle {
                display: block;
                position: fixed;
                top: 15px;
                right: 15px;
                z-index: 1001;
                background: var(--accent-primary);
                border: none;
                padding: 12px 15px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 1.5rem;
                color: var(--bg-dark);
                box-shadow: 0 4px 15px rgba(0, 255, 204, 0.3);
            }
            
            .mobile-menu-toggle:active {
                transform: scale(0.95);
            }
            
            /* Tab navigation responsive */
            .tab-nav {
                position: fixed;
                top: 0;
                right: -100%;
                width: 280px;
                height: 100vh;
                background: var(--bg-dark);
                border-left: 2px solid var(--accent-primary);
                z-index: 1000;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
                transition: right 0.3s ease;
                padding: 70px 10px 60px 10px; /* Adjusted for scroll hint */
                display: flex;
                flex-direction: column;
                gap: 10px;
                overscroll-behavior: contain; /* Prevent scroll chaining */
                box-shadow: -5px 0 20px rgba(0, 0, 0, 0.5);
            }
            
            /* Scroll indicator gradient at bottom */
            .tab-nav::after {
                content: '⬇️ Scroll for more ⬇️';
                position: sticky;
                bottom: 0;
                left: 0;
                right: 0;
                height: 50px;
                background: linear-gradient(to top, var(--bg-dark) 0%, var(--bg-dark) 60%, transparent 100%);
                pointer-events: none;
                margin-top: auto;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.7rem;
                color: var(--text-secondary);
                text-align: center;
            }
            
            .tab-nav.mobile-open {
                right: 0;
            }
            
            .tab-button {
                width: 100%;
                margin: 0;
                padding: 15px;
                font-size: 1rem;
                min-height: 50px;
                border-radius: 8px;
                flex-shrink: 0; /* Prevent buttons from shrinking */
            }
            
            /* Container adjustments */
            .container {
                padding: 10px;
                margin: 0;
                max-width: 100%;
            }
            
            header {
                font-size: 1.5rem;
                padding: 15px;
                margin-bottom: 15px;
            }
            
            /* Stats bar - stack on mobile */
            .stats-bar {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .stat-card {
                width: 100%;
                padding: 12px;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
            
            .stat-value {
                font-size: 1.1rem;
            }
            
            /* Buttons */
            .btn, .spin-button {
                padding: 15px 20px;
                font-size: 1rem;
                min-height: 50px;
                touch-action: manipulation;
            }
            
            .spin-button {
                font-size: 1.2rem;
                padding: 20px 30px;
            }
            
            /* Inventory grid - 2 columns on mobile */
            .inventory-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 10px;
            }
            
            .inventory-item {
                padding: 12px;
                min-height: 120px;
            }
            
            .item-name {
                font-size: 0.8rem;
            }
            
            .item-value {
                font-size: 0.75rem;
            }
            
            /* Crafting/recipe grids - 1 column on mobile */
            .crafting-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .recipe-card, .stat-card {
                padding: 15px;
            }
            
            /* Trade cards */
            .trade-card {
                padding: 15px;
            }
            
            /* Tabs content */
            .tab-content {
                padding: 15px 10px;
            }
            
            /* Result display */
            .result-display {
                padding: 15px;
                margin: 15px 0;
            }
            
            .item-display {
                font-size: 1rem;
                padding: 15px;
            }
            
            /* Lucky Spin buttons - stack on mobile */
            .tab-content > div > div[style*="grid-template-columns: repeat(3"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            /* Progress bars */
            .progress-bar {
                height: 25px;
            }
            
            .progress-fill {
                font-size: 0.85rem;
            }
            
            /* Pity counter */
            #pityCounterDisplay {
                font-size: 0.9rem;
            }
            
            /* Notifications */
            .notification {
                width: 90%;
                max-width: 350px;
                font-size: 0.9rem;
                padding: 12px;
            }
            
            /* Quest container */
            #questContainer {
                padding: 10px;
            }
            
            /* Battle Pass */
            #bpTiers {
                grid-template-columns: 1fr;
            }
            
            /* Fusion grid */
            #fusionItemsContainer {
                grid-template-columns: 1fr !important;
            }
            
            #fusionInventoryGrid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* Collections grid */
            #collectionBonusesGrid,
            #rarityMilestonesGrid {
                grid-template-columns: 1fr;
            }
            
            /* Admin panel */
            .admin-controls {
                grid-template-columns: 1fr;
            }
            
            /* Font size adjustments */
            h2 {
                font-size: 1.3rem;
            }
            
            h3 {
                font-size: 1.1rem;
            }
            
            p {
                font-size: 0.9rem;
            }
            
            /* Save/Load buttons */
            .container > div[style*="display: flex; justify-content: center"] {
                flex-direction: column;
                gap: 10px !important;
                padding: 0 10px;
            }
            
            .container > div[style*="display: flex; justify-content: center"] button {
                width: 100%;
            }
            
            /* Ultra rare overlay text */
            .animation-result-item {
                font-size: 1.8rem;
            }
            
            .animation-result-rarity {
                font-size: 1.2rem;
            }
            
            .animation-result-chance {
                font-size: 1rem;
            }
        }
        
        /* Small phones (max 480px) */
        @media (max-width: 480px) {
            header {
                font-size: 1.2rem;
                padding: 12px;
            }
            
            .inventory-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-value {
                font-size: 1rem;
            }
            
            .btn {
                font-size: 0.9rem;
                padding: 12px 15px;
            }
            
            .spin-button {
                font-size: 1.1rem;
                padding: 18px 25px;
            }
            
            .tab-button {
                font-size: 0.9rem;
                padding: 12px;
            }
            
            h2 {
                font-size: 1.1rem;
            }
            
            h3 {
                font-size: 1rem;
            }
        }
        
        /* Landscape phones */
        @media (max-width: 768px) and (orientation: landscape) {
            .stats-bar {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .stat-card {
                width: calc(50% - 5px);
            }
            
            .inventory-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Tablet adjustments */
        @media (min-width: 769px) and (max-width: 1024px) {
            .inventory-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .crafting-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-bar {
                flex-wrap: wrap;
            }
            
            .stat-card {
                flex: 1 1 calc(33.333% - 10px);
                min-width: 150px;
            }
        }
        
        /* Hide mobile menu toggle on desktop */
        @media (min-width: 769px) {
            .mobile-menu-toggle {
                display: none;
            }
            
            /* Reset tab-nav for desktop */
            .tab-nav {
                position: static;
                width: auto;
                height: auto;
                overflow-y: visible;
                padding: 0;
                flex-direction: row;
                flex-wrap: wrap;
                background: transparent;
                border: none;
                box-shadow: none;
            }
            
            /* Hide scroll indicators on desktop */
            .tab-nav::after {
                display: none;
            }
            
            .tab-nav > div:first-child {
                display: none;
            }
        }
        
        /* Prevent zoom on double-tap */
        * {
            touch-action: manipulation;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Better touch feedback */
        button:active, .inventory-item:active, .tab-button:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }
        
        @keyframes boss-float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes boss-shake {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-5px, 5px) rotate(-5deg); }
            50% { transform: translate(5px, -5px) rotate(5deg); }
            75% { transform: translate(-5px, -5px) rotate(-3deg); }
        }
        
        @keyframes screen-shake {
            0%, 100% { transform: translate(0, 0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-10px, 0); }
            20%, 40%, 60%, 80% { transform: translate(10px, 0); }
        }
        
        @keyframes fire-particle {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(calc(random() * 200px - 100px), calc(random() * 200px - 100px)) scale(0);
                opacity: 0;
            }
        }
        
        @keyframes primordial-explosion {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0.8;
            }
            100% {
                transform: translate(-50%, -50%) scale(4);
                opacity: 0;
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" id="mobileMenuBtn">☰</button>
        
        <header>
            ⚡ RNG TRADER ⚡
        </header>
        
        <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
            <button class="btn btn-accept" onclick="saveGame()" style="padding: 10px 25px;">💾 Save Game</button>
            <button class="btn btn-accept" onclick="loadGame()" style="padding: 10px 25px;">📂 Load Game</button>
        </div>
        
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Money</div>
                <div class="stat-value" id="money">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Value</div>
                <div class="stat-value" id="totalValue">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Spins</div>
                <div class="stat-value" id="totalSpins">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Luck</div>
                <div class="stat-value" id="luckMultiplier">1.0x</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Trade Wins</div>
                <div class="stat-value" id="tradeWins">0</div>
            </div>
        </div>
        
        <div class="tabs tab-nav" id="tabNav">
            <div style="position: sticky; top: 0; background: var(--bg-dark); padding: 10px; margin: -10px -10px 10px -10px; border-bottom: 1px solid var(--accent-primary); z-index: 1; text-align: center; font-size: 0.7rem; color: var(--text-secondary);">
                📱 Swipe to scroll ⬇️
            </div>
            <button class="tab-button active" onclick="switchTab('spin')">🎰 Spin</button>
            <button class="tab-button" onclick="switchTab('inventory')">🎒 Inventory</button>
            <button class="tab-button" onclick="switchTab('shop')">🏪 Shop</button>
            <button class="tab-button" onclick="switchTab('upgrades')">⬆️ Upgrades</button>
            <button class="tab-button" onclick="switchTab('trading')">🤝 Trading</button>
            <button class="tab-button" onclick="switchTab('crafting')">🔨 Crafting</button>
            <button class="tab-button" onclick="switchTab('enchanting')">✨ Enchanting</button>
            <button class="tab-button" onclick="switchTab('achievements')">🏆 Achievements</button>
            <button class="tab-button" onclick="switchTab('quests')">📋 Quests</button>
            <button class="tab-button" onclick="switchTab('fusion')">🔮 Fusion</button>
            <button class="tab-button" onclick="switchTab('statistics')">📊 Statistics</button>
            <button class="tab-button" onclick="switchTab('collections')">🏆 Collections</button>
            <button class="tab-button" onclick="switchTab('battlepass')">🎫 Battle Pass</button>
            <button class="tab-button" onclick="switchTab('rebirth')">♻️ Rebirth</button>
            <button class="tab-button" onclick="switchTab('events')">🎄 Events</button>
            <button class="tab-button" onclick="switchTab('bosses')">👹 Bosses</button>
            <button class="tab-button" onclick="switchTab('dungeons')">🗺️ Dungeons</button>
            <button class="tab-button" onclick="switchTab('artifacts')">💎 Artifacts</button>
            <button class="tab-button" onclick="switchTab('dailies')">📅 Daily</button>
            <button class="tab-button" onclick="switchTab('achievementshop')">🏪 A-Shop</button>
            <button class="tab-button" onclick="switchTab('pets')">🐉 Pets</button>
            <button class="tab-button" onclick="switchTab('potions')">🧪 Potions</button>
            <button class="tab-button" onclick="switchTab('skills')">⚡ Skills</button>
            <button class="tab-button" onclick="switchTab('leaderboard')">🏆 Board</button>
            <button class="tab-button" onclick="switchTab('guild')">🤝 Guild</button>
            <button class="tab-button" onclick="switchTab('gacha')">🎲 Gacha</button>
            <button class="tab-button" onclick="switchTab('themes')">🎨 Themes</button>
            <button class="tab-button" onclick="switchTab('titles')">🏅 Titles</button>
            <button class="tab-button" onclick="switchTab('prestige')">⭐ Prestige</button>
            <button class="tab-button" onclick="switchTab('settings')">⚙️ Settings</button>
            <button class="tab-button" onclick="switchTab('admin')">🎁 Codes</button>
        </div>
        
        <!-- Spin Tab -->
        <div id="spin" class="tab-content active">
            <div class="spin-section">
                <h2 style="margin-bottom: 20px; color: var(--accent-primary);">🎲 Spin the Wheel of Fortune! 🎲</h2>
                
                <!-- Pity Counter Display -->
                <div class="stat-card" style="max-width: 600px; margin: 20px auto; background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="color: var(--accent-gold); font-weight: bold;">🍀 Pity System</span>
                        <span id="pityCounterDisplay" style="color: var(--warning); font-weight: bold;">0 / 100</span>
                    </div>
                    <div class="progress-bar" style="height: 20px;">
                        <div class="progress-fill" id="pityProgressBar" style="width: 0%; background: linear-gradient(90deg, var(--warning) 0%, var(--accent-gold) 100%);">
                            <span style="font-size: 0.85rem; font-weight: bold;">0%</span>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 8px; text-align: center;">
                        Guaranteed Legendary+ at 100!
                    </p>
                </div>
                
                <button class="spin-button" onclick="spinItem()" id="spinBtn">SPIN NOW!</button>
                
                <!-- Lucky Spin Mode -->
                <div style="margin-top: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">
                    <h3 style="color: var(--accent-gold); text-align: center; margin-bottom: 15px;">⭐ Lucky Spin Mode ⭐</h3>
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: 20px;">Pay money for boosted odds!</p>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <button class="btn btn-accept" onclick="luckySpinItem(2)" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding: 15px; font-size: 1rem;">
                            <div style="font-weight: bold; font-size: 1.1rem;">2x Luck</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">$10,000</div>
                        </button>
                        <button class="btn btn-accept" onclick="luckySpinItem(5)" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 15px; font-size: 1rem;">
                            <div style="font-weight: bold; font-size: 1.1rem;">5x Luck</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">$100,000</div>
                        </button>
                        <button class="btn btn-accept" onclick="luckySpinItem(10)" style="background: linear-gradient(135deg, #FF69B4 0%, #FF1493 100%); padding: 15px; font-size: 1rem;">
                            <div style="font-weight: bold; font-size: 1.1rem;">10x Luck</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">$1,000,000</div>
                        </button>
                    </div>
                </div>
                
                <div class="result-display" id="resultDisplay">
                    <p style="color: var(--text-secondary);">Click SPIN to get your first item!</p>
                </div>
            </div>
        </div>
        
        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <h2>Your Inventory</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Tap/Click an item to flex it! Long-press/Right-click to sell it for money.</p>
            
            <!-- Sorting Options -->
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; justify-content: center;">
                <button class="btn btn-accept" onclick="sortInventory('rarity')" style="padding: 10px 15px;">Sort by Rarity</button>
                <button class="btn btn-accept" onclick="sortInventory('value')" style="padding: 10px 15px;">Sort by Value</button>
                <button class="btn btn-accept" onclick="sortInventory('count')" style="padding: 10px 15px;">Sort by Count</button>
                <select id="filterType" onchange="filterInventory()" style="padding: 10px; background: var(--bg-medium); color: var(--text-primary); border: 2px solid var(--accent-primary); border-radius: 8px; cursor: pointer;">
                    <option value="all">All Items</option>
                    <optgroup label="By Rarity">
                        <option value="common">Common</option>
                        <option value="uncommon">Uncommon</option>
                        <option value="rare">Rare</option>
                        <option value="epic">Epic</option>
                        <option value="legendary">Legendary</option>
                        <option value="mythic">Mythic</option>
                        <option value="exotic">Exotic</option>
                        <option value="celestial">Celestial</option>
                        <option value="divine">Divine</option>
                        <option value="cosmic">Cosmic</option>
                        <option value="infinite">Infinite</option>
                        <option value="transcendent">Transcendent</option>
                        <option value="ethereal">Ethereal</option>
                        <option value="primordial">Primordial+</option>
                    </optgroup>
                    <optgroup label="By Type">
                        <option value="event">All Event Items</option>
                        <option value="christmas">Christmas Items</option>
                        <option value="disco">Disco Items</option>
                        <option value="galactic">Galactic Items</option>
                        <option value="glitch">Glitch Items</option>
                        <option value="fullmoon">Full Moon Items</option>
                        <option value="bloodmoon">Blood Moon Items</option>
                        <option value="weather">Weather Items</option>
                        <option value="battlepass">Battle Pass Items</option>
                    </optgroup>
                </select>
            </div>
            
            <!-- Bulk Actions -->
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; justify-content: center;">
                <select id="bulkSellRarity" style="padding: 10px; background: var(--bg-medium); color: var(--text-primary); border: 2px solid var(--accent-primary); border-radius: 8px; cursor: pointer;">
                    <option value="">Select Rarity to Sell...</option>
                    <option value="Common">Common</option>
                    <option value="Uncommon">Uncommon</option>
                    <option value="Rare">Rare</option>
                    <option value="Epic">Epic</option>
                    <option value="Legendary">Legendary</option>
                    <option value="Mythic">Mythic</option>
                    <option value="Exotic">Exotic</option>
                    <option value="Celestial">Celestial</option>
                    <option value="Divine">Divine</option>
                    <option value="Cosmic">Cosmic</option>
                    <option value="Infinite">Infinite</option>
                    <option value="Transcendent">Transcendent</option>
                    <option value="Ethereal">Ethereal</option>
                </select>
                <button class="btn btn-decline" onclick="bulkSellByRarity()" style="padding: 10px 20px;">
                    💰 Sell Selected Rarity
                </button>
            </div>
            
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; justify-content: center;">
                <button class="btn btn-decline" onclick="sellAllItems()" style="padding: 10px 20px;">💰 Sell All (70% value)</button>
                <button class="btn btn-decline" onclick="sellAllNonFavorited()" style="padding: 10px 20px;">💰 Sell Non-Favorited</button>
                <button class="btn btn-warning" onclick="favoriteAllByRarity()" style="padding: 10px 20px;">⭐ Favorite by Rarity</button>
                <button class="btn btn-warning" onclick="unfavoriteAll()" style="padding: 10px 20px;">✖️ Unfavorite All</button>
            </div>
            
            <div class="inventory-grid" id="inventoryGrid"></div>
        </div>
        
        <!-- Shop Tab -->
        <div id="shop" class="tab-content">
            <h2>Item Shop</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Buy items with your hard-earned money!</p>
            <div class="inventory-grid" id="shopGrid"></div>
        </div>
        
        <!-- Upgrades Tab -->
        <div id="upgrades" class="tab-content">
            <h2>Upgrades</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Spend money to improve your game permanently!</p>
            <div class="crafting-grid" id="upgradesGrid"></div>
        </div>
        
        <!-- Trading Tab -->
        <div id="trading" class="tab-content">
            <h2>NPC Trading Post</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">NPCs will randomly offer item trades. Values are hidden - trade at your own risk!</p>
            <p style="margin: 10px 0; color: var(--warning);">⚠️ The richer you are, the more NPCs will try to scam you! ⚠️</p>
            <div id="npcContainer"></div>
        </div>
        
        <!-- Crafting Tab -->
        <div id="crafting" class="tab-content">
            <h2>Crafting Station</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Combine items to create more valuable ones!</p>
            <div class="crafting-grid" id="craftingGrid"></div>
        </div>
        
        <!-- Enchanting Tab -->
        <div id="enchanting" class="tab-content">
            <h2>✨ Enchantment Altar ✨</h2>
            <p style="margin: 10px 0; color: var(--warning);">⚠️ Only items Divine rarity or higher can be enchanted!</p>
            <p style="margin: 10px 0; color: var(--text-secondary);">Get random enchantments with powerful effects - or risk losing your item!</p>
            
            <div style="margin: 20px 0;">
                <h3>Select Divine+ Item to Enchant:</h3>
                <div class="inventory-grid" id="enchantInventoryGrid"></div>
            </div>
            
            <div id="enchantmentInterface" style="display: none;">
                <div class="enchant-slots">
                    <div class="enchant-slot filled" id="selectedEnchantItem"></div>
                </div>
                <div style="margin: 20px 0; padding: 15px; background: var(--bg-light); border-radius: 12px;">
                    <h3 style="color: var(--accent-primary); margin-bottom: 10px;">Possible Enchantments:</h3>
                    <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">
                        <div style="margin: 5px 0;">💰 <strong>Value Upgrade</strong> - Increases item value</div>
                        <div style="margin: 5px 0;">🤝 <strong>Traders Dream</strong> - NPCs want this item more</div>
                        <div style="margin: 5px 0;">🔨 <strong>Crafting Merger</strong> - Chance to duplicate crafts</div>
                        <div style="margin: 5px 0;">✨ <strong>Enchanters Tool</strong> - Better enchant chances</div>
                        <div style="margin: 5px 0;">💵 <strong>Money Multi</strong> - Better sell value</div>
                        <div style="margin: 5px 0;">🎲 <strong>Lucky Item</strong> - Boosts spin luck</div>
                        <div style="margin: 10px 0; padding-top: 10px; border-top: 2px solid var(--accent-gold);">
                            <strong style="color: var(--accent-gold);">GODLY ENCHANTS:</strong>
                        </div>
                        <div style="margin: 5px 0; color: var(--accent-gold);">👑 <strong>Admins Dreams</strong> - 2x value, 2x luck, trade boost</div>
                        <div style="margin: 5px 0; color: var(--accent-gold);">🎭 <strong>Emperors Style</strong> - 4x luck, trade boost</div>
                        <div style="margin: 5px 0; color: var(--accent-gold);">🌀 <strong>Endless Possibilities</strong> - Craft dupe + enchant luck</div>
                        <div style="margin: 5px 0; color: var(--accent-gold);">⚡ <strong>Chaotics Thoughts</strong> - 2x spins, anti-scammer</div>
                        <div style="margin: 10px 0; padding-top: 10px; border-top: 2px solid #ff00ff;">
                            <strong style="color: #ff00ff;">ULTIMATE:</strong>
                        </div>
                        <div style="margin: 5px 0; color: #ff00ff;">🌟 <strong>Ruler of the World</strong> - ALL ENCHANTS COMBINED!</div>
                        <div style="margin: 10px 0; padding-top: 10px; border-top: 2px solid var(--danger);">
                            <strong style="color: var(--danger);">BAD ENCHANTS:</strong>
                        </div>
                        <div style="margin: 5px 0; color: var(--danger);">⚠️ Ditto, Too Much/Little Energy (destroys item)</div>
                    </div>
                </div>
                <button class="btn btn-accept" onclick="enchantItem()" style="width: 100%; padding: 20px; font-size: 1.2rem;">
                    ⚡ ENCHANT ITEM ⚡
                </button>
            </div>
        </div>
        
        <!-- Achievements Tab -->
        <div id="achievements" class="tab-content">
            <h2>Achievements</h2>
            <div class="achievement-list" id="achievementList"></div>
        </div>
        
        <!-- Quests Tab -->
        <div id="quests" class="tab-content">
            <h2>📋 Daily & Weekly Quests</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Complete quests to earn Battle Pass XP!</p>
            
            <div id="questContainer" style="max-width: 800px; margin: 0 auto;">
                <!-- Quests will be populated here -->
            </div>
        </div>
        
        <!-- Fusion Tab -->
        <div id="fusion" class="tab-content">
            <h2>🔮 Item Fusion</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Combine items of the same rarity to create a higher rarity item!</p>
            
            <div style="max-width: 1000px; margin: 0 auto;">
                <div class="stat-card" style="margin-bottom: 30px; background: linear-gradient(135deg, var(--bg-medium) 0%, var(--bg-dark) 100%);">
                    <h3 style="color: var(--accent-primary); margin-bottom: 15px;">How Fusion Works</h3>
                    <p style="margin: 10px 0;">• Select 3 items of the <strong>same rarity</strong></p>
                    <p style="margin: 10px 0;">• Items will be consumed in the fusion process</p>
                    <p style="margin: 10px 0;">• You'll receive 1 <strong>random item of the SAME rarity</strong></p>
                    <p style="margin: 10px 0; color: var(--accent-primary);">✨ Great for re-rolling bad items!</p>
                    <p style="margin: 10px 0; color: var(--warning);">⚠️ This process cannot be undone!</p>
                </div>
                
                <div id="fusionItemsContainer" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div class="stat-card" style="min-height: 150px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--accent-primary);">
                        <span style="color: var(--text-secondary);">Item Slot 1</span>
                    </div>
                    <div class="stat-card" style="min-height: 150px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--accent-primary);">
                        <span style="color: var(--text-secondary);">Item Slot 2</span>
                    </div>
                    <div class="stat-card" style="min-height: 150px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--accent-primary);">
                        <span style="color: var(--text-secondary);">Item Slot 3</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-accept" onclick="performFusion()" id="fusionButton" disabled style="opacity: 0.5; font-size: 1.2rem; padding: 15px 40px;">
                        ⚗️ FUSE ITEMS
                    </button>
                    <button class="btn btn-decline" onclick="clearFusionSlots()" style="margin-left: 10px; padding: 15px 30px;">
                        Clear Slots
                    </button>
                </div>
                
                <h3 style="color: var(--accent-primary); margin: 40px 0 20px 0;">Available Items for Fusion</h3>
                <div id="fusionInventoryGrid" class="inventory-grid" style="margin-top: 20px;">
                    <!-- Fusion inventory will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Statistics Tab -->
        <div id="statistics" class="tab-content">
            <h2>📊 Statistics & Records</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">Your complete game statistics and achievements</p>
            
            <div class="crafting-grid" style="max-width: 1200px; margin: 0 auto;">
                <!-- General Stats -->
                <div class="stat-card">
                    <h3 style="color: var(--accent-primary); margin-bottom: 15px;">🎲 General Stats</h3>
                    <div style="text-align: left;">
                        <p><strong>Total Spins:</strong> <span id="statTotalSpins">0</span></p>
                        <p><strong>Total Logins:</strong> <span id="statTotalLogins">0</span></p>
                        <p><strong>Current Login Streak:</strong> <span id="statLoginStreak">0</span> days</p>
                        <p><strong>Total Rebirths:</strong> <span id="statRebirths">0</span></p>
                        <p><strong>Quests Completed:</strong> <span id="statQuestsCompleted">0</span></p>
                    </div>
                </div>
                
                <!-- Money Stats -->
                <div class="stat-card">
                    <h3 style="color: var(--accent-gold); margin-bottom: 15px;">💰 Financial Stats</h3>
                    <div style="text-align: left;">
                        <p><strong>Current Money:</strong> $<span id="statCurrentMoney">0</span></p>
                        <p><strong>Total Value:</strong> $<span id="statTotalValue">0</span></p>
                        <p><strong>Lifetime Earned:</strong> $<span id="statLifetimeEarned">0</span></p>
                        <p><strong>Lifetime Spent:</strong> $<span id="statLifetimeSpent">0</span></p>
                        <p><strong>Net Profit:</strong> $<span id="statNetProfit">0</span></p>
                    </div>
                </div>
                
                <!-- Trading Stats -->
                <div class="stat-card">
                    <h3 style="color: var(--success); margin-bottom: 15px;">🤝 Trading Stats</h3>
                    <div style="text-align: left;">
                        <p><strong>Trade Wins:</strong> <span id="statTradeWins">0</span></p>
                        <p><strong>Trade Losses:</strong> <span id="statTradeLosses">0</span></p>
                        <p><strong>Win Rate:</strong> <span id="statWinRate">0</span>%</p>
                        <p><strong>Biggest Win:</strong> $<span id="statBiggestWin">0</span></p>
                        <p><strong>Biggest Loss:</strong> $<span id="statBiggestLoss">0</span></p>
                    </div>
                </div>
                
                <!-- Crafting Stats -->
                <div class="stat-card">
                    <h3 style="color: var(--accent-primary); margin-bottom: 15px;">🔨 Creation Stats</h3>
                    <div style="text-align: left;">
                        <p><strong>Items Crafted:</strong> <span id="statCrafted">0</span></p>
                        <p><strong>Enchant Success:</strong> <span id="statEnchantSuccess">0</span></p>
                        <p><strong>Enchant Fails:</strong> <span id="statEnchantFails">0</span></p>
                        <p><strong>Enchant Success Rate:</strong> <span id="statEnchantRate">0</span>%</p>
                        <p><strong>Shop Purchases:</strong> <span id="statShopPurchases">0</span></p>
                    </div>
                </div>
                
                <!-- Collection Stats -->
                <div class="stat-card">
                    <h3 style="color: var(--accent-purple); margin-bottom: 15px;">📦 Collection Stats</h3>
                    <div style="text-align: left;">
                        <p><strong>Unique Items:</strong> <span id="statUniqueItems">0</span></p>
                        <p><strong>Total Items:</strong> <span id="statTotalItems">0</span></p>
                        <p><strong>Event Items:</strong> <span id="statEventItems">0</span></p>
                        <p><strong>Achievements:</strong> <span id="statAchievements">0</span></p>
                        <p><strong>Battle Pass Tier:</strong> <span id="statBPTier">0</span></p>
                    </div>
                </div>
                
                <!-- Pity System Stats -->
                <div class="stat-card">
                    <h3 style="color: var(--warning); margin-bottom: 15px;">🍀 Luck & Pity Stats</h3>
                    <div style="text-align: left;">
                        <p><strong>Current Luck:</strong> <span id="statCurrentLuck">1.0</span>x</p>
                        <p><strong>Pity Counter:</strong> <span id="statPityCounter">0</span> / <span id="statPityThreshold">100</span></p>
                        <p><strong>Pity Triggered:</strong> <span id="statPityTriggered">0</span> times</p>
                        <div class="progress-bar" style="margin-top: 10px;">
                            <div class="progress-fill" id="pityProgress" style="width: 0%; background: var(--warning);">0%</div>
                        </div>
                    </div>
                </div>
                
                <!-- Rarity Distribution -->
                <div class="stat-card" style="grid-column: span 2;">
                    <h3 style="color: var(--accent-primary); margin-bottom: 15px;">🎯 Rarity Distribution</h3>
                    <div id="rarityDistribution" style="max-height: 300px; overflow-y: auto;">
                        <!-- Rarity counts will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Collections Tab -->
        <div id="collections" class="tab-content">
            <h2>🏆 Collection Bonuses & Milestones</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">Complete collections for permanent bonuses!</p>
            
            <div style="max-width: 1200px; margin: 0 auto;">
                <!-- Collection Bonuses -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: var(--accent-primary); margin-bottom: 20px;">🎁 Event Collection Bonuses</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">Collect all items from an event to unlock permanent bonuses during that event!</p>
                    <div id="collectionBonusesGrid" class="crafting-grid">
                        <!-- Collection bonuses will be populated here -->
                    </div>
                </div>
                
                <!-- Rarity Milestones -->
                <div>
                    <h3 style="color: var(--accent-gold); margin-bottom: 20px;">⭐ Rarity Milestones</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">Collect certain amounts of each rarity to unlock permanent luck boosts!</p>
                    <div id="rarityMilestonesGrid" class="crafting-grid">
                        <!-- Rarity milestones will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Battle Pass Tab -->
        <div id="battlepass" class="tab-content">
            <h2>Battle Pass - Season 1</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="bpProgress" style="width: 0%;">Tier 0/10</div>
            </div>
            <div id="bpTiers"></div>
        </div>
        
        <!-- Events Tab -->
        <div id="events" class="tab-content">
            <div class="event-banner">
                🎄 CHRISTMAS EVENT 🎅
            </div>
            <p style="margin: 20px 0;">The Christmas event happens automatically every hour (at XX:00) and lasts for 5 minutes! During this time, you have a 15% chance to spin special holiday items!</p>
            <div style="margin-top: 30px;">
                <h3>Active Bonuses:</h3>
                <div id="eventBonuses" style="margin-top: 15px;"></div>
            </div>
        </div>
        
        <!-- Rebirth Tab -->
        <div id="rebirth" class="tab-content">
            <h2>♻️ Rebirth System</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Rebirth to gain permanent bonuses, but lose all progress!</p>
            
            <div class="stat-card" style="margin: 20px 0;">
                <div class="stat-label">Total Rebirths</div>
                <div class="stat-value" style="color: var(--accent-primary);" id="rebirthCount">0</div>
            </div>
            
            <div class="stat-card" style="margin: 20px 0;">
                <div class="stat-label">Permanent Luck Boost</div>
                <div class="stat-value" style="color: var(--accent-gold);" id="permanentLuck">1.0x</div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 10px;">Each rebirth adds +2x permanent luck</p>
            </div>
            
            <div class="npc-container" style="margin-top: 30px;">
                <h3 style="color: var(--accent-primary); margin-bottom: 15px;">Rebirth Requirements:</h3>
                <div id="rebirthRequirements" style="background: var(--bg-light); padding: 20px; border-radius: 12px; border: 2px solid var(--accent-secondary);">
                    <p style="color: var(--accent-gold);">Next Rebirth Requirements:</p>
                    <p style="color: var(--text-secondary);">💰 Money: $1,000,000</p>
                    <p style="color: var(--rarity-mythic);">✨ Item: Mythic+ rarity</p>
                    <p style="color: var(--success);">🎁 Reward: +2.0x permanent luck</p>
                </div>
                <div style="margin: 20px 0; padding: 15px; background: var(--bg-medium); border-radius: 8px; border-left: 4px solid var(--danger);">
                    <p style="color: var(--danger); font-weight: bold; margin-bottom: 10px;">⚠️ WARNING ⚠️</p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Rebirthing will reset:</p>
                    <ul style="color: var(--text-secondary); font-size: 0.9rem; margin: 10px 0 10px 20px;">
                        <li>All items in inventory</li>
                        <li>All money</li>
                        <li>All upgrades</li>
                        <li>Battle Pass progress</li>
                        <li>Total spins counter</li>
                    </ul>
                    <p style="color: var(--success); font-size: 0.9rem; margin-top: 10px;">✓ You keep: Achievements, Rebirths, Permanent Luck, Quest Stats</p>
                </div>
                    <button class="btn btn-decline" onclick="performRebirth()" style="width: 100%; padding: 15px; font-size: 1.1rem;">
                        ♻️ REBIRTH NOW ♻️
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Boss Battles Tab -->
        <div id="bosses" class="tab-content">
            <h2>👹 Boss Battles</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Fight powerful bosses for legendary rewards!</p>
            
            <div style="max-width: 1200px; margin: 0 auto;">
                <!-- Boss Statistics -->
                <div class="stat-card" style="margin-bottom: 20px; background: linear-gradient(135deg, var(--bg-medium), var(--bg-dark));">
                    <h3 style="color: var(--accent-primary);">📊 Your Boss Stats</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Bosses Defeated</div>
                            <div style="color: var(--accent-gold); font-size: 1.5rem; font-weight: bold;" id="totalBossesDefeated">0</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Damage Dealt</div>
                            <div style="color: var(--danger); font-size: 1.5rem; font-weight: bold;" id="totalBossDamage">0</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Best Rewards</div>
                            <div style="color: var(--success); font-size: 1.5rem; font-weight: bold;" id="bestBossReward">$0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Boss List -->
                <div id="bossesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    <!-- Bosses will be rendered here -->
                </div>
            </div>
        </div>
        
        <!-- Dungeons Tab -->
        <div id="dungeons" class="tab-content">
            <h2>🗺️ Dungeon Exploration</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Explore dangerous dungeons for rare loot and treasures!</p>
            
            <div style="max-width: 1400px; margin: 0 auto;">
                <!-- Dungeon Stats -->
                <div class="stat-card" style="margin-bottom: 20px; background: linear-gradient(135deg, var(--bg-medium), var(--bg-dark));">
                    <h3 style="color: var(--accent-gold);">⚔️ Explorer Stats</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Dungeons Cleared</div>
                            <div style="color: var(--success); font-size: 1.6rem; font-weight: bold;"><span id="dungeonsCleared">0</span></div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Enemies Defeated</div>
                            <div style="color: var(--danger); font-size: 1.6rem; font-weight: bold;"><span id="enemiesDefeated">0</span></div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Treasure Found</div>
                            <div style="color: var(--accent-gold); font-size: 1.6rem; font-weight: bold;"><span id="treasureFound">0</span></div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Loot Value</div>
                            <div style="color: var(--accent-primary); font-size: 1.6rem; font-weight: bold;">$<span id="totalDungeonLoot">0</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Active Expedition -->
                <div id="activeExpedition" style="display: none; margin-bottom: 30px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--bg-dark), #1a472a);">
                        <h3 style="color: var(--success);">🎯 Active Expedition</h3>
                        <div id="expeditionContent"></div>
                    </div>
                </div>
                
                <!-- Dungeon List -->
                <h3 style="color: var(--accent-primary); margin: 30px 0 20px 0;">🏰 Available Dungeons</h3>
                <div id="dungeonsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px;">
                    <!-- Dungeons will be rendered here -->
                </div>
            </div>
        </div>
        
        <!-- Artifacts Tab -->
        <div id="artifacts" class="tab-content">
            <h2>💎 Legendary Artifacts</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Collect powerful artifacts for permanent bonuses!</p>
            
            <div style="max-width: 1200px; margin: 0 auto;">
                <!-- Artifact Collection Stats -->
                <div class="stat-card" style="margin-bottom: 20px; background: linear-gradient(135deg, var(--bg-medium), var(--bg-dark));">
                    <h3 style="color: var(--accent-gold);">🏆 Collection Progress</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Artifacts Owned</div>
                            <div style="color: var(--accent-gold); font-size: 1.8rem; font-weight: bold;"><span id="artifactsOwned">0</span> / 15</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Power</div>
                            <div style="color: var(--accent-primary); font-size: 1.8rem; font-weight: bold;" id="totalArtifactPower">0%</div>
                        </div>
                    </div>
                </div>
                
                <!-- Artifact List by Tier -->
                <div id="artifactsContainer">
                    <!-- Artifacts will be rendered here by tier -->
                </div>
            </div>
        </div>
        
        <!-- Daily Challenges Tab -->
        <div id="dailies" class="tab-content">
            <h2>📅 Daily Challenges</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Complete challenges for rewards! Resets daily at midnight.</p>
            
            <div style="text-align: center; margin: 20px 0;">
                <div style="font-size: 1.2rem; color: var(--accent-primary);">
                    🏆 Achievement Points: <span id="achievementPointsDisplay">0</span>
                </div>
            </div>
            
            <div id="dailyChallengesContainer" class="crafting-grid" style="margin-top: 20px;"></div>
        </div>
        
        <!-- Achievement Shop Tab -->
        <div id="achievementshop" class="tab-content">
            <h2>🏪 Achievement Shop</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Spend Achievement Points on permanent upgrades!</p>
            
            <div style="text-align: center; margin: 20px 0;">
                <div style="font-size: 1.5rem; color: var(--accent-gold);">
                    💰 Points: <span id="achievementPointsShopDisplay">0</span>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px;">
                    Earn points by completing achievements!
                </p>
            </div>
            
            <div id="achievementShopContainer" class="crafting-grid" style="margin-top: 20px;"></div>
        </div>
        
        <!-- Pets Tab -->
        <div id="pets" class="tab-content">
            <h2>🐉 Pet Collection</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Collect and level up pets for permanent bonuses!</p>
            
            <div style="text-align: center; margin: 20px 0; padding: 20px; background: var(--bg-light); border-radius: 12px;">
                <h3 style="color: var(--accent-primary); margin-bottom: 15px;">Active Pet</h3>
                <div id="activePetDisplay" style="font-size: 3rem; margin: 10px 0;">❓</div>
                <div id="activePetName" style="font-size: 1.2rem; color: var(--accent-gold); margin: 10px 0;">No pet equipped</div>
                <div id="activePetBonus" style="color: var(--text-secondary); font-size: 0.9rem;">Equip a pet to get bonuses!</div>
                <div id="activePetLevel" style="color: var(--success); font-size: 0.9rem; margin-top: 5px;">Level: 0</div>
            </div>
            
            <h3 style="margin: 20px 0;">🌟 Available Pets</h3>
            <div id="petsContainer" class="crafting-grid"></div>
        </div>
        
        <!-- Potions Tab -->
        <div id="potions" class="tab-content">
            <h2>🧪 Mystical Potions</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Powerful elixirs for late-game power!</p>
            
            <div id="potionsLockedMessage" style="max-width: 800px; margin: 50px auto; text-align: center; padding: 50px; background: linear-gradient(135deg, var(--bg-dark), var(--bg-medium)); border-radius: 15px; border: 3px solid var(--warning);">
                <div style="font-size: 5rem; margin-bottom: 20px;">🔒</div>
                <h2 style="color: var(--warning); margin-bottom: 20px;">POTIONS SYSTEM LOCKED</h2>
                <p style="color: var(--text-secondary); font-size: 1.2rem; margin-bottom: 30px;">
                    The ancient art of potion-making will be unlocked on:
                </p>
                <div style="background: var(--bg-dark); padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <div style="font-size: 2rem; color: var(--accent-gold); font-weight: bold;">December 12, 2025</div>
                    <div style="font-size: 1.5rem; color: var(--accent-primary); margin-top: 10px;">12:00 AM (Midnight)</div>
                </div>
                <div id="potionsCountdown" style="font-size: 1.8rem; color: var(--success); margin-top: 30px; font-weight: bold;"></div>
                <p style="color: var(--text-secondary); margin-top: 30px; font-size: 0.9rem;">
                    💡 Prepare your resources! Potions will provide massive late-game bonuses.
                </p>
            </div>
            
            <div id="potionsUnlockedContent" style="display: none; max-width: 1400px; margin: 0 auto;">
                <!-- Potion Stats -->
                <div class="stat-card" style="margin-bottom: 20px; background: linear-gradient(135deg, var(--bg-medium), var(--bg-dark));">
                    <h3 style="color: var(--accent-primary);">🧪 Potion Effects</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Potions Owned</div>
                            <div style="color: var(--accent-gold); font-size: 1.6rem; font-weight: bold;"><span id="potionsOwned">0</span></div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Active Effects</div>
                            <div style="color: var(--success); font-size: 1.6rem; font-weight: bold;"><span id="activeEffects">0</span></div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Consumed</div>
                            <div style="color: var(--accent-primary); font-size: 1.6rem; font-weight: bold;"><span id="potionsConsumed">0</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Active Potions Display -->
                <div id="activePotionsDisplay" style="margin-bottom: 30px;"></div>
                
                <!-- Potions List -->
                <h3 style="color: var(--accent-primary); margin: 30px 0 20px 0;">🧪 Available Potions</h3>
                <div id="potionsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    <!-- Potions will be rendered here -->
                </div>
            </div>
        </div>
        
        <!-- Prestige Tab -->
        <div id="prestige" class="tab-content">
            <h2>⭐ Prestige System</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Reset everything for powerful permanent bonuses!</p>
            
            <div style="max-width: 600px; margin: 30px auto;">
                <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, var(--bg-medium) 0%, var(--bg-light) 100%); border-radius: 15px; border: 2px solid var(--accent-gold);">
                    <div style="font-size: 3rem; margin-bottom: 10px;">⭐</div>
                    <h3 style="color: var(--accent-gold); margin-bottom: 10px;">Current Prestige Level</h3>
                    <div style="font-size: 3rem; color: var(--accent-gold); margin: 20px 0;" id="prestigeLevelDisplay">0</div>
                    <div style="font-size: 1.2rem; color: var(--success); margin: 10px 0;">
                        Prestige Points: <span id="prestigePointsDisplay">0</span>
                    </div>
                    
                    <div style="margin: 30px 0; padding: 20px; background: var(--bg-dark); border-radius: 10px; text-align: left;">
                        <h4 style="color: var(--accent-primary); margin-bottom: 15px;">Prestige Requirements:</h4>
                        <div style="margin: 10px 0;">
                            ✅ 10+ Rebirths: <span id="prestigeRebirthReq" style="color: var(--danger);">Not met</span>
                        </div>
                        <div style="margin: 10px 0;">
                            ✅ $1 Billion: <span id="prestigeMoneyReq" style="color: var(--danger);">Not met</span>
                        </div>
                        <div style="margin: 10px 0;">
                            ✅ 1 Primordial+ Item: <span id="prestigeItemReq" style="color: var(--danger);">Not met</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-accept" onclick="performPrestige()" id="prestigeButton" disabled style="width: 100%; padding: 20px; font-size: 1.2rem; opacity: 0.5; cursor: not-allowed;">
                        ⭐ PRESTIGE NOW ⭐
                    </button>
                    
                    <div style="margin-top: 20px; color: var(--text-secondary); font-size: 0.9rem;">
                        <p style="margin: 5px 0;">💎 You keep: Prestige Points, Prestige Shop, Pets</p>
                        <p style="margin: 5px 0; color: var(--danger);">❌ You lose: EVERYTHING ELSE</p>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0; text-align: center;">🏪 Prestige Shop</h3>
                <div id="prestigeShopContainer" class="crafting-grid"></div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2>⚙️ Settings</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Customize your gameplay experience</p>
            
            <div class="crafting-grid" style="margin-top: 20px;">
                <div class="recipe-card">
                    <h3 style="color: var(--accent-primary);">Notifications</h3>
                    <div style="margin: 15px 0;">
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingSoundEffects" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>🔊 Sound Effects</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingTradeNotif" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Show Trade Notifications</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingExpiredNotif" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Show Expired Trade Notifications</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingSpinNotif" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Show Spin Result Notifications</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingAchievementNotif" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Show Achievement Notifications</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingEventNotif" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Show Random Event Notifications</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingAutoSaveNotif" onchange="updateSettings()" style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Show Auto-Save Notifications</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingPityNotif" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Show Pity System Notifications</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingFusionNotif" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Show Fusion Notifications</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingCollectionNotif" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Show Collection Completions</span>
                        </label>
                    </div>
                </div>
                
                <div class="recipe-card">
                    <h3 style="color: var(--accent-primary);">Gameplay</h3>
                    <div style="margin: 15px 0;">
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingConfirmSell" onchange="updateSettings()" style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Confirm Before Selling Items</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingAnimations" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Enable Ultra-Rare Animations</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingCompactMode" onchange="updateSettings()" style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Compact UI Mode</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingShowValue" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Show Item Values in Inventory</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingAutoClaimQuests" onchange="updateSettings()" style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Auto-Claim Completed Quests</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingConfirmRebirth" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Confirm Rebirth Action</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingConfirmPrestige" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Confirm Prestige Action</span>
                        </label>
                    </div>
                </div>
                
                <div class="recipe-card">
                    <h3 style="color: var(--accent-primary);">Auto-Save</h3>
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin: 10px 0;">
                            <span style="color: var(--text-secondary); display: block; margin-bottom: 5px;">Auto-Save Interval</span>
                            <select id="settingAutoSaveInterval" onchange="updateSettings()" style="width: 100%; padding: 10px; background: var(--bg-medium); color: var(--text-primary); border: 2px solid var(--accent-primary); border-radius: 8px;">
                                <option value="30">30 seconds</option>
                                <option value="60" selected>1 minute</option>
                                <option value="120">2 minutes</option>
                                <option value="300">5 minutes</option>
                                <option value="0">Disabled</option>
                            </select>
                        </label>
                    </div>
                </div>
                
                <div class="recipe-card">
                    <h3 style="color: var(--accent-primary);">Visual Preferences</h3>
                    <div style="margin: 15px 0;">
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingShowRarityColors" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Colorful Rarity Names</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingShowItemCount" onchange="updateSettings()" checked style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Show Item Counts</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingReduceMotion" onchange="updateSettings()" style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Reduce Motion (Accessibility)</span>
                        </label>
                        <label style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;">
                            <input type="checkbox" id="settingLargeText" onchange="updateSettings()" style="width: 20px; height: 20px; margin-right: 10px;">
                            <span>Large Text Mode</span>
                        </label>
                    </div>
                </div>
                
                <div class="recipe-card">
                    <h3 style="color: var(--accent-primary);">⌨️ Keyboard Shortcuts</h3>
                    <div style="margin: 15px 0; line-height: 2;">
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; color: var(--text-secondary); font-size: 0.9rem;">
                            <span style="color: var(--accent-gold); font-weight: bold;">SPACE</span><span>Spin the wheel</span>
                            <span style="color: var(--accent-gold); font-weight: bold;">1-9</span><span>Switch tabs (1=Inventory, 2=Shop, etc.)</span>
                            <span style="color: var(--accent-gold); font-weight: bold;">S</span><span>Shop tab</span>
                            <span style="color: var(--accent-gold); font-weight: bold;">I</span><span>Inventory tab</span>
                            <span style="color: var(--accent-gold); font-weight: bold;">B</span><span>Bosses tab</span>
                            <span style="color: var(--accent-gold); font-weight: bold;">A</span><span>Artifacts tab</span>
                            <span style="color: var(--accent-gold); font-weight: bold;">P</span><span>Prestige tab</span>
                            <span style="color: var(--accent-gold); font-weight: bold;">R</span><span>Rebirth tab</span>
                            <span style="color: var(--accent-gold); font-weight: bold;">ESC</span><span>Close modals</span>
                        </div>
                    </div>
                </div>
                
                <div class="recipe-card">
                    <h3 style="color: var(--accent-primary);">💾 Save Management</h3>
                    <div style="margin: 15px 0;">
                        <button class="btn btn-accept" onclick="exportSaveData()" style="width: 100%; margin-bottom: 10px;">
                            📤 Export Save Code
                        </button>
                        <button class="btn btn-accept" onclick="resetTutorial()" style="width: 100%; margin-bottom: 10px; background: linear-gradient(135deg, var(--accent-primary), var(--success));">
                            📚 Restart Tutorial
                        </button>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 10px;">
                            Export to backup your progress or share with friends!<br>
                            <strong>Import is in Admin Panel for safety.</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Codes Redemption -->
        <div id="admin" class="tab-content">
            <!-- Toggle Buttons -->
            <div style="text-align: center; margin-bottom: 30px;">
                <button id="showCodesBtn" class="btn btn-accept" onclick="showCodesPanel()" style="margin: 0 10px; padding: 12px 30px; font-size: 1.1rem;">🎁 Codes</button>
                <button id="showAdminBtn" class="btn btn-decline" onclick="showAdminPanel()" style="margin: 0 10px; padding: 12px 30px; font-size: 1.1rem; display: none;">⚙️ Admin Panel</button>
            </div>
            
            <div id="codesPanel" style="display: block;">
                <h2>🎁 Redeem Codes</h2>
                <p style="margin: 20px 0; color: var(--text-secondary);">Enter special codes to unlock exclusive rewards!</p>
                <div style="max-width: 500px; margin: 0 auto;">
                    <input type="text" id="codeInput" placeholder="Enter code here..." 
                           style="width: 100%; padding: 15px; margin: 20px 0; background: var(--bg-medium); color: var(--text-primary); border: 2px solid var(--accent-primary); border-radius: 8px; font-size: 1.1rem; text-align: center;">
                    <button class="btn btn-accept" onclick="redeemCode()" style="width: 100%; padding: 15px; font-size: 1.1rem;">✨ REDEEM CODE</button>
                    
                    <div style="margin-top: 40px; padding: 20px; background: var(--bg-dark); border-radius: 10px; border: 2px solid var(--accent-primary);">
                        <h3 style="color: var(--accent-gold); margin-bottom: 15px;">💡 Code Hints</h3>
                        <p style="color: var(--text-secondary); font-size: 0.95rem; line-height: 1.6;">
                            • Codes are case-sensitive<br>
                            • Check social media for new codes<br>
                            • Codes can only be used once<br>
                            • Special events may have limited-time codes<br>
                            • Some codes unlock exclusive items!
                        </p>
                    </div>
                    
                    <div id="redeemedCodesList" style="margin-top: 30px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 15px;">✅ Redeemed Codes</h3>
                        <div id="redeemedCodesContainer" style="max-height: 300px; overflow-y: auto;">
                            <p style="color: var(--text-secondary); font-style: italic;">No codes redeemed yet...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="adminPanel" style="display: none;">
                <h2>⚙️ Admin Panel</h2>
                <p style="margin: 10px 0; color: var(--warning);">⚠️ Warning: These are cheat commands for testing purposes!</p>
                
                <div class="crafting-grid" style="margin-top: 20px;">
                    <div class="recipe-card">
                        <h3 style="color: var(--accent-primary);">Money Cheats</h3>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-accept" onclick="adminAddMoney(1000)">+$1,000</button>
                            <button class="btn btn-accept" onclick="adminAddMoney(10000)" style="margin-top: 10px;">+$10,000</button>
                            <button class="btn btn-accept" onclick="adminAddMoney(100000)" style="margin-top: 10px;">+$100,000</button>
                            <button class="btn btn-accept" onclick="adminAddMoney(1000000)" style="margin-top: 10px;">+$1,000,000</button>
                        </div>
                    </div>
                    
                    <div class="recipe-card">
                        <h3 style="color: var(--accent-primary);">Item Spawner</h3>
                        <div style="margin: 15px 0;">
                            <select id="adminRaritySelect" style="width: 100%; padding: 10px; margin-bottom: 10px; background: var(--bg-medium); color: var(--text-primary); border: 2px solid var(--accent-primary); border-radius: 8px; max-height: 200px; overflow-y: auto;">
                                <option value="0">Common</option>
                                <option value="1">Uncommon</option>
                                <option value="2">Rare</option>
                                <option value="3">Epic</option>
                                <option value="4">Legendary</option>
                                <option value="5">Mythic</option>
                                <option value="6">Exotic</option>
                                <option value="7">Celestial</option>
                                <option value="8">Divine</option>
                                <option value="9">Cosmic</option>
                                <option value="10">Infinite</option>
                                <option value="11">Transcendent</option>
                                <option value="12">Ethereal</option>
                                <option value="13">Primordial</option>
                                <option value="14">Omega</option>
                                <option value="15">Supreme</option>
                                <option value="16">Godlike</option>
                                <option value="17">Universal</option>
                                <option value="18">Multiversal</option>
                                <option value="19">Omnipotent</option>
                                <option value="20">Infinite Absolute</option>
                                <option value="21">Eternal</option>
                                <option value="22">Shaw ⭐</option>
                                <option value="23">Immortal</option>
                                <option value="24">Ascended</option>
                                <option value="25">Transcendental</option>
                                <option value="26">Boundless</option>
                                <option value="27">Limitless</option>
                                <option value="28">Admin ⚡</option>
                                <option value="29">Absolute</option>
                                <option value="30">Beyond</option>
                                <option value="31">Incomprehensible</option>
                                <option value="32">Unimaginable</option>
                                <option value="33">Impossible</option>
                                <option value="34">Paradox</option>
                                <option value="35">Singularity</option>
                                <option value="36">Void</option>
                                <option value="37">Nothingness</option>
                                <option value="38">Everything</option>
                                <option value="39">The End</option>
                                <option value="40">The Beginning</option>
                                <option value="41">Alpha Omega</option>
                                <option value="42">True Infinity</option>
                                <option value="43">The One</option>
                                <option value="44">Primeval</option>
                                <option value="45">Celestial Prime</option>
                                <option value="46">Quantum</option>
                                <option value="47">Dimensional</option>
                                <option value="48">Hyperversal</option>
                                <option value="49">Outerversal</option>
                                <option value="50">Boundaryless</option>
                                <option value="51">Formless</option>
                                <option value="52">Abstract</option>
                                <option value="53">Conceptual</option>
                                <option value="54">Metaphysical</option>
                                <option value="55">The Source</option>
                                <option value="56">The Eternal</option>
                                <option value="57">The Absolute Infinity</option>
                                <option value="58">Beyond Infinity</option>
                                <option value="59">Infinite Beyond</option>
                                <option value="60">Transcendent Infinity</option>
                                <option value="61">Omniversal</option>
                                <option value="62">Absolute Beyond</option>
                                <option value="63">The Totality</option>
                                <option value="64">The Omnipotent</option>
                                <option value="65">Reality Itself 🌌</option>
                            </select>
                            <input type="number" id="adminItemCount" placeholder="Amount (1-100)" min="1" max="100" value="1" style="width: 100%; padding: 10px; margin-bottom: 10px; background: var(--bg-medium); color: var(--text-primary); border: 2px solid var(--accent-primary); border-radius: 8px;">
                            <button class="btn btn-accept" onclick="adminSpawnItem()">Spawn Item(s)</button>
                        </div>
                    </div>
                    
                    <div class="recipe-card">
                        <h3 style="color: var(--accent-primary);">Luck Manipulation</h3>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-accept" onclick="adminSetLuck(2)">Set Luck 2x</button>
                            <button class="btn btn-accept" onclick="adminSetLuck(5)" style="margin-top: 10px;">Set Luck 5x</button>
                            <button class="btn btn-accept" onclick="adminSetLuck(10)" style="margin-top: 10px;">Set Luck 10x</button>
                            <button class="btn btn-accept" onclick="adminSetLuck(100)" style="margin-top: 10px;">Set Luck 100x</button>
                        </div>
                    </div>
                    
                    <div class="recipe-card">
                        <h3 style="color: var(--accent-primary);">Max Upgrades</h3>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-accept" onclick="adminMaxUpgrades()">Max All Upgrades</button>
                            <p style="color: var(--text-secondary); margin-top: 10px; font-size: 0.9rem;">Sets all upgrades to max level</p>
                        </div>
                    </div>
                    
                    <div class="recipe-card">
                        <h3 style="color: var(--accent-primary);">Battle Pass</h3>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-accept" onclick="adminAddBPXP(1000)">+1,000 XP</button>
                            <button class="btn btn-accept" onclick="adminAddBPXP(10000)" style="margin-top: 10px;">+10,000 XP</button>
                            <button class="btn btn-accept" onclick="adminMaxBP()" style="margin-top: 10px;">Max Battle Pass</button>
                        </div>
                    </div>
                    
                    <div class="recipe-card">
                        <h3 style="color: var(--accent-primary);">🧪 Potions System</h3>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-accept" onclick="adminUnlockPotions()">Unlock Potions Early</button>
                            <p style="color: var(--text-secondary); margin-top: 10px; font-size: 0.9rem;">Unlocks potions before Dec 12 (for testing)</p>
                        </div>
                    </div>
                    
                    <div class="recipe-card">
                        <h3 style="color: var(--accent-primary);">🌟 New Systems (Dec 12)</h3>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-accept" onclick="adminUnlockAllNewSystems()" style="width: 100%;">Unlock ALL New Systems</button>
                            <p style="color: var(--text-secondary); margin-top: 10px; font-size: 0.9rem;">Unlocks Skills, Leaderboard, Guild, Gacha, Themes & Titles</p>
                            <button class="btn btn-accept" onclick="adminGiveSkillPoints(10)" style="width: 100%; margin-top: 10px;">+10 Skill Points</button>
                            <button class="btn btn-accept" onclick="adminGiveGems(1000)" style="width: 100%; margin-top: 10px;">+1000 Gems</button>
                        </div>
                    </div>
                    
                    <div class="recipe-card">
                        <h3 style="color: var(--accent-primary);">Events</h3>
                        <div style="margin: 15px 0;">
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">Weather Events:</p>
                            <button class="btn btn-accept" onclick="adminStartWeatherEvent('cloudy')">Start Cloudy Event</button>
                            <button class="btn btn-accept" onclick="adminStartWeatherEvent('rainy')" style="margin-top: 5px;">Start Rainy Event</button>
                            <button class="btn btn-accept" onclick="adminStartWeatherEvent('storming')" style="margin-top: 5px;">Start Storming Event</button>
                            
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 15px 0 10px 0;">Special Events (1 min each):</p>
                            <button class="btn btn-accept" onclick="adminStartSpecialEvent('disco')" style="background: #ff00ff;">🪩 Disco Event</button>
                            <button class="btn btn-accept" onclick="adminStartSpecialEvent('galactic')" style="margin-top: 5px; background: #4B0082;">🌌 Galactic Event</button>
                            <button class="btn btn-accept" onclick="adminStartSpecialEvent('glitch')" style="margin-top: 5px; background: #00ff00; color: black;">⚡ Glitch Event</button>
                            <button class="btn btn-accept" onclick="adminStartSpecialEvent('fullmoon')" style="margin-top: 5px; background: #f0f0f0; color: black;">🌕 Full Moon Event</button>
                            <button class="btn btn-accept" onclick="adminStartSpecialEvent('bloodmoon')" style="margin-top: 5px; background: #8B0000;">🔴 Blood Moon Event</button>
                            <button class="btn btn-accept" onclick="adminStartSpecialEvent('nuclear')" style="margin-top: 5px; background: #00ff00; color: black;">☢️ Nuclear Event</button>
                            <button class="btn btn-accept" onclick="adminStartSpecialEvent('volcanic')" style="margin-top: 5px; background: #ff4500;">🌋 Volcanic Event</button>
                            <button class="btn btn-accept" onclick="adminStartSpecialEvent('goldenrain')" style="margin-top: 5px; background: #ffd700; color: black;">💰 Golden Rain Event</button>
                            
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 15px 0 10px 0;">Luck Events:</p>
                            <button class="btn btn-accept" onclick="adminSetLuckEvent(2)" style="background: #66ccff;">2x Luck</button>
                            <button class="btn btn-accept" onclick="adminSetLuckEvent(4)" style="margin-top: 5px; background: #44aaff;">4x Luck</button>
                            <button class="btn btn-accept" onclick="adminSetLuckEvent(6)" style="margin-top: 5px; background: #2288ff;">6x Luck</button>
                            <button class="btn btn-accept" onclick="adminSetLuckEvent(8)" style="margin-top: 5px; background: #0066ff;">8x Luck</button>
                            <button class="btn btn-accept" onclick="adminStopLuckEvent()" style="margin-top: 5px; background: var(--danger);">Stop Luck Event</button>
                            
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 15px 0 10px 0;">Other Events:</p>
                            <button class="btn btn-accept" onclick="adminToggleChristmas()">Toggle Christmas Event</button>
                            <button class="btn btn-accept" onclick="adminSpawnTrade()" style="margin-top: 5px;">Spawn Trade Now</button>
                        </div>
                    </div>
                    
                    <div class="recipe-card">
                        <h3 style="color: var(--accent-primary);">Inventory</h3>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-decline" onclick="adminClearInventory()">Clear Inventory</button>
                            <button class="btn btn-accept" onclick="adminDuplicateInventory()" style="margin-top: 10px;">Duplicate Inventory</button>
                        </div>
                    </div>
                    
                    <div class="recipe-card">
                        <h3 style="color: var(--accent-primary);">Achievements</h3>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-accept" onclick="adminUnlockAllAchievements()">Unlock All Achievements</button>
                            <button class="btn btn-decline" onclick="adminResetAchievements()" style="margin-top: 10px;">Reset Achievements</button>
                        </div>
                    </div>
                    
                    <div class="recipe-card">
                        <h3 style="color: var(--accent-primary);">Stats Manipulation</h3>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-accept" onclick="adminSetSpins(10000)">Set 10k Spins</button>
                            <button class="btn btn-accept" onclick="adminAddRebirths(1)" style="margin-top: 10px;">+1 Rebirth</button>
                            <button class="btn btn-accept" onclick="adminSetTradeWins(1000)" style="margin-top: 10px;">Set 1k Trade Wins</button>
                        </div>
                    </div>
                    
                    <div class="recipe-card">
                        <h3 style="color: var(--accent-primary);">Quick Actions</h3>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-accept" onclick="adminCompleteEverything()">Complete Everything</button>
                            <p style="color: var(--text-secondary); margin-top: 10px; font-size: 0.9rem;">Max upgrades, BP, money, achievements</p>
                        </div>
                    </div>
                    
                    <div class="recipe-card">
                        <h3 style="color: var(--accent-primary);">📥 Import Save</h3>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-accept" onclick="showImportDialog()" style="width: 100%;">Import Save Code</button>
                            <p style="color: var(--warning); margin-top: 10px; font-size: 0.9rem;">⚠️ Will overwrite current progress!</p>
                        </div>
                    </div>
                    
                    <div class="recipe-card">
                        <h3 style="color: var(--danger);">Danger Zone</h3>
                        <div style="margin: 15px 0;">
                            <button class="btn btn-decline" onclick="adminResetGame()">Reset Everything</button>
                            <p style="color: var(--text-secondary); margin-top: 10px; font-size: 0.9rem;">⚠️ This will delete all progress!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Skills Tab -->
        <div id="skills" class="tab-content">
            <div id="skillsLockedMessage" style="display: none; text-align: center; padding: 50px;">
                <h2>⚡ SKILLS SYSTEM</h2>
                <p style="font-size: 1.2rem; margin: 20px 0;">🔒 Unlocks on December 12, 2025</p>
                <p id="skillsCountdown" style="font-size: 1.5rem; color: var(--accent-gold); font-weight: bold;">⏰ Calculating...</p>
            </div>
            <div id="skillsContent" style="display: none;">
                <h2>⚡ Skill Trees</h2>
                <p style="margin: 20px 0;">Spend skill points to unlock permanent passive bonuses!</p>
                <div style="text-align: center; margin: 20px 0; padding: 20px; background: var(--bg-dark); border-radius: 10px;">
                    <h3>Available Skill Points: <span id="skillPointsDisplay" style="color: var(--accent-gold);">0</span></h3>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Earn skill points by leveling up and prestiging!</p>
                </div>
                <div id="skillTreesContainer" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <!-- Leaderboard Tab -->
        <div id="leaderboard" class="tab-content">
            <div id="leaderboardLockedMessage" style="display: none; text-align: center; padding: 50px;">
                <h2>🏆 LEADERBOARDS</h2>
                <p style="font-size: 1.2rem; margin: 20px 0;">🔒 Unlocks on December 12, 2025</p>
                <p id="leaderboardCountdown" style="font-size: 1.5rem; color: var(--accent-gold); font-weight: bold;">⏰ Calculating...</p>
            </div>
            <div id="leaderboardContent" style="display: none;">
                <h2>🏆 Leaderboards</h2>
                <p style="margin: 20px 0;">Compete with players worldwide!</p>
                <div style="margin: 20px 0;">
                    <button class="btn btn-accept" onclick="switchLeaderboardCategory('money')" style="margin: 5px;">💰 Richest</button>
                    <button class="btn btn-accept" onclick="switchLeaderboardCategory('luck')" style="margin: 5px;">🍀 Luckiest</button>
                    <button class="btn btn-accept" onclick="switchLeaderboardCategory('items')" style="margin: 5px;">🎁 Most Items</button>
                    <button class="btn btn-accept" onclick="switchLeaderboardCategory('prestige')" style="margin: 5px;">⭐ Highest Prestige</button>
                </div>
                <div id="leaderboardDisplay" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <!-- Guild Tab -->
        <div id="guild" class="tab-content">
            <div id="guildLockedMessage" style="display: none; text-align: center; padding: 50px;">
                <h2>🤝 GUILDS & CLANS</h2>
                <p style="font-size: 1.2rem; margin: 20px 0;">🔒 Unlocks on December 12, 2025</p>
                <p id="guildCountdown" style="font-size: 1.5rem; color: var(--accent-gold); font-weight: bold;">⏰ Calculating...</p>
            </div>
            <div id="guildContent" style="display: none;">
                <div id="noGuildPanel">
                    <h2>🤝 Guilds</h2>
                    <p style="margin: 20px 0;">Join a guild to receive powerful passive bonuses!</p>
                    <div id="availableGuildsContainer" style="margin-top: 20px;"></div>
                </div>
                <div id="inGuildPanel" style="display: none;">
                    <h2 id="guildNameDisplay">Guild Name</h2>
                    <div id="guildStatsContainer" style="margin: 20px 0;"></div>
                    <button class="btn btn-decline" onclick="leaveGuild()" style="margin-top: 20px;">Leave Guild</button>
                </div>
            </div>
        </div>
        
        <!-- Gacha Tab -->
        <div id="gacha" class="tab-content">
            <div id="gachaLockedMessage" style="display: none; text-align: center; padding: 50px;">
                <h2>🎲 GACHA BANNERS</h2>
                <p style="font-size: 1.2rem; margin: 20px 0;">🔒 Unlocks on December 12, 2025</p>
                <p id="gachaCountdown" style="font-size: 1.5rem; color: var(--accent-gold); font-weight: bold;">⏰ Calculating...</p>
            </div>
            <div id="gachaContent" style="display: none;">
                <h2>🎲 Gacha Banners</h2>
                <p style="margin: 20px 0;">Use gems to pull for featured items!</p>
                <div style="text-align: center; margin: 20px 0; padding: 20px; background: var(--bg-dark); border-radius: 10px;">
                    <h3>💎 Gems: <span id="gemsDisplay" style="color: var(--accent-primary);">0</span></h3>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Earn gems through quests, achievements, and daily login!</p>
                </div>
                <div id="currentBannerContainer" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <!-- Themes Tab -->
        <div id="themes" class="tab-content">
            <div id="themesLockedMessage" style="display: none; text-align: center; padding: 50px;">
                <h2>🎨 THEMES & SKINS</h2>
                <p style="font-size: 1.2rem; margin: 20px 0;">🔒 Unlocks on December 12, 2025</p>
                <p id="themesCountdown" style="font-size: 1.5rem; color: var(--accent-gold); font-weight: bold;">⏰ Calculating...</p>
            </div>
            <div id="themesContent" style="display: none;">
                <h2>🎨 Themes & Cosmetics</h2>
                <p style="margin: 20px 0;">Customize your game's appearance!</p>
                <div id="themesContainer" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <!-- Titles Tab -->
        <div id="titles" class="tab-content">
            <div id="titlesLockedMessage" style="display: none; text-align: center; padding: 50px;">
                <h2>🏅 TITLES & BADGES</h2>
                <p style="font-size: 1.2rem; margin: 20px 0;">🔒 Unlocks on December 12, 2025</p>
                <p id="titlesCountdown" style="font-size: 1.5rem; color: var(--accent-gold); font-weight: bold;">⏰ Calculating...</p>
            </div>
            <div id="titlesContent" style="display: none;">
                <h2>🏅 Titles & Badges</h2>
                <p style="margin: 20px 0;">Earn titles by completing challenges and show them off!</p>
                <div style="text-align: center; margin: 20px 0; padding: 20px; background: var(--bg-dark); border-radius: 10px;">
                    <h3>Current Title: <span id="currentTitleDisplay" style="color: var(--accent-gold);">None</span></h3>
                </div>
                <div id="titlesListContainer" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Game State
        const gameState = {
            inventory: {},
            totalValue: 0,
            money: 0,
            totalSpins: 0,
            luckMultiplier: 1.0,
            tradeWins: 0,
            tradeLosses: 0,
            flexedItem: null,
            christmasEvent: false,
            christmasEventEnd: null,
            battlePassTier: 0,
            battlePassXP: 0,
            achievements: {},
            enchantmentTarget: null,
            activeTrades: [],
            tradeTimer: null,
            upgrades: {
                spinSpeed: 0,
                popularity: 0,
                luckBoost: 0,
                autoSpin: 0,
                tradeInsight: 0,
                valueBoost: 0,
                craftingMastery: 0,
                enchantPower: 0,
                multiSpin: 0,
                shopDiscount: 0,
                rarityBoost: 0,
                eventLuck: 0,
                xpBoost: 0,
                sellPrice: 0,
                questSpeed: 0,
                mysteryBox: 0,
                autoFusion: 0
            },
            adminUnlocked: false,
            rebirths: 0,
            permanentLuckBoost: 1.0,
            // Collection Bonuses
            collectionBonuses: {
                discoComplete: false,
                galacticComplete: false,
                glitchComplete: false,
                fullmoonComplete: false,
                bloodmoonComplete: false,
                weatherComplete: false,
                christmasComplete: false
            },
            // Rarity Milestones
            rarityMilestones: {},
            weatherEvent: null, // 'cloudy', 'rainy', 'storming', or null
            weatherEventEnd: null,
            lastWeatherEvent: 0,
            specialEvent: null, // 'disco', 'galactic', 'glitch', 'fullmoon', 'bloodmoon', or null
            specialEventEnd: null,
            specialEventIsAdmin: false, // true if triggered by admin, false if scheduled
            questsCompleted: 0,
            dailyStreak: 0,
            weeklyQuestsCompleted: 0,
            shopPurchases: 0,
            activeQuests: [],
            completedQuests: [],
            lastQuestRefresh: 0,
            // Pity System
            pityCounter: 0,
            pityThreshold: 100,
            pityTriggered: 0,
            // Daily Login
            lastLoginDate: null,
            loginStreak: 0,
            totalLogins: 0,
            loginRewardsClaimed: [],
            // Stats Tracking
            lifetimeMoneyEarned: 0,
            lifetimeMoneySpent: 0,
            biggestTradeWin: 0,
            biggestTradeLoss: 0,
            rarityCounts: {},
            itemsFromEvents: 0,
            craftCount: 0,
            enchantSuccess: 0,
            enchantFails: 0,
            fusionCount: 0,
            // Notification Queue
            notificationQueue: [],
            isShowingNotification: false,
            settings: {
                soundEffects: true,
                showTradeNotifications: true,
                showExpiredNotifications: true,
                showSpinResults: true,
                showAchievementNotifications: true,
                showRandomEvents: true,
                showAutoSaveNotifications: false,
                showPityNotifications: true,
                showFusionNotifications: true,
                showCollectionNotifications: true,
                confirmSell: false,
                animations: true,
                compactMode: false,
                showValue: true,
                autoSaveInterval: 60
            },
            inventorySort: 'rarity',
            inventoryFilter: 'all',
            favoriteItems: [], // Protected from selling
            // Tutorial System
            tutorialStep: 0,
            tutorialComplete: false,
            tutorialSkipped: false,
            // Daily Challenges
            dailyChallenges: [],
            dailyChallengesCompleted: [],
            lastDailyChallengeReset: 0,
            // Achievement Shop
            achievementPoints: 0,
            achievementShopPurchases: {},
            // Pet System
            pets: [],
            activePet: null,
            petLevels: {},
            petXP: {},
            // Prestige System
            prestigeLevel: 0,
            prestigePoints: 0,
            prestigeShopPurchases: {},
            // Boss System
            bosses: {},
            bossStats: {
                totalDefeated: 0,
                totalDamage: 0,
                bestReward: 0
            },
            // Artifacts System
            artifacts: [],
            // Timed Events
            triggeredTimedEvents: {},
            // Battle Pass
            claimedBPTiers: [],
            lastDailyChallengeDate: null,
            // Code Redemption System
            redeemedCodes: [],
            // Luck Event System
            luckEvent: {
                active: false,
                multiplier: 1,
                endTime: 0
            },
            // NEW SYSTEMS - Time-locked until 12/12/25
            skillsUnlocked: undefined,
            leaderboardUnlocked: undefined,
            guildUnlocked: undefined,
            gachaUnlocked: undefined,
            themesUnlocked: undefined,
            titlesUnlocked: undefined,
            // Skills System
            skillPoints: 0,
            skillsPurchased: {},
            // Guild System
            currentGuild: null,
            // Gacha System
            gems: 0,
            gachaPulls: 0,
            gachaPity: 0,
            // Themes System
            currentTheme: 'default',
            unlockedThemes: ['default'],
            // Titles System
            currentTitle: null,
            unlockedTitles: []
        };
        
        const ADMIN_PASSWORD = "admin123"; // Change this to your desired password
        
        // Upgrade costs and effects
        const upgradeData = {
            spinSpeed: {
                name: 'Spin Speed',
                description: 'Reduce spin cooldown time',
                maxLevel: 25,
                baseCost: 50,
                costMultiplier: 2.5,
                effect: (level) => `${level * 10}% faster spins`
            },
            popularity: {
                name: 'Popularity',
                description: 'Increase trade frequency',
                maxLevel: 25,
                baseCost: 100,
                costMultiplier: 3,
                effect: (level) => `${level * 15}% more trades`
            },
            luckBoost: {
                name: 'Luck Boost',
                description: 'Permanently increase luck multiplier',
                maxLevel: 50,
                baseCost: 200,
                costMultiplier: 2,
                effect: (level) => `+${(level * 0.1).toFixed(1)}x luck`
            },
            autoSpin: {
                name: 'Auto Spin',
                description: 'Automatically spin every few seconds',
                maxLevel: 15,
                baseCost: 5000,
                costMultiplier: 5,
                effect: (level) => level > 0 ? `Auto-spin every ${Math.max(10 - level, 2)}s` : 'Not unlocked'
            },
            tradeInsight: {
                name: 'Trade Insight',
                description: 'See if trades are good or bad',
                maxLevel: 3,
                baseCost: 100000,
                costMultiplier: 20,
                effect: (level) => level === 0 ? 'Not unlocked' : level === 1 ? 'See trade quality' : level === 2 ? 'See exact difference' : 'See both item values'
            },
            valueBoost: {
                name: 'Value Boost',
                description: 'Increase value of all items you get',
                maxLevel: 50,
                baseCost: 1000,
                costMultiplier: 3,
                effect: (level) => `+${level * 5}% item value`
            },
            craftingMastery: {
                name: 'Crafting Mastery',
                description: 'Reduce crafting costs and increase output',
                maxLevel: 40,
                baseCost: 5000,
                costMultiplier: 4,
                effect: (level) => `${level * 5}% cheaper crafts, ${level * 2}% better results`
            },
            enchantPower: {
                name: 'Enchant Power',
                description: 'Increase chances of getting good enchantments',
                maxLevel: 50,
                baseCost: 10000,
                costMultiplier: 5,
                effect: (level) => `+${level * 10}% better enchant rolls`
            },
            multiSpin: {
                name: 'Multi Spin',
                description: 'Chance to spin multiple times at once',
                maxLevel: 20,
                baseCost: 50000,
                costMultiplier: 6,
                effect: (level) => `${level * 5}% chance for double spin`
            },
            shopDiscount: {
                name: 'Shop Discount',
                description: 'Reduce shop prices',
                maxLevel: 30,
                baseCost: 25000,
                costMultiplier: 4,
                effect: (level) => `${level * 3}% cheaper shop items`
            },
            rarityBoost: {
                name: 'Rarity Boost',
                description: 'Slightly increase chances for rarer items',
                maxLevel: 25,
                baseCost: 100000,
                costMultiplier: 8,
                effect: (level) => `${(level * 2).toFixed(1)}% better rarity rolls`
            },
            eventLuck: {
                name: 'Event Luck',
                description: 'Increase chance to get event items during events',
                maxLevel: 20,
                baseCost: 75000,
                costMultiplier: 5,
                effect: (level) => `+${level * 5}% event item chance`
            },
            xpBoost: {
                name: 'XP Boost',
                description: 'Gain more Battle Pass XP from all activities',
                maxLevel: 30,
                baseCost: 50000,
                costMultiplier: 4,
                effect: (level) => `+${level * 10}% XP gain`
            },
            sellPrice: {
                name: 'Sell Price',
                description: 'Get more money when selling items',
                maxLevel: 40,
                baseCost: 30000,
                costMultiplier: 4,
                effect: (level) => `+${level * 2}% sell price`
            },
            questSpeed: {
                name: 'Quest Master',
                description: 'Quests give more XP and progress faster',
                maxLevel: 25,
                baseCost: 60000,
                costMultiplier: 5,
                effect: (level) => `+${level * 5}% quest XP rewards`
            },
            mysteryBox: {
                name: 'Mystery Box',
                description: 'Small chance to get a random bonus item when spinning',
                maxLevel: 15,
                baseCost: 150000,
                costMultiplier: 7,
                effect: (level) => `${level * 2}% chance for bonus item`
            },
            autoFusion: {
                name: 'Auto-Fusion',
                description: 'Automatically fuse 3 items of same rarity',
                maxLevel: 1,
                baseCost: 500000,
                costMultiplier: 1,
                effect: (level) => level > 0 ? 'Auto-fuses items' : 'Not unlocked'
            }
        };
        
        // Item Rarities with 1 in 2^n progression
        const rarities = [
            { name: 'Common', chance: 1/2, color: 'var(--rarity-common)', minValue: 1, maxValue: 5 },
            { name: 'Uncommon', chance: 1/4, color: 'var(--rarity-uncommon)', minValue: 6, maxValue: 15 },
            { name: 'Rare', chance: 1/8, color: 'var(--rarity-rare)', minValue: 16, maxValue: 40 },
            { name: 'Epic', chance: 1/16, color: 'var(--rarity-epic)', minValue: 41, maxValue: 100 },
            { name: 'Legendary', chance: 1/32, color: 'var(--rarity-legendary)', minValue: 101, maxValue: 250 },
            { name: 'Mythic', chance: 1/64, color: 'var(--rarity-mythic)', minValue: 251, maxValue: 650 },
            { name: 'Exotic', chance: 1/128, color: 'var(--rarity-exotic)', minValue: 651, maxValue: 1500 },
            { name: 'Celestial', chance: 1/256, color: 'var(--rarity-celestial)', minValue: 1501, maxValue: 4000 },
            { name: 'Divine', chance: 1/512, color: '#ffd700', minValue: 4001, maxValue: 10000 },
            { name: 'Cosmic', chance: 1/1024, color: '#ff69b4', minValue: 10001, maxValue: 25000 },
            { name: 'Infinite', chance: 1/2048, color: '#ffffff', minValue: 25001, maxValue: 65000 },
            { name: 'Transcendent', chance: 1/4096, color: '#00fff2', minValue: 65001, maxValue: 150000 },
            { name: 'Ethereal', chance: 1/8192, color: '#b19cd9', minValue: 150001, maxValue: 350000 },
            { name: 'Primordial', chance: 1/65536, color: '#ff6b35', minValue: 350001, maxValue: 800000 }, // Made 4x rarer
            { name: 'Omega', chance: 1/262144, color: '#4ecdc4', minValue: 800001, maxValue: 2000000 }, // Made 8x rarer
            { name: 'Supreme', chance: 1/1048576, color: '#ffe66d', minValue: 2000001, maxValue: 5000000 }, // Made 16x rarer
            { name: 'Godlike', chance: 1/4194304, color: '#ff00ff', minValue: 5000001, maxValue: 12000000 }, // Made 32x rarer
            { name: 'Universal', chance: 1/16777216, color: '#00ffaa', minValue: 12000001, maxValue: 30000000 }, // Made 64x rarer
            { name: 'Multiversal', chance: 1/67108864, color: '#ff3399', minValue: 30000001, maxValue: 75000000 }, // Made 128x rarer
            { name: 'Omnipotent', chance: 1/1048576, color: '#ffcc00', minValue: 75000001, maxValue: 200000000 },
            { name: 'Infinite Absolute', chance: 1/2097152, color: '#ff99ff', minValue: 200000001, maxValue: 500000000 },
            { name: 'Eternal', chance: 1/4194304, color: '#66ffff', minValue: 500000001, maxValue: 1000000000 },
            { name: 'Shaw', chance: 0, color: '#ff1493', minValue: 750000001, maxValue: 1750000000 }, // EXCLUSIVE CODE-ONLY - NOT SPINNABLE!
            { name: 'Immortal', chance: 1/8388608, color: '#ffff66', minValue: 1000000001, maxValue: 2500000000 },
            { name: 'Ascended', chance: 1/16777216, color: '#ff6666', minValue: 2500000001, maxValue: 5000000000 },
            { name: 'Transcendental', chance: 1/33554432, color: '#66ff66', minValue: 5000000001, maxValue: 10000000000 },
            { name: 'Boundless', chance: 1/67108864, color: '#6666ff', minValue: 10000000001, maxValue: 25000000000 },
            { name: 'Limitless', chance: 1/134217728, color: '#ff66ff', minValue: 25000000001, maxValue: 50000000000 },
            { name: 'Admin', chance: 1/268435456, color: '#ff0000', minValue: 50000000001, maxValue: 100000000000 }, // EXCLUSIVE - Rarer than Limitless!
            { name: 'Absolute', chance: 1/536870912, color: '#ffffff', minValue: 100000000001, maxValue: 250000000000 },
            { name: 'Beyond', chance: 1/1073741824, color: '#ffaa00', minValue: 250000000001, maxValue: 500000000000 },
            { name: 'Incomprehensible', chance: 1/1073741824, color: '#aa00ff', minValue: 250000000001, maxValue: 500000000000 },
            { name: 'Unimaginable', chance: 1/2147483648, color: '#00aaff', minValue: 500000000001, maxValue: 1000000000000 },
            { name: 'Impossible', chance: 1/4294967296, color: '#ff0066', minValue: 1000000000001, maxValue: 10000000000000 },
            { name: 'Paradox', chance: 1/8589934592, color: '#00ff99', minValue: 10000000000001, maxValue: 50000000000000 },
            { name: 'Singularity', chance: 1/17179869184, color: '#9900ff', minValue: 50000000000001, maxValue: 100000000000000 },
            { name: 'Void', chance: 1/34359738368, color: '#000000', minValue: 100000000000001, maxValue: 500000000000000 },
            { name: 'Nothingness', chance: 1/68719476736, color: '#111111', minValue: 500000000000001, maxValue: 1000000000000000 },
            { name: 'Everything', chance: 1/137438953472, color: '#ffffff', minValue: 1000000000000001, maxValue: 5000000000000000 },
            { name: 'The End', chance: 1/274877906944, color: '#ff0000', minValue: 5000000000000001, maxValue: 10000000000000000 },
            { name: 'The Beginning', chance: 1/549755813888, color: '#00ff00', minValue: 10000000000000001, maxValue: 50000000000000000 },
            { name: 'Alpha Omega', chance: 1/1099511627776, color: '#ffff00', minValue: 50000000000000001, maxValue: 100000000000000000 },
            { name: 'True Infinity', chance: 1/2199023255552, color: '#ff00ff', minValue: 100000000000000001, maxValue: 500000000000000000 },
            { name: 'The One', chance: 1/4398046511104, color: '#ffffff', minValue: 500000000000000001, maxValue: 1000000000000000000 },
            { name: 'Primeval', chance: 1/8796093022208, color: '#8b4513', minValue: 1000000000000000001, maxValue: 5000000000000000000 },
            { name: 'Celestial Prime', chance: 1/17592186044416, color: '#4169e1', minValue: 5000000000000000001, maxValue: 10000000000000000000 },
            { name: 'Quantum', chance: 1/35184372088832, color: '#00ffff', minValue: 10000000000000000001, maxValue: 50000000000000000000 },
            { name: 'Dimensional', chance: 1/70368744177664, color: '#9370db', minValue: 50000000000000000001, maxValue: 100000000000000000000 },
            { name: 'Hyperversal', chance: 1/140737488355328, color: '#ff1493', minValue: 100000000000000000001, maxValue: 500000000000000000000 },
            { name: 'Outerversal', chance: 1/281474976710656, color: '#00ff00', minValue: 500000000000000000001, maxValue: 1000000000000000000000 },
            { name: 'Boundaryless', chance: 1/562949953421312, color: '#ff4500', minValue: 1000000000000000000001, maxValue: 5000000000000000000000 },
            { name: 'Formless', chance: 1/1125899906842624, color: '#a9a9a9', minValue: 5000000000000000000001, maxValue: 10000000000000000000000 },
            { name: 'Abstract', chance: 1/2251799813685248, color: '#dda0dd', minValue: 10000000000000000000001, maxValue: 50000000000000000000000 },
            { name: 'Conceptual', chance: 1/4503599627370496, color: '#7fffd4', minValue: 50000000000000000000001, maxValue: 100000000000000000000000 },
            { name: 'Metaphysical', chance: 1/9007199254740992, color: '#dc143c', minValue: 100000000000000000000001, maxValue: 500000000000000000000000 },
            { name: 'The Source', chance: 1/18014398509481984, color: '#ffd700', minValue: 500000000000000000000001, maxValue: 1000000000000000000000000 },
            { name: 'The Eternal', chance: 1/36028797018963968, color: '#00bfff', minValue: 1000000000000000000000001, maxValue: 5000000000000000000000000 },
            { name: 'The Absolute Infinity', chance: 1/72057594037927936, color: '#ff00ff', minValue: 5000000000000000000000001, maxValue: 10000000000000000000000000 },
            { name: 'Beyond Infinity', chance: 1/144115188075855872, color: '#ffffff', minValue: 10000000000000000000000001, maxValue: 50000000000000000000000000 },
            { name: 'Infinite Beyond', chance: 1/288230376151711744, color: '#00ffff', minValue: 50000000000000000000000001, maxValue: 100000000000000000000000000 },
            { name: 'Transcendent Infinity', chance: 1/576460752303423488, color: '#ff69b4', minValue: 100000000000000000000000001, maxValue: 500000000000000000000000000 },
            { name: 'Omniversal', chance: 1/1152921504606846976, color: '#9400d3', minValue: 500000000000000000000000001, maxValue: 1000000000000000000000000000 },
            { name: 'Absolute Beyond', chance: 1/1000000000000000000000, color: '#ffd700', minValue: 1000000000000000000000000001, maxValue: 5000000000000000000000000000 }, // 1 Sextillion
            { name: 'The Totality', chance: 1/10000000000000000000000, color: '#ff1493', minValue: 5000000000000000000000000001, maxValue: 10000000000000000000000000000 },
            { name: 'The Omnipotent', chance: 1/100000000000000000000000, color: '#00ff00', minValue: 10000000000000000000000000001, maxValue: 50000000000000000000000000000 },
            { name: 'Reality Itself', chance: 1/1000000000000000000000000, color: '#ffffff', minValue: 50000000000000000000000000001, maxValue: 100000000000000000000000000000 } // 1 SEPTILLION!
        ];
        
        // Item name pools by rarity
        const itemNames = {
            'Common': {
                prefixes: ['Rusty', 'Broken', 'Dirty', 'Smelly', 'Bent', 'Cracked', 'Dull', 'Worn', 'Tattered', 'Moldy'],
                items: ['Stick', 'Rock', 'Pebble', 'Twig', 'Leaf', 'Dirt Clump', 'Old Shoe', 'Trash', 'Junk', 'Scrap']
            },
            'Uncommon': {
                prefixes: ['Basic', 'Simple', 'Plain', 'Ordinary', 'Standard', 'Regular', 'Common', 'Typical', 'Normal', 'Average'],
                items: ['Sword', 'Dagger', 'Shield', 'Helmet', 'Boots', 'Gloves', 'Ring', 'Necklace', 'Potion', 'Scroll']
            },
            'Rare': {
                prefixes: ['Polished', 'Sharp', 'Sturdy', 'Fine', 'Quality', 'Steel', 'Iron', 'Silver', 'Reinforced', 'Crafted'],
                items: ['Blade', 'Axe', 'Mace', 'Armor', 'Gauntlets', 'Amulet', 'Gem', 'Tome', 'Elixir', 'Pendant']
            },
            'Epic': {
                prefixes: ['Enchanted', 'Mystic', 'Magical', 'Powerful', 'Superior', 'Enhanced', 'Arcane', 'Blessed', 'Forged', 'Master'],
                items: ['Sword', 'Staff', 'Bow', 'Shield', 'Crown', 'Scepter', 'Orb', 'Crystal', 'Artifact', 'Relic']
            },
            'Legendary': {
                prefixes: ['Ancient', 'Legendary', 'Mythical', 'Blazing', 'Frozen', 'Thunder', 'Shadow', 'Light', 'Dragon', 'Phoenix'],
                items: ['Blade', 'Staff', 'Shield', 'Crown', 'Amulet', 'Ring', 'Orb', 'Gem', 'Rune', 'Sigil']
            },
            'Mythic': {
                prefixes: ['Divine', 'Godly', 'Celestial', 'Ethereal', 'Cosmic', 'Primordial', 'Eternal', 'Immortal', 'Supreme', 'Ultimate'],
                items: ['Sword', 'Staff', 'Crown', 'Throne', 'Scepter', 'Eye', 'Heart', 'Soul', 'Essence', 'Core']
            },
            'Exotic': {
                prefixes: ['Transcendent', 'Omnipotent', 'Infinite', 'Void', 'Astral', 'Quantum', 'Temporal', 'Reality', 'Dimensional', 'Universal'],
                items: ['Weapon', 'Armor', 'Crown', 'Throne', 'Gate', 'Key', 'Fragment', 'Shard', 'Crystal', 'Nexus']
            },
            'Celestial': {
                prefixes: ['Galaxy', 'Nebula', 'Stellar', 'Solar', 'Lunar', 'Supernova', 'Constellation', 'Comet', 'Meteor', 'Aurora'],
                items: ['Crown', 'Throne', 'Scepter', 'Orb', 'Ring', 'Blade', 'Shield', 'Aegis', 'Mantle', 'Regalia']
            },
            'Divine': {
                prefixes: ['Omni', 'Absolute', 'Perfect', 'Sacred', 'Holy', 'Sanctified', 'Consecrated', 'Hallowed', 'Blessed', 'Exalted'],
                items: ['Godhead', 'Divinity', 'Supremacy', 'Sovereignty', 'Dominion', 'Authority', 'Power', 'Glory', 'Majesty', 'Radiance']
            },
            'Cosmic': {
                prefixes: ['Multiverse', 'Omniverse', 'Hyperspace', 'Singularity', 'Infinity', 'Eternity', 'Genesis', 'Apocalypse', 'Alpha', 'Omega'],
                items: ['Construct', 'Entity', 'Phenomenon', 'Anomaly', 'Paradox', 'Singularity', 'Convergence', 'Divergence', 'Matrix', 'Nexus']
            },
            'Infinite': {
                prefixes: ['Boundless', 'Limitless', 'Endless', 'Timeless', 'Formless', 'Nameless', 'Unknowable', 'Incomprehensible', 'Ineffable', 'Absolute'],
                items: ['Existence', 'Concept', 'Idea', 'Dream', 'Truth', 'Reality', 'Universe', 'Everything', 'Nothing', 'All']
            },
            'Transcendent': {
                prefixes: ['Beyond', 'Meta', 'Hyper', 'Ultra', 'Supra', 'Trans', 'Extra', 'Over', 'Super', 'Mega'],
                items: ['Dimension', 'Plane', 'Realm', 'Sphere', 'Domain', 'Territory', 'Space', 'Void', 'Chaos', 'Order']
            },
            'Ethereal': {
                prefixes: ['Spectral', 'Phantom', 'Ghost', 'Spirit', 'Wraith', 'Shade', 'Apparition', 'Vision', 'Mirage', 'Illusion'],
                items: ['Essence', 'Soul', 'Being', 'Entity', 'Presence', 'Force', 'Energy', 'Power', 'Aura', 'Manifestation']
            },
            'Primordial': {
                prefixes: ['Primal', 'Original', 'First', 'Ancient', 'Elder', 'Prehistoric', 'Antediluvian', 'Archaic', 'Primeval', 'Primitive'],
                items: ['Chaos', 'Void', 'Creation', 'Beginning', 'Origin', 'Genesis', 'Source', 'Root', 'Foundation', 'Basis']
            },
            'Omega': {
                prefixes: ['Final', 'Last', 'Ultimate', 'Terminal', 'Conclusive', 'Ending', 'Closing', 'Finishing', 'Concluding', 'Completing'],
                items: ['Judgement', 'Verdict', 'Decree', 'Sentence', 'Destiny', 'Fate', 'End', 'Finale', 'Conclusion', 'Termination']
            },
            'Supreme': {
                prefixes: ['Paramount', 'Preeminent', 'Dominant', 'Sovereign', 'Imperial', 'Regal', 'Royal', 'Majestic', 'Grand', 'Noble'],
                items: ['Authority', 'Command', 'Control', 'Rule', 'Reign', 'Empire', 'Kingdom', 'Dynasty', 'Legacy', 'Heritage']
            },
            'Godlike': {
                prefixes: ['Deific', 'Theistic', 'Apotheosis', 'Ascended', 'Transcended', 'Enlightened', 'Awakened', 'Elevated', 'Exalted', 'Glorified'],
                items: ['Godhood', 'Divinity', 'Deity', 'Immortal', 'Eternal', 'Infinite', 'Perfect', 'Flawless', 'Pure', 'Holy']
            },
            'Universal': {
                prefixes: ['Cosmic', 'Galactic', 'Stellar', 'Planetary', 'Astronomical', 'Celestial', 'Heavenly', 'Astral', 'Spatial', 'Interstellar'],
                items: ['Cosmos', 'Universe', 'Galaxy', 'Nebula', 'Supernova', 'Quasar', 'Pulsar', 'Black Hole', 'Wormhole', 'Singularity']
            },
            'Multiversal': {
                prefixes: ['Parallel', 'Alternate', 'Divergent', 'Branching', 'Split', 'Multiple', 'Infinite', 'Countless', 'Endless', 'Limitless'],
                items: ['Timeline', 'Reality', 'Dimension', 'Universe', 'World', 'Existence', 'Possibility', 'Probability', 'Outcome', 'Future']
            },
            'Omnipotent': {
                prefixes: ['All-Powerful', 'Almighty', 'Supreme', 'Unlimited', 'Unbound', 'Unrestricted', 'Unconstrained', 'Absolute', 'Total', 'Complete'],
                items: ['Power', 'Might', 'Strength', 'Force', 'Energy', 'Potential', 'Capability', 'Capacity', 'Ability', 'Faculty']
            },
            'Absolute': {
                prefixes: ['Pure', 'True', 'Real', 'Genuine', 'Authentic', 'Perfect', 'Ideal', 'Ultimate', 'Final', 'Complete'],
                items: ['Zero', 'One', 'Everything', 'Nothing', 'All', 'None', 'Beginning', 'End', 'Alpha', 'Omega']
            },
            'Beyond': {
                prefixes: ['Post', 'After', 'Outside', 'Past', 'Exceeding', 'Surpassing', 'Transcending', 'Outstripping', 'Eclipsing', 'Outdoing'],
                items: ['Comprehension', 'Understanding', 'Logic', 'Reason', 'Thought', 'Concept', 'Idea', 'Perception', 'Cognition', 'Awareness']
            },
            'Incomprehensible': {
                prefixes: ['Unfathomable', 'Inexplicable', 'Inscrutable', 'Impenetrable', 'Mysterious', 'Cryptic', 'Enigmatic', 'Arcane', 'Esoteric', 'Obscure'],
                items: ['Mystery', 'Enigma', 'Riddle', 'Puzzle', 'Secret', 'Unknown', 'Hidden', 'Veiled', 'Shrouded', 'Occult']
            },
            'Unimaginable': {
                prefixes: ['Inconceivable', 'Unthinkable', 'Incredible', 'Fantastic', 'Miraculous', 'Supernatural', 'Otherworldly', 'Unearthly', 'Preternatural', 'Paranormal'],
                items: ['Wonder', 'Marvel', 'Miracle', 'Phenomenon', 'Spectacle', 'Vision', 'Apparition', 'Manifestation', 'Revelation', 'Epiphany']
            },
            'Impossible': {
                prefixes: ['Never', 'Cannot', 'Non', 'Un', 'Anti', 'Contra', 'Counter', 'Opposite', 'Reverse', 'Inverse'],
                items: ['Existence', 'Reality', 'Truth', 'Fact', 'Actuality', 'Certainty', 'Inevitability', 'Necessity', 'Destiny', 'Fate']
            },
            'Infinite Absolute': {
                prefixes: ['Endless', 'Eternal', 'Perpetual', 'Everlasting', 'Immortal', 'Undying', 'Deathless', 'Ageless', 'Timeless', 'Permanent'],
                items: ['Perfection', 'Flawlessness', 'Excellence', 'Superiority', 'Supremacy', 'Preeminence', 'Dominance', 'Ascendancy', 'Sovereignty', 'Mastery']
            },
            'Eternal': {
                prefixes: ['Forever', 'Always', 'Constantly', 'Continuously', 'Ceaselessly', 'Perpetually', 'Endlessly', 'Infinitely', 'Boundlessly', 'Limitlessly'],
                items: ['Moment', 'Instant', 'Second', 'Eternity', 'Infinity', 'Forever', 'Always', 'Evermore', 'Perpetuity', 'Timelessness']
            },
            'Shaw': {
                prefixes: ['Legendary', 'Epic', 'Mythical', 'Fabled', 'Renowned', 'Celebrated', 'Illustrious', 'Distinguished', 'Prestigious', 'Glorious'],
                items: ['Legacy', 'Heritage', 'Dynasty', 'Legend', 'Myth', 'Tale', 'Story', 'Chronicle', 'Saga', 'Epic']
            },
            'Immortal': {
                prefixes: ['Undead', 'Undying', 'Deathless', 'Imperishable', 'Indestructible', 'Invincible', 'Unconquerable', 'Invulnerable', 'Impregnable', 'Unassailable'],
                items: ['Life', 'Soul', 'Spirit', 'Essence', 'Being', 'Entity', 'Creature', 'Organism', 'Individual', 'Person']
            },
            'Ascended': {
                prefixes: ['Risen', 'Elevated', 'Uplifted', 'Exalted', 'Glorified', 'Ennobled', 'Dignified', 'Honored', 'Revered', 'Venerated'],
                items: ['Master', 'Lord', 'King', 'Emperor', 'Ruler', 'Sovereign', 'Monarch', 'Potentate', 'Overlord', 'Supreme']
            },
            'Transcendental': {
                prefixes: ['Sublime', 'Magnificent', 'Majestic', 'Grand', 'Glorious', 'Splendid', 'Resplendent', 'Radiant', 'Brilliant', 'Luminous'],
                items: ['Beauty', 'Grace', 'Elegance', 'Refinement', 'Sophistication', 'Poise', 'Dignity', 'Nobility', 'Majesty', 'Grandeur']
            },
            'Boundless': {
                prefixes: ['Infinite', 'Unlimited', 'Unrestricted', 'Unconfined', 'Unbounded', 'Unconstrained', 'Unfettered', 'Unhampered', 'Unhindered', 'Unimpeded'],
                items: ['Freedom', 'Liberty', 'Independence', 'Autonomy', 'Sovereignty', 'Self-rule', 'Self-governance', 'Self-determination', 'Free-will', 'Choice']
            },
            'Limitless': {
                prefixes: ['Measureless', 'Immeasurable', 'Incalculable', 'Innumerable', 'Countless', 'Numberless', 'Untold', 'Infinite', 'Endless', 'Boundless'],
                items: ['Potential', 'Possibility', 'Capability', 'Capacity', 'Power', 'Strength', 'Might', 'Force', 'Energy', 'Vigor']
            },
            'Admin': {
                prefixes: ['Forbidden', 'Restricted', 'Classified', 'Privileged', 'Exclusive', 'Hidden', 'Secret', 'Banned', 'Prohibited', 'Omnipotent'],
                items: ['Command', 'Override', 'Authority', 'Control', 'Privilege', 'Access', 'Permission', 'Power', 'Console', 'Root']
            },
            'Paradox': {
                prefixes: ['Self-Contradicting', 'Illogical', 'Absurd', 'Contradictory', 'Inconsistent', 'Conflicting', 'Opposing', 'Clashing', 'Incompatible', 'Irreconcilable'],
                items: ['Statement', 'Truth', 'Lie', 'Question', 'Answer', 'Problem', 'Solution', 'Cause', 'Effect', 'Loop']
            },
            'Singularity': {
                prefixes: ['Unique', 'One', 'Sole', 'Single', 'Only', 'Lone', 'Solitary', 'Individual', 'Distinct', 'Separate'],
                items: ['Point', 'Moment', 'Event', 'Instance', 'Occurrence', 'Happening', 'Phenomenon', 'Incident', 'Episode', 'Case']
            },
            'Void': {
                prefixes: ['Empty', 'Vacant', 'Hollow', 'Bare', 'Blank', 'Barren', 'Desolate', 'Abandoned', 'Forsaken', 'Deserted'],
                items: ['Space', 'Abyss', 'Chasm', 'Pit', 'Hole', 'Gap', 'Cavity', 'Vacuum', 'Emptiness', 'Nothingness']
            },
            'Nothingness': {
                prefixes: ['Absent', 'Missing', 'Gone', 'Lost', 'Vanished', 'Disappeared', 'Dissolved', 'Evaporated', 'Faded', 'Erased'],
                items: ['Void', 'Nil', 'Naught', 'Zero', 'Cipher', 'Nobody', 'Nothing', 'None', 'Not', 'Never']
            },
            'Everything': {
                prefixes: ['All', 'Total', 'Whole', 'Complete', 'Entire', 'Full', 'Absolute', 'Perfect', 'Pure', 'True'],
                items: ['Universe', 'Cosmos', 'Reality', 'Existence', 'Creation', 'World', 'Life', 'Matter', 'Energy', 'Time']
            },
            'The End': {
                prefixes: ['Final', 'Last', 'Ultimate', 'Terminal', 'Concluding', 'Closing', 'Finishing', 'Ending', 'Culminating', 'Completing'],
                items: ['Moment', 'Second', 'Day', 'Hour', 'Year', 'Age', 'Era', 'Epoch', 'Period', 'Time']
            },
            'The Beginning': {
                prefixes: ['First', 'Initial', 'Original', 'Primary', 'Primal', 'Primeval', 'Primordial', 'Ancient', 'Archaic', 'Antique'],
                items: ['Spark', 'Flame', 'Light', 'Dawn', 'Sunrise', 'Genesis', 'Origin', 'Birth', 'Creation', 'Start']
            },
            'Alpha Omega': {
                prefixes: ['First-Last', 'Beginning-End', 'Start-Finish', 'Alpha-Beta', 'Top-Bottom', 'High-Low', 'Left-Right', 'Up-Down', 'In-Out', 'On-Off'],
                items: ['Duality', 'Unity', 'Pair', 'Duo', 'Couple', 'Twin', 'Double', 'Binary', 'Dichotomy', 'Contrast']
            },
            'True Infinity': {
                prefixes: ['Real', 'Genuine', 'Authentic', 'Actual', 'Veritable', 'Legitimate', 'Bona-fide', 'Honest', 'Pure', 'Absolute'],
                items: ['Endlessness', 'Eternity', 'Perpetuity', 'Everlastingness', 'Timelessness', 'Boundlessness', 'Limitlessness', 'Immensity', 'Vastness', 'Infinity']
            },
            'The One': {
                prefixes: ['Only', 'Sole', 'Single', 'Singular', 'Unique', 'Exclusive', 'Individual', 'Particular', 'Specific', 'Distinct'],
                items: ['God', 'Creator', 'Source', 'Origin', 'Beginning', 'Root', 'Foundation', 'Base', 'Core', 'Heart']
            },
            'Primeval': {
                prefixes: ['Ancient', 'Primal', 'Primordial', 'Original', 'First', 'Proto', 'Archaic', 'Prehistoric', 'Antediluvian', 'Ancestral'],
                items: ['Force', 'Power', 'Energy', 'Essence', 'Spirit', 'Will', 'Consciousness', 'Mind', 'Soul', 'Being']
            },
            'Celestial Prime': {
                prefixes: ['Supreme', 'Ultimate', 'Paramount', 'Preeminent', 'Sovereign', 'Principal', 'Chief', 'Foremost', 'Primary', 'Leading'],
                items: ['Star', 'Galaxy', 'Universe', 'Cosmos', 'Constellation', 'Nebula', 'Supernova', 'Quasar', 'Pulsar', 'Void']
            },
            'Quantum': {
                prefixes: ['Subatomic', 'Particle', 'Wave', 'Probability', 'Superposition', 'Entangled', 'Collapsed', 'Uncertain', 'Discrete', 'Planck'],
                items: ['Field', 'State', 'Foam', 'Fluctuation', 'Leap', 'Tunnel', 'Decoherence', 'Spin', 'Charge', 'String']
            },
            'Dimensional': {
                prefixes: ['Multi', 'Extra', 'Higher', 'Parallel', 'Alternate', 'Perpendicular', 'Orthogonal', 'Spatial', 'Temporal', 'Planar'],
                items: ['Dimension', 'Reality', 'Plane', 'Axis', 'Membrane', 'Brane', 'Manifold', 'Space', 'Continuum', 'Fabric']
            },
            'Hyperversal': {
                prefixes: ['Super', 'Meta', 'Ultra', 'Hyper', 'Trans', 'Beyond', 'Above', 'Transcendent', 'Superior', 'Greater'],
                items: ['Realm', 'Domain', 'Sphere', 'Zone', 'Region', 'Territory', 'Province', 'Kingdom', 'Empire', 'Cosmos']
            },
            'Outerversal': {
                prefixes: ['Outer', 'External', 'Outside', 'Beyond', 'Exterior', 'Peripheral', 'Remote', 'Distant', 'Far', 'Edge'],
                items: ['Boundary', 'Limit', 'Border', 'Frontier', 'Threshold', 'Horizon', 'Edge', 'Rim', 'Periphery', 'Margin']
            },
            'Boundaryless': {
                prefixes: ['Unlimited', 'Infinite', 'Endless', 'Limitless', 'Unbounded', 'Measureless', 'Immeasurable', 'Vast', 'Expansive', 'Infinite'],
                items: ['Expanse', 'Vastness', 'Infinity', 'Eternity', 'Forever', 'Always', 'Never-ending', 'Perpetual', 'Everlasting', 'Timeless']
            },
            'Formless': {
                prefixes: ['Shapeless', 'Amorphous', 'Undefined', 'Vague', 'Nebulous', 'Abstract', 'Intangible', 'Incorporeal', 'Immaterial', 'Ethereal'],
                items: ['Void', 'Emptiness', 'Nothingness', 'Absence', 'Negation', 'Non-being', 'Non-existence', 'Nihility', 'Vacuum', 'Null']
            },
            'Abstract': {
                prefixes: ['Conceptual', 'Theoretical', 'Ideal', 'Pure', 'Platonic', 'Universal', 'General', 'Non-concrete', 'Mental', 'Intellectual'],
                items: ['Concept', 'Idea', 'Notion', 'Thought', 'Theory', 'Principle', 'Law', 'Truth', 'Form', 'Essence']
            },
            'Conceptual': {
                prefixes: ['Fundamental', 'Essential', 'Basic', 'Elementary', 'Primary', 'Core', 'Central', 'Key', 'Crucial', 'Vital'],
                items: ['Framework', 'Structure', 'System', 'Model', 'Pattern', 'Design', 'Scheme', 'Plan', 'Blueprint', 'Template']
            },
            'Metaphysical': {
                prefixes: ['Ontological', 'Existential', 'Phenomenal', 'Noumenal', 'Transcendental', 'A-priori', 'Absolute', 'Necessary', 'Contingent', 'Essential'],
                items: ['Being', 'Existence', 'Reality', 'Actuality', 'Substance', 'Essence', 'Nature', 'Property', 'Quality', 'Attribute']
            },
            'The Source': {
                prefixes: ['Originating', 'Generative', 'Creative', 'Productive', 'Fertile', 'Fruitful', 'Prolific', 'Causative', 'Formative', 'Constitutive'],
                items: ['Wellspring', 'Fountain', 'Spring', 'Origin', 'Genesis', 'Beginning', 'Start', 'Commencement', 'Inception', 'Birth']
            },
            'The Eternal': {
                prefixes: ['Everlasting', 'Immortal', 'Undying', 'Deathless', 'Imperishable', 'Indestructible', 'Permanent', 'Lasting', 'Enduring', 'Perpetual'],
                items: ['Cycle', 'Return', 'Recurrence', 'Repetition', 'Loop', 'Circle', 'Wheel', 'Spiral', 'Helix', 'Vortex']
            },
            'The Absolute Infinity': {
                prefixes: ['Total', 'Complete', 'Whole', 'Entire', 'Full', 'Perfect', 'Pure', 'Sheer', 'Utter', 'Absolute'],
                items: ['Aleph', 'Omega-plus', 'Cardinality', 'Ordinal', 'Transfinite', 'Inaccessible', 'Mahlo', 'Measurable', 'Worldly', 'Ineffable']
            },
            'Beyond Infinity': {
                prefixes: ['Post', 'After', 'Past', 'Over', 'Above', 'Supra', 'Super', 'Hyper', 'Ultra', 'Transcending'],
                items: ['Limit', 'Bound', 'End', 'Terminus', 'Finality', 'Conclusion', 'Completion', 'Culmination', 'Apex', 'Zenith']
            }
        };
        
        // Weather Event Items
        const weatherItems = {
            cloudy: [
                { name: '☁️ Cloud Fragment', rarity: 'Rare' },
                { name: '☁️ Misty Essence', rarity: 'Epic' },
                { name: '☁️ Sky Vapor', rarity: 'Legendary' },
                { name: '☁️ Cumulus Crown', rarity: 'Mythic' },
                { name: '☁️ Nimbus Core', rarity: 'Exotic' },
                { name: '☁️ Stratosphere Soul', rarity: 'Celestial' }
            ],
            rainy: [
                { name: '🌧️ Raindrop Crystal', rarity: 'Rare' },
                { name: '🌧️ Storm Tear', rarity: 'Epic' },
                { name: '🌧️ Aqua Prism', rarity: 'Legendary' },
                { name: '🌧️ Deluge Diamond', rarity: 'Mythic' },
                { name: '🌧️ Monsoon Heart', rarity: 'Exotic' },
                { name: '🌧️ Typhoon Spirit', rarity: 'Celestial' }
            ],
            storming: [
                { name: '⛈️ Lightning Shard', rarity: 'Epic' },
                { name: '⛈️ Thunder Stone', rarity: 'Legendary' },
                { name: '⛈️ Storm Bolt', rarity: 'Mythic' },
                { name: '⛈️ Tempest Core', rarity: 'Exotic' },
                { name: '⛈️ Hurricane Eye', rarity: 'Celestial' },
                { name: '⛈️ Cataclysm Crown', rarity: 'Divine' }
            ]
        };
        
        // Christmas Items
        const christmasItems = [
            { name: '🎅 Santa Hat', rarity: 'Legendary' },
            { name: '🎄 Christmas Tree', rarity: 'Epic' },
            { name: '⛄ Snowman', rarity: 'Rare' },
            { name: '🎁 Gift Box', rarity: 'Uncommon' },
            { name: '❄️ Snowflake', rarity: 'Common' },
            { name: '🔔 Jingle Bell', rarity: 'Rare' },
            { name: '🦌 Reindeer', rarity: 'Mythic' }
        ];
        
        // Disco Event Items
        const discoItems = [
            { name: '🪩 Disco Ball', rarity: 'Epic' },
            { name: '🕺 Groove Shoes', rarity: 'Legendary' },
            { name: '💃 Dance Floor Tile', rarity: 'Rare' },
            { name: '🎵 Funky Beat', rarity: 'Mythic' },
            { name: '✨ Glitter Bomb', rarity: 'Exotic' },
            { name: '🎶 Rhythm Soul', rarity: 'Celestial' },
            { name: '🎤 Mic Drop', rarity: 'Divine' },
            { name: '🎸 Funk Guitar', rarity: 'Cosmic' },
            { name: '🎹 Synth Wave', rarity: 'Infinite' },
            { name: '🕶️ Cool Shades', rarity: 'Legendary' }
        ];
        
        // Galactic Event Items
        const galacticItems = [
            { name: '🌌 Nebula Fragment', rarity: 'Legendary' },
            { name: '⭐ Star Dust', rarity: 'Mythic' },
            { name: '🌠 Comet Tail', rarity: 'Exotic' },
            { name: '🪐 Planet Core', rarity: 'Celestial' },
            { name: '🌟 Supernova Spark', rarity: 'Divine' },
            { name: '🔭 Galaxy Eye', rarity: 'Cosmic' },
            { name: '🛸 UFO Wreckage', rarity: 'Infinite' },
            { name: '👽 Alien Tech', rarity: 'Transcendent' },
            { name: '🌍 Earth Shard', rarity: 'Ethereal' },
            { name: '🚀 Rocket Fuel', rarity: 'Mythic' }
        ];
        
        // Glitch Event Items
        const glitchItems = [
            { name: '⚡ Error Code', rarity: 'Epic' },
            { name: '🔲 Corrupted Pixel', rarity: 'Legendary' },
            { name: '📟 Digital Anomaly', rarity: 'Mythic' },
            { name: '💾 Data Fragment', rarity: 'Exotic' },
            { name: '🖥️ System Break', rarity: 'Celestial' },
            { name: '⌨️ Reality Bug', rarity: 'Divine' },
            { name: '💿 Corrupted Disc', rarity: 'Cosmic' },
            { name: '🔌 Power Surge', rarity: 'Infinite' },
            { name: '📱 Phone Glitch', rarity: 'Transcendent' },
            { name: '🎮 Game Crash', rarity: 'Mythic' }
        ];
        
        // Full Moon Event Items
        const fullMoonItems = [
            { name: '🌕 Moonstone', rarity: 'Legendary' },
            { name: '🐺 Lunar Howl', rarity: 'Mythic' },
            { name: '🌙 Silver Beam', rarity: 'Exotic' },
            { name: '✨ Moon Dust', rarity: 'Celestial' },
            { name: '🌛 Crescent Blade', rarity: 'Divine' },
            { name: '🔮 Lunar Oracle', rarity: 'Cosmic' },
            { name: '🦇 Night Wing', rarity: 'Infinite' },
            { name: '🌜 Dark Side Shard', rarity: 'Transcendent' },
            { name: '⭐ Starlight Tear', rarity: 'Ethereal' },
            { name: '🌠 Meteor Piece', rarity: 'Legendary' }
        ];
        
        // Blood Moon Event Items
        const bloodMoonItems = [
            { name: '🔴 Crimson Orb', rarity: 'Mythic' },
            { name: '🩸 Blood Crystal', rarity: 'Exotic' },
            { name: '🌑 Eclipse Shard', rarity: 'Celestial' },
            { name: '⚔️ Scarlet Blade', rarity: 'Divine' },
            { name: '💀 Cursed Relic', rarity: 'Cosmic' },
            { name: '👁️ Crimson Eye', rarity: 'Infinite' },
            { name: '🗡️ Blood Sword', rarity: 'Transcendent' },
            { name: '🔥 Flame of Darkness', rarity: 'Ethereal' },
            { name: '⚰️ Death Box', rarity: 'Primordial' },
            { name: '👹 Demon Mask', rarity: 'Divine' }
        ];
        
        // Nuclear Event Items (NEW!)
        const nuclearItems = [
            { name: '☢️ Radioactive Core', rarity: 'Cosmic' },
            { name: '⚛️ Atom Split', rarity: 'Divine' },
            { name: '💥 Nuclear Blast', rarity: 'Infinite' },
            { name: '🧪 Unstable Isotope', rarity: 'Transcendent' },
            { name: '☣️ Hazmat Suit', rarity: 'Ethereal' },
            { name: '⚡ Fusion Reactor', rarity: 'Primordial' },
            { name: '💡 Glowing Waste', rarity: 'Mythic' },
            { name: '🔬 Lab Accident', rarity: 'Exotic' },
            { name: '🌡️ Geiger Counter', rarity: 'Legendary' },
            { name: '💚 Toxic Glow', rarity: 'Celestial' }
        ];
        
        // Volcanic Event Items (NEW!)
        const volcanicItems = [
            { name: '🌋 Lava Core', rarity: 'Divine' },
            { name: '🔥 Magma Heart', rarity: 'Cosmic' },
            { name: '💎 Volcanic Diamond', rarity: 'Infinite' },
            { name: '🪨 Obsidian Shard', rarity: 'Transcendent' },
            { name: '🌡️ Heat Wave', rarity: 'Ethereal' },
            { name: '⛰️ Mountain Peak', rarity: 'Primordial' },
            { name: '💨 Ash Cloud', rarity: 'Mythic' },
            { name: '🔶 Amber Stone', rarity: 'Exotic' },
            { name: '🏔️ Crater Fragment', rarity: 'Legendary' },
            { name: '🌪️ Eruption Force', rarity: 'Celestial' }
        ];
        
        // Golden Rain Event Items (NEW!)
        const goldenRainItems = [
            { name: '💰 Gold Bar', rarity: 'Infinite' },
            { name: '💎 Diamond Rain', rarity: 'Transcendent' },
            { name: '👑 Royal Crown', rarity: 'Ethereal' },
            { name: '🏆 Trophy Drop', rarity: 'Primordial' },
            { name: '💳 Golden Card', rarity: 'Omega' },
            { name: '💵 Money Storm', rarity: 'Supreme' },
            { name: '🪙 Ancient Coin', rarity: 'Godlike' },
            { name: '💸 Cash Rain', rarity: 'Divine' },
            { name: '✨ Golden Spark', rarity: 'Cosmic' },
            { name: '🌟 Treasure Chest', rarity: 'Mythic' }
        ];
        
        // NPC Types
        const npcTypes = ['honest', 'fair', 'scammer'];
        const npcNames = ['Bob', 'Alice', 'Charlie', 'Diana', 'Eve', 'Frank', 'Grace', 'Henry', 'Ivy', 'Jack', 
                          'Karma', 'Luna', 'Max', 'Nova', 'Oscar', 'Penny', 'Quinn', 'Ruby', 'Sam', 'Tina'];
        
        // Crafting Recipes
        const recipes = [
            { name: 'Steel Sword', requires: { 'Common': 10 }, result: 'Uncommon', value: 12 },
            { name: 'Magic Staff', requires: { 'Uncommon': 8 }, result: 'Rare', value: 30 },
            { name: 'Dragon Scale', requires: { 'Rare': 7 }, result: 'Epic', value: 80 },
            { name: 'Phoenix Feather', requires: { 'Epic': 6 }, result: 'Legendary', value: 200 },
            { name: 'Void Crystal', requires: { 'Legendary': 5 }, result: 'Mythic', value: 500 },
            { name: 'Stardust Shard', requires: { 'Mythic': 5 }, result: 'Exotic', value: 1200 },
            { name: 'Celestial Fragment', requires: { 'Exotic': 4 }, result: 'Celestial', value: 3000 },
            { name: 'Divine Essence', requires: { 'Celestial': 4 }, result: 'Divine', value: 8000 },
            { name: 'Cosmic Dust', requires: { 'Divine': 4 }, result: 'Cosmic', value: 20000 },
            { name: 'Infinite Loop', requires: { 'Cosmic': 3 }, result: 'Infinite', value: 50000 },
            { name: 'Transcendence Core', requires: { 'Infinite': 3 }, result: 'Transcendent', value: 120000 },
            { name: 'Ethereal Wisp', requires: { 'Transcendent': 3 }, result: 'Ethereal', value: 280000 },
            { name: 'Primordial Spark', requires: { 'Ethereal': 3 }, result: 'Primordial', value: 650000 },
            { name: 'Omega Sigil', requires: { 'Primordial': 3 }, result: 'Omega', value: 1500000 },
            { name: 'Supreme Authority', requires: { 'Omega': 3 }, result: 'Supreme', value: 3800000 },
            { name: 'Godly Pinnacle', requires: { 'Supreme': 3 }, result: 'Godlike', value: 9500000 },
            { name: 'Universal Key', requires: { 'Godlike': 3 }, result: 'Universal', value: 23000000 },
            { name: 'Multiversal Gate', requires: { 'Universal': 3 }, result: 'Multiversal', value: 55000000 },
            { name: 'Omnipotent Crown', requires: { 'Multiversal': 4 }, result: 'Omnipotent', value: 135000000 },
            { name: 'Absolute Perfection', requires: { 'Omnipotent': 5 }, result: 'Absolute', value: 75000000000 },
            { name: 'Beyond Comprehension', requires: { 'Absolute': 4 }, result: 'Beyond', value: 180000000000 },
            { name: 'Incomprehensible Core', requires: { 'Beyond': 4 }, result: 'Incomprehensible', value: 400000000000 },
            { name: 'Unimaginable Essence', requires: { 'Incomprehensible': 4 }, result: 'Unimaginable', value: 800000000000 },
            { name: 'Impossible Artifact', requires: { 'Unimaginable': 5 }, result: 'Impossible', value: 8000000000000 }
        ];
        
        // Achievements
        const achievements = [
            { id: 'first_spin', name: 'First Spin', desc: 'Spin your first item', reward: 'Lucky Charm (+0.1 Luck)', check: () => gameState.totalSpins >= 1 },
            { id: 'spin_master', name: 'Spin Master', desc: 'Spin 100 items', reward: 'Spin Token (+0.2 Luck)', check: () => gameState.totalSpins >= 100 },
            { id: 'spin_legend', name: 'Spin Legend', desc: 'Spin 1,000 items', reward: 'Legendary Spinner (+0.5 Luck)', check: () => gameState.totalSpins >= 1000 },
            { id: 'spin_god', name: 'Spin God', desc: 'Spin 10,000 items', reward: 'Divine Spinner (+1.0 Luck)', check: () => gameState.totalSpins >= 10000 },
            { id: 'spin_master_100k', name: 'Spin Mastery', desc: 'Spin 100,000 items', reward: 'Ultimate Spinner (+2.0 Luck)', check: () => gameState.totalSpins >= 100000 },
            { id: 'millionaire', name: 'Millionaire', desc: 'Reach $1,000,000 total value', reward: 'Golden Crown', check: () => gameState.totalValue >= 1000000 },
            { id: 'multi_millionaire', name: 'Multi-Millionaire', desc: 'Reach $10,000,000 total value', reward: 'Diamond Crown', check: () => gameState.totalValue >= 10000000 },
            { id: 'mega_rich', name: 'Mega Rich', desc: 'Reach $100,000,000 total value', reward: 'Cosmic Crown', check: () => gameState.totalValue >= 100000000 },
            { id: 'ultra_rich', name: 'Ultra Rich', desc: 'Reach $1,000,000,000 total value', reward: 'Absolute Crown', check: () => gameState.totalValue >= 1000000000 },
            { id: 'legendary_pull', name: 'Legendary Pull', desc: 'Get a Legendary item', reward: 'Rare Spin Boost', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'Legendary') },
            { id: 'mythic_pull', name: 'Mythic Hunter', desc: 'Get a Mythic item', reward: 'Mythic Aura', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'Mythic') },
            { id: 'exotic_pull', name: 'Exotic Collector', desc: 'Get an Exotic item', reward: 'Exotic Badge', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'Exotic') },
            { id: 'divine_pull', name: 'Divine Blessing', desc: 'Get a Divine item', reward: 'Divine Halo', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'Divine') },
            { id: 'infinite_pull', name: 'Infinite Luck', desc: 'Get an Infinite item', reward: 'Infinite Power', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'Infinite') },
            { id: 'absolute_pull', name: 'Absolute Master', desc: 'Get an Absolute item', reward: 'Absolute Authority', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'Absolute') },
            { id: 'trade_king', name: 'Trade King', desc: 'Win 50 trades', reward: 'Trader Badge', check: () => gameState.tradeWins >= 50 },
            { id: 'trade_emperor', name: 'Trade Emperor', desc: 'Win 500 trades', reward: 'Emperor Medal', check: () => gameState.tradeWins >= 500 },
            { id: 'trade_god', name: 'Trade God', desc: 'Win 5,000 trades', reward: 'Trade Master', check: () => gameState.tradeWins >= 5000 },
            { id: 'scammed', name: 'Getting Scammed', desc: 'Lose 100 trades', reward: 'Cautious Trader', check: () => gameState.tradeLosses >= 100 },
            { id: 'crafter', name: 'Master Crafter', desc: 'Craft 10 items', reward: 'Crafting Kit', check: () => gameState.craftCount >= 10 },
            { id: 'crafter_expert', name: 'Crafting Expert', desc: 'Craft 100 items', reward: 'Expert Kit', check: () => gameState.craftCount >= 100 },
            { id: 'enchanter', name: 'Enchantment Expert', desc: 'Successfully enchant 20 items', reward: 'Enchanter Robe', check: () => gameState.enchantSuccess >= 20 },
            { id: 'enchanter_master', name: 'Enchantment Master', desc: 'Successfully enchant 100 items', reward: 'Master Robe', check: () => gameState.enchantSuccess >= 100 },
            { id: 'failed_enchants', name: 'Destruction Expert', desc: 'Fail 50 enchantments', reward: 'Phoenix Charm', check: () => gameState.enchantFails >= 50 },
            { id: 'collector', name: 'Item Collector', desc: 'Have 50 different items', reward: 'Collector Badge', check: () => Object.keys(gameState.inventory).filter(k => gameState.inventory[k].count > 0).length >= 50 },
            { id: 'collector_master', name: 'Master Collector', desc: 'Have 100 different items', reward: 'Master Badge', check: () => Object.keys(gameState.inventory).filter(k => gameState.inventory[k].count > 0).length >= 100 },
            { id: 'hoarder', name: 'Hoarder', desc: 'Have 1,000 total items', reward: 'Storage Expansion', check: () => Object.values(gameState.inventory).reduce((sum, item) => sum + item.count, 0) >= 1000 },
            { id: 'rich_trader', name: 'Rich Trader', desc: 'Have $100,000 in cash', reward: 'Cash King Title', check: () => gameState.money >= 100000 },
            { id: 'cash_king', name: 'Cash King', desc: 'Have $1,000,000 in cash', reward: 'Golden Wallet', check: () => gameState.money >= 1000000 },
            { id: 'battle_pass_hero', name: 'Battle Pass Hero', desc: 'Reach Battle Pass Tier 15', reward: 'Hero Badge', check: () => gameState.battlePassTier >= 15 },
            { id: 'battle_pass_master', name: 'Battle Pass Master', desc: 'Complete Battle Pass (Tier 25)', reward: 'Master Crown', check: () => gameState.battlePassTier >= 25 },
            { id: 'christmas_spirit', name: 'Christmas Spirit', desc: 'Get 10 Christmas items', reward: 'Santa Hat', check: () => Object.keys(gameState.inventory).filter(k => k.includes('🎅') || k.includes('🎄') || k.includes('⛄') || k.includes('🎁')).length >= 10 },
            { id: 'upgraded', name: 'Upgraded', desc: 'Buy any upgrade', reward: 'Upgrade Token', check: () => Object.values(gameState.upgrades).some(v => v > 0) },
            { id: 'fully_upgraded', name: 'Fully Upgraded', desc: 'Max out any upgrade', reward: 'Max Token', check: () => Object.entries(gameState.upgrades).some(([key, val]) => val >= upgradeData[key].maxLevel) },
            { id: 'first_rebirth', name: 'Reborn', desc: 'Complete your first rebirth', reward: 'Rebirth Crown', check: () => gameState.rebirths >= 1 },
            { id: 'rebirth_5', name: 'Serial Rebirther', desc: 'Complete 5 rebirths', reward: 'Eternal Crown', check: () => gameState.rebirths >= 5 },
            { id: 'rebirth_10', name: 'Rebirth Master', desc: 'Complete 10 rebirths', reward: 'Infinite Rebirth', check: () => gameState.rebirths >= 10 },
            { id: 'paradox_pull', name: 'Paradoxical', desc: 'Get a Paradox item', reward: 'Reality Breaker', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'Paradox') },
            { id: 'singularity_pull', name: 'Singularity Hunter', desc: 'Get a Singularity item', reward: 'Black Hole Core', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'Singularity') },
            { id: 'void_pull', name: 'Void Walker', desc: 'Get a Void item', reward: 'Void Cloak', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'Void') },
            { id: 'everything_pull', name: 'Universe Creator', desc: 'Get an Everything item', reward: 'Creation Power', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'Everything') },
            { id: 'theone_pull', name: 'THE ONE', desc: 'Get The One item', reward: 'EXISTENCE ITSELF', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'The One') },
            { id: 'quantum_pull', name: 'Quantum Collector', desc: 'Get a Quantum item', reward: 'Quantum Mastery', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'Quantum') },
            { id: 'hyperversal_pull', name: 'Hyperversal Explorer', desc: 'Get a Hyperversal item', reward: 'Reality Shifter', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'Hyperversal') },
            { id: 'abstract_pull', name: 'Conceptual Being', desc: 'Get an Abstract or Conceptual item', reward: 'Pure Thought', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && (item.rarity === 'Abstract' || item.rarity === 'Conceptual')) },
            { id: 'source_pull', name: 'Source Finder', desc: 'Get The Source item', reward: 'Origin Power', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'The Source') },
            { id: 'beyond_infinity_pull', name: 'BEYOND ALL', desc: 'Get Beyond Infinity item', reward: 'TRANSCENDENCE', check: () => Object.values(gameState.inventory).some(item => item.count > 0 && item.rarity === 'Beyond Infinity') },
            { id: 'ultra_rich', name: 'Quadrillionaire', desc: 'Reach $1 Quadrillion total value', reward: 'Ultimate Wealth', check: () => gameState.totalValue >= 1000000000000000 },
            { id: 'quest_master', name: 'Quest Master', desc: 'Complete 10 quests', reward: 'Quest Master Badge', check: () => gameState.questsCompleted >= 10 },
            { id: 'quest_legend', name: 'Quest Legend', desc: 'Complete 50 quests', reward: 'Quest Legend Crown', check: () => gameState.questsCompleted >= 50 },
            { id: 'daily_grinder', name: 'Daily Grinder', desc: 'Complete 5 daily quests in a row', reward: 'Dedication Medal', check: () => gameState.dailyStreak >= 5 },
            { id: 'weekly_warrior', name: 'Weekly Warrior', desc: 'Complete 10 weekly quests', reward: 'Warrior Badge', check: () => gameState.weeklyQuestsCompleted >= 10 },
            { id: 'enchant_god', name: 'Enchantment God', desc: 'Successfully enchant 500 items', reward: 'God Robe', check: () => gameState.enchantSuccess >= 500 },
            { id: 'shop_addict', name: 'Shop Addict', desc: 'Buy 100 items from shop', reward: 'VIP Card', check: () => gameState.shopPurchases >= 100 },
            { id: 'weather_chaser', name: 'Weather Chaser', desc: 'Collect 25 weather event items', reward: 'Storm Chaser Badge', check: () => Object.keys(gameState.inventory).filter(k => k.includes('☁️') || k.includes('🌧️') || k.includes('⛈️')).length >= 25 },
            { id: 'lucky_devil', name: 'Lucky Devil', desc: 'Reach 10x luck multiplier', reward: 'Devil Horns', check: () => (gameState.luckMultiplier * gameState.permanentLuckBoost) >= 10 },
            { id: 'spin_addict', name: 'Spin Addict', desc: 'Spin 1,000,000 items', reward: 'Addiction Crown', check: () => gameState.totalSpins >= 1000000 },
            { id: 'trade_tycoon', name: 'Trade Tycoon', desc: 'Win 10,000 trades', reward: 'Tycoon Medal', check: () => gameState.tradeWins >= 10000 },
            { id: 'mega_crafter', name: 'Mega Crafter', desc: 'Craft 1,000 items', reward: 'Mega Kit', check: () => gameState.craftCount >= 1000 },
            { id: 'rebirth_legend', name: 'Rebirth Legend', desc: 'Complete 25 rebirths', reward: 'Legend Status', check: () => gameState.rebirths >= 25 },
            { id: 'rebirth_god', name: 'Rebirth God', desc: 'Complete 50 rebirths', reward: 'God Status', check: () => gameState.rebirths >= 50 },
            { id: 'ultimate_collector', name: 'Ultimate Collector', desc: 'Have 250 different items', reward: 'Ultimate Badge', check: () => Object.keys(gameState.inventory).filter(k => gameState.inventory[k].count > 0).length >= 250 },
            { id: 'disco_fever', name: 'Disco Fever', desc: 'Collect 10 Disco items', reward: 'Disco King', check: () => Object.keys(gameState.inventory).filter(k => k.includes('🪩') || k.includes('🕺') || k.includes('💃')).length >= 10 },
            { id: 'galactic_explorer', name: 'Galactic Explorer', desc: 'Collect 10 Galactic items', reward: 'Space Badge', check: () => Object.keys(gameState.inventory).filter(k => k.includes('🌌') || k.includes('⭐') || k.includes('🌠')).length >= 10 },
            { id: 'glitch_master', name: 'Glitch Master', desc: 'Collect 10 Glitch items', reward: 'Digital Crown', check: () => Object.keys(gameState.inventory).filter(k => k.includes('⚡') || k.includes('🔲') || k.includes('📟')).length >= 10 },
            { id: 'lunar_collector', name: 'Lunar Collector', desc: 'Collect 10 Full Moon items', reward: 'Moon Crown', check: () => Object.keys(gameState.inventory).filter(k => k.includes('🌕') || k.includes('🐺') || k.includes('🌙')).length >= 10 },
            { id: 'blood_hunter', name: 'Blood Hunter', desc: 'Collect 10 Blood Moon items', reward: 'Crimson Crown', check: () => Object.keys(gameState.inventory).filter(k => k.includes('🔴') || k.includes('🩸') || k.includes('🌑')).length >= 10 },
            { id: 'event_master', name: 'Event Master', desc: 'Collect items from all 5 special events', reward: 'Event King', check: () => {
                const hasDisco = Object.keys(gameState.inventory).some(k => k.includes('🪩'));
                const hasGalactic = Object.keys(gameState.inventory).some(k => k.includes('🌌'));
                const hasGlitch = Object.keys(gameState.inventory).some(k => k.includes('⚡') && (k.includes('Error') || k.includes('Pixel')));
                const hasMoon = Object.keys(gameState.inventory).some(k => k.includes('🌕'));
                const hasBlood = Object.keys(gameState.inventory).some(k => k.includes('🔴') && (k.includes('Crimson') || k.includes('Blood')));
                return hasDisco && hasGalactic && hasGlitch && hasMoon && hasBlood;
            } },
            { id: 'upgrade_addict', name: 'Upgrade Addict', desc: 'Max out 5 different upgrades', reward: 'Master Upgrader', check: () => Object.entries(gameState.upgrades).filter(([key, val]) => upgradeData[key] && val >= upgradeData[key].maxLevel).length >= 5 },
            { id: 'upgrade_legend', name: 'Upgrade Legend', desc: 'Max out 10 different upgrades', reward: 'Legendary Upgrader', check: () => Object.entries(gameState.upgrades).filter(([key, val]) => upgradeData[key] && val >= upgradeData[key].maxLevel).length >= 10 },
            { id: 'billionaire', name: 'Billionaire', desc: 'Have $1,000,000,000 in cash', reward: 'Billion Badge', check: () => gameState.money >= 1000000000 },
            { id: 'trillionaire', name: 'Trillionaire', desc: 'Have $1,000,000,000,000 in cash', reward: 'Trillion Badge', check: () => gameState.money >= 1000000000000 },
            { id: 'quest_god', name: 'Quest God', desc: 'Complete 100 quests', reward: 'Quest Deity', check: () => gameState.questsCompleted >= 100 },
            { id: 'perfect_streak', name: 'Perfect Streak', desc: 'Maintain 10 day daily quest streak', reward: 'Streak Master', check: () => gameState.dailyStreak >= 10 },
            { id: 'shop_whale', name: 'Shop Whale', desc: 'Buy 500 items from shop', reward: 'Platinum Card', check: () => gameState.shopPurchases >= 500 },
            { id: 'mega_hoarder', name: 'Mega Hoarder', desc: 'Have 10,000 total items', reward: 'Warehouse King', check: () => Object.values(gameState.inventory).reduce((sum, item) => sum + item.count, 0) >= 10000 },
            { id: 'trade_master_ultimate', name: 'Ultimate Trade Master', desc: 'Win 25,000 trades', reward: 'Trade Deity', check: () => gameState.tradeWins >= 25000 },
            { id: 'craft_deity', name: 'Crafting Deity', desc: 'Craft 5,000 items', reward: 'Divine Crafting Kit', check: () => gameState.craftCount >= 5000 },
            { id: 'enchant_deity', name: 'Enchantment Deity', desc: 'Successfully enchant 1,000 items', reward: 'Divine Robe', check: () => gameState.enchantSuccess >= 1000 },
            { id: 'super_lucky', name: 'Super Lucky', desc: 'Reach 25x luck multiplier', reward: 'Luck God', check: () => (gameState.luckMultiplier * gameState.permanentLuckBoost) >= 25 },
            { id: 'mega_spinner', name: 'Mega Spinner', desc: 'Spin 10,000,000 items', reward: 'Spinner Deity', check: () => gameState.totalSpins >= 10000000 },
            { id: 'quintillionaire', name: 'Quintillionaire', desc: 'Reach $1 Quintillion total value', reward: 'Ultimate Fortune', check: () => gameState.totalValue >= 1000000000000000000 },
            { id: 'collection_master', name: 'Collection Master', desc: 'Have 500 different items', reward: 'Master Collection Badge', check: () => Object.keys(gameState.inventory).filter(k => gameState.inventory[k].count > 0).length >= 500 },
            // Fusion Achievements
            { id: 'first_fusion', name: 'First Fusion', desc: 'Fuse your first item', reward: 'Alchemist Badge', check: () => gameState.fusionCount >= 1 },
            { id: 'fusion_adept', name: 'Fusion Adept', desc: 'Fuse 25 items', reward: 'Fusion Master', check: () => gameState.fusionCount >= 25 },
            { id: 'fusion_master', name: 'Fusion Master', desc: 'Fuse 100 items', reward: 'Grand Alchemist', check: () => gameState.fusionCount >= 100 },
            { id: 'fusion_legend', name: 'Fusion Legend', desc: 'Fuse 500 items', reward: 'Legendary Alchemist', check: () => gameState.fusionCount >= 500 },
            // Pity System Achievements
            { id: 'pity_triggered', name: 'Pity Party', desc: 'Trigger pity system for the first time', reward: 'Lucky Charm', check: () => gameState.pityTriggered >= 1 },
            { id: 'pity_master', name: 'Pity Master', desc: 'Trigger pity system 10 times', reward: 'Pity Crown', check: () => gameState.pityTriggered >= 10 },
            { id: 'pity_god', name: 'Pity God', desc: 'Trigger pity system 50 times', reward: 'Divine Pity', check: () => gameState.pityTriggered >= 50 },
            // Daily Login Achievements
            { id: 'first_login', name: 'Welcome Back', desc: 'Login for the first time', reward: 'Greeting Card', check: () => gameState.totalLogins >= 1 },
            { id: 'faithful', name: 'Faithful', desc: 'Login 30 days in a row', reward: 'Dedication Medal', check: () => gameState.loginStreak >= 30 },
            { id: 'daily_legend', name: 'Daily Legend', desc: 'Login 100 days in a row', reward: 'Legend Badge', check: () => gameState.loginStreak >= 100 },
            { id: 'lucky_seven', name: 'Lucky Seven', desc: 'Reach day 7 login reward', reward: 'Jackpot', check: () => gameState.loginStreak >= 7 },
            { id: 'login_veteran', name: 'Login Veteran', desc: 'Login 365 total times', reward: 'Veteran Badge', check: () => gameState.totalLogins >= 365 },
            // Statistics Achievements
            { id: 'statistics_nerd', name: 'Statistics Nerd', desc: 'Open the statistics tab', reward: 'Nerd Glasses', check: () => gameState.statisticsViewed === true },
            { id: 'profit_king', name: 'Profit King', desc: 'Earn $1 Billion net profit', reward: 'Business Tycoon', check: () => {
                const netProfit = (gameState.lifetimeMoneyEarned || 0) - (gameState.lifetimeMoneySpent || 0);
                return netProfit >= 1000000000;
            } },
            { id: 'big_spender', name: 'Big Spender', desc: 'Spend $100 Million total', reward: 'Spender Badge', check: () => gameState.lifetimeMoneySpent >= 100000000 },
            // Collection Achievements
            { id: 'disco_collector', name: 'Disco Collector', desc: 'Complete the Disco collection', reward: 'Disco King', check: () => gameState.collectionBonuses.discoComplete === true },
            { id: 'galactic_collector', name: 'Galactic Collector', desc: 'Complete the Galactic collection', reward: 'Space Explorer', check: () => gameState.collectionBonuses.galacticComplete === true },
            { id: 'glitch_collector', name: 'Glitch Collector', desc: 'Complete the Glitch collection', reward: 'Bug Hunter', check: () => gameState.collectionBonuses.glitchComplete === true },
            { id: 'lunar_collector', name: 'Lunar Collector', desc: 'Complete the Full Moon collection', reward: 'Moon Master', check: () => gameState.collectionBonuses.fullmoonComplete === true },
            { id: 'blood_collector', name: 'Blood Moon Collector', desc: 'Complete the Blood Moon collection', reward: 'Eclipse Lord', check: () => gameState.collectionBonuses.bloodmoonComplete === true },
            { id: 'weather_collector', name: 'Weather Collector', desc: 'Complete the Weather collection', reward: 'Storm Caller', check: () => gameState.collectionBonuses.weatherComplete === true },
            { id: 'christmas_collector', name: 'Christmas Collector', desc: 'Complete the Christmas collection', reward: 'Santa\'s Helper', check: () => gameState.collectionBonuses.christmasComplete === true },
            { id: 'master_collector', name: 'Master Collector', desc: 'Complete all 7 collections', reward: 'Grand Collector', check: () => {
                return gameState.collectionBonuses.discoComplete &&
                       gameState.collectionBonuses.galacticComplete &&
                       gameState.collectionBonuses.glitchComplete &&
                       gameState.collectionBonuses.fullmoonComplete &&
                       gameState.collectionBonuses.bloodmoonComplete &&
                       gameState.collectionBonuses.weatherComplete &&
                       gameState.collectionBonuses.christmasComplete;
            }},
            // Rarity Milestone Achievements
            { id: 'milestone_hunter', name: 'Milestone Hunter', desc: 'Unlock 10 rarity milestones', reward: 'Milestone Badge', check: () => Object.keys(gameState.rarityMilestones).length >= 10 },
            { id: 'milestone_master', name: 'Milestone Master', desc: 'Unlock 25 rarity milestones', reward: 'Master Badge', check: () => Object.keys(gameState.rarityMilestones).length >= 25 }
        ];
        
        // Battle Pass Tiers
        const battlePassTiers = [
            { tier: 1, xpRequired: 100, reward: 'Common Crate' },
            { tier: 2, xpRequired: 250, reward: 'Uncommon Crate' },
            { tier: 3, xpRequired: 500, reward: 'Rare Crate' },
            { tier: 4, xpRequired: 1000, reward: 'Epic Crate' },
            { tier: 5, xpRequired: 2000, reward: 'Legendary Crate' },
            { tier: 6, xpRequired: 3500, reward: 'Mythic Crate' },
            { tier: 7, xpRequired: 5000, reward: 'Exotic Crate' },
            { tier: 8, xpRequired: 7500, reward: 'Celestial Crate' },
            { tier: 9, xpRequired: 10000, reward: 'Divine Crate' },
            { tier: 10, xpRequired: 13000, reward: 'Cosmic Crate' },
            { tier: 11, xpRequired: 16500, reward: 'Infinite Crate' },
            { tier: 12, xpRequired: 20000, reward: 'Transcendent Crate' },
            { tier: 13, xpRequired: 25000, reward: 'Ethereal Crate' },
            { tier: 14, xpRequired: 30000, reward: 'Primordial Crate' },
            { tier: 15, xpRequired: 35000, reward: 'Omega Badge' },
            { tier: 16, xpRequired: 40000, reward: 'Supreme Crown' },
            { tier: 17, xpRequired: 45000, reward: 'Godlike Aura' },
            { tier: 18, xpRequired: 50000, reward: 'Universal Key' },
            { tier: 19, xpRequired: 55000, reward: 'Multiversal Token' },
            { tier: 20, xpRequired: 60000, reward: 'Omnipotent Seal' },
            { tier: 21, xpRequired: 70000, reward: 'Absolute Fragment' },
            { tier: 22, xpRequired: 80000, reward: 'Ultimate Power' },
            { tier: 23, xpRequired: 90000, reward: 'Perfect Essence' },
            { tier: 24, xpRequired: 100000, reward: 'True Divinity' },
            { tier: 25, xpRequired: 125000, reward: 'Eternal Glory' },
            { tier: 26, xpRequired: 150000, reward: 'Immortal Spark' },
            { tier: 27, xpRequired: 175000, reward: 'Ascended Flame' },
            { tier: 28, xpRequired: 200000, reward: 'Boundless Power' },
            { tier: 29, xpRequired: 225000, reward: 'Limitless Crate' },
            { tier: 30, xpRequired: 250000, reward: 'Zenith Crown' },
            { tier: 31, xpRequired: 275000, reward: 'Apex Medallion' },
            { tier: 32, xpRequired: 300000, reward: 'Peak Fragment' },
            { tier: 33, xpRequired: 330000, reward: 'Summit Crate' },
            { tier: 34, xpRequired: 360000, reward: 'Pinnacle Orb' },
            { tier: 35, xpRequired: 390000, reward: 'Utmost Relic' },
            { tier: 36, xpRequired: 420000, reward: 'Maximum Core' },
            { tier: 37, xpRequired: 450000, reward: 'Superlative Shard' },
            { tier: 38, xpRequired: 480000, reward: 'Paramount Essence' },
            { tier: 39, xpRequired: 510000, reward: 'Sovereign Crate' },
            { tier: 40, xpRequired: 550000, reward: 'Emperor Crown' },
            { tier: 41, xpRequired: 590000, reward: 'Tyrant Seal' },
            { tier: 42, xpRequired: 630000, reward: 'Overlord Token' },
            { tier: 43, xpRequired: 670000, reward: 'Monarch Fragment' },
            { tier: 44, xpRequired: 710000, reward: 'Ruler Crate' },
            { tier: 45, xpRequired: 750000, reward: 'Dominator Badge' },
            { tier: 46, xpRequired: 800000, reward: 'Master Key' },
            { tier: 47, xpRequired: 850000, reward: 'Champion Relic' },
            { tier: 48, xpRequired: 900000, reward: 'Victor Essence' },
            { tier: 49, xpRequired: 950000, reward: 'Conqueror Crate' },
            { tier: 50, xpRequired: 1000000, reward: 'Legend Incarnate' }
        ];
        
        // Quest System
        const questTemplates = {
            daily: [
                { id: 'spin_25', name: 'Spin 25 Items', desc: 'Spin 25 items today', target: 25, xpReward: 100, check: (progress) => progress >= 25, track: 'spins' },
                { id: 'win_5_trades', name: 'Win 5 Trades', desc: 'Win 5 trades today', target: 5, xpReward: 150, check: (progress) => progress >= 5, track: 'tradeWins' },
                { id: 'craft_3', name: 'Craft 3 Items', desc: 'Craft 3 items today', target: 3, xpReward: 120, check: (progress) => progress >= 3, track: 'crafts' },
                { id: 'earn_10k', name: 'Earn $10K', desc: 'Earn $10,000 today', target: 10000, xpReward: 100, check: (progress) => progress >= 10000, track: 'moneyEarned' },
                { id: 'enchant_2', name: 'Enchant 2 Items', desc: 'Enchant 2 items today', target: 2, xpReward: 200, check: (progress) => progress >= 2, track: 'enchants' },
                { id: 'shop_buy_5', name: 'Shop Spree', desc: 'Buy 5 items from shop', target: 5, xpReward: 150, check: (progress) => progress >= 5, track: 'shopBuys' }
            ],
            weekly: [
                { id: 'spin_500', name: 'Spin Master', desc: 'Spin 500 items this week', target: 500, xpReward: 1000, check: (progress) => progress >= 500, track: 'spins' },
                { id: 'win_50_trades', name: 'Trade Master', desc: 'Win 50 trades this week', target: 50, xpReward: 1500, check: (progress) => progress >= 50, track: 'tradeWins' },
                { id: 'craft_30', name: 'Crafting Master', desc: 'Craft 30 items this week', target: 30, xpReward: 1200, check: (progress) => progress >= 30, track: 'crafts' },
                { id: 'rare_pull', name: 'Lucky Week', desc: 'Get 10 Legendary+ items', target: 10, xpReward: 2000, check: (progress) => progress >= 10, track: 'rarePulls' },
                { id: 'enchant_15', name: 'Enchanting Week', desc: 'Enchant 15 items this week', target: 15, xpReward: 1800, check: (progress) => progress >= 15, track: 'enchants' }
            ]
        };
        
        // Initialize
        gameState.craftCount = 0;
        gameState.enchantSuccess = 0;
        gameState.enchantFails = 0;
        
        // Enchantment System
        const enchantments = {
            // Regular Enchants
            'Value Upgrade I': { tier: 1, type: 'regular', chance: 0.15, effect: { valueMultiplier: 1.25 } },
            'Value Upgrade II': { tier: 2, type: 'regular', chance: 0.12, effect: { valueMultiplier: 1.5 } },
            'Value Upgrade III': { tier: 3, type: 'regular', chance: 0.09, effect: { valueMultiplier: 2.0 } },
            'Value Upgrade IV': { tier: 4, type: 'regular', chance: 0.06, effect: { valueMultiplier: 3.0 } },
            'Value Upgrade V': { tier: 5, type: 'regular', chance: 0.03, effect: { valueMultiplier: 5.0 } },
            
            'Traders Dream I': { tier: 1, type: 'regular', chance: 0.15, effect: { tradeAttraction: 1.25 } },
            'Traders Dream II': { tier: 2, type: 'regular', chance: 0.12, effect: { tradeAttraction: 1.5 } },
            'Traders Dream III': { tier: 3, type: 'regular', chance: 0.09, effect: { tradeAttraction: 2.0 } },
            'Traders Dream IV': { tier: 4, type: 'regular', chance: 0.06, effect: { tradeAttraction: 3.0 } },
            'Traders Dream V': { tier: 5, type: 'regular', chance: 0.03, effect: { tradeAttraction: 5.0 } },
            
            'Crafting Merger I': { tier: 1, type: 'regular', chance: 0.15, effect: { craftDupeChance: 0.1 } },
            'Crafting Merger II': { tier: 2, type: 'regular', chance: 0.12, effect: { craftDupeChance: 0.15 } },
            'Crafting Merger III': { tier: 3, type: 'regular', chance: 0.09, effect: { craftDupeChance: 0.25 } },
            'Crafting Merger IV': { tier: 4, type: 'regular', chance: 0.06, effect: { craftDupeChance: 0.35 } },
            'Crafting Merger V': { tier: 5, type: 'regular', chance: 0.03, effect: { craftDupeChance: 0.5 } },
            
            'Enchanters Tool I': { tier: 1, type: 'regular', chance: 0.15, effect: { enchantLuckBoost: 1.1 } },
            'Enchanters Tool II': { tier: 2, type: 'regular', chance: 0.12, effect: { enchantLuckBoost: 1.2 } },
            'Enchanters Tool III': { tier: 3, type: 'regular', chance: 0.09, effect: { enchantLuckBoost: 1.35 } },
            'Enchanters Tool IV': { tier: 4, type: 'regular', chance: 0.06, effect: { enchantLuckBoost: 1.5 } },
            'Enchanters Tool V': { tier: 5, type: 'regular', chance: 0.03, effect: { enchantLuckBoost: 2.0 } },
            
            'Money Multi I': { tier: 1, type: 'regular', chance: 0.15, effect: { sellMultiplier: 1.2 } },
            'Money Multi II': { tier: 2, type: 'regular', chance: 0.12, effect: { sellMultiplier: 1.4 } },
            'Money Multi III': { tier: 3, type: 'regular', chance: 0.09, effect: { sellMultiplier: 1.7 } },
            'Money Multi IV': { tier: 4, type: 'regular', chance: 0.06, effect: { sellMultiplier: 2.0 } },
            'Money Multi V': { tier: 5, type: 'regular', chance: 0.03, effect: { sellMultiplier: 2.5 } },
            
            'Event Starter III': { tier: 3, type: 'regular', chance: 0.08, effect: { eventStarter: true } },
            'Event Starter IV': { tier: 4, type: 'regular', chance: 0.05, effect: { eventStarter: true } },
            'Event Starter V': { tier: 5, type: 'regular', chance: 0.02, effect: { eventStarter: true } },
            
            'Lucky Item': { tier: 1, type: 'regular', chance: 0.15, effect: { luckBoost: 0.1 } },
            
            // Godly Enchants
            'Admins Dreams V': { tier: 5, type: 'godly', chance: 0.01, effect: { valueMultiplier: 2, luckBoost: 2, tradeAttraction: 2 } },
            'Emperors Style V': { tier: 5, type: 'godly', chance: 0.01, effect: { luckBoost: 4, tradeAttraction: 3 } },
            'Endless Possibilities V': { tier: 5, type: 'godly', chance: 0.01, effect: { craftDupeChance: 0.5, enchantLuckBoost: 2 } },
            'Chaotics Thoughts IV': { tier: 4, type: 'godly', chance: 0.015, effect: { spinMultiplier: 2, scammerBlock: true } },
            'Chaotics Thoughts V': { tier: 5, type: 'godly', chance: 0.01, effect: { spinMultiplier: 2, scammerBlock: true } },
            
            // Best Enchant
            'Ruler of the World VI': { tier: 6, type: 'ultimate', chance: 0.001, effect: { 
                valueMultiplier: 5, 
                luckBoost: 5, 
                tradeAttraction: 5,
                craftDupeChance: 0.75,
                enchantLuckBoost: 3,
                sellMultiplier: 3,
                spinMultiplier: 3
            }},
            
            // Bad Enchants
            'Ditto I': { tier: 1, type: 'bad', chance: 0.1, effect: { dittoCopy: 1.1 } },
            'Ditto II': { tier: 2, type: 'bad', chance: 0.08, effect: { dittoCopy: 1.15 } },
            'Ditto III': { tier: 3, type: 'bad', chance: 0.06, effect: { dittoCopy: 1.2 } },
            'Ditto IV': { tier: 4, type: 'bad', chance: 0.04, effect: { dittoCopy: 1.25 } },
            'Ditto V': { tier: 5, type: 'bad', chance: 0.02, effect: { dittoCopy: 1.3 } },
            'Too Much Energy': { tier: 0, type: 'bad', chance: 0.05, effect: { destroy: true } },
            'Too Little Energy': { tier: 0, type: 'bad', chance: 0.05, effect: { destroy: true } }
        };
        
        // Spin Function
        // Format large numbers (1000 -> 1K, 1000000 -> 1M, etc.)
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            
            const absNum = Math.abs(num);
            const sign = num < 0 ? '-' : '';
            
            if (absNum >= 1e63) return sign + (absNum / 1e63).toFixed(2) + 'VG';
            if (absNum >= 1e60) return sign + (absNum / 1e60).toFixed(2) + 'NOD';
            if (absNum >= 1e57) return sign + (absNum / 1e57).toFixed(2) + 'OCD';
            if (absNum >= 1e54) return sign + (absNum / 1e54).toFixed(2) + 'SPD';
            if (absNum >= 1e51) return sign + (absNum / 1e51).toFixed(2) + 'SXD';
            if (absNum >= 1e48) return sign + (absNum / 1e48).toFixed(2) + 'QID';
            if (absNum >= 1e45) return sign + (absNum / 1e45).toFixed(2) + 'QAD';
            if (absNum >= 1e42) return sign + (absNum / 1e42).toFixed(2) + 'TD';
            if (absNum >= 1e39) return sign + (absNum / 1e39).toFixed(2) + 'DD';
            if (absNum >= 1e36) return sign + (absNum / 1e36).toFixed(2) + 'UD';
            if (absNum >= 1e33) return sign + (absNum / 1e33).toFixed(2) + 'DC';
            if (absNum >= 1e30) return sign + (absNum / 1e30).toFixed(2) + 'NO';
            if (absNum >= 1e27) return sign + (absNum / 1e27).toFixed(2) + 'OC';
            if (absNum >= 1e24) return sign + (absNum / 1e24).toFixed(2) + 'SP';
            if (absNum >= 1e21) return sign + (absNum / 1e21).toFixed(2) + 'SX';
            if (absNum >= 1e18) return sign + (absNum / 1e18).toFixed(2) + 'QI';
            if (absNum >= 1e15) return sign + (absNum / 1e15).toFixed(2) + 'QA';
            if (absNum >= 1e12) return sign + (absNum / 1e12).toFixed(2) + 'T';
            if (absNum >= 1e9) return sign + (absNum / 1e9).toFixed(2) + 'B';
            if (absNum >= 1e6) return sign + (absNum / 1e6).toFixed(2) + 'M';
            if (absNum >= 1e3) return sign + (absNum / 1e3).toFixed(2) + 'K';
            return sign + absNum.toFixed(0);
        }
        
        // ===== QUEST SYSTEM =====
        
        function generateDailyQuests() {
            const dailyQuests = [...questTemplates.daily];
            // Shuffle and pick 3 random daily quests
            for (let i = dailyQuests.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [dailyQuests[i], dailyQuests[j]] = [dailyQuests[j], dailyQuests[i]];
            }
            return dailyQuests.slice(0, 3).map(q => ({...q, progress: 0, type: 'daily', completed: false}));
        }
        
        function generateWeeklyQuests() {
            const weeklyQuests = [...questTemplates.weekly];
            // Shuffle and pick 2 random weekly quests
            for (let i = weeklyQuests.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [weeklyQuests[i], weeklyQuests[j]] = [weeklyQuests[j], weeklyQuests[i]];
            }
            return weeklyQuests.slice(0, 2).map(q => ({...q, progress: 0, type: 'weekly', completed: false}));
        }
        
        function refreshQuests() {
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            const oneWeek = 7 * oneDay;
            
            if (!gameState.lastQuestRefresh || now - gameState.lastQuestRefresh >= oneDay) {
                // Refresh daily quests
                const dailyQuests = generateDailyQuests();
                const weeklyQuests = gameState.activeQuests.filter(q => q.type === 'weekly');
                
                // Check if weekly quests need refresh
                if (!gameState.lastQuestRefresh || now - gameState.lastQuestRefresh >= oneWeek) {
                    gameState.activeQuests = [...dailyQuests, ...generateWeeklyQuests()];
                } else {
                    gameState.activeQuests = [...dailyQuests, ...weeklyQuests];
                }
                
                gameState.lastQuestRefresh = now;
                saveGame(true);
            }
        }
        
        function updateQuestProgress(trackType, amount) {
            if (!gameState.activeQuests || gameState.activeQuests.length === 0) {
                refreshQuests();
            }
            
            if (!gameState.activeQuests) return; // Safety check
            
            for (const quest of gameState.activeQuests) {
                if (quest.track === trackType && !quest.completed) {
                    quest.progress += amount;
                    
                    // Check completion - handle both function-based and target-based checks
                    let isComplete = false;
                    if (typeof quest.check === 'function') {
                        isComplete = quest.check(quest.progress);
                    } else if (quest.target) {
                        // Fallback to simple target comparison
                        isComplete = quest.progress >= quest.target;
                    }
                    
                    if (isComplete) {
                        completeQuest(quest);
                    }
                }
            }
            
            updateQuestDisplay();
        }
        
        function completeQuest(quest) {
            if (quest.completed) return;
            
            quest.completed = true;
            gameState.questsCompleted = (gameState.questsCompleted || 0) + 1;
            
            // Apply quest speed upgrade
            let questXP = quest.xpReward;
            if (gameState.upgrades.questSpeed > 0) {
                questXP = Math.floor(questXP * (1 + gameState.upgrades.questSpeed * 0.05)); // +5% per level
            }
            gameState.battlePassXP += questXP;
            claimBattlePassRewards();
            
            if (quest.type === 'daily') {
                gameState.dailyStreak = (gameState.dailyStreak || 0) + 1;
            } else if (quest.type === 'weekly') {
                gameState.weeklyQuestsCompleted = (gameState.weeklyQuestsCompleted || 0) + 1;
            }
            
            showNotification(`✅ Quest Complete: ${quest.name}! +${quest.xpReward} XP`, 'var(--success)');
            updateBattlePass();
            checkAchievements();
            saveGame(true);
        }
        
        function updateQuestDisplay() {
            const container = document.getElementById('questContainer');
            if (!container) return;
            
            if (!gameState.activeQuests || gameState.activeQuests.length === 0) {
                refreshQuests();
            }
            
            container.innerHTML = '';
            
            const dailyQuests = gameState.activeQuests.filter(q => q.type === 'daily');
            const weeklyQuests = gameState.activeQuests.filter(q => q.type === 'weekly');
            
            if (dailyQuests.length > 0) {
                const dailySection = document.createElement('div');
                dailySection.innerHTML = '<h3 style="color: var(--accent-gold); margin-bottom: 10px;">📅 Daily Quests</h3>';
                dailyQuests.forEach(quest => {
                    dailySection.innerHTML += createQuestCard(quest);
                });
                container.appendChild(dailySection);
            }
            
            if (weeklyQuests.length > 0) {
                const weeklySection = document.createElement('div');
                weeklySection.innerHTML = '<h3 style="color: var(--accent-primary); margin: 20px 0 10px 0;">📆 Weekly Quests</h3>';
                weeklyQuests.forEach(quest => {
                    weeklySection.innerHTML += createQuestCard(quest);
                });
                container.appendChild(weeklySection);
            }
        }
        
        function createQuestCard(quest) {
            const target = quest.target || 1;
            const progressPercent = Math.min(100, (quest.progress / target) * 100);
            const statusColor = quest.completed ? 'var(--success)' : 'var(--accent-primary)';
            const statusText = quest.completed ? '✅ COMPLETED' : `${Math.floor(quest.progress)}/${target}`;
            
            return `
                <div class="recipe-card" style="border-color: ${statusColor}; opacity: ${quest.completed ? 0.7 : 1};">
                    <h4 style="color: ${statusColor};">${quest.name}</h4>
                    <p style="color: var(--text-secondary); margin: 5px 0;">${quest.desc}</p>
                    <div style="background: var(--bg-dark); border-radius: 10px; overflow: hidden; margin: 10px 0;">
                        <div style="background: ${statusColor}; height: 8px; width: ${progressPercent}%; transition: width 0.3s;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: ${statusColor};">${statusText}</span>
                        <span style="color: var(--accent-gold);">🎁 ${quest.xpReward} XP</span>
                    </div>
                </div>
            `;
        }
        
        let spinCooldown = false;
        
        function spinItem() {
            if (spinCooldown) return;
            
            const btn = document.getElementById('spinBtn');
            btn.classList.add('spinning');
            btn.textContent = 'SPINNING...';
            
            // Apply speed upgrade
            const speedMultiplier = 1 - (gameState.upgrades.spinSpeed * 0.1); // 10% faster per level
            const spinTime = Math.max(500, 1000 * speedMultiplier);
            
            setTimeout(() => {
                // Apply both regular luck multiplier AND permanent luck boost
                let totalLuck = gameState.luckMultiplier * gameState.permanentLuckBoost;
                
                // Apply luck boost upgrade (5% per level)
                if (gameState.upgrades.luckBoost > 0) {
                    totalLuck *= (1 + (gameState.upgrades.luckBoost * 0.05));
                }
                
                // Apply luck event multiplier if active
                if (gameState.luckEvent && gameState.luckEvent.active) {
                    totalLuck *= gameState.luckEvent.multiplier;
                }
                
                // Apply active pet luck bonus
                if (gameState.activePet) {
                    const petBonus = getPetLuckBonus();
                    totalLuck *= petBonus;
                }
                
                // Apply artifact bonuses
                if (gameState.artifacts && gameState.artifacts.length > 0) {
                    gameState.artifacts.forEach(artifact => {
                        if (artifact === 'ancient_coin') totalLuck *= 1.03;
                        else if (artifact === 'lucky_clover') totalLuck *= 1.05;
                        else if (artifact === 'rabbits_foot') totalLuck *= 1.07;
                        else if (artifact === 'fortune_crystal') totalLuck *= 1.10;
                        else if (artifact === 'celestial_amulet') totalLuck *= 1.15;
                    });
                }
                
                // Apply collection bonuses during active events
                if (gameState.specialEvent) {
                    if (gameState.specialEvent === 'disco' && gameState.collectionBonuses.discoComplete) {
                        totalLuck *= 1.1;
                    } else if (gameState.specialEvent === 'galactic' && gameState.collectionBonuses.galacticComplete) {
                        totalLuck *= 1.1;
                    } else if (gameState.specialEvent === 'glitch' && gameState.collectionBonuses.glitchComplete) {
                        totalLuck *= 1.1;
                    } else if (gameState.specialEvent === 'fullmoon' && gameState.collectionBonuses.fullmoonComplete) {
                        totalLuck *= 1.1;
                    } else if (gameState.specialEvent === 'bloodmoon' && gameState.collectionBonuses.bloodmoonComplete) {
                        totalLuck *= 1.1;
                    }
                }
                if (gameState.weatherEvent && gameState.collectionBonuses.weatherComplete) {
                    totalLuck *= 1.15;
                }
                if (gameState.christmasEvent && gameState.collectionBonuses.christmasComplete) {
                    totalLuck *= 1.15;
                }
                
                // Apply POTION BONUSES
                totalLuck *= getPotionBonus('luck');
                
                // Apply value potion bonus to item values later
                const valueMultiplier = getPotionBonus('value');
                
                const roll = Math.random() * totalLuck;
                let selectedRarity = rarities[0];
                
                // Check for Special Event items (40% base + eventLuck upgrade)
                let specialEventChance = 0.4;
                if (gameState.upgrades.eventLuck > 0) {
                    specialEventChance += gameState.upgrades.eventLuck * 0.05; // +5% per level
                }
                if (gameState.specialEvent && Math.random() < specialEventChance) {
                    const eventItems = {
                        disco: discoItems,
                        galactic: galacticItems,
                        glitch: glitchItems,
                        fullmoon: fullMoonItems,
                        bloodmoon: bloodMoonItems,
                        nuclear: nuclearItems,
                        volcanic: volcanicItems,
                        goldenrain: goldenRainItems,
                        admin: [
                            { name: 'Forbidden Command', rarity: 'Admin' },
                            { name: 'Root Access Key', rarity: 'Admin' },
                            { name: 'System Override', rarity: 'Admin' },
                            { name: 'Admin Console', rarity: 'Limitless' },
                            { name: 'Restricted Data', rarity: 'Boundless' },
                            { name: 'Classified File', rarity: 'Transcendental' }
                        ]
                    };
                    
                    // Admin event has small chance (5%) to give actual Admin rarity
                    let specialItem;
                    if (gameState.specialEvent === 'admin') {
                        if (Math.random() < 0.05) {
                            // 5% chance for Admin rarity during admin event!
                            specialItem = { name: 'Forbidden Command', rarity: 'Admin' };
                        } else {
                            specialItem = eventItems[gameState.specialEvent][Math.floor(Math.random() * eventItems[gameState.specialEvent].length)];
                        }
                    } else {
                        specialItem = eventItems[gameState.specialEvent][Math.floor(Math.random() * eventItems[gameState.specialEvent].length)];
                    }
                    
                    const rarity = rarities.find(r => r.name === specialItem.rarity);
                    if (rarity) {
                        selectedRarity = rarity;
                        addItemToInventory(specialItem.name, selectedRarity);
                        gameState.itemsFromEvents++;
                    }
                }
                // Check for Weather Event items (30% base + eventLuck upgrade)
                else if (gameState.weatherEvent) {
                    let weatherEventChance = 0.3;
                    if (gameState.upgrades.eventLuck > 0) {
                        weatherEventChance += gameState.upgrades.eventLuck * 0.05; // +5% per level
                    }
                    if (Math.random() < weatherEventChance) {
                        const weatherItem = weatherItems[gameState.weatherEvent][Math.floor(Math.random() * weatherItems[gameState.weatherEvent].length)];
                        const rarity = rarities.find(r => r.name === weatherItem.rarity);
                        if (rarity) {
                            selectedRarity = rarity;
                            addItemToInventory(weatherItem.name, selectedRarity);
                            gameState.itemsFromEvents++;
                        }
                    }
                }
                // Check for Christmas item
                else if (gameState.christmasEvent && Math.random() < 0.15) {
                    const christmasItem = christmasItems[Math.floor(Math.random() * christmasItems.length)];
                    const rarity = rarities.find(r => r.name === christmasItem.rarity);
                    if (rarity) {
                        selectedRarity = rarity;
                        addItemToInventory(christmasItem.name, selectedRarity);
                        gameState.itemsFromEvents++;
                    }
                } else {
                    // Check Pity System first
                    if (gameState.pityCounter >= gameState.pityThreshold) {
                        // Pity activated! Give guaranteed Legendary+ item
                        const pityRarities = rarities.filter((r, i) => i >= 4); // Legendary and above
                        selectedRarity = pityRarities[Math.floor(Math.random() * Math.min(5, pityRarities.length))];
                        const itemName = generateItemName(selectedRarity);
                        addItemToInventory(itemName, selectedRarity);
                        
                        gameState.pityCounter = 0;
                        gameState.pityTriggered++;
                        showNotification(`🍀 PITY SYSTEM ACTIVATED! Guaranteed ${selectedRarity.name} item!`, selectedRarity.color);
                    } else {
                        // Regular item generation
                        let cumulativeChance = 0;
                        for (let i = rarities.length - 1; i >= 0; i--) {
                            cumulativeChance += rarities[i].chance;
                            if (roll < cumulativeChance) {
                                selectedRarity = rarities[i];
                                break;
                            }
                        }
                        
                        const itemName = generateItemName(selectedRarity);
                        addItemToInventory(itemName, selectedRarity);
                        
                        // Apply rarity boost upgrade (10% chance per level to upgrade to next rarity)
                        if (gameState.upgrades.rarityBoost > 0) {
                            const upgradeChance = gameState.upgrades.rarityBoost * 0.1; // 10% per level
                            if (Math.random() < upgradeChance) {
                                const currentIndex = rarities.findIndex(r => r.name === selectedRarity.name);
                                if (currentIndex < rarities.length - 1) {
                                    // Remove the current item
                                    const currentKey = `${itemName} (${selectedRarity.name})`;
                                    if (gameState.inventory[currentKey]) {
                                        gameState.inventory[currentKey].count--;
                                        if (gameState.inventory[currentKey].count <= 0) {
                                            delete gameState.inventory[currentKey];
                                        }
                                    }
                                    // Add upgraded rarity item
                                    const upgradedRarity = rarities[currentIndex + 1];
                                    const upgradedName = generateItemName(upgradedRarity);
                                    addItemToInventory(upgradedName, upgradedRarity);
                                    showNotification(`⬆️ RARITY BOOST! ${selectedRarity.name} → ${upgradedRarity.name}!`, upgradedRarity.color);
                                    selectedRarity = upgradedRarity;
                                }
                            }
                        }
                        
                        // Update pity counter
                        const rarityIndex = rarities.findIndex(r => r.name === selectedRarity.name);
                        if (rarityIndex < 4) { // Common to Epic
                            gameState.pityCounter++;
                        } else { // Legendary or higher - reset pity
                            gameState.pityCounter = 0;
                        }
                    }
                }
                
                // Check for spin multiplier from Chaotics Thoughts enchant
                let spinMultiplier = 1;
                for (const [key, item] of Object.entries(gameState.inventory)) {
                    if (item.count > 0 && item.enchantments) {
                        for (const enchantName of item.enchantments) {
                            const enchantData = enchantments[enchantName];
                            if (enchantData && enchantData.effect.spinMultiplier) {
                                spinMultiplier = Math.max(spinMultiplier, enchantData.effect.spinMultiplier);
                            }
                        }
                    }
                }
                
                gameState.totalSpins += spinMultiplier;
                if (spinMultiplier > 1) {
                    showNotification(`⚡ Chaotics Thoughts! ${spinMultiplier}x spin count!`, 'var(--accent-gold)');
                }
                
                // Update daily challenges
                updateDailyChallengeProgress('spins', spinMultiplier);
                
                // Apply XP boost upgrade
                let baseXP = 10;
                if (gameState.upgrades.xpBoost > 0) {
                    baseXP = Math.floor(baseXP * (1 + gameState.upgrades.xpBoost * 0.1));
                }
                gameState.battlePassXP += baseXP;
                claimBattlePassRewards();
                
                // Mystery Box chance - give a bonus random item
                if (gameState.upgrades.mysteryBox > 0) {
                    const mysteryChance = gameState.upgrades.mysteryBox * 0.02; // 2% per level
                    if (Math.random() < mysteryChance) {
                        const bonusRarity = rarities[Math.floor(Math.random() * Math.min(15, rarities.length))];
                        const bonusItem = generateItemName(bonusRarity);
                        addItemToInventory(bonusItem, bonusRarity);
                        showNotification(`🎁 MYSTERY BOX! Bonus: ${bonusItem}!`, bonusRarity.color);
                    }
                }
                
                // Update quests
                updateQuestProgress('spins', spinMultiplier);
                
                // Track rare pulls for quests and daily challenges
                const rarityIndex = rarities.findIndex(r => r.name === selectedRarity.name);
                if (rarityIndex >= 4) { // Legendary or higher
                    updateQuestProgress('rarePulls', 1);
                    updateDailyChallengeProgress('legendaryItems', 1);
                }
                if (rarityIndex >= 2) { // Rare+
                    updateDailyChallengeProgress('rareItems', 1);
                }
                
                updateStats();
                checkAchievements();
                updateBattlePass();
                
                btn.classList.remove('spinning');
                btn.textContent = 'SPIN AGAIN!';
                
                // Random event chance
                if (Math.random() < 0.05) {
                    triggerRandomEvent();
                }
                
                // Cooldown
                spinCooldown = true;
                setTimeout(() => {
                    spinCooldown = false;
                }, spinTime);
            }, spinTime);
        }
        
        // Auto-spin functionality
        function startAutoSpin() {
            if (gameState.upgrades.autoSpin > 0) {
                const interval = Math.max(3000, (11 - gameState.upgrades.autoSpin) * 1000);
                setInterval(() => {
                    if (gameState.upgrades.autoSpin > 0 && !spinCooldown) {
                        spinItem();
                    }
                }, interval);
            }
        }
        
        // Lucky Spin Mode
        function luckySpinItem(multiplier) {
            const costs = { 2: 10000, 5: 100000, 10: 1000000 };
            const cost = costs[multiplier];
            
            if (gameState.money < cost) {
                showNotification('Not enough money for Lucky Spin!', 'var(--danger)');
                return;
            }
            
            gameState.money -= cost;
            gameState.lifetimeMoneySpent = (gameState.lifetimeMoneySpent || 0) + cost;
            
            // Temporarily boost luck
            const originalLuck = gameState.luckMultiplier;
            gameState.luckMultiplier *= multiplier;
            
            showNotification(`⭐ LUCKY SPIN! ${multiplier}x Luck Boost!`, 'var(--accent-gold)');
            
            // Spin with boosted luck
            spinItem();
            
            // Restore original luck after spin completes
            setTimeout(() => {
                gameState.luckMultiplier = originalLuck;
                updateStats();
            }, 1500);
        }
        
        // Auto-Fusion System
        function checkAutoFusion() {
            if (gameState.upgrades.autoFusion === 0) return;
            
            // Find items with 3+ count of same rarity
            const rarityCounts = {};
            
            for (const [key, item] of Object.entries(gameState.inventory)) {
                if (item.count >= 3) {
                    const rarityIndex = rarities.findIndex(r => r.name === item.rarity);
                    // Don't auto-fuse max rarity
                    if (rarityIndex < rarities.length - 1) {
                        if (!rarityCounts[item.rarity]) {
                            rarityCounts[item.rarity] = [];
                        }
                        rarityCounts[item.rarity].push(key);
                    }
                }
            }
            
            // Auto-fuse if we have 3+ of same rarity
            for (const [rarity, itemKeys] of Object.entries(rarityCounts)) {
                if (itemKeys.length >= 3) {
                    // Pick first 3 items
                    const fusionItems = itemKeys.slice(0, 3);
                    const rarityIndex = rarities.findIndex(r => r.name === rarity);
                    const nextRarity = rarities[rarityIndex + 1];
                    
                    // Remove 3 items
                    fusionItems.forEach(key => {
                        const item = gameState.inventory[key];
                        if (item && item.count > 0) {
                            item.count--;
                            gameState.totalValue -= item.value;
                        }
                    });
                    
                    // Create new item
                    const newItemName = generateItemName(nextRarity);
                    addItemToInventory(newItemName, nextRarity);
                    gameState.fusionCount++;
                    
                    showNotification(`🤖 AUTO-FUSION! Created ${newItemName}!`, nextRarity.color);
                    updateStats();
                    updateInventory();
                    checkAchievements();
                    return; // Only fuse one at a time
                }
            }
        }
        
        // Collection Bonus System
        const collectionData = {
            disco: {
                name: 'Disco Collection',
                items: ['🪩 Disco Ball', '🕺 Groove Shoes', '💃 Dance Floor Tile', '🎵 Funky Beat', '✨ Glitter Bomb', '🎶 Rhythm Soul'],
                bonus: 'event',
                bonusAmount: 0.1,
                description: '+10% luck during Disco events'
            },
            galactic: {
                name: 'Galactic Collection',
                items: ['🌌 Nebula Fragment', '⭐ Star Dust', '🌠 Comet Tail', '🪐 Planet Core', '🌟 Supernova Spark', '🔭 Galaxy Eye'],
                bonus: 'event',
                bonusAmount: 0.1,
                description: '+10% luck during Galactic events'
            },
            glitch: {
                name: 'Glitch Collection',
                items: ['⚡ Error Code', '🔲 Corrupted Pixel', '📟 Digital Anomaly', '💾 Data Fragment', '🖥️ System Break', '⌨️ Reality Bug'],
                bonus: 'event',
                bonusAmount: 0.1,
                description: '+10% luck during Glitch events'
            },
            fullmoon: {
                name: 'Full Moon Collection',
                items: ['🌕 Moonstone', '🐺 Lunar Howl', '🌙 Silver Beam', '✨ Moon Dust', '🌛 Crescent Blade', '🔮 Lunar Oracle'],
                bonus: 'event',
                bonusAmount: 0.1,
                description: '+10% luck during Full Moon events'
            },
            bloodmoon: {
                name: 'Blood Moon Collection',
                items: ['🔴 Crimson Orb', '🩸 Blood Crystal', '🌑 Eclipse Shard', '⚔️ Scarlet Blade', '💀 Cursed Relic', '👁️ Crimson Eye'],
                bonus: 'event',
                bonusAmount: 0.1,
                description: '+10% luck during Blood Moon events'
            },
            weather: {
                name: 'Weather Collection',
                items: ['☁️ Cloud Fragment', '🌧️ Raindrop', '⛈️ Lightning Bolt'],
                bonus: 'event',
                bonusAmount: 0.15,
                description: '+15% luck during Weather events'
            },
            christmas: {
                name: 'Christmas Collection',
                items: ['🎄 Christmas Tree', '🎅 Santa Hat', '🎁 Gift Box', '⛄ Snowman', '🔔 Jingle Bell', '🕯️ Candle'],
                bonus: 'event',
                bonusAmount: 0.15,
                description: '+15% luck during Christmas events'
            }
        };
        
        function checkCollectionBonuses() {
            for (const [key, collection] of Object.entries(collectionData)) {
                const hasAllItems = collection.items.every(itemName => {
                    return Object.keys(gameState.inventory).some(invKey => 
                        invKey.startsWith(itemName) && gameState.inventory[invKey].count > 0
                    );
                });
                
                if (hasAllItems && !gameState.collectionBonuses[key + 'Complete']) {
                    gameState.collectionBonuses[key + 'Complete'] = true;
                    showNotification(`🏆 COLLECTION COMPLETE! ${collection.name} unlocked!`, 'var(--accent-gold)');
                    checkAchievements();
                }
            }
        }
        
        // Rarity Milestone System
        const rarityMilestoneData = [
            { rarity: 'Common', milestones: [1000, 5000, 25000], bonuses: [0.005, 0.01, 0.02] }, // 2x, 2x, 2.5x harder
            { rarity: 'Uncommon', milestones: [500, 2500, 10000], bonuses: [0.005, 0.015, 0.025] }, // 2x, 2.5x, 2x harder
            { rarity: 'Rare', milestones: [250, 1000, 5000], bonuses: [0.01, 0.02, 0.04] }, // 2.5x, 2x, 2.5x harder
            { rarity: 'Epic', milestones: [100, 500, 2500], bonuses: [0.015, 0.03, 0.06] }, // 2x, 2.5x, 2.5x harder
            { rarity: 'Legendary', milestones: [50, 250, 1000], bonuses: [0.02, 0.05, 0.10] }, // 2x, 2.5x, 2x harder
            { rarity: 'Mythic', milestones: [25, 100, 500], bonuses: [0.03, 0.07, 0.15] }, // 2.5x, 2x, 2x harder
            { rarity: 'Exotic', milestones: [10, 50, 250], bonuses: [0.05, 0.10, 0.20] }, // 2x, 2x, 2.5x harder
            { rarity: 'Celestial', milestones: [5, 25, 100], bonuses: [0.07, 0.15, 0.30] }, // 1.67x, 2.5x, 2x harder
            { rarity: 'Divine', milestones: [3, 10, 50], bonuses: [0.10, 0.20, 0.40] }, // 1.5x, 2x, 2x harder
            { rarity: 'Cosmic', milestones: [2, 5, 25], bonuses: [0.15, 0.30, 0.60] }, // NEW!
            { rarity: 'Infinite', milestones: [1, 3, 15], bonuses: [0.20, 0.40, 0.80] }, // NEW!
            { rarity: 'Transcendent', milestones: [1, 2, 10], bonuses: [0.25, 0.50, 1.00] }, // NEW!
            { rarity: 'Ethereal', milestones: [1, 2, 5], bonuses: [0.30, 0.60, 1.20] }, // NEW!
            { rarity: 'Primordial', milestones: [1, 2, 3], bonuses: [0.50, 1.00, 2.00] } // NEW! Massive bonuses
        ];
        
        function checkRarityMilestones() {
            let bonusApplied = false;
            
            rarityMilestoneData.forEach(data => {
                const count = gameState.rarityCounts[data.rarity] || 0;
                
                data.milestones.forEach((milestone, index) => {
                    const milestoneKey = `${data.rarity}_${milestone}`;
                    
                    if (count >= milestone && !gameState.rarityMilestones[milestoneKey]) {
                        gameState.rarityMilestones[milestoneKey] = true;
                        gameState.permanentLuckBoost += data.bonuses[index];
                        showNotification(`⭐ MILESTONE! ${count} ${data.rarity} items! +${(data.bonuses[index] * 100).toFixed(0)}% permanent luck!`, 'var(--accent-gold)');
                        bonusApplied = true;
                    }
                });
            });
            
            if (bonusApplied) {
                updateStats();
                checkAchievements();
            }
        }
        
        function updateCollectionsDisplay() {
            const bonusesGrid = document.getElementById('collectionBonusesGrid');
            const milestonesGrid = document.getElementById('rarityMilestonesGrid');
            
            if (bonusesGrid) {
                bonusesGrid.innerHTML = '';
                
                for (const [key, collection] of Object.entries(collectionData)) {
                    const hasAllItems = collection.items.every(itemName => {
                        return Object.keys(gameState.inventory).some(invKey => 
                            invKey.startsWith(itemName) && gameState.inventory[invKey].count > 0
                        );
                    });
                    
                    const ownedCount = collection.items.filter(itemName => {
                        return Object.keys(gameState.inventory).some(invKey => 
                            invKey.startsWith(itemName) && gameState.inventory[invKey].count > 0
                        );
                    }).length;
                    
                    const isComplete = gameState.collectionBonuses[key + 'Complete'];
                    
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.style.borderColor = isComplete ? 'var(--accent-gold)' : 'var(--bg-medium)';
                    card.innerHTML = `
                        <h3 style="color: ${isComplete ? 'var(--accent-gold)' : 'var(--text-primary)'};">
                            ${isComplete ? '✅' : '⬜'} ${collection.name}
                        </h3>
                        <p style="color: var(--text-secondary); margin: 10px 0;">${collection.description}</p>
                        <div class="progress-bar" style="margin: 10px 0;">
                            <div class="progress-fill" style="width: ${(ownedCount / collection.items.length) * 100}%; background: ${isComplete ? 'var(--accent-gold)' : 'var(--accent-primary)'};">
                                ${ownedCount} / ${collection.items.length}
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            ${collection.items.map(item => {
                                const owned = Object.keys(gameState.inventory).some(invKey => 
                                    invKey.startsWith(item) && gameState.inventory[invKey].count > 0
                                );
                                return `<span style="color: ${owned ? 'var(--success)' : 'var(--text-secondary)'}">${owned ? '✓' : '✗'} ${item}</span>`;
                            }).join('<br>')}
                        </div>
                    `;
                    bonusesGrid.appendChild(card);
                }
            }
            
            if (milestonesGrid) {
                milestonesGrid.innerHTML = '';
                
                rarityMilestoneData.forEach(data => {
                    const count = gameState.rarityCounts[data.rarity] || 0;
                    const rarity = rarities.find(r => r.name === data.rarity);
                    
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.style.borderColor = rarity.color;
                    
                    const milestoneHTML = data.milestones.map((milestone, index) => {
                        const milestoneKey = `${data.rarity}_${milestone}`;
                        const achieved = gameState.rarityMilestones[milestoneKey] === true;
                        const bonus = (data.bonuses[index] * 100).toFixed(0);
                        
                        return `
                            <div style="display: flex; justify-content: space-between; padding: 5px; background: ${achieved ? 'rgba(0,255,0,0.1)' : 'var(--bg-dark)'}; margin: 3px 0; border-radius: 5px;">
                                <span style="color: ${achieved ? 'var(--success)' : 'var(--text-secondary)'}">${achieved ? '✅' : '⬜'} ${milestone} items</span>
                                <span style="color: var(--accent-gold);">+${bonus}% luck</span>
                            </div>
                        `;
                    }).join('');
                    
                    card.innerHTML = `
                        <h3 style="color: ${rarity.color};">${data.rarity}</h3>
                        <p style="color: var(--text-primary); font-size: 1.2rem; margin: 10px 0;">Current: ${count}</p>
                        ${milestoneHTML}
                    `;
                    milestonesGrid.appendChild(card);
                });
            }
        }
        
        function triggerUltraRareAnimation(rarityName, rarityColor, itemName, itemValue) {
            const rarityIndex = rarities.findIndex(r => r.name === rarityName);
            
            // Only trigger for Cosmic (index 9) and beyond
            if (rarityIndex < 9) return;
            
            const overlay = document.createElement('div');
            overlay.className = 'ultra-rare-overlay';
            document.body.appendChild(overlay);
            
            // Different animations based on rarity
            if (rarityName === 'Cosmic') {
                // Purple sparkles
                for (let i = 0; i < 50; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.style.position = 'absolute';
                    sparkle.style.width = '10px';
                    sparkle.style.height = '10px';
                    sparkle.style.background = '#ff69b4';
                    sparkle.style.borderRadius = '50%';
                    sparkle.style.left = Math.random() * 100 + '%';
                    sparkle.style.top = Math.random() * 100 + '%';
                    sparkle.style.animation = 'cosmic-sparkle 2s ease-out';
                    sparkle.style.animationDelay = (Math.random() * 0.5) + 's';
                    overlay.appendChild(sparkle);
                }
            } else if (rarityName === 'Infinite') {
                // Rainbow waves
                for (let i = 0; i < 5; i++) {
                    const wave = document.createElement('div');
                    wave.style.position = 'absolute';
                    wave.style.width = '200%';
                    wave.style.height = '100px';
                    wave.style.top = (i * 20) + '%';
                    wave.style.background = `linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent)`;
                    wave.style.animation = 'infinite-wave 2s ease-out';
                    wave.style.animationDelay = (i * 0.2) + 's';
                    overlay.appendChild(wave);
                }
            } else if (rarityName === 'Transcendent') {
                // Cyan lightning
                const lightning = document.createElement('div');
                lightning.style.position = 'absolute';
                lightning.style.width = '100%';
                lightning.style.height = '100%';
                lightning.style.background = '#00fff2';
                lightning.style.animation = 'transcendent-lightning 1.5s ease-out';
                overlay.appendChild(lightning);
            } else if (rarityName === 'Ethereal') {
                // Ghost wisps
                for (let i = 0; i < 20; i++) {
                    const wisp = document.createElement('div');
                    wisp.style.position = 'absolute';
                    wisp.style.width = '50px';
                    wisp.style.height = '50px';
                    wisp.style.background = 'radial-gradient(circle, rgba(177,156,217,0.8), transparent)';
                    wisp.style.left = Math.random() * 100 + '%';
                    wisp.style.animation = 'ethereal-wisp 3s ease-out';
                    wisp.style.animationDelay = (Math.random() * 0.5) + 's';
                    overlay.appendChild(wisp);
                }
            } else if (rarityName === 'Primordial') {
                // ENHANCED Fire explosion with screen shake
                const explosion = document.createElement('div');
                explosion.style.position = 'absolute';
                explosion.style.width = '200px';
                explosion.style.height = '200px';
                explosion.style.left = '50%';
                explosion.style.top = '50%';
                explosion.style.transform = 'translate(-50%, -50%)';
                explosion.style.background = 'radial-gradient(circle, rgba(255,200,0,1), rgba(255,107,53,0.9), rgba(255,0,0,0.6), transparent)';
                explosion.style.animation = 'primordial-explosion 3s ease-out';
                explosion.style.boxShadow = '0 0 100px 50px rgba(255,107,53,0.8)';
                overlay.appendChild(explosion);
                
                // Fire particles
                for (let i = 0; i < 80; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'absolute';
                    particle.style.width = '8px';
                    particle.style.height = '8px';
                    particle.style.borderRadius = '50%';
                    particle.style.background = i % 2 === 0 ? '#ff6b35' : '#ff0000';
                    particle.style.left = '50%';
                    particle.style.top = '50%';
                    particle.style.animation = 'fire-particle 2s ease-out';
                    particle.style.animationDelay = (Math.random() * 0.3) + 's';
                    overlay.appendChild(particle);
                }
                
                // Screen shake
                document.body.style.animation = 'screen-shake 0.5s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 500);
            } else if (rarityName === 'Omega') {
                // Black hole vortex
                const vortex = document.createElement('div');
                vortex.style.position = 'absolute';
                vortex.style.width = '200px';
                vortex.style.height = '200px';
                vortex.style.left = '50%';
                vortex.style.top = '50%';
                vortex.style.transform = 'translate(-50%, -50%)';
                vortex.style.background = 'radial-gradient(circle, rgba(0,0,0,0.9), rgba(78,205,196,0.6), transparent)';
                vortex.style.animation = 'omega-vortex 3s ease-out';
                vortex.style.borderRadius = '50%';
                overlay.appendChild(vortex);
            } else if (rarityName === 'Supreme') {
                // Golden rays
                for (let i = 0; i < 12; i++) {
                    const ray = document.createElement('div');
                    ray.style.position = 'absolute';
                    ray.style.width = '5px';
                    ray.style.height = '100%';
                    ray.style.left = '50%';
                    ray.style.top = '0';
                    ray.style.background = 'linear-gradient(to bottom, transparent, rgba(255,230,109,0.8), transparent)';
                    ray.style.transformOrigin = 'center top';
                    ray.style.transform = `rotate(${i * 30}deg)`;
                    ray.style.animation = 'supreme-rays 2s ease-out';
                    overlay.appendChild(ray);
                }
            } else if (rarityName === 'Godlike') {
                // Divine pillars
                for (let i = 0; i < 8; i++) {
                    const pillar = document.createElement('div');
                    pillar.style.position = 'absolute';
                    pillar.style.width = '100px';
                    pillar.style.height = '100%';
                    pillar.style.left = (i * 12.5) + '%';
                    pillar.style.background = 'linear-gradient(to top, rgba(255,0,255,0.6), rgba(255,0,255,0))';
                    pillar.style.animation = 'godlike-pillar 2.5s ease-out';
                    pillar.style.animationDelay = (i * 0.1) + 's';
                    overlay.appendChild(pillar);
                }
            } else if (rarityName === 'Universal') {
                // Galaxy spiral
                const spiral = document.createElement('div');
                spiral.style.position = 'absolute';
                spiral.style.width = '300px';
                spiral.style.height = '300px';
                spiral.style.left = '50%';
                spiral.style.top = '50%';
                spiral.style.transform = 'translate(-50%, -50%)';
                spiral.style.background = 'radial-gradient(circle, rgba(0,255,170,0.4), rgba(0,255,170,0.2), transparent)';
                spiral.style.animation = 'universal-spiral 3s ease-out';
                spiral.style.borderRadius = '50%';
                overlay.appendChild(spiral);
            } else if (rarityName === 'Multiversal') {
                // Reality fracture
                const fracture = document.createElement('div');
                fracture.style.position = 'absolute';
                fracture.style.width = '100%';
                fracture.style.height = '100%';
                fracture.style.background = 'linear-gradient(45deg, rgba(255,51,153,0.5), rgba(0,255,255,0.5))';
                fracture.style.animation = 'multiversal-fracture 2s ease-out';
                overlay.appendChild(fracture);
            } else if (rarityName === 'Omnipotent') {
                // World shake
                document.body.style.animation = 'omnipotent-shake 2s ease-out';
                setTimeout(() => {
                    document.body.style.animation = '';
                }, 2000);
                
                // Add intense light flash
                const flash = document.createElement('div');
                flash.style.position = 'absolute';
                flash.style.width = '100%';
                flash.style.height = '100%';
                flash.style.background = 'rgba(255,204,0,0.8)';
                flash.style.animation = 'multiversal-fracture 2s ease-out';
                overlay.appendChild(flash);
            } else if (rarityName === 'Infinite Absolute') {
                // Dual infinity spirals
                for (let i = 0; i < 8; i++) {
                    const spiral = document.createElement('div');
                    spiral.style.position = 'absolute';
                    spiral.style.width = '100px';
                    spiral.style.height = '100px';
                    spiral.style.left = '50%';
                    spiral.style.top = '50%';
                    spiral.style.transform = 'translate(-50%, -50%)';
                    spiral.style.background = `radial-gradient(circle, rgba(255,153,255,0.6), transparent)`;
                    spiral.style.borderRadius = '50%';
                    spiral.style.animation = 'infinite-absolute-spiral 3s ease-out';
                    spiral.style.animationDelay = (i * 0.2) + 's';
                    overlay.appendChild(spiral);
                }
            } else if (rarityName === 'Eternal') {
                // Time ripples
                for (let i = 0; i < 10; i++) {
                    const ripple = document.createElement('div');
                    ripple.style.position = 'absolute';
                    ripple.style.width = '50px';
                    ripple.style.height = '50px';
                    ripple.style.left = '50%';
                    ripple.style.top = '50%';
                    ripple.style.transform = 'translate(-50%, -50%)';
                    ripple.style.border = '3px solid rgba(102,255,255,0.7)';
                    ripple.style.borderRadius = '50%';
                    ripple.style.animation = 'eternal-ripple 3s ease-out';
                    ripple.style.animationDelay = (i * 0.3) + 's';
                    overlay.appendChild(ripple);
                }
            } else if (rarityName === 'Immortal') {
                // Phoenix rebirth
                for (let i = 0; i < 12; i++) {
                    const feather = document.createElement('div');
                    feather.style.position = 'absolute';
                    feather.style.width = '80px';
                    feather.style.height = '80px';
                    feather.style.left = '50%';
                    feather.style.top = '50%';
                    feather.style.background = `radial-gradient(circle, rgba(255,255,102,0.8), rgba(255,102,102,0.6))`;
                    feather.style.borderRadius = '50%';
                    feather.style.animation = 'immortal-rebirth 3s ease-out';
                    feather.style.animationDelay = (i * 0.15) + 's';
                    overlay.appendChild(feather);
                }
            } else if (rarityName === 'Ascended') {
                // Heavenly ascension
                for (let i = 0; i < 10; i++) {
                    const beam = document.createElement('div');
                    beam.style.position = 'absolute';
                    beam.style.width = '50px';
                    beam.style.height = '100%';
                    beam.style.left = (i * 10) + '%';
                    beam.style.background = 'linear-gradient(to top, transparent, rgba(255,102,102,0.6))';
                    beam.style.animation = 'ascended-rise 3s ease-out';
                    beam.style.animationDelay = (i * 0.1) + 's';
                    overlay.appendChild(beam);
                }
            } else if (rarityName === 'Transcendental') {
                // Reality layers
                for (let i = 0; i < 8; i++) {
                    const layer = document.createElement('div');
                    layer.style.position = 'absolute';
                    layer.style.width = '100%';
                    layer.style.height = '100%';
                    layer.style.background = `rgba(102,255,102,${0.1 + i * 0.05})`;
                    layer.style.animation = 'transcendental-layers 3s ease-out';
                    layer.style.animationDelay = (i * 0.2) + 's';
                    overlay.appendChild(layer);
                }
            } else if (rarityName === 'Boundless') {
                // Expanding boundaries
                for (let i = 0; i < 6; i++) {
                    const boundary = document.createElement('div');
                    boundary.style.position = 'absolute';
                    boundary.style.width = '200px';
                    boundary.style.height = '200px';
                    boundary.style.left = '50%';
                    boundary.style.top = '50%';
                    boundary.style.transform = 'translate(-50%, -50%)';
                    boundary.style.border = '5px solid rgba(102,102,255,0.6)';
                    boundary.style.animation = 'boundless-expand 3s ease-out';
                    boundary.style.animationDelay = (i * 0.3) + 's';
                    overlay.appendChild(boundary);
                }
            } else if (rarityName === 'Limitless') {
                // Breaking limits
                const limitBreak = document.createElement('div');
                limitBreak.style.position = 'absolute';
                limitBreak.style.width = '300px';
                limitBreak.style.height = '300px';
                limitBreak.style.left = '50%';
                limitBreak.style.top = '50%';
                limitBreak.style.transform = 'translate(-50%, -50%)';
                limitBreak.style.background = 'radial-gradient(circle, rgba(255,102,255,0.8), transparent)';
                limitBreak.style.borderRadius = '50%';
                limitBreak.style.animation = 'limitless-break 3s ease-out';
                overlay.appendChild(limitBreak);
                
                // Add 15 breaking particles
                for (let i = 0; i < 15; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'absolute';
                    particle.style.width = '20px';
                    particle.style.height = '20px';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.background = 'rgba(255,102,255,0.8)';
                    particle.style.borderRadius = '50%';
                    particle.style.animation = 'limitless-break 3s ease-out';
                    particle.style.animationDelay = (Math.random() * 0.5) + 's';
                    overlay.appendChild(particle);
                }
            } else if (rarityName === 'Absolute') {
                // Universe explosion - THE BIG ONE!
                const bigBang = document.createElement('div');
                bigBang.style.position = 'absolute';
                bigBang.style.width = '50px';
                bigBang.style.height = '50px';
                bigBang.style.left = '50%';
                bigBang.style.top = '50%';
                bigBang.style.transform = 'translate(-50%, -50%)';
                bigBang.style.background = 'radial-gradient(circle, rgba(255,255,255,1), rgba(255,215,0,0.8), rgba(255,0,255,0.6), transparent)';
                bigBang.style.animation = 'absolute-big-bang 4s ease-out';
                bigBang.style.borderRadius = '50%';
                overlay.appendChild(bigBang);
                
                // Shake everything
                document.body.style.animation = 'omnipotent-shake 4s ease-out';
                setTimeout(() => {
                    document.body.style.animation = '';
                }, 4000);
            } else if (rarityName === 'Beyond') {
                // Dimension tear
                const tear = document.createElement('div');
                tear.style.position = 'absolute';
                tear.style.width = '100%';
                tear.style.height = '100%';
                tear.style.background = 'linear-gradient(45deg, rgba(255,170,0,0.8), rgba(255,0,170,0.8))';
                tear.style.animation = 'beyond-tear 5s ease-out';
                overlay.appendChild(tear);
                
                document.body.style.animation = 'omnipotent-shake 5s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 5000);
            } else if (rarityName === 'Incomprehensible') {
                // Reality distortion
                const distortion = document.createElement('div');
                distortion.style.position = 'absolute';
                distortion.style.width = '100%';
                distortion.style.height = '100%';
                distortion.style.background = 'radial-gradient(circle, rgba(170,0,255,0.7), rgba(0,255,255,0.7))';
                distortion.style.animation = 'incomprehensible-distort 6s ease-out';
                overlay.appendChild(distortion);
                
                document.body.style.animation = 'incomprehensible-distort 6s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 6000);
            } else if (rarityName === 'Unimaginable') {
                // Kaleidoscope explosion - OPTIMIZED
                for (let i = 0; i < 10; i++) {
                    const piece = document.createElement('div');
                    piece.style.position = 'absolute';
                    piece.style.width = '80px';
                    piece.style.height = '80px';
                    piece.style.left = '50%';
                    piece.style.top = '50%';
                    piece.style.background = `hsl(${i * 36}, 100%, 50%)`;
                    piece.style.animation = 'unimaginable-kaleidoscope 7s ease-out';
                    piece.style.animationDelay = (i * 0.2) + 's';
                    piece.style.borderRadius = '50%';
                    overlay.appendChild(piece);
                }
                
                document.body.style.animation = 'omnipotent-shake 7s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 7000);
            } else if (rarityName === 'Impossible') {
                // THE ULTIMATE IMPOSSIBLE ANIMATION - OPTIMIZED
                const ultimate = document.createElement('div');
                ultimate.style.position = 'absolute';
                ultimate.style.width = '100%';
                ultimate.style.height = '100%';
                ultimate.style.background = 'radial-gradient(circle, rgba(255,0,102,1), rgba(0,170,255,1), rgba(255,255,0,1))';
                ultimate.style.animation = 'impossible-ultimate 10s ease-out';
                overlay.appendChild(ultimate);
                
                // Add 30 particles instead of 100
                for (let i = 0; i < 30; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'absolute';
                    particle.style.width = '20px';
                    particle.style.height = '20px';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    particle.style.animation = 'impossible-ultimate 10s ease-out';
                    particle.style.animationDelay = (Math.random() * 2) + 's';
                    particle.style.borderRadius = '50%';
                    overlay.appendChild(particle);
                }
                
                document.body.style.animation = 'impossible-ultimate 10s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 10000);
            } else if (rarityName === 'Paradox') {
                // Reality breaks - impossible contradictions
                const paradox = document.createElement('div');
                paradox.style.position = 'absolute';
                paradox.style.width = '100%';
                paradox.style.height = '100%';
                paradox.style.background = 'linear-gradient(45deg, rgba(0,255,153,0.8), rgba(255,0,153,0.8))';
                paradox.style.animation = 'paradox-break 12s ease-out';
                overlay.appendChild(paradox);
                
                document.body.style.animation = 'paradox-break 12s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 12000);
            } else if (rarityName === 'Singularity') {
                // Black hole collapse - everything to a point
                const singularity = document.createElement('div');
                singularity.style.position = 'absolute';
                singularity.style.width = '500px';
                singularity.style.height = '500px';
                singularity.style.left = '50%';
                singularity.style.top = '50%';
                singularity.style.transform = 'translate(-50%, -50%)';
                singularity.style.background = 'radial-gradient(circle, rgba(153,0,255,1), rgba(0,0,0,0.9))';
                singularity.style.borderRadius = '50%';
                singularity.style.animation = 'singularity-collapse 14s ease-out';
                overlay.appendChild(singularity);
                
                document.body.style.animation = 'omnipotent-shake 14s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 14000);
            } else if (rarityName === 'Void') {
                // Consume everything into darkness
                const voidDiv = document.createElement('div');
                voidDiv.style.position = 'absolute';
                voidDiv.style.width = '100%';
                voidDiv.style.height = '100%';
                voidDiv.style.animation = 'void-consume 16s ease-out';
                overlay.appendChild(voidDiv);
                
                document.body.style.animation = 'void-consume 16s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 16000);
            } else if (rarityName === 'Nothingness') {
                // Erase reality itself
                const nothing = document.createElement('div');
                nothing.style.position = 'absolute';
                nothing.style.width = '100%';
                nothing.style.height = '100%';
                nothing.style.background = 'rgba(17,17,17,0.95)';
                nothing.style.animation = 'nothingness-erase 18s ease-out';
                overlay.appendChild(nothing);
                
                document.body.style.animation = 'nothingness-erase 18s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 18000);
            } else if (rarityName === 'Everything') {
                // Create an entire universe - OPTIMIZED
                const everything = document.createElement('div');
                everything.style.position = 'absolute';
                everything.style.width = '100px';
                everything.style.height = '100px';
                everything.style.left = '50%';
                everything.style.top = '50%';
                everything.style.transform = 'translate(-50%, -50%)';
                everything.style.background = 'radial-gradient(circle, rgba(255,255,255,1), rgba(255,255,0,0.8), rgba(0,255,255,0.6))';
                everything.style.borderRadius = '50%';
                everything.style.animation = 'everything-create 20s ease-out';
                overlay.appendChild(everything);
                
                // Add 50 creation particles instead of 200
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'absolute';
                    particle.style.width = '15px';
                    particle.style.height = '15px';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    particle.style.animation = 'everything-create 20s ease-out';
                    particle.style.animationDelay = (Math.random() * 5) + 's';
                    particle.style.borderRadius = '50%';
                    overlay.appendChild(particle);
                }
                
                document.body.style.animation = 'omnipotent-shake 20s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 20000);
            } else if (rarityName === 'The End') {
                // Time stops
                const end = document.createElement('div');
                end.style.position = 'absolute';
                end.style.width = '100%';
                end.style.height = '100%';
                end.style.background = 'rgba(255,0,0,0.3)';
                end.style.animation = 'end-timestop 25s ease-out';
                overlay.appendChild(end);
                
                document.body.style.animation = 'end-timestop 25s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 25000);
            } else if (rarityName === 'The Beginning') {
                // The Big Bang itself
                const beginning = document.createElement('div');
                beginning.style.position = 'absolute';
                beginning.style.width = '10px';
                beginning.style.height = '10px';
                beginning.style.left = '50%';
                beginning.style.top = '50%';
                beginning.style.transform = 'translate(-50%, -50%)';
                beginning.style.background = 'radial-gradient(circle, rgba(0,255,0,1), rgba(255,255,255,0.9))';
                beginning.style.borderRadius = '50%';
                beginning.style.animation = 'beginning-bigbang 30s ease-out';
                overlay.appendChild(beginning);
                
                document.body.style.animation = 'omnipotent-shake 30s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 30000);
            } else if (rarityName === 'Alpha Omega') {
                // Start and End merge
                const alphaomega = document.createElement('div');
                alphaomega.style.position = 'absolute';
                alphaomega.style.width = '100%';
                alphaomega.style.height = '100%';
                alphaomega.style.background = 'linear-gradient(90deg, rgba(255,255,0,0.8), rgba(0,0,0,0.8))';
                alphaomega.style.animation = 'alphaomega-merge 35s ease-out';
                overlay.appendChild(alphaomega);
                
                document.body.style.animation = 'alphaomega-merge 35s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 35000);
            } else if (rarityName === 'True Infinity') {
                // Endless recursion - OPTIMIZED
                const infinity = document.createElement('div');
                infinity.style.position = 'absolute';
                infinity.style.width = '200px';
                infinity.style.height = '200px';
                infinity.style.left = '50%';
                infinity.style.top = '50%';
                infinity.style.transform = 'translate(-50%, -50%)';
                infinity.style.background = 'radial-gradient(circle, rgba(255,0,255,1), transparent)';
                infinity.style.borderRadius = '50%';
                infinity.style.animation = 'infinity-recursion 40s ease-out';
                overlay.appendChild(infinity);
                
                // Add 20 recursive circles instead of 50
                for (let i = 0; i < 20; i++) {
                    const circle = document.createElement('div');
                    circle.style.position = 'absolute';
                    circle.style.width = (200 - i * 10) + 'px';
                    circle.style.height = (200 - i * 10) + 'px';
                    circle.style.left = '50%';
                    circle.style.top = '50%';
                    circle.style.transform = 'translate(-50%, -50%)';
                    circle.style.border = '2px solid rgba(255,0,255,0.5)';
                    circle.style.borderRadius = '50%';
                    circle.style.animation = 'infinity-recursion 40s ease-out';
                    circle.style.animationDelay = (i * 0.2) + 's';
                    overlay.appendChild(circle);
                }
                
                document.body.style.animation = 'infinity-recursion 40s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 40000);
            } else if (rarityName === 'The One') {
                // EXISTENCE ITSELF - THE ULTIMATE ULTIMATE - OPTIMIZED
                const theone = document.createElement('div');
                theone.style.position = 'absolute';
                theone.style.width = '100px';
                theone.style.height = '100px';
                theone.style.left = '50%';
                theone.style.top = '50%';
                theone.style.transform = 'translate(-50%, -50%)';
                theone.style.background = 'radial-gradient(circle, white, rgba(255,255,255,0))';
                theone.style.borderRadius = '50%';
                theone.style.boxShadow = '0 0 200px 100px white';
                theone.style.animation = 'theone-existence 30s ease-out';
                overlay.appendChild(theone);
                
                // Add 30 existence particles instead of 500
                for (let i = 0; i < 30; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'absolute';
                    particle.style.width = '25px';
                    particle.style.height = '25px';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    particle.style.animation = 'theone-existence 30s ease-out';
                    particle.style.animationDelay = (Math.random() * 5) + 's';
                    particle.style.borderRadius = '50%';
                    particle.style.boxShadow = `0 0 30px 15px hsl(${Math.random() * 360}, 100%, 50%)`;
                    overlay.appendChild(particle);
                }
                
                document.body.style.animation = 'theone-existence 30s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 30000);
            } else if (rarityName === 'Admin') {
                // ADMIN - RESTRICTED ACCESS - RED ALERT
                document.body.style.animation = 'screen-shake 1s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 1000);
                
                const warning = document.createElement('div');
                warning.style.position = 'absolute';
                warning.style.width = '100%';
                warning.style.height = '100%';
                warning.style.background = 'rgba(255,0,0,0.3)';
                warning.style.animation = 'multiversal-fracture 3s ease-out';
                overlay.appendChild(warning);
                
                // Admin console lines
                for (let i = 0; i < 20; i++) {
                    const line = document.createElement('div');
                    line.style.position = 'absolute';
                    line.style.width = '100%';
                    line.style.height = '2px';
                    line.style.left = '0';
                    line.style.top = (i * 5) + '%';
                    line.style.background = '#ff0000';
                    line.style.animation = 'admin-scan 2s ease-out';
                    line.style.animationDelay = (i * 0.05) + 's';
                    overlay.appendChild(line);
                }
                
                // Forbidden symbol
                const symbol = document.createElement('div');
                symbol.style.position = 'absolute';
                symbol.style.width = '200px';
                symbol.style.height = '200px';
                symbol.style.left = '50%';
                symbol.style.top = '50%';
                symbol.style.transform = 'translate(-50%, -50%)';
                symbol.style.border = '10px solid #ff0000';
                symbol.style.borderRadius = '50%';
                symbol.style.animation = 'admin-pulse 2s ease-out infinite';
                symbol.innerHTML = '<div style="position: absolute; width: 100%; height: 10px; background: #ff0000; top: 50%; transform: translateY(-50%) rotate(45deg);"></div><div style="position: absolute; width: 100%; height: 10px; background: #ff0000; top: 50%; transform: translateY(-50%) rotate(-45deg);"></div>';
                overlay.appendChild(symbol);
            } else if (rarityName === 'Primeval') {
                // PRIMEVAL - ANCIENT BEYOND TIME
                for (let i = 0; i < 40; i++) {
                    const ancient = document.createElement('div');
                    ancient.style.position = 'absolute';
                    ancient.style.width = '30px';
                    ancient.style.height = '30px';
                    ancient.style.left = Math.random() * 100 + '%';
                    ancient.style.top = Math.random() * 100 + '%';
                    ancient.style.background = 'radial-gradient(circle, #8b4513, transparent)';
                    ancient.style.borderRadius = '50%';
                    ancient.style.animation = 'primeval-ancient 4s ease-out';
                    ancient.style.animationDelay = (Math.random() * 1) + 's';
                    overlay.appendChild(ancient);
                }
            } else if (rarityName === 'Celestial Prime') {
                // CELESTIAL PRIME - HEAVENLY ROYALTY
                for (let i = 0; i < 12; i++) {
                    const star = document.createElement('div');
                    star.style.position = 'absolute';
                    star.style.width = '50px';
                    star.style.height = '50px';
                    star.style.left = '50%';
                    star.style.top = '50%';
                    star.style.transform = 'translate(-50%, -50%)';
                    star.style.background = 'radial-gradient(circle, #4169e1, transparent)';
                    star.style.borderRadius = '50%';
                    star.style.animation = 'celestial-prime-burst 3s ease-out';
                    star.style.animationDelay = (i * 0.1) + 's';
                    overlay.appendChild(star);
                }
            } else if (rarityName === 'Quantum') {
                // QUANTUM - SUPERPOSITION
                for (let i = 0; i < 30; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'absolute';
                    particle.style.width = '20px';
                    particle.style.height = '20px';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.background = '#00ffff';
                    particle.style.borderRadius = '50%';
                    particle.style.animation = 'quantum-flicker 2s ease-out infinite';
                    particle.style.animationDelay = (Math.random() * 0.5) + 's';
                    overlay.appendChild(particle);
                }
            } else if (rarityName === 'Dimensional') {
                // DIMENSIONAL - REALITY LAYERS
                for (let i = 0; i < 10; i++) {
                    const layer = document.createElement('div');
                    layer.style.position = 'absolute';
                    layer.style.width = '100%';
                    layer.style.height = '100%';
                    layer.style.background = `rgba(147,112,219,${0.1 * (10-i)})`;
                    layer.style.animation = 'dimensional-shift 3s ease-out';
                    layer.style.animationDelay = (i * 0.2) + 's';
                    overlay.appendChild(layer);
                }
            } else if (rarityName === 'Hyperversal' || rarityName === 'Outerversal') {
                // HYPERVERSAL / OUTERVERSAL - BEYOND DIMENSIONS
                const hyper = document.createElement('div');
                hyper.style.position = 'absolute';
                hyper.style.width = '100%';
                hyper.style.height = '100%';
                hyper.style.background = `linear-gradient(45deg, ${rarityName === 'Hyperversal' ? '#ff1493' : '#00ff00'}, transparent)`;
                hyper.style.animation = 'hyper-warp 4s ease-out';
                overlay.appendChild(hyper);
            } else if (rarityName === 'The Source' || rarityName === 'The Eternal' || rarityName === 'The Absolute Infinity') {
                // THE SOURCE / THE ETERNAL / THE ABSOLUTE INFINITY
                const divine = document.createElement('div');
                divine.style.position = 'absolute';
                divine.style.width = '300px';
                divine.style.height = '300px';
                divine.style.left = '50%';
                divine.style.top = '50%';
                divine.style.transform = 'translate(-50%, -50%)';
                divine.style.background = 'radial-gradient(circle, rgba(255,215,0,0.8), transparent)';
                divine.style.borderRadius = '50%';
                divine.style.boxShadow = '0 0 200px 100px rgba(255,215,0,0.5)';
                divine.style.animation = 'divine-presence 5s ease-out';
                overlay.appendChild(divine);
            } else if (rarityName === 'Beyond Infinity') {
                // BEYOND INFINITY - THE FINAL TIER
                document.body.style.animation = 'theone-existence 5s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 5000);
                
                for (let i = 0; i < 50; i++) {
                    const infinity = document.createElement('div');
                    infinity.style.position = 'absolute';
                    infinity.style.width = '30px';
                    infinity.style.height = '30px';
                    infinity.style.left = Math.random() * 100 + '%';
                    infinity.style.top = Math.random() * 100 + '%';
                    infinity.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    infinity.style.borderRadius = '50%';
                    infinity.style.boxShadow = `0 0 50px 25px hsl(${Math.random() * 360}, 100%, 50%)`;
                    infinity.style.animation = 'beyond-infinity-explosion 5s ease-out';
                    infinity.style.animationDelay = (Math.random() * 2) + 's';
                    overlay.appendChild(infinity);
                }
            } else if (rarityName === 'Boundaryless' || rarityName === 'Formless' || rarityName === 'Abstract') {
                // BOUNDARYLESS / FORMLESS / ABSTRACT - NO LIMITS
                const colors = { 'Boundaryless': '#ff4500', 'Formless': '#a9a9a9', 'Abstract': '#dda0dd' };
                for (let i = 0; i < 20; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'absolute';
                    particle.style.width = '40px';
                    particle.style.height = '40px';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.background = `radial-gradient(circle, ${colors[rarityName]}, transparent)`;
                    particle.style.borderRadius = Math.random() > 0.5 ? '50%' : '0%';
                    particle.style.animation = 'fade-pulse 3s ease-out';
                    particle.style.animationDelay = (Math.random() * 1) + 's';
                    overlay.appendChild(particle);
                }
            } else if (rarityName === 'Conceptual' || rarityName === 'Metaphysical') {
                // CONCEPTUAL / METAPHYSICAL - PURE IDEAS
                const colors = { 'Conceptual': '#7fffd4', 'Metaphysical': '#dc143c' };
                const orb = document.createElement('div');
                orb.style.position = 'absolute';
                orb.style.width = '200px';
                orb.style.height = '200px';
                orb.style.left = '50%';
                orb.style.top = '50%';
                orb.style.transform = 'translate(-50%, -50%)';
                orb.style.background = `radial-gradient(circle, ${colors[rarityName]}, transparent)`;
                orb.style.borderRadius = '50%';
                orb.style.boxShadow = `0 0 150px 75px ${colors[rarityName]}`;
                orb.style.animation = 'divine-presence 3s ease-out';
                overlay.appendChild(orb);
            } else if (rarityName === 'Shaw') {
                // SHAW - EXCLUSIVE CODE-ONLY RARITY!
                document.body.style.animation = 'screen-shake 2s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 2000);
                
                // Pink explosion effect
                for (let i = 0; i < 30; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'absolute';
                    particle.style.width = '30px';
                    particle.style.height = '30px';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.background = 'radial-gradient(circle, #ff1493, transparent)';
                    particle.style.borderRadius = '50%';
                    particle.style.animation = 'fade-pulse 2s ease-out';
                    particle.style.animationDelay = (Math.random() * 0.5) + 's';
                    overlay.appendChild(particle);
                }
                
                // Shaw text
                const text = document.createElement('div');
                text.style.position = 'absolute';
                text.style.width = '100%';
                text.style.top = '50%';
                text.style.transform = 'translateY(-50%)';
                text.style.textAlign = 'center';
                text.style.fontSize = '4rem';
                text.style.fontWeight = 'bold';
                text.style.color = '#ff1493';
                text.style.textShadow = '0 0 30px #ff1493';
                text.style.animation = 'divine-presence 2s ease-out';
                text.textContent = '⭐ SHAW ⭐';
                overlay.appendChild(text);
            } else if (rarityName === 'Infinite Beyond' || rarityName === 'Transcendent Infinity') {
                // NEW ULTRA-HIGH RARITIES
                const colors = { 'Infinite Beyond': '#00ffff', 'Transcendent Infinity': '#ff69b4' };
                for (let i = 0; i < 40; i++) {
                    const star = document.createElement('div');
                    star.style.position = 'absolute';
                    star.style.width = '25px';
                    star.style.height = '25px';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    star.style.background = `radial-gradient(circle, ${colors[rarityName]}, transparent)`;
                    star.style.borderRadius = '50%';
                    star.style.boxShadow = `0 0 40px 20px ${colors[rarityName]}`;
                    star.style.animation = 'beyond-infinity-explosion 5s ease-out';
                    star.style.animationDelay = (Math.random() * 2) + 's';
                    overlay.appendChild(star);
                }
            } else if (rarityName === 'Omniversal' || rarityName === 'Absolute Beyond') {
                // OMNIVERSAL / ABSOLUTE BEYOND
                const colors = { 'Omniversal': '#9400d3', 'Absolute Beyond': '#ffd700' };
                const bigOrb = document.createElement('div');
                bigOrb.style.position = 'absolute';
                bigOrb.style.width = '300px';
                bigOrb.style.height = '300px';
                bigOrb.style.left = '50%';
                bigOrb.style.top = '50%';
                bigOrb.style.transform = 'translate(-50%, -50%)';
                bigOrb.style.background = `radial-gradient(circle, ${colors[rarityName]}, transparent)`;
                bigOrb.style.borderRadius = '50%';
                bigOrb.style.boxShadow = `0 0 200px 100px ${colors[rarityName]}`;
                bigOrb.style.animation = 'theone-existence 5s ease-out';
                overlay.appendChild(bigOrb);
            } else if (rarityName === 'The Totality' || rarityName === 'The Omnipotent') {
                // THE TOTALITY / THE OMNIPOTENT - NEAR ULTIMATE
                const colors = { 'The Totality': '#ff1493', 'The Omnipotent': '#00ff00' };
                document.body.style.animation = 'omnipotent-shake 5s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 5000);
                
                for (let i = 0; i < 50; i++) {
                    const sphere = document.createElement('div');
                    sphere.style.position = 'absolute';
                    sphere.style.width = '35px';
                    sphere.style.height = '35px';
                    sphere.style.left = Math.random() * 100 + '%';
                    sphere.style.top = Math.random() * 100 + '%';
                    sphere.style.background = `radial-gradient(circle, ${colors[rarityName]}, transparent)`;
                    sphere.style.borderRadius = '50%';
                    sphere.style.boxShadow = `0 0 60px 30px ${colors[rarityName]}`;
                    sphere.style.animation = 'everything-create 5s ease-out';
                    sphere.style.animationDelay = (Math.random() * 2) + 's';
                    overlay.appendChild(sphere);
                }
            } else if (rarityName === 'Reality Itself') {
                // REALITY ITSELF - 1 IN 1 SEPTILLION!!! THE ULTIMATE!
                document.body.style.animation = 'omnipotent-shake 5s ease-out';
                setTimeout(() => { document.body.style.animation = ''; }, 5000);
                
                // White explosion
                const core = document.createElement('div');
                core.style.position = 'absolute';
                core.style.width = '150px';
                core.style.height = '150px';
                core.style.left = '50%';
                core.style.top = '50%';
                core.style.transform = 'translate(-50%, -50%)';
                core.style.background = 'radial-gradient(circle, white, rgba(255,255,255,0))';
                core.style.borderRadius = '50%';
                core.style.boxShadow = '0 0 300px 150px white';
                core.style.animation = 'theone-existence 5s ease-out';
                overlay.appendChild(core);
                
                // Reality particles - 60 of them
                for (let i = 0; i < 60; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'absolute';
                    particle.style.width = '40px';
                    particle.style.height = '40px';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    particle.style.borderRadius = '50%';
                    particle.style.boxShadow = `0 0 80px 40px hsl(${Math.random() * 360}, 100%, 50%)`;
                    particle.style.animation = 'beyond-infinity-explosion 5s ease-out';
                    particle.style.animationDelay = (Math.random() * 2) + 's';
                    overlay.appendChild(particle);
                }
            }
            
            // Remove overlay after animation (ALL ANIMATIONS NOW 5 SECONDS OR LESS!)
            const duration = rarityName === 'Reality Itself' ? 5000 :
                           rarityName === 'The Omnipotent' || rarityName === 'The Totality' ? 5000 :
                           rarityName === 'Absolute Beyond' || rarityName === 'Omniversal' ? 5000 :
                           rarityName === 'Transcendent Infinity' || rarityName === 'Infinite Beyond' ? 5000 :
                           rarityName === 'Beyond Infinity' ? 5000 :
                           rarityName === 'The Absolute Infinity' || rarityName === 'The Source' || rarityName === 'The Eternal' ? 5000 :
                           rarityName === 'Hyperversal' || rarityName === 'Outerversal' ? 4000 :
                           rarityName === 'Quantum' || rarityName === 'Dimensional' ? 4000 :
                           rarityName === 'Celestial Prime' ? 3000 :
                           rarityName === 'Primeval' ? 3000 :
                           rarityName === 'Admin' ? 3000 :
                           rarityName === 'Shaw' ? 2000 :
                           rarityName === 'The One' ? 5000 :
                           rarityName === 'True Infinity' ? 5000 :
                           rarityName === 'Alpha Omega' ? 5000 :
                           rarityName === 'The Beginning' ? 5000 :
                           rarityName === 'The End' ? 4000 :
                           rarityName === 'Everything' ? 4000 :
                           rarityName === 'Nothingness' ? 4000 :
                           rarityName === 'Void' ? 4000 :
                           rarityName === 'Singularity' ? 4000 :
                           rarityName === 'Paradox' ? 3000 :
                           rarityName === 'Impossible' ? 3000 : 
                           rarityName === 'Unimaginable' ? 3000 : 
                           rarityName === 'Incomprehensible' ? 3000 : 
                           rarityName === 'Beyond' ? 3000 : 
                           rarityName === 'Absolute' ? 3000 : 
                           rarityName === 'Limitless' ? 3000 :
                           rarityName === 'Boundless' || rarityName === 'Formless' || rarityName === 'Abstract' ? 3000 :
                           rarityName === 'Conceptual' || rarityName === 'Metaphysical' ? 3000 :
                           rarityName === 'Transcendental' ? 3000 :
                           rarityName === 'Ascended' ? 3000 :
                           rarityName === 'Immortal' ? 3000 :
                           rarityName === 'Eternal' ? 3000 :
                           rarityName === 'Infinite Absolute' ? 3000 :
                           rarityName === 'Ethereal' || rarityName === 'Omega' || rarityName === 'Universal' ? 3000 : 
                           rarityName === 'Godlike' ? 2500 : 2000;
            
            setTimeout(() => {
                overlay.remove();
                
                // Show result display
                const rarity = rarities.find(r => r.name === rarityName);
                const chance = Math.round(1 / rarity.chance);
                
                // Special titles for ultra-rare items
                let title = '🎉 ULTRA RARE PULL! 🎉';
                if (rarityName === 'The One') {
                    title = '⭐ EXISTENCE ITSELF ⭐';
                } else if (rarityName === 'True Infinity') {
                    title = '♾️ INFINITE POWER ♾️';
                } else if (rarityName === 'Alpha Omega') {
                    title = '🌌 BEGINNING AND END 🌌';
                } else if (rarityName === 'The Beginning') {
                    title = '🌅 THE FIRST LIGHT 🌅';
                } else if (rarityName === 'The End') {
                    title = '🌑 FINAL MOMENT 🌑';
                } else if (rarityName === 'Everything') {
                    title = '🌟 UNIVERSE CREATED 🌟';
                } else if (rarityName === 'Void') {
                    title = '🖤 CONSUMED BY VOID 🖤';
                } else if (rarityName === 'Impossible') {
                    title = '❌ IMPOSSIBILITY ACHIEVED ❌';
                } else if (chance >= 1000000000) {
                    title = '💎 LEGENDARY JACKPOT 💎';
                }
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'animation-result';
                resultDiv.style.cursor = 'pointer';
                resultDiv.innerHTML = `
                    <div class="animation-result-title">${title}</div>
                    <div class="animation-result-item" style="color: ${rarityColor};">${itemName}</div>
                    <div class="animation-result-rarity" style="color: ${rarityColor};">${rarityName}</div>
                    <div class="animation-result-chance">1 in ${formatNumber(chance)} chance</div>
                    <div style="margin-top: 20px; color: var(--accent-gold); font-size: 1.2rem;">Value: $${formatNumber(itemValue)}</div>
                    <div style="margin-top: 15px; color: var(--text-secondary); font-size: 0.9rem;">(Click to dismiss)</div>
                `;
                document.body.appendChild(resultDiv);
                
                // Click to dismiss
                const dismissResult = () => {
                    resultDiv.style.animation = 'resultFadeIn 0.5s ease-out reverse';
                    setTimeout(() => resultDiv.remove(), 500);
                };
                resultDiv.onclick = dismissResult;
            }, duration);
        }
        
        function generateItemName(rarity) {
            const namePool = itemNames[rarity.name] || itemNames['Common'];
            const prefix = namePool.prefixes[Math.floor(Math.random() * namePool.prefixes.length)];
            const item = namePool.items[Math.floor(Math.random() * namePool.items.length)];
            return `${prefix} ${item}`;
        }
        
        function addItemToInventory(name, rarity) {
            let value = Math.floor(Math.random() * (rarity.maxValue - rarity.minValue + 1)) + rarity.minValue;
            
            // Apply valueBoost upgrade
            if (gameState.upgrades.valueBoost > 0) {
                const boostMultiplier = 1 + (gameState.upgrades.valueBoost * 0.05); // 5% per level
                value = Math.floor(value * boostMultiplier);
            }
            
            const fullName = `${name} (${rarity.name})`;
            
            if (gameState.inventory[fullName]) {
                gameState.inventory[fullName].count++;
            } else {
                gameState.inventory[fullName] = {
                    name: name,
                    rarity: rarity.name,
                    color: rarity.color,
                    value: value,
                    count: 1
                };
            }
            
            gameState.totalValue += value;
            
            // Check for auto-fusion
            checkAutoFusion();
            
            // Check collection bonuses and rarity milestones
            checkCollectionBonuses();
            checkRarityMilestones();
            
            // Trigger ultra-rare animation for Cosmic and beyond (1 in 1024+)
            const rarityIndex = rarities.findIndex(r => r.name === rarity.name);
            if (rarityIndex >= 9) { // Index 9 is Cosmic
                triggerUltraRareAnimation(rarity.name, rarity.color, name, value);
                playSound('ultra_rare');
            } else if (rarityIndex >= 4) { // Legendary+
                playSound('rare');
            } else {
                playSound('spin');
            }
            
            // Display result
            const resultDiv = document.getElementById('resultDisplay');
            resultDiv.innerHTML = `
                <div class="item-display" style="background: ${rarity.color}; color: ${rarity.name === 'Common' ? 'black' : 'white'};">
                    ${fullName}
                </div>
                <div style="color: var(--accent-gold); font-size: 1.2rem; margin-top: 10px;">
                    Value: $${formatNumber(value)}
                </div>
                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px;">
                    Chance: 1 in ${formatNumber(Math.round(1/rarities.find(r => r.name === rarity.name).chance))}
                </div>
            `;
            
            showNotification(`You got: ${fullName}!`, rarity.color);
        }
        
        function getPetLuckBonus() {
            if (!gameState.activePet) return 1.0;
            
            // Define pet bonuses
            const petBonuses = {
                'divine_dragon': 1.15, // +15% luck (from RNG_GODLY code)
                // Add other pets here
            };
            
            return petBonuses[gameState.activePet] || 1.0;
        }
        
        function updateStats() {
            const moneyEl = document.getElementById('money');
            const totalValueEl = document.getElementById('totalValue');
            const totalSpinsEl = document.getElementById('totalSpins');
            const luckMultiplierEl = document.getElementById('luckMultiplier');
            const tradeWinsEl = document.getElementById('tradeWins');
            
            if (moneyEl) moneyEl.textContent = '$' + formatNumber(gameState.money);
            if (totalValueEl) totalValueEl.textContent = '$' + formatNumber(gameState.totalValue);
            if (totalSpinsEl) totalSpinsEl.textContent = formatNumber(gameState.totalSpins);
            
            const combinedLuck = gameState.luckMultiplier * gameState.permanentLuckBoost;
            if (luckMultiplierEl) luckMultiplierEl.textContent = combinedLuck.toFixed(1) + 'x';
            if (tradeWinsEl) tradeWinsEl.textContent = formatNumber(gameState.tradeWins);
            
            updatePityDisplay();
            
            // Update boss display if on bosses tab (so buttons update when money changes)
            const bossesTab = document.getElementById('bosses');
            if (bossesTab && bossesTab.classList.contains('active')) {
                updateBossesDisplay();
            }
            
            // Update artifacts display if on artifacts tab
            const artifactsTab = document.getElementById('artifacts');
            if (artifactsTab && artifactsTab.classList.contains('active')) {
                updateArtifactsDisplay();
            }
        }
        
        function updatePityDisplay() {
            const counter = document.getElementById('pityCounterDisplay');
            const progressBar = document.getElementById('pityProgressBar');
            
            if (counter && progressBar) {
                const pityCount = gameState.pityCounter || 0;
                const pityThreshold = gameState.pityThreshold || 100;
                const pityPercent = Math.min(100, (pityCount / pityThreshold) * 100);
                
                counter.textContent = `${pityCount} / ${pityThreshold}`;
                progressBar.style.width = `${pityPercent}%`;
                progressBar.innerHTML = `<span style="font-size: 0.85rem; font-weight: bold;">${pityPercent.toFixed(0)}%</span>`;
                
                // Change color as it gets closer to pity
                if (pityPercent >= 90) {
                    progressBar.style.background = 'linear-gradient(90deg, #ff0000 0%, #ff6600 100%)';
                } else if (pityPercent >= 70) {
                    progressBar.style.background = 'linear-gradient(90deg, #ff6600 0%, var(--accent-gold) 100%)';
                } else {
                    progressBar.style.background = 'linear-gradient(90deg, var(--warning) 0%, var(--accent-gold) 100%)';
                }
            }
        }
        
        function updateInventory() {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = '';
            
            // Get and sort/filter inventory
            let items = Object.entries(gameState.inventory).filter(([key, item]) => item.count > 0);
            
            // Apply filter
            const filterType = gameState.inventoryFilter || 'all';
            if (filterType !== 'all') {
                items = items.filter(([key, item]) => {
                    // Rarity filters
                    if (filterType === 'common') return item.rarity === 'Common';
                    if (filterType === 'uncommon') return item.rarity === 'Uncommon';
                    if (filterType === 'rare') return item.rarity === 'Rare';
                    if (filterType === 'epic') return item.rarity === 'Epic';
                    if (filterType === 'legendary') return item.rarity === 'Legendary';
                    if (filterType === 'mythic') return item.rarity === 'Mythic';
                    if (filterType === 'exotic') return item.rarity === 'Exotic';
                    if (filterType === 'celestial') return item.rarity === 'Celestial';
                    if (filterType === 'divine') return item.rarity === 'Divine';
                    if (filterType === 'cosmic') return item.rarity === 'Cosmic';
                    if (filterType === 'infinite') return item.rarity === 'Infinite';
                    if (filterType === 'transcendent') return item.rarity === 'Transcendent';
                    if (filterType === 'ethereal') return item.rarity === 'Ethereal';
                    if (filterType === 'primordial') {
                        // Primordial+ includes Primordial and all higher rarities
                        const rarityIndex = rarities.findIndex(r => r.name === item.rarity);
                        return rarityIndex >= 13; // Primordial is index 13
                    }
                    
                    // Type filters
                    if (filterType === 'event') {
                        return key.includes('🪩') || key.includes('🌌') || key.includes('⚡') || 
                               key.includes('🌕') || key.includes('🔴') || key.includes('☁️') || 
                               key.includes('🌧️') || key.includes('⛈️') || key.includes('🎄');
                    } else if (filterType === 'christmas') {
                        return key.includes('🎄') || key.includes('🎅') || key.includes('⛄') || 
                               key.includes('🎁') || key.includes('🔔') || key.includes('🕯️');
                    } else if (filterType === 'disco') {
                        return key.includes('🪩') || key.includes('🕺') || key.includes('💃') || 
                               key.includes('🎵') || key.includes('✨') || key.includes('🎶');
                    } else if (filterType === 'galactic') {
                        return key.includes('🌌') || key.includes('⭐') || key.includes('🌠') || 
                               key.includes('🪐') || key.includes('🌟') || key.includes('🔭');
                    } else if (filterType === 'glitch') {
                        return key.includes('⚡') || key.includes('🔲') || key.includes('📟') || 
                               key.includes('💾') || key.includes('🖥️') || key.includes('⌨️');
                    } else if (filterType === 'fullmoon') {
                        return key.includes('🌕') || key.includes('🐺') || key.includes('🌙') || 
                               key.includes('🌛') || key.includes('🔮');
                    } else if (filterType === 'bloodmoon') {
                        return key.includes('🔴') || key.includes('🩸') || key.includes('🌑') || 
                               key.includes('⚔️') || key.includes('💀') || key.includes('👁️');
                    } else if (filterType === 'weather') {
                        return key.includes('☁️') || key.includes('🌧️') || key.includes('⛈️');
                    } else if (filterType === 'battlepass') {
                        // Battle pass items don't have specific markers, so this shows all for now
                        return true;
                    }
                    return true;
                });
            }
            
            // Apply sort
            const sortType = gameState.inventorySort || 'rarity';
            if (sortType === 'rarity') {
                items.sort((a, b) => {
                    const rarityA = rarities.findIndex(r => r.name === a[1].rarity);
                    const rarityB = rarities.findIndex(r => r.name === b[1].rarity);
                    return rarityB - rarityA; // Higher rarity first
                });
            } else if (sortType === 'value') {
                items.sort((a, b) => b[1].value - a[1].value); // Higher value first
            } else if (sortType === 'count') {
                items.sort((a, b) => b[1].count - a[1].count); // Higher count first
            }
            
            // Display items
            for (const [key, item] of items) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item' + (gameState.flexedItem === key ? ' flexed' : '');
                itemDiv.style.borderColor = item.color;
                itemDiv.onclick = () => flexItem(key);
                itemDiv.oncontextmenu = (e) => {
                    e.preventDefault();
                    sellItem(key);
                };
                
                // Mobile long-press to sell
                let pressTimer;
                itemDiv.ontouchstart = (e) => {
                    pressTimer = setTimeout(() => {
                        sellItem(key);
                        navigator.vibrate && navigator.vibrate(50); // Haptic feedback
                    }, 500); // 500ms long press
                };
                itemDiv.ontouchend = () => {
                    clearTimeout(pressTimer);
                };
                itemDiv.ontouchmove = () => {
                    clearTimeout(pressTimer);
                };
                
                // Build detailed tooltip for hover
                let tooltipText = `${item.name} (${item.rarity})\nCount: ${item.count}\nValue: $${formatNumber(item.value)} each`;
                if (item.enchantments && item.enchantments.length > 0) {
                    tooltipText += `\nEnchantments: ${item.enchantments.join(', ')}`;
                }
                tooltipText += `\nTotal Value: $${formatNumber(item.value * item.count)}`;
                tooltipText += `\n\nLeft-click: Flex | Right-click: Sell`;
                
                itemDiv.title = tooltipText;
                
                // Show enchantments if present
                let enchantDisplay = '';
                if (item.enchantments && item.enchantments.length > 0) {
                    const enchantList = item.enchantments.map(e => {
                        const enchantData = enchantments[e];
                        const color = enchantData.type === 'ultimate' ? '#ff00ff' : 
                                     enchantData.type === 'godly' ? 'var(--accent-gold)' : 
                                     enchantData.type === 'bad' ? 'var(--danger)' : 
                                     'var(--accent-primary)';
                        return `<span style="color: ${color};">✨${e}</span>`;
                    }).join(' ');
                    enchantDisplay = `<div style="font-size: 0.65rem; margin-top: 3px;">${enchantList}</div>`;
                }
                
                const isFavorited = gameState.favoriteItems && gameState.favoriteItems.includes(key);
                
                itemDiv.innerHTML = `
                    ${item.count > 1 ? `<div class="item-count">${item.count}</div>` : ''}
                    <button onclick="event.stopPropagation(); toggleFavorite('${key}')" 
                            style="position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 1.3rem; cursor: pointer; padding: 5px; z-index: 10;"
                            title="${isFavorited ? 'Unfavorite' : 'Favorite (protect from selling)'}">
                        ${isFavorited ? '⭐' : '☆'}
                    </button>
                    <div style="font-size: 2rem;">💎</div>
                    <div class="item-name" style="color: ${item.color};">${item.name}</div>
                    <div style="font-size: 0.8rem; color: ${item.color};">${item.rarity}</div>
                    <div class="item-value">$${formatNumber(item.value)}</div>
                    ${enchantDisplay}
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 5px;">Tap: Flex | Long-press/Right-click: Sell</div>
                `;
                grid.appendChild(itemDiv);
            }
        }
        
        function sellItem(itemKey) {
            const item = gameState.inventory[itemKey];
            if (!item || item.count === 0) return;
            
            // Check if favorited
            if (gameState.favoriteItems && gameState.favoriteItems.includes(itemKey)) {
                showNotification('⭐ Item is favorited! Unfavorite to sell.', 'var(--warning)');
                return;
            }
            
            // Confirmation for high-rarity items (Mythic and above)
            const rarityIndex = rarities.findIndex(r => r.name === item.rarity);
            if (rarityIndex >= 5 && gameState.settings && gameState.settings.confirmSell !== false) { // Mythic is index 5
                if (!confirm(`Sell ${item.name} (${item.rarity}) for $${Math.floor(item.value * 0.7)}?`)) {
                    return;
                }
            }
            
            let sellMultiplier = 0.7; // Base 70% sell value
            let hasEventStarter = false;
            
            // Check for enchantments that affect selling
            if (item.enchantments && item.enchantments.length > 0) {
                for (const enchantName of item.enchantments) {
                    const enchantData = enchantments[enchantName];
                    if (enchantData && enchantData.effect.sellMultiplier) {
                        sellMultiplier *= enchantData.effect.sellMultiplier;
                    }
                    if (enchantData && enchantData.effect.eventStarter) {
                        hasEventStarter = true;
                    }
                }
            }
            
            // Apply sell price upgrade
            if (gameState.upgrades.sellPrice > 0) {
                sellMultiplier *= (1 + gameState.upgrades.sellPrice * 0.02); // +2% per level
            }
            
            const sellPrice = Math.floor(item.value * sellMultiplier);
            gameState.money += sellPrice;
            playSound('coin');
            gameState.lifetimeMoneyEarned = (gameState.lifetimeMoneyEarned || 0) + sellPrice;
            gameState.totalValue -= item.value;
            item.count--;
            
            // Track money earned for quests and challenges
            updateQuestProgress('moneyEarned', sellPrice);
            updateDailyChallengeProgress('moneyEarned', sellPrice);
            
            if (gameState.flexedItem === itemKey && item.count === 0) {
                gameState.flexedItem = null;
            }
            
            // Trigger Event Starter effect
            if (hasEventStarter && !gameState.weatherEvent) {
                const events = ['cloudy', 'rainy', 'storming'];
                const selectedEvent = events[Math.floor(Math.random() * events.length)];
                startWeatherEvent(selectedEvent);
                showNotification(`🌟 Event Starter activated! ${selectedEvent.toUpperCase()} event started!`, '#00aaff');
            }
            
            showNotification(`Sold for $${formatNumber(sellPrice)}!`, 'var(--success)');
            updateStats();
            updateInventory();
        }
        
        function flexItem(itemKey) {
            if (gameState.flexedItem === itemKey) {
                gameState.flexedItem = null;
                showNotification('Stopped flexing item', 'var(--text-secondary)');
            } else {
                gameState.flexedItem = itemKey;
                showNotification(`Now flexing: ${itemKey}!`, gameState.inventory[itemKey].color);
            }
            updateInventory();
        }
        
        function sortInventory(sortType) {
            gameState.inventorySort = sortType;
            updateInventory();
            showNotification(`Sorted by ${sortType}`, 'var(--accent-primary)');
        }
        
        function filterInventory() {
            const filterSelect = document.getElementById('filterType');
            gameState.inventoryFilter = filterSelect.value;
            updateInventory();
            showNotification(`Filtered: ${filterSelect.options[filterSelect.selectedIndex].text}`, 'var(--accent-primary)');
        }
        
        function startAutoTrading() {
            if (gameState.tradeTimer) {
                clearInterval(gameState.tradeTimer);
            }
            
            // Generate initial trade
            setTimeout(generateNPCTrade, 5000);
            
            // Set up automatic trade generation
            gameState.tradeTimer = setInterval(() => {
                // More trades appear with higher wealth (adjusted thresholds)
                const baseInterval = 15000; // 15 seconds base
                const wealthFactor = Math.min(gameState.totalValue / 5000, 0.8); // Adjusted from 100000 to 5000, up to 80% faster
                const popularityBonus = gameState.upgrades.popularity * 0.15; // 15% more trades per level
                const actualInterval = baseInterval * (1 - wealthFactor);
                
                // Chance to spawn multiple trades for rich players and with popularity upgrade (adjusted threshold)
                const maxTrades = Math.min(Math.floor(gameState.totalValue / 2500) + 1 + Math.floor(popularityBonus * 3), 6); // Adjusted from 50000 to 2500
                const tradesToSpawn = Math.floor(Math.random() * maxTrades) + 1;
                
                for (let i = 0; i < tradesToSpawn; i++) {
                    setTimeout(() => generateNPCTrade(), i * 1000);
                }
            }, 20000); // Check every 20 seconds
        }
        
        function generateNPCTrade() {
            const inventoryKeys = Object.keys(gameState.inventory).filter(key => gameState.inventory[key].count > 0);
            if (inventoryKeys.length === 0) return;
            
            // Prioritize higher rarity items (weighted selection)
            const weightedItems = [];
            inventoryKeys.forEach(key => {
                const item = gameState.inventory[key];
                const rarityIndex = rarities.findIndex(r => r.name === item.rarity);
                // Higher rarity = more weight (multiply by rarity index + 1)
                let weight = Math.max(1, rarityIndex);
                
                // Check for Traders Dream enchant - increases trade attraction
                if (item.enchantments && item.enchantments.length > 0) {
                    for (const enchantName of item.enchantments) {
                        const enchantData = enchantments[enchantName];
                        if (enchantData && enchantData.effect.tradeAttraction) {
                            weight *= enchantData.effect.tradeAttraction;
                        }
                    }
                }
                
                for (let i = 0; i < Math.floor(weight); i++) {
                    weightedItems.push(key);
                }
            });
            
            const yourItemKey = weightedItems[Math.floor(Math.random() * weightedItems.length)];
            const yourItem = gameState.inventory[yourItemKey];
            
            // Check for Chaotics Thoughts enchant to block scammers
            let blockScammers = false;
            if (yourItem.enchantments && yourItem.enchantments.length > 0) {
                for (const enchantName of yourItem.enchantments) {
                    const enchantData = enchantments[enchantName];
                    if (enchantData && enchantData.effect.scammerBlock) {
                        blockScammers = true;
                        break;
                    }
                }
            }
            
            // Higher value items attract more scammers
            let npcType;
            if (blockScammers) {
                // Chaotics Thoughts blocks scammers
                npcType = Math.random() < 0.5 ? 'honest' : 'fair';
            } else if (yourItem.value > 500) { // Adjusted from 10000 to 500
                const roll = Math.random();
                if (roll < 0.5) npcType = 'scammer';
                else if (roll < 0.8) npcType = 'fair';
                else npcType = 'honest';
            } else {
                const roll = Math.random();
                if (roll < 0.2) npcType = 'scammer';
                else if (roll < 0.6) npcType = 'fair';
                else npcType = 'honest';
            }
            
            const npcName = npcNames[Math.floor(Math.random() * npcNames.length)];
            
            // Generate offer item
            let offerValue;
            if (npcType === 'honest') {
                offerValue = yourItem.value * (1.1 + Math.random() * 0.3); // 110-140% value
            } else if (npcType === 'fair') {
                offerValue = yourItem.value * (0.95 + Math.random() * 0.15); // 95-110% value
            } else {
                offerValue = yourItem.value * (0.3 + Math.random() * 0.5); // 30-80% value
            }
            
            // Find a rarity tier for the offer based on value
            let offerRarity = rarities[0];
            for (let i = rarities.length - 1; i >= 0; i--) {
                if (offerValue >= rarities[i].minValue && offerValue <= rarities[i].maxValue) {
                    offerRarity = rarities[i];
                    break;
                }
            }
            
            const offerItemName = generateItemName(offerRarity);
            offerValue = Math.floor(offerValue);
            
            // Create trade object
            const trade = {
                id: Date.now() + Math.random(),
                npcName,
                npcType,
                yourItemKey,
                yourItem: { ...yourItem },
                offerItem: {
                    name: offerItemName,
                    rarity: offerRarity.name,
                    color: offerRarity.color,
                    value: offerValue
                }
            };
            
            gameState.activeTrades.push(trade);
            displayTrade(trade);
        }
        
        function displayTrade(trade) {
            const container = document.getElementById('npcContainer');
            
            // Show popup notification for new trade
            showNotification(`💼 ${trade.npcName} wants to trade!`, 'var(--accent-primary)');
            
            const insightLevel = gameState.upgrades.tradeInsight;
            let yourValueDisplay = '<div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px;">❓ Unknown Value ❓</div>';
            let offerValueDisplay = '<div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px;">❓ Unknown Value ❓</div>';
            let tradeQualityDisplay = '';
            
            if (insightLevel >= 3) {
                // Show both values
                yourValueDisplay = `<div style="color: var(--accent-gold); font-size: 0.8rem; margin-top: 5px;">$${formatNumber(trade.yourItem.value)}</div>`;
                offerValueDisplay = `<div style="color: var(--accent-gold); font-size: 0.8rem; margin-top: 5px;">$${formatNumber(trade.offerItem.value)}</div>`;
            }
            
            if (insightLevel >= 1) {
                const diff = trade.offerItem.value - trade.yourItem.value;
                if (insightLevel === 1) {
                    // Show quality indicator
                    if (diff > 0) tradeQualityDisplay = '<div style="color: var(--success); margin-top: 10px;">✅ Good Trade</div>';
                    else if (diff < 0) tradeQualityDisplay = '<div style="color: var(--danger); margin-top: 10px;">⚠️ Bad Trade</div>';
                    else tradeQualityDisplay = '<div style="color: var(--warning); margin-top: 10px;">⚖️ Fair Trade</div>';
                } else if (insightLevel >= 2) {
                    // Show exact difference
                    if (diff > 0) tradeQualityDisplay = `<div style="color: var(--success); margin-top: 10px;">+$${formatNumber(diff)}</div>`;
                    else if (diff < 0) tradeQualityDisplay = `<div style="color: var(--danger); margin-top: 10px;">-$${formatNumber(Math.abs(diff))}</div>`;
                    else tradeQualityDisplay = '<div style="color: var(--warning); margin-top: 10px;">±$0</div>';
                }
            }
            
            const npcDiv = document.createElement('div');
            npcDiv.className = 'npc-card';
            npcDiv.setAttribute('data-trade-id', trade.id);
            npcDiv.innerHTML = `
                <div class="npc-header">
                    <div class="npc-name">${trade.npcName}</div>
                    <div style="color: var(--text-secondary); font-size: 0.8rem;">Expires in 30s</div>
                </div>
                <div class="trade-offer">
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 5px;">You Give:</div>
                        <div style="color: ${trade.yourItem.color}; font-weight: bold; font-size: 1.1rem;">${trade.yourItem.name}</div>
                        <div style="color: ${trade.yourItem.color}; font-size: 0.9rem;">${trade.yourItem.rarity}</div>
                        ${yourValueDisplay}
                    </div>
                    <div style="font-size: 2rem;">↔️</div>
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 5px;">You Get:</div>
                        <div style="color: ${trade.offerItem.color}; font-weight: bold; font-size: 1.1rem;">${trade.offerItem.name}</div>
                        <div style="color: ${trade.offerItem.color}; font-size: 0.9rem;">${trade.offerItem.rarity}</div>
                        ${offerValueDisplay}
                    </div>
                </div>
                ${tradeQualityDisplay}
                <div class="trade-buttons">
                    <button class="btn btn-accept" onclick="acceptTrade(${trade.id})">Accept Trade</button>
                    <button class="btn btn-decline" onclick="declineTrade(${trade.id})">Decline</button>
                </div>
            `;
            
            // Add to top of container
            container.insertBefore(npcDiv, container.firstChild);
            
            // Auto-remove after 30 seconds
            setTimeout(() => {
                const element = document.querySelector(`[data-trade-id="${trade.id}"]`);
                if (element) {
                    showNotification(`Trade with ${trade.npcName} expired!`, 'var(--text-secondary)');
                    element.style.animation = 'slideIn 0.5s ease-out reverse';
                    setTimeout(() => {
                        element.remove();
                        gameState.activeTrades = gameState.activeTrades.filter(t => t.id !== trade.id);
                    }, 500);
                }
            }, 30000);
        }
        
        function acceptTrade(tradeId) {
            const trade = gameState.activeTrades.find(t => t.id === tradeId);
            if (!trade) return;
            
            const item = gameState.inventory[trade.yourItemKey];
            if (!item || item.count === 0) {
                showNotification('Item no longer available!', 'var(--danger)');
                declineTrade(tradeId);
                return;
            }
            
            // Remove your item
            item.count--;
            gameState.totalValue -= trade.yourItem.value;
            
            // Add received item
            const receivedFullName = `${trade.offerItem.name} (${trade.offerItem.rarity})`;
            if (gameState.inventory[receivedFullName]) {
                gameState.inventory[receivedFullName].count++;
            } else {
                gameState.inventory[receivedFullName] = {
                    name: trade.offerItem.name,
                    rarity: trade.offerItem.rarity,
                    color: trade.offerItem.color,
                    value: trade.offerItem.value,
                    count: 1
                };
            }
            gameState.totalValue += trade.offerItem.value;
            
            // Determine if it was a good trade
            const valueDiff = trade.offerItem.value - trade.yourItem.value;
            if (valueDiff > 0) {
                gameState.tradeWins++;
                updateQuestProgress('tradeWins', 1);
                updateDailyChallengeProgress('tradeWins', 1);
                if (valueDiff > (gameState.biggestTradeWin || 0)) {
                    gameState.biggestTradeWin = valueDiff;
                }
                showNotification(`Great trade! Gained $${formatNumber(valueDiff)} value! 📈`, 'var(--success)');
            } else if (valueDiff < 0) {
                gameState.tradeLosses++;
                const loss = Math.abs(valueDiff);
                if (loss > (gameState.biggestTradeLoss || 0)) {
                    gameState.biggestTradeLoss = loss;
                }
                showNotification(`Bad trade! Lost $${formatNumber(loss)} value! 📉`, 'var(--danger)');
            } else {
                showNotification('Fair trade! Same value 📊', 'var(--warning)');
            }
            
            gameState.battlePassXP += 5;
            claimBattlePassRewards();
            updateStats();
            updateInventory();
            updateBattlePass();
            checkAchievements();
            
            declineTrade(tradeId);
        }
        
        function declineTrade(tradeId) {
            const element = document.querySelector(`[data-trade-id="${tradeId}"]`);
            if (element) {
                element.style.animation = 'slideIn 0.5s ease-out reverse';
                setTimeout(() => element.remove(), 500);
            }
            gameState.activeTrades = gameState.activeTrades.filter(t => t.id !== tradeId);
        }
        
        function initCrafting() {
            const grid = document.getElementById('craftingGrid');
            recipes.forEach(recipe => {
                const canCraft = Object.entries(recipe.requires).every(([rarity, count]) => {
                    return Object.values(gameState.inventory).filter(item => 
                        item.rarity === rarity && item.count > 0
                    ).length >= count;
                });
                
                const recipeDiv = document.createElement('div');
                recipeDiv.className = 'recipe-card';
                recipeDiv.innerHTML = `
                    <h3 style="color: var(--accent-primary);">${recipe.name}</h3>
                    <div class="recipe-requirements">
                        <div style="color: var(--text-secondary); margin-bottom: 10px;">Requires:</div>
                        ${Object.entries(recipe.requires).map(([rarity, count]) => 
                            `<div>${count}x ${rarity} items</div>`
                        ).join('')}
                    </div>
                    <div style="margin: 10px 0;">
                        <div style="color: var(--accent-gold);">Creates: ${recipe.result}</div>
                        <div style="color: var(--success);">Value: $${formatNumber(recipe.value)}</div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-accept" ${!canCraft ? 'disabled' : ''} 
                                onclick="craftItem('${recipe.name}')" 
                                style="flex: 1; ${!canCraft ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            Craft 1x
                        </button>
                        <button class="btn btn-accept" ${!canCraft ? 'disabled' : ''} 
                                onclick="craftMax('${recipe.name}')" 
                                style="flex: 1; background: linear-gradient(135deg, var(--accent-gold), var(--warning)); ${!canCraft ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            Craft Max
                        </button>
                    </div>
                `;
                grid.appendChild(recipeDiv);
            });
        }
        
        function craftItem(recipeName, silent = false) {
            const recipe = recipes.find(r => r.name === recipeName);
            if (!recipe) return;
            
            // Remove required items
            for (const [rarity, count] of Object.entries(recipe.requires)) {
                let removed = 0;
                for (const [key, item] of Object.entries(gameState.inventory)) {
                    if (item.rarity === rarity && item.count > 0 && removed < count) {
                        const toRemove = Math.min(item.count, count - removed);
                        item.count -= toRemove;
                        gameState.totalValue -= item.value * toRemove;
                        removed += toRemove;
                    }
                }
            }
            
            // Check for Crafting Merger enchants in inventory
            let craftDupeChance = 0;
            for (const [key, item] of Object.entries(gameState.inventory)) {
                if (item.enchantments && item.count > 0) {
                    for (const enchantName of item.enchantments) {
                        const enchantData = enchantments[enchantName];
                        if (enchantData && enchantData.effect.craftDupeChance) {
                            craftDupeChance = Math.max(craftDupeChance, enchantData.effect.craftDupeChance);
                        }
                    }
                }
            }
            
            // Add crafted item
            const rarity = rarities.find(r => r.name === recipe.result);
            
            if (!rarity) {
                if (!silent) showNotification('Error: Invalid recipe rarity!', 'var(--danger)');
                return;
            }
            
            let craftValue = recipe.value;
            
            // Apply craftingMastery upgrade - increases craft output value
            if (gameState.upgrades.craftingMastery > 0) {
                const masteryBonus = 1 + (gameState.upgrades.craftingMastery * 0.02); // 2% per level
                craftValue = Math.floor(craftValue * masteryBonus);
            }
            
            addItemToInventory(recipe.name, { ...rarity, minValue: craftValue, maxValue: craftValue });
            
            // Try to duplicate with Crafting Merger
            if (craftDupeChance > 0 && Math.random() < craftDupeChance) {
                addItemToInventory(recipe.name, { ...rarity, minValue: craftValue, maxValue: craftValue });
                if (!silent) showNotification(`🔨 Crafting Merger! Duplicated craft!`, 'var(--accent-gold)');
            }
            
            gameState.craftCount = (gameState.craftCount || 0) + 1;
            gameState.battlePassXP += 20;
            claimBattlePassRewards();
            
            // Update quests
            updateQuestProgress('crafts', 1);
            
            // Update daily challenges
            updateDailyChallengeProgress('crafts', 1);
            
            if (!silent) {
                showNotification(`Crafted: ${recipe.name}!`, rarity.color);
                updateStats();
                updateInventory();
            }
            updateBattlePass();
            checkAchievements();
            
            // Refresh crafting UI
            document.getElementById('craftingGrid').innerHTML = '';
            initCrafting();
        }
        
        function initShop() {
            const grid = document.getElementById('shopGrid');
            grid.innerHTML = '';
            
            // Generate shop items for each rarity (expanded to 20)
            const shopRarities = rarities.slice(0, 20); // Common to Primordial
            
            shopRarities.forEach(rarity => {
                const itemName = generateItemName(rarity);
                const baseValue = (rarity.minValue + rarity.maxValue) / 2;
                const shopPrice = Math.floor(baseValue * 1.5); // 50% markup
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';
                itemDiv.style.borderColor = rarity.color;
                itemDiv.innerHTML = `
                    <div style="font-size: 2rem;">🏪</div>
                    <div class="item-name" style="color: ${rarity.color};">${itemName}</div>
                    <div style="font-size: 0.8rem; color: ${rarity.color};">${rarity.name}</div>
                    <div class="item-value">$${formatNumber(shopPrice)}</div>
                    <button class="btn btn-accept" style="margin-top: 10px; padding: 8px 15px; font-size: 0.8rem;" 
                            onclick="buyItem('${itemName}', '${rarity.name}', '${rarity.color}', ${Math.floor(baseValue)}, ${shopPrice})"
                            ${gameState.money < shopPrice ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                        Buy
                    </button>
                `;
                grid.appendChild(itemDiv);
            });
        }
        
        function buyItem(name, rarityName, color, value, price) {
            if (gameState.money < price) {
                showNotification('Not enough money!', 'var(--danger)');
                return;
            }
            
            gameState.money -= price;
            gameState.lifetimeMoneySpent = (gameState.lifetimeMoneySpent || 0) + price;
            
            const fullName = `${name} (${rarityName})`;
            if (gameState.inventory[fullName]) {
                gameState.inventory[fullName].count++;
            } else {
                gameState.inventory[fullName] = {
                    name: name,
                    rarity: rarityName,
                    color: color,
                    value: value,
                    count: 1
                };
            }
            gameState.totalValue += value;
            gameState.shopPurchases = (gameState.shopPurchases || 0) + 1;
            
            // Update quests
            updateQuestProgress('shopBuys', 1);
            
            showNotification(`Purchased: ${name}!`, color);
            updateStats();
            updateInventory();
            initShop(); // Refresh shop to update buy buttons
            checkAchievements();
        }
        
        function updateEnchantInventory() {
            const grid = document.getElementById('enchantInventoryGrid');
            grid.innerHTML = '';
            
            // Only show Divine (index 8) and higher rarities
            const divineIndex = rarities.findIndex(r => r.name === 'Divine');
            
            let hasEligibleItems = false;
            for (const [key, item] of Object.entries(gameState.inventory)) {
                if (item.count > 0) {
                    const itemRarityIndex = rarities.findIndex(r => r.name === item.rarity);
                    if (itemRarityIndex >= divineIndex) {
                        hasEligibleItems = true;
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'inventory-item';
                        itemDiv.style.borderColor = item.color;
                        itemDiv.onclick = () => selectItemForEnchant(key);
                        
                        // Show existing enchantments
                        const enchantDisplay = item.enchantments && item.enchantments.length > 0 
                            ? `<div style="font-size: 0.7rem; color: var(--accent-gold); margin-top: 3px;">${item.enchantments.join(', ')}</div>` 
                            : '';
                        
                        itemDiv.innerHTML = `
                            ${item.count > 1 ? `<div class="item-count">${item.count}</div>` : ''}
                            <div style="font-size: 2rem;">✨</div>
                            <div class="item-name" style="color: ${item.color};">${item.name}</div>
                            <div style="font-size: 0.8rem; color: ${item.color};">${item.rarity}</div>
                            <div class="item-value">$${formatNumber(item.value)}</div>
                            ${enchantDisplay}
                        `;
                        grid.appendChild(itemDiv);
                    }
                }
            }
            
            if (!hasEligibleItems) {
                grid.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No Divine or higher rarity items available for enchanting.</p>';
            }
        }
        
        function initUpgrades() {
            const grid = document.getElementById('upgradesGrid');
            grid.innerHTML = '';
            
            for (const [key, data] of Object.entries(upgradeData)) {
                const currentLevel = gameState.upgrades[key];
                const cost = Math.floor(data.baseCost * Math.pow(data.costMultiplier, currentLevel));
                const canAfford = gameState.money >= cost;
                const isMaxed = currentLevel >= data.maxLevel;
                
                const upgradeDiv = document.createElement('div');
                upgradeDiv.className = 'recipe-card';
                upgradeDiv.innerHTML = `
                    <h3 style="color: var(--accent-primary);">${data.name}</h3>
                    <p style="color: var(--text-secondary); margin: 10px 0;">${data.description}</p>
                    <div class="recipe-requirements">
                        <div style="color: var(--accent-gold); font-weight: bold;">Level: ${currentLevel}/${data.maxLevel}</div>
                        <div style="color: var(--accent-primary); margin-top: 5px;">${data.effect(currentLevel)}</div>
                        ${!isMaxed ? `<div style="color: var(--warning); margin-top: 10px;">Next: ${data.effect(currentLevel + 1)}</div>` : ''}
                    </div>
                    <div style="margin: 10px 0;">
                        <div style="color: var(--accent-gold);">Cost: $${formatNumber(cost)}</div>
                    </div>
                    <button class="btn btn-accept" 
                            ${!canAfford || isMaxed ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}
                            onclick="purchaseUpgrade('${key}')">
                        ${isMaxed ? 'MAXED' : 'Upgrade'}
                    </button>
                `;
                grid.appendChild(upgradeDiv);
            }
        }
        
        function purchaseUpgrade(upgradeKey) {
            const data = upgradeData[upgradeKey];
            const currentLevel = gameState.upgrades[upgradeKey];
            
            if (currentLevel >= data.maxLevel) {
                showNotification('Already at max level!', 'var(--warning)');
                return;
            }
            
            const cost = Math.floor(data.baseCost * Math.pow(data.costMultiplier, currentLevel));
            
            if (gameState.money < cost) {
                showNotification('Not enough money!', 'var(--danger)');
                return;
            }
            
            gameState.money -= cost;
            gameState.lifetimeMoneySpent = (gameState.lifetimeMoneySpent || 0) + cost;
            gameState.upgrades[upgradeKey]++;
            
            // Apply upgrade effects
            if (upgradeKey === 'luckBoost') {
                gameState.luckMultiplier += 0.1;
            } else if (upgradeKey === 'autoSpin' && gameState.upgrades[upgradeKey] === 1) {
                startAutoSpin();
            }
            
            showNotification(`Upgraded ${data.name} to level ${gameState.upgrades[upgradeKey]}!`, 'var(--success)');
            updateStats();
            initUpgrades();
        }
        
        function selectItemForEnchant(itemKey) {
            const item = gameState.inventory[itemKey];
            if (!item || item.count === 0) {
                showNotification('Item no longer available!', 'var(--danger)');
                return;
            }
            
            gameState.enchantmentTarget = itemKey;
            
            const slot = document.getElementById('selectedEnchantItem');
            slot.innerHTML = `
                <strong style="color: ${item.color};">${item.name}</strong><br>
                <span style="color: ${item.color}; font-size: 0.9rem;">${item.rarity}</span><br>
                <span style="color: var(--accent-gold);">$${formatNumber(item.value)}</span>
            `;
            
            document.getElementById('enchantmentInterface').style.display = 'block';
        }
        
        function enchantItem() {
            if (!gameState.enchantmentTarget) {
                showNotification('Select an item first!', 'var(--danger)');
                return;
            }
            
            const item = gameState.inventory[gameState.enchantmentTarget];
            if (!item || item.count === 0) {
                showNotification('Item no longer available!', 'var(--danger)');
                gameState.enchantmentTarget = null;
                document.getElementById('enchantmentInterface').style.display = 'none';
                return;
            }
            
            // Check if item is Divine or higher
            const divineIndex = rarities.findIndex(r => r.name === 'Divine');
            const itemRarityIndex = rarities.findIndex(r => r.name === item.rarity);
            if (itemRarityIndex < divineIndex) {
                showNotification('Item must be Divine or higher rarity!', 'var(--danger)');
                return;
            }
            
            // Initialize enchantments array if it doesn't exist
            if (!item.enchantments) {
                item.enchantments = [];
            }
            
            // Check if item already has an enchantment (limit to 1)
            if (item.enchantments.length > 0) {
                showNotification('⚠️ Item already has an enchantment! Items can only have ONE enchantment.', 'var(--warning)');
                return;
            }
            
            // Roll for enchantment
            const roll = Math.random();
            let selectedEnchant = null;
            let cumulativeChance = 0;
            
            // Shuffle enchantments for fairness
            const enchantKeys = Object.keys(enchantments);
            for (let i = enchantKeys.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [enchantKeys[i], enchantKeys[j]] = [enchantKeys[j], enchantKeys[i]];
            }
            
            // Apply enchantPower upgrade boost
            let luckBoost = 1.0;
            
            // Apply enchantPower upgrade
            if (gameState.upgrades.enchantPower > 0) {
                const upgradeLuckBoost = 1 + (gameState.upgrades.enchantPower * 0.1); // 10% per level
                luckBoost *= upgradeLuckBoost;
            }
            
            for (const enchantName of enchantKeys) {
                const enchant = enchantments[enchantName];
                cumulativeChance += enchant.chance * luckBoost;
                if (roll < cumulativeChance) {
                    selectedEnchant = { name: enchantName, data: enchant };
                    break;
                }
            }
            
            if (!selectedEnchant) {
                showNotification('Enchantment failed - no effect!', 'var(--warning)');
                gameState.enchantmentTarget = null;
                document.getElementById('enchantmentInterface').style.display = 'none';
                updateEnchantInventory();
                saveGame(true); // Auto-save
                return;
            }
            
            const enchantName = selectedEnchant.name;
            const enchantData = selectedEnchant.data;
            const effect = enchantData.effect;
            
            // Handle bad enchants
            if (enchantName === 'Too Much Energy' || enchantName === 'Too Little Energy') {
                gameState.totalValue -= item.value;
                item.count--;
                gameState.enchantFails = (gameState.enchantFails || 0) + 1;
                showNotification(`💀 ${enchantName}! Item DESTROYED! 💀`, 'var(--danger)');
                
                gameState.enchantmentTarget = null;
                document.getElementById('enchantmentInterface').style.display = 'none';
                updateStats();
                updateInventory();
                updateEnchantInventory();
                checkAchievements();
                saveGame(true); // Auto-save
                return;
            }
            
            // Handle Ditto enchant - copies random item
            if (enchantName.startsWith('Ditto')) {
                const inventoryKeys = Object.keys(gameState.inventory).filter(k => gameState.inventory[k].count > 0 && k !== gameState.enchantmentTarget);
                if (inventoryKeys.length > 0) {
                    const randomKey = inventoryKeys[Math.floor(Math.random() * inventoryKeys.length)];
                    const copiedItem = gameState.inventory[randomKey];
                    const newValue = Math.floor(copiedItem.value * effect.dittoCopy);
                    
                    // Add copied item to inventory
                    const newKey = `${copiedItem.name} (${copiedItem.rarity}) [Ditto Copy]`;
                    gameState.inventory[newKey] = {
                        name: `${copiedItem.name} [Ditto Copy]`,
                        rarity: copiedItem.rarity,
                        color: copiedItem.color,
                        value: newValue,
                        count: 1,
                        enchantments: []
                    };
                    gameState.totalValue += newValue;
                    
                    showNotification(`🎭 ${enchantName}! Copied ${copiedItem.name} (+${((effect.dittoCopy - 1) * 100).toFixed(0)}% value)`, 'var(--warning)');
                } else {
                    showNotification(`🎭 ${enchantName}! But no items to copy...`, 'var(--warning)');
                }
                
                gameState.enchantmentTarget = null;
                document.getElementById('enchantmentInterface').style.display = 'none';
                updateStats();
                updateInventory();
                updateEnchantInventory();
                saveGame(true); // Auto-save
                return;
            }
            
            // Apply good enchantments
            item.enchantments.push(enchantName);
            
            // Apply value multiplier if present
            if (effect.valueMultiplier) {
                const oldValue = item.value;
                item.value = Math.floor(item.value * effect.valueMultiplier);
                gameState.totalValue += (item.value - oldValue);
            }
            
            // Apply luck boost if present
            if (effect.luckBoost) {
                gameState.luckMultiplier += effect.luckBoost;
            }
            
            gameState.enchantSuccess = (gameState.enchantSuccess || 0) + 1;
            gameState.battlePassXP += 15;
            claimBattlePassRewards();
            
            // Update quests
            updateQuestProgress('enchants', 1);
            
            const rarityColor = enchantData.type === 'ultimate' ? '#ff00ff' : 
                               enchantData.type === 'godly' ? 'var(--accent-gold)' : 
                               'var(--success)';
            
            showNotification(`✨ ${enchantName} applied! ✨`, rarityColor);
            
            gameState.enchantmentTarget = null;
            document.getElementById('enchantmentInterface').style.display = 'none';
            
            updateStats();
            updateInventory();
            updateEnchantInventory();
            updateBattlePass();
            checkAchievements();
            saveGame(true); // Auto-save after enchant
        }
        
        function initAchievements() {
            const list = document.getElementById('achievementList');
            achievements.forEach(achievement => {
                const unlocked = gameState.achievements[achievement.id] || achievement.check();
                if (unlocked && !gameState.achievements[achievement.id]) {
                    gameState.achievements[achievement.id] = true;
                    
                    // Award achievement points
                    awardAchievementPoints(achievement.id);
                    
                    // Grant rewards
                    if (achievement.id === 'first_spin') {
                        gameState.luckMultiplier += 0.1;
                    } else if (achievement.id === 'spin_master') {
                        gameState.luckMultiplier += 0.2;
                    } else if (achievement.id === 'spin_legend') {
                        gameState.luckMultiplier += 0.5;
                    } else if (achievement.id === 'spin_god') {
                        gameState.luckMultiplier += 1.0;
                    } else if (achievement.id === 'spin_master_100k') {
                        gameState.luckMultiplier += 2.0;
                    }
                    
                    // Show achievement notification if enabled
                    if (gameState.settings.showAchievementNotifications) {
                        showNotification(`🏆 Achievement Unlocked: ${achievement.name}!`, 'var(--accent-gold)');
                        playSound('achievement');
                    }
                }
                
                const achDiv = document.createElement('div');
                achDiv.className = 'achievement-card' + (unlocked ? ' unlocked' : '');
                achDiv.innerHTML = `
                    <div class="achievement-icon">${unlocked ? '🏆' : '🔒'}</div>
                    <h3 style="color: ${unlocked ? 'var(--accent-gold)' : 'var(--text-secondary)'};">${achievement.name}</h3>
                    <p style="color: var(--text-secondary); margin: 10px 0;">${achievement.desc}</p>
                    <div style="color: var(--accent-primary); font-weight: bold;">Reward: ${achievement.reward}</div>
                `;
                list.appendChild(achDiv);
            });
        }
        
        function checkAchievements() {
            const list = document.getElementById('achievementList');
            list.innerHTML = '';
            initAchievements();
        }
        
        
        function updateBattlePass() {
            const currentTier = battlePassTiers.findIndex(t => gameState.battlePassXP < t.xpRequired);
            const tierIndex = currentTier === -1 ? battlePassTiers.length : currentTier;
            
            // Initialize claimed tiers tracking
            if (!gameState.claimedBPTiers) {
                gameState.claimedBPTiers = [];
            }
            
            // Calculate current tier properly
            let currentTierNum = 0;
            for (let i = 0; i < battlePassTiers.length; i++) {
                if (gameState.battlePassXP >= battlePassTiers[i].xpRequired) {
                    currentTierNum = battlePassTiers[i].tier;
                }
            }
            gameState.battlePassTier = currentTierNum;
            
            const progress = document.getElementById('bpProgress');
            if (progress) {
                const maxXP = battlePassTiers[battlePassTiers.length - 1].xpRequired;
                const percentage = Math.min((gameState.battlePassXP / maxXP) * 100, 100);
                progress.style.width = percentage + '%';
                progress.textContent = `Tier ${currentTierNum}/${battlePassTiers.length} (${formatNumber(gameState.battlePassXP)} XP)`;
            }
            
            const tiersDiv = document.getElementById('bpTiers');
            if (tiersDiv) {
                tiersDiv.innerHTML = '';
                initBattlePass();
            }
        }
        
        function claimBattlePassRewards() {
            // This function checks for newly unlocked tiers and gives rewards
            // Only called when XP is gained, not on refresh
            const currentTier = battlePassTiers.findIndex(t => gameState.battlePassXP < t.xpRequired);
            const tierIndex = currentTier === -1 ? battlePassTiers.length : currentTier;
            
            if (!gameState.claimedBPTiers) {
                gameState.claimedBPTiers = [];
            }
            
            // Check for newly unlocked tiers and give rewards
            for (let i = 0; i < tierIndex; i++) {
                const tier = battlePassTiers[i];
                if (!gameState.claimedBPTiers.includes(tier.tier)) {
                    // Give reward
                    giveRewardFromTier(tier);
                    gameState.claimedBPTiers.push(tier.tier);
                }
            }
        }
        
        function giveRewardFromTier(tier) {
            const reward = tier.reward;
            
            // Rewards are crates - give items based on crate type
            if (reward.includes('Crate')) {
                const rarityName = reward.replace(' Crate', '');
                const rarity = rarities.find(r => r.name === rarityName);
                
                if (rarity) {
                    const itemName = generateItemName(rarity);
                    addItemToInventory(itemName, rarity);
                    showNotification(`🎁 Battle Pass Tier ${tier.tier} Reward: ${itemName}!`, rarity.color);
                } else {
                    console.error(`Could not find rarity for: ${rarityName}`);
                    showNotification(`🎁 Battle Pass Tier ${tier.tier} Unlocked: ${reward}!`, 'var(--accent-gold)');
                }
            } else {
                // Non-crate rewards (badges, titles, etc) - just notify
                showNotification(`🎁 Battle Pass Tier ${tier.tier} Unlocked: ${reward}!`, 'var(--accent-gold)');
            }
            
            updateInventory();
            saveGame(true);
        }
        
        function checkChristmasEvent() {
            const now = new Date();
            const minutes = now.getMinutes();
            
            // Event happens at the hour mark (00-04 minutes)
            if (minutes < 5 && !gameState.christmasEvent) {
                gameState.christmasEvent = true;
                gameState.christmasEventEnd = new Date(now.getTime() + 5 * 60000); // 5 minutes
                showNotification('🎄 CHRISTMAS EVENT STARTED! 5 minutes remaining! 🎅', '#ff0000');
                updateEventBonuses();
            } else if (gameState.christmasEvent && now >= gameState.christmasEventEnd) {
                gameState.christmasEvent = false;
                gameState.christmasEventEnd = null;
                showNotification('🎄 Christmas Event Ended! See you next hour! ❄️', 'var(--text-secondary)');
                updateEventBonuses();
            }
        }
        
        function checkWeatherEvents() {
            const now = Date.now();
            
            // Initialize lastWeatherEvent to now if it's 0 (first load)
            if (gameState.lastWeatherEvent === 0) {
                gameState.lastWeatherEvent = now;
                return; // Don't trigger event on first load
            }
            
            // Check if current weather event has ended
            if (gameState.weatherEvent && gameState.weatherEventEnd && now >= gameState.weatherEventEnd) {
                const eventEmojis = { cloudy: '☁️', rainy: '🌧️', storming: '⛈️' };
                showNotification(`${eventEmojis[gameState.weatherEvent]} ${gameState.weatherEvent.toUpperCase()} Event Ended!`, 'var(--text-secondary)');
                gameState.weatherEvent = null;
                gameState.weatherEventEnd = null;
                updateEventBonuses();
            }
            
            // Try to start a new weather event (every 10 minutes)
            if (!gameState.weatherEvent && now - gameState.lastWeatherEvent >= 600000) { // 10 minutes
                if (Math.random() < 0.8) { // 80% chance to start event
                    const events = ['cloudy', 'rainy', 'storming'];
                    const selectedEvent = events[Math.floor(Math.random() * events.length)];
                    startWeatherEvent(selectedEvent);
                }
                gameState.lastWeatherEvent = now;
            }
        }
        
        function startWeatherEvent(eventType) {
            gameState.weatherEvent = eventType;
            gameState.weatherEventEnd = Date.now() + 60000; // 1 minute
            
            const eventNames = { cloudy: 'CLOUDY', rainy: 'RAINY', storming: 'STORMING' };
            const eventEmojis = { cloudy: '☁️', rainy: '🌧️', storming: '⛈️' };
            showNotification(`${eventEmojis[eventType]} ${eventNames[eventType]} EVENT STARTED! 1 minute!`, '#00aaff');
            updateEventBonuses();
        }
        
        function checkSpecialEvents() {
            const now = new Date();
            const currentTime = now.getTime();
            const minutes = now.getMinutes();
            const hours = now.getHours();
            
            // Check if any active event has expired (admin or scheduled)
            if (gameState.specialEvent && gameState.specialEventEnd && currentTime >= gameState.specialEventEnd) {
                const eventEmojis = { 
                    disco: '🪩', galactic: '🌌', glitch: '⚡', fullmoon: '🌕', bloodmoon: '🔴',
                    nuclear: '☢️', volcanic: '🌋', goldenrain: '💰'
                };
                showNotification(`${eventEmojis[gameState.specialEvent]} ${gameState.specialEvent.toUpperCase()} Event Ended!`, 'var(--text-secondary)');
                gameState.specialEvent = null;
                gameState.specialEventEnd = null;
                gameState.specialEventIsAdmin = false;
                updateEventBonuses();
            }
            
            // Check if luck event has expired
            if (gameState.luckEvent && gameState.luckEvent.active && currentTime >= gameState.luckEvent.endTime) {
                gameState.luckEvent.active = false;
                showNotification('✨ Luck event ended!', 'var(--text-secondary)');
                updateEventBonuses();
            }
            
            // Special events now only trigger via admin or timed events schedule
            // No random/automatic triggers
        }
        
        function startSpecialEvent(eventType, endMinute = null, isAdmin = true) {
            gameState.specialEvent = eventType;
            gameState.specialEventIsAdmin = isAdmin;
            
            // Calculate exact end time based on the end minute of the time window
            if (endMinute !== null) {
                const now = new Date();
                const endTime = new Date(now);
                endTime.setMinutes(endMinute);
                endTime.setSeconds(0);
                endTime.setMilliseconds(0);
                
                // If end time is in the past (shouldn't happen), add an hour
                if (endTime <= now) {
                    endTime.setHours(endTime.getHours() + 1);
                }
                
                gameState.specialEventEnd = endTime.getTime();
            } else {
                // Admin-triggered and timed events last 1 minute
                gameState.specialEventEnd = Date.now() + 60000;
            }
            
            const eventNames = { 
                disco: 'DISCO 🪩', 
                galactic: 'GALACTIC 🌌', 
                glitch: 'GLITCH ⚡', 
                fullmoon: 'FULL MOON 🌕', 
                bloodmoon: 'BLOOD MOON 🔴',
                nuclear: 'NUCLEAR ☢️',
                volcanic: 'VOLCANIC 🌋',
                goldenrain: 'GOLDEN RAIN 💰',
                admin: 'ADMIN ACCESS 🔴'
            };
            const eventColors = {
                disco: '#ff00ff',
                galactic: '#4B0082',
                glitch: '#00ff00',
                fullmoon: '#f0f0f0',
                bloodmoon: '#8B0000',
                nuclear: '#00ff00',
                volcanic: '#ff4500',
                goldenrain: '#ffd700',
                admin: '#ff0000'
            };
            
            const eventTypeLabel = isAdmin ? 'Admin' : 'Scheduled';
            showNotification(`✨ ${eventNames[eventType]} EVENT STARTED! (${eventTypeLabel}) ✨`, eventColors[eventType]);
            updateEventBonuses();
        }
        
        function sellAllItems() {
            if (!confirm('Are you sure you want to sell ALL items for 70% of their value?')) {
                return;
            }
            
            let totalSellValue = 0;
            let itemCount = 0;
            
            for (const [key, item] of Object.entries(gameState.inventory)) {
                if (item.count > 0) {
                    const sellValue = Math.floor(item.value * 0.7 * item.count);
                    totalSellValue += sellValue;
                    itemCount += item.count;
                    gameState.totalValue -= item.value * item.count;
                    item.count = 0;
                }
            }
            
            gameState.money += totalSellValue;
            gameState.flexedItem = null;
            
            showNotification(`Sold ${itemCount} items for $${formatNumber(totalSellValue)}!`, 'var(--success)');
            updateStats();
            updateInventory();
        }
        
        // ===== DAILY LOGIN SYSTEM =====
        function checkDailyLogin() {
            const today = new Date().toDateString();
            
            if (!gameState.lastLoginDate || gameState.lastLoginDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();
                
                // Check if streak continues or breaks
                if (gameState.lastLoginDate === yesterdayStr) {
                    gameState.loginStreak++;
                } else if (gameState.lastLoginDate) {
                    gameState.loginStreak = 1; // Reset streak
                } else {
                    gameState.loginStreak = 1; // First login
                }
                
                gameState.lastLoginDate = today;
                gameState.totalLogins++;
                
                // Give rewards
                giveDailyLoginReward();
            }
        }
        
        function giveDailyLoginReward() {
            const day = gameState.loginStreak;
            const rewards = [
                { day: 1, money: 1000, desc: '$1,000' },
                { day: 2, money: 2500, desc: '$2,500' },
                { day: 3, money: 5000, xp: 100, desc: '$5,000 + 100 XP' },
                { day: 4, money: 10000, desc: '$10,000' },
                { day: 5, money: 25000, xp: 250, desc: '$25,000 + 250 XP' },
                { day: 6, money: 50000, desc: '$50,000' },
                { day: 7, money: 100000, xp: 500, item: 'Mythic', desc: '$100K + Mythic Item + 500 XP' }
            ];
            
            const rewardIndex = Math.min(day, 7) - 1;
            const reward = rewards[rewardIndex];
            
            if (reward.money) {
                gameState.money += reward.money;
                gameState.lifetimeMoneyEarned += reward.money;
            }
            if (reward.xp) {
                gameState.battlePassXP += reward.xp;
                claimBattlePassRewards();
            }
            if (reward.item) {
                const rarity = rarities.find(r => r.name === reward.item);
                if (rarity) {
                    const itemName = generateItemName(rarity);
                    addItemToInventory(itemName, rarity);
                }
            }
            
            showDailyLoginPopup(day, reward.desc);
        }
        
        function showDailyLoginPopup(day, rewardDesc) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 100%);
                border: 3px solid var(--accent-gold);
                border-radius: 15px;
                padding: 40px;
                z-index: 10000;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                text-align: center;
                animation: slideInTop 0.5s ease-out;
            `;
            
            popup.innerHTML = `
                <h2 style="color: var(--accent-gold); font-size: 2rem; margin-bottom: 20px;">🎁 Daily Login Reward!</h2>
                <p style="color: var(--text-primary); font-size: 1.2rem; margin: 20px 0;">Day ${day} Streak!</p>
                <p style="color: var(--accent-primary); font-size: 1.5rem; margin: 20px 0; font-weight: bold;">${rewardDesc}</p>
                <button class="btn btn-accept" onclick="this.parentElement.remove()" style="margin-top: 20px; font-size: 1.1rem; padding: 12px 30px;">
                    Claim Reward
                </button>
            `;
            
            document.body.appendChild(popup);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (popup.parentElement) popup.remove();
            }, 10000);
        }
        
        // ===== FUSION SYSTEM =====
        const fusionSlots = [null, null, null];
        
        function updateFusionInventory() {
            const grid = document.getElementById('fusionInventoryGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            const sortedItems = Object.entries(gameState.inventory)
                .filter(([key, item]) => item.count > 0)
                .sort((a, b) => {
                    const rarityA = rarities.findIndex(r => r.name === a[1].rarity);
                    const rarityB = rarities.findIndex(r => r.name === b[1].rarity);
                    return rarityB - rarityA;
                });
            
            sortedItems.forEach(([key, item]) => {
                // Don't show items beyond Ethereal (can't fuse to next tier)
                const rarityIndex = rarities.findIndex(r => r.name === item.rarity);
                if (rarityIndex >= rarities.length - 1) return;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';
                itemDiv.style.borderColor = item.color;
                itemDiv.style.cursor = 'pointer';
                itemDiv.onclick = () => addToFusionSlot(key, item);
                
                itemDiv.innerHTML = `
                    <div style="font-size: 1.5rem;">🔮</div>
                    <div class="item-name" style="color: ${item.color};">${item.name}</div>
                    <div style="font-size: 0.8rem; color: ${item.color};">${item.rarity}</div>
                    <div class="item-value">x${item.count}</div>
                `;
                
                grid.appendChild(itemDiv);
            });
        }
        
        function addToFusionSlot(itemKey, item) {
            // Check how many of this item are already in fusion slots
            const alreadyInSlots = fusionSlots.filter(slot => slot && slot.key === itemKey).length;
            
            // Check if we have enough of this item
            if (alreadyInSlots >= item.count) {
                showNotification(`You only have ${item.count} of this item! Can't add more to fusion.`, 'var(--danger)');
                return;
            }
            
            // Find first empty slot
            const emptySlotIndex = fusionSlots.findIndex(slot => slot === null);
            if (emptySlotIndex === -1) {
                showNotification('All fusion slots are full! Clear slots first.', 'var(--warning)');
                return;
            }
            
            // Check if rarity matches (if other slots have items)
            const existingRarity = fusionSlots.find(slot => slot !== null)?.rarity;
            if (existingRarity && existingRarity !== item.rarity) {
                showNotification(`Items must be same rarity! Slots have ${existingRarity} items.`, 'var(--danger)');
                return;
            }
            
            fusionSlots[emptySlotIndex] = { key: itemKey, ...item };
            updateFusionSlots();
        }
        
        function updateFusionSlots() {
            const container = document.getElementById('fusionItemsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            fusionSlots.forEach((slot, index) => {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'stat-card';
                slotDiv.style.minHeight = '150px';
                slotDiv.style.display = 'flex';
                slotDiv.style.flexDirection = 'column';
                slotDiv.style.alignItems = 'center';
                slotDiv.style.justifyContent = 'center';
                
                if (slot) {
                    slotDiv.style.borderColor = slot.color;
                    slotDiv.style.cursor = 'pointer';
                    slotDiv.onclick = () => {
                        fusionSlots[index] = null;
                        updateFusionSlots();
                    };
                    slotDiv.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 10px;">🔮</div>
                        <div style="color: ${slot.color}; font-weight: bold;">${slot.name}</div>
                        <div style="color: ${slot.color}; font-size: 0.9rem; margin-top: 5px;">${slot.rarity}</div>
                        <div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 10px;">Click to remove</div>
                    `;
                } else {
                    slotDiv.style.border = '2px dashed var(--accent-primary)';
                    slotDiv.innerHTML = `<span style="color: var(--text-secondary);">Item Slot ${index + 1}</span>`;
                }
                
                container.appendChild(slotDiv);
            });
            
            // Update fusion button
            const fusionButton = document.getElementById('fusionButton');
            if (fusionButton) {
                const canFuse = fusionSlots.every(slot => slot !== null);
                fusionButton.disabled = !canFuse;
                fusionButton.style.opacity = canFuse ? '1' : '0.5';
                fusionButton.style.cursor = canFuse ? 'pointer' : 'not-allowed';
            }
        }
        
        function performFusion() {
            if (fusionSlots.some(slot => slot === null)) {
                showNotification('All 3 slots must be filled!', 'var(--danger)');
                return;
            }
            
            // Verify all same rarity
            const rarity = fusionSlots[0].rarity;
            if (!fusionSlots.every(slot => slot.rarity === rarity)) {
                showNotification('All items must be the same rarity!', 'var(--danger)');
                return;
            }
            
            // Get the current rarity (NOT next rarity - we stay at same rarity!)
            const currentRarityIndex = rarities.findIndex(r => r.name === rarity);
            const currentRarity = rarities[currentRarityIndex];
            
            // Remove items from inventory
            fusionSlots.forEach(slot => {
                const item = gameState.inventory[slot.key];
                if (item && item.count > 0) {
                    item.count--;
                    gameState.totalValue -= item.value;
                    if (item.count === 0 && gameState.flexedItem === slot.key) {
                        gameState.flexedItem = null;
                    }
                }
            });
            
            // Create new RANDOM item of SAME rarity (not next tier!)
            const newItemName = generateItemName(currentRarity);
            addItemToInventory(newItemName, currentRarity);
            
            gameState.fusionCount++;
            playSound('fusion');
            showNotification(`⚗️ FUSION SUCCESS! Created ${newItemName} (${rarity})!`, currentRarity.color);
            
            // Clear slots
            clearFusionSlots();
            updateStats();
            updateInventory();
            updateFusionInventory();
            updateStatistics();
            checkAchievements();
        }
        
        function clearFusionSlots() {
            fusionSlots.fill(null);
            updateFusionSlots();
        }
        
        // ===== STATISTICS SYSTEM =====
        function updateStatistics() {
            // Update rarity counts
            gameState.rarityCounts = {};
            Object.values(gameState.inventory).forEach(item => {
                if (item.count > 0) {
                    gameState.rarityCounts[item.rarity] = (gameState.rarityCounts[item.rarity] || 0) + item.count;
                }
            });
            
            // General Stats
            document.getElementById('statTotalSpins').textContent = formatNumber(gameState.totalSpins);
            document.getElementById('statTotalLogins').textContent = formatNumber(gameState.totalLogins || 0);
            document.getElementById('statLoginStreak').textContent = gameState.loginStreak || 0;
            document.getElementById('statRebirths').textContent = gameState.rebirths;
            document.getElementById('statQuestsCompleted').textContent = gameState.questsCompleted;
            
            // Money Stats
            document.getElementById('statCurrentMoney').textContent = formatNumber(gameState.money);
            document.getElementById('statTotalValue').textContent = formatNumber(gameState.totalValue);
            document.getElementById('statLifetimeEarned').textContent = formatNumber(gameState.lifetimeMoneyEarned || 0);
            document.getElementById('statLifetimeSpent').textContent = formatNumber(gameState.lifetimeMoneySpent || 0);
            const netProfit = (gameState.lifetimeMoneyEarned || 0) - (gameState.lifetimeMoneySpent || 0);
            document.getElementById('statNetProfit').textContent = formatNumber(netProfit);
            
            // Trading Stats
            document.getElementById('statTradeWins').textContent = formatNumber(gameState.tradeWins);
            document.getElementById('statTradeLosses').textContent = formatNumber(gameState.tradeLosses);
            const winRate = gameState.tradeWins + gameState.tradeLosses > 0 
                ? ((gameState.tradeWins / (gameState.tradeWins + gameState.tradeLosses)) * 100).toFixed(1) 
                : 0;
            document.getElementById('statWinRate').textContent = winRate;
            document.getElementById('statBiggestWin').textContent = formatNumber(gameState.biggestTradeWin || 0);
            document.getElementById('statBiggestLoss').textContent = formatNumber(gameState.biggestTradeLoss || 0);
            
            // Crafting Stats
            document.getElementById('statCrafted').textContent = formatNumber(gameState.craftCount || 0);
            document.getElementById('statEnchantSuccess').textContent = formatNumber(gameState.enchantSuccess || 0);
            document.getElementById('statEnchantFails').textContent = formatNumber(gameState.enchantFails || 0);
            const enchantTotal = (gameState.enchantSuccess || 0) + (gameState.enchantFails || 0);
            const enchantRate = enchantTotal > 0 
                ? (((gameState.enchantSuccess || 0) / enchantTotal) * 100).toFixed(1) 
                : 0;
            document.getElementById('statEnchantRate').textContent = enchantRate;
            document.getElementById('statShopPurchases').textContent = formatNumber(gameState.shopPurchases);
            
            // Collection Stats
            const uniqueItems = Object.keys(gameState.inventory).filter(k => gameState.inventory[k].count > 0).length;
            const totalItems = Object.values(gameState.inventory).reduce((sum, item) => sum + item.count, 0);
            document.getElementById('statUniqueItems').textContent = formatNumber(uniqueItems);
            document.getElementById('statTotalItems').textContent = formatNumber(totalItems);
            document.getElementById('statEventItems').textContent = formatNumber(gameState.itemsFromEvents || 0);
            const achievementCount = Object.values(gameState.achievements).filter(a => a).length;
            document.getElementById('statAchievements').textContent = `${achievementCount} / ${achievements.length}`;
            document.getElementById('statBPTier').textContent = gameState.battlePassTier;
            
            // Pity Stats
            const totalLuck = (gameState.luckMultiplier * gameState.permanentLuckBoost).toFixed(2);
            document.getElementById('statCurrentLuck').textContent = totalLuck;
            document.getElementById('statPityCounter').textContent = gameState.pityCounter || 0;
            document.getElementById('statPityThreshold').textContent = gameState.pityThreshold;
            document.getElementById('statPityTriggered').textContent = gameState.pityTriggered || 0;
            const pityPercent = ((gameState.pityCounter / gameState.pityThreshold) * 100).toFixed(1);
            document.getElementById('pityProgress').style.width = `${pityPercent}%`;
            document.getElementById('pityProgress').textContent = `${pityPercent}%`;
            
            // Rarity Distribution
            const rarityDist = document.getElementById('rarityDistribution');
            if (rarityDist) {
                rarityDist.innerHTML = '';
                Object.entries(gameState.rarityCounts).forEach(([rarityName, count]) => {
                    const rarity = rarities.find(r => r.name === rarityName);
                    if (rarity) {
                        const div = document.createElement('div');
                        div.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            padding: 8px;
                            margin: 5px 0;
                            background: var(--bg-dark);
                            border-left: 3px solid ${rarity.color};
                            border-radius: 5px;
                        `;
                        div.innerHTML = `
                            <span style="color: ${rarity.color}; font-weight: bold;">${rarityName}</span>
                            <span style="color: var(--text-primary);">${formatNumber(count)}</span>
                        `;
                        rarityDist.appendChild(div);
                    }
                });
            }
        }
        
        function saveGame(isAutoSave = false) {
            try {
                const saveData = {
                    inventory: gameState.inventory,
                    totalValue: gameState.totalValue,
                    money: gameState.money,
                    totalSpins: gameState.totalSpins,
                    luckMultiplier: gameState.luckMultiplier,
                    tradeWins: gameState.tradeWins,
                    tradeLosses: gameState.tradeLosses,
                    battlePassXP: gameState.battlePassXP,
                    battlePassTier: gameState.battlePassTier,
                    achievements: gameState.achievements,
                    upgrades: gameState.upgrades,
                    rebirths: gameState.rebirths,
                    permanentLuckBoost: gameState.permanentLuckBoost,
                    settings: gameState.settings,
                    craftCount: gameState.craftCount,
                    enchantSuccess: gameState.enchantSuccess,
                    enchantFails: gameState.enchantFails,
                    adminUnlocked: gameState.adminUnlocked,
                    // New features
                    bosses: gameState.bosses,
                    bossStats: gameState.bossStats,
                    artifacts: gameState.artifacts,
                    triggeredTimedEvents: gameState.triggeredTimedEvents,
                    // Other existing fields
                    pityCounter: gameState.pityCounter,
                    pityThreshold: gameState.pityThreshold,
                    pityTriggered: gameState.pityTriggered,
                    lastLoginDate: gameState.lastLoginDate,
                    loginStreak: gameState.loginStreak,
                    totalLogins: gameState.totalLogins,
                    loginRewardsClaimed: gameState.loginRewardsClaimed,
                    lifetimeMoneyEarned: gameState.lifetimeMoneyEarned,
                    lifetimeMoneySpent: gameState.lifetimeMoneySpent,
                    biggestTradeWin: gameState.biggestTradeWin,
                    biggestTradeLoss: gameState.biggestTradeLoss,
                    rarityCounts: gameState.rarityCounts,
                    itemsFromEvents: gameState.itemsFromEvents,
                    fusionCount: gameState.fusionCount,
                    statisticsViewed: gameState.statisticsViewed,
                    collectionBonuses: gameState.collectionBonuses,
                    rarityMilestones: gameState.rarityMilestones,
                    inventorySort: gameState.inventorySort,
                    inventoryFilter: gameState.inventoryFilter,
                    favoriteItems: gameState.favoriteItems,
                    tutorialStep: gameState.tutorialStep,
                    tutorialComplete: gameState.tutorialComplete,
                    tutorialSkipped: gameState.tutorialSkipped,
                    questsCompleted: gameState.questsCompleted,
                    dailyStreak: gameState.dailyStreak,
                    weeklyQuestsCompleted: gameState.weeklyQuestsCompleted,
                    shopPurchases: gameState.shopPurchases,
                    activeQuests: gameState.activeQuests,
                    completedQuests: gameState.completedQuests,
                    lastQuestRefresh: gameState.lastQuestRefresh,
                    dailyChallenges: gameState.dailyChallenges,
                    lastDailyChallengeDate: gameState.lastDailyChallengeDate,
                    achievementPoints: gameState.achievementPoints,
                    achievementShopPurchases: gameState.achievementShopPurchases,
                    pets: gameState.pets,
                    activePet: gameState.activePet,
                    petLevels: gameState.petLevels,
                    petXP: gameState.petXP,
                    prestigeLevel: gameState.prestigeLevel,
                    prestigePoints: gameState.prestigePoints,
                    prestigeShopPurchases: gameState.prestigeShopPurchases,
                    claimedBPTiers: gameState.claimedBPTiers,
                    redeemedCodes: gameState.redeemedCodes,
                    // NEW SYSTEMS
                    skillsUnlocked: gameState.skillsUnlocked,
                    leaderboardUnlocked: gameState.leaderboardUnlocked,
                    guildUnlocked: gameState.guildUnlocked,
                    gachaUnlocked: gameState.gachaUnlocked,
                    themesUnlocked: gameState.themesUnlocked,
                    titlesUnlocked: gameState.titlesUnlocked,
                    skillPoints: gameState.skillPoints,
                    skillsPurchased: gameState.skillsPurchased,
                    currentGuild: gameState.currentGuild,
                    gems: gameState.gems,
                    gachaPulls: gameState.gachaPulls,
                    gachaPity: gameState.gachaPity,
                    currentTheme: gameState.currentTheme,
                    unlockedThemes: gameState.unlockedThemes,
                    currentTitle: gameState.currentTitle,
                    unlockedTitles: gameState.unlockedTitles,
                    saveDate: new Date().toISOString()
                };
                
                localStorage.setItem('rngTraderSave', JSON.stringify(saveData));
                
                // Only show notification if it's a manual save OR if auto-save notifications are enabled
                if (!isAutoSave || gameState.settings.showAutoSaveNotifications) {
                    showNotification('Game saved successfully!', 'var(--success)');
                }
            } catch (error) {
                showNotification('Failed to save game!', 'var(--danger)');
                console.error('Save error:', error);
            }
        }
        
        function loadGame() {
            try {
                const saveData = localStorage.getItem('rngTraderSave');
                
                if (!saveData) {
                    showNotification('No save file found!', 'var(--warning)');
                    return;
                }
                
                if (!confirm('Loading will overwrite current progress. Continue?')) {
                    return;
                }
                
                const data = JSON.parse(saveData);
                
                // Load all saved data
                gameState.inventory = data.inventory || {};
                gameState.totalValue = data.totalValue || 0;
                gameState.money = data.money || 0;
                gameState.totalSpins = data.totalSpins || 0;
                gameState.luckMultiplier = data.luckMultiplier || 1.0;
                gameState.tradeWins = data.tradeWins || 0;
                gameState.tradeLosses = data.tradeLosses || 0;
                gameState.battlePassXP = data.battlePassXP || 0;
                gameState.achievements = data.achievements || {};
                gameState.upgrades = data.upgrades || {
                    spinSpeed: 0,
                    popularity: 0,
                    luckBoost: 0,
                    autoSpin: 0,
                    tradeInsight: 0,
                    valueBoost: 0,
                    craftingMastery: 0,
                    enchantPower: 0,
                    multiSpin: 0,
                    shopDiscount: 0,
                    rarityBoost: 0
                };
                // Ensure new upgrades exist in old saves
                if (gameState.upgrades.valueBoost === undefined) gameState.upgrades.valueBoost = 0;
                if (gameState.upgrades.craftingMastery === undefined) gameState.upgrades.craftingMastery = 0;
                if (gameState.upgrades.enchantPower === undefined) gameState.upgrades.enchantPower = 0;
                if (gameState.upgrades.multiSpin === undefined) gameState.upgrades.multiSpin = 0;
                if (gameState.upgrades.shopDiscount === undefined) gameState.upgrades.shopDiscount = 0;
                if (gameState.upgrades.rarityBoost === undefined) gameState.upgrades.rarityBoost = 0;
                if (gameState.upgrades.eventLuck === undefined) gameState.upgrades.eventLuck = 0;
                if (gameState.upgrades.xpBoost === undefined) gameState.upgrades.xpBoost = 0;
                if (gameState.upgrades.sellPrice === undefined) gameState.upgrades.sellPrice = 0;
                if (gameState.upgrades.questSpeed === undefined) gameState.upgrades.questSpeed = 0;
                if (gameState.upgrades.mysteryBox === undefined) gameState.upgrades.mysteryBox = 0;
                if (gameState.specialEventIsAdmin === undefined) gameState.specialEventIsAdmin = false;
                
                // Backwards compatibility for new features
                if (gameState.pityCounter === undefined) gameState.pityCounter = 0;
                if (gameState.pityThreshold === undefined) gameState.pityThreshold = 100;
                if (gameState.pityTriggered === undefined) gameState.pityTriggered = 0;
                if (gameState.lastLoginDate === undefined) gameState.lastLoginDate = null;
                if (gameState.loginStreak === undefined) gameState.loginStreak = 0;
                if (gameState.totalLogins === undefined) gameState.totalLogins = 0;
                if (gameState.loginRewardsClaimed === undefined) gameState.loginRewardsClaimed = [];
                if (gameState.lifetimeMoneyEarned === undefined) gameState.lifetimeMoneyEarned = 0;
                if (gameState.lifetimeMoneySpent === undefined) gameState.lifetimeMoneySpent = 0;
                if (gameState.biggestTradeWin === undefined) gameState.biggestTradeWin = 0;
                if (gameState.biggestTradeLoss === undefined) gameState.biggestTradeLoss = 0;
                if (gameState.rarityCounts === undefined) gameState.rarityCounts = {};
                if (gameState.itemsFromEvents === undefined) gameState.itemsFromEvents = 0;
                if (gameState.craftCount === undefined) gameState.craftCount = 0;
                if (gameState.enchantSuccess === undefined) gameState.enchantSuccess = 0;
                if (gameState.enchantFails === undefined) gameState.enchantFails = 0;
                if (gameState.fusionCount === undefined) gameState.fusionCount = 0;
                if (gameState.statisticsViewed === undefined) gameState.statisticsViewed = false;
                if (gameState.collectionBonuses === undefined) gameState.collectionBonuses = {discoComplete:false,galacticComplete:false,glitchComplete:false,fullmoonComplete:false,bloodmoonComplete:false,weatherComplete:false,christmasComplete:false};
                if (gameState.rarityMilestones === undefined) gameState.rarityMilestones = {};
                if (gameState.upgrades.autoFusion === undefined) gameState.upgrades.autoFusion = 0;
                if (gameState.notificationQueue === undefined) gameState.notificationQueue = [];
                if (gameState.isShowingNotification === undefined) gameState.isShowingNotification = false;
                
                gameState.rebirths = data.rebirths || 0;
                gameState.permanentLuckBoost = data.permanentLuckBoost || 1.0;
                gameState.settings = data.settings || {
                    soundEffects: true,
                    showTradeNotifications: true,
                    showExpiredNotifications: true,
                    showSpinResults: true,
                    showAchievementNotifications: true,
                    showRandomEvents: true,
                    showAutoSaveNotifications: false
                };
                // Ensure new setting exists in old saves
                if (gameState.settings.soundEffects === undefined) {
                    gameState.settings.soundEffects = true;
                }
                if (gameState.settings.showAutoSaveNotifications === undefined) {
                    gameState.settings.showAutoSaveNotifications = false;
                }
                gameState.craftCount = data.craftCount || 0;
                gameState.enchantSuccess = data.enchantSuccess || 0;
                gameState.enchantFails = data.enchantFails || 0;
                gameState.adminUnlocked = data.adminUnlocked || false;
                gameState.questsCompleted = data.questsCompleted || 0;
                gameState.dailyStreak = data.dailyStreak || 0;
                gameState.weeklyQuestsCompleted = data.weeklyQuestsCompleted || 0;
                gameState.shopPurchases = data.shopPurchases || 0;
                gameState.activeQuests = data.activeQuests || [];
                gameState.completedQuests = data.completedQuests || [];
                gameState.lastQuestRefresh = data.lastQuestRefresh || 0;
                gameState.claimedBPTiers = data.claimedBPTiers || [];
                gameState.battlePassTier = data.battlePassTier || 0;
                
                // Load new features (bosses, dungeons, artifacts, timed events)
                gameState.bosses = data.bosses || {};
                gameState.bossStats = data.bossStats || { totalDefeated: 0, totalDamage: 0, bestReward: 0 };
                gameState.dungeons = data.dungeons || { unlocked: ['dark_forest'], stats: { cleared: 0, enemiesDefeated: 0, treasureFound: 0, totalLoot: 0 }, activeExpedition: null, cooldowns: {} };
                gameState.potions = data.potions || { owned: [], active: [], consumed: 0 };
                gameState.potionsUnlocked = data.potionsUnlocked || false;
                gameState.artifacts = data.artifacts || [];
                gameState.triggeredTimedEvents = data.triggeredTimedEvents || {};
                
                // Load other existing fields
                gameState.inventorySort = data.inventorySort || 'rarity';
                gameState.inventoryFilter = data.inventoryFilter || 'all';
                gameState.favoriteItems = data.favoriteItems || [];
                gameState.tutorialStep = data.tutorialStep || 0;
                gameState.tutorialComplete = data.tutorialComplete || false;
                gameState.tutorialSkipped = data.tutorialSkipped || false;
                gameState.dailyChallenges = data.dailyChallenges || [];
                gameState.lastDailyChallengeDate = data.lastDailyChallengeDate || null;
                gameState.achievementPoints = data.achievementPoints || 0;
                gameState.achievementShopPurchases = data.achievementShopPurchases || [];
                gameState.pets = data.pets || [];
                gameState.activePet = data.activePet || null;
                gameState.petLevels = data.petLevels || {};
                gameState.petXP = data.petXP || {};
                gameState.prestigeLevel = data.prestigeLevel || 0;
                gameState.prestigePoints = data.prestigePoints || 0;
                gameState.prestigeShopPurchases = data.prestigeShopPurchases || {};
                gameState.redeemedCodes = data.redeemedCodes || [];
                
                // NEW SYSTEMS
                gameState.skillsUnlocked = data.skillsUnlocked;
                gameState.leaderboardUnlocked = data.leaderboardUnlocked;
                gameState.guildUnlocked = data.guildUnlocked;
                gameState.gachaUnlocked = data.gachaUnlocked;
                gameState.themesUnlocked = data.themesUnlocked;
                gameState.titlesUnlocked = data.titlesUnlocked;
                gameState.skillPoints = data.skillPoints || 0;
                gameState.skillsPurchased = data.skillsPurchased || {};
                gameState.currentGuild = data.currentGuild || null;
                gameState.gems = data.gems || 100;
                gameState.gachaPulls = data.gachaPulls || 0;
                gameState.gachaPity = data.gachaPity || 0;
                gameState.currentTheme = data.currentTheme || 'default';
                gameState.unlockedThemes = data.unlockedThemes || ['default'];
                gameState.currentTitle = data.currentTitle || null;
                gameState.unlockedTitles = data.unlockedTitles || [];
                
                // Update all displays
                updateStats();
                updateInventory();
                updateBattlePass();
                updateRebirthDisplay();
                refreshQuests();
                updateQuestDisplay();
                updateBossesDisplay();
                updateDungeonsDisplay();
                updatePotionsDisplay();
                updateArtifactsDisplay();
                updateRedeemedCodesList();
                checkAchievements();
                
                // Update new systems displays
                initializeNewSystems();
                updateSkillsDisplay();
                updateLeaderboardDisplay();
                updateGuildDisplay();
                updateGachaDisplay();
                updateThemesDisplay();
                updateTitlesDisplay();
                
                const saveDate = data.saveDate ? new Date(data.saveDate) : 'Unknown';
                showNotification(`Game loaded! (Saved: ${saveDate})`, 'var(--success)');
            } catch (error) {
                showNotification('Failed to load game!', 'var(--danger)');
                console.error('Load error:', error);
            }
        }
        
        // ===== ADMIN FUNCTIONS =====
        
        function adminAddMoney(amount) {
            gameState.money += amount;
            updateStats();
            showNotification(`Admin: Added $${formatNumber(amount)}!`, 'var(--accent-gold)');
        }
        
        function adminSpawnItem() {
            const rarityIndex = parseInt(document.getElementById('adminRaritySelect').value);
            const count = parseInt(document.getElementById('adminItemCount').value) || 1;
            const rarity = rarities[rarityIndex];
            
            for (let i = 0; i < count; i++) {
                const itemName = generateItemName(rarity);
                addItemToInventory(itemName, rarity);
            }
            
            updateInventory();
            showNotification(`Admin: Spawned ${count}x ${rarity.name} item(s)!`, rarity.color);
        }
        
        function adminSetLuck(multiplier) {
            gameState.luckMultiplier = multiplier;
            updateStats();
            showNotification(`Admin: Luck set to ${multiplier}x`, 'var(--accent-primary)');
        }
        
        function adminMaxUpgrades() {
            for (const key in gameState.upgrades) {
                gameState.upgrades[key] = upgradeData[key].maxLevel;
            }
            // Apply effects
            gameState.luckMultiplier = 1.0 + (upgradeData.luckBoost.maxLevel * 0.1);
            updateStats();
            initUpgrades();
            showNotification('Admin: All upgrades maxed!', 'var(--success)');
        }
        
        function adminAddBPXP(amount) {
            gameState.battlePassXP += amount;
            claimBattlePassRewards();
            updateBattlePass();
            showNotification(`Admin: Added ${formatNumber(amount)} BP XP`, 'var(--accent-primary)');
        }
        
        function adminMaxBP() {
            gameState.battlePassXP = battlePassTiers[battlePassTiers.length - 1].xpRequired;
            claimBattlePassRewards();
            updateBattlePass();
            showNotification('Admin: Battle Pass maxed!', 'var(--accent-gold)');
        }
        
        function adminToggleChristmas() {
            gameState.christmasEvent = !gameState.christmasEvent;
            if (gameState.christmasEvent) {
                gameState.christmasEventEnd = new Date(Date.now() + 5 * 60000);
            } else {
                gameState.christmasEventEnd = null;
            }
            updateEventBonuses();
            showNotification(`Admin: Christmas Event ${gameState.christmasEvent ? 'Activated' : 'Deactivated'}!`, '#ff0000');
        }
        
        function adminSpawnTrade() {
            generateNPCTrade();
            showNotification('Admin: Spawned trade!', 'var(--accent-primary)');
        }
        
        function adminStartWeatherEvent(eventType) {
            startWeatherEvent(eventType);
            showNotification(`Admin: Started ${eventType} event!`, '#00aaff');
        }
        
        function adminStartSpecialEvent(eventType) {
            startSpecialEvent(eventType);
            const eventColors = {
                disco: '#ff00ff',
                galactic: '#4B0082',
                glitch: '#00ff00',
                fullmoon: '#f0f0f0',
                bloodmoon: '#8B0000',
                nuclear: '#00ff00',
                volcanic: '#ff4500',
                goldenrain: '#ffd700'
            };
            showNotification(`Admin: Started ${eventType} event!`, eventColors[eventType]);
        }
        
        function adminSetLuckEvent(multiplier) {
            if (!gameState.luckEvent) gameState.luckEvent = {};
            gameState.luckEvent.active = true;
            gameState.luckEvent.multiplier = multiplier;
            gameState.luckEvent.endTime = Date.now() + 60000; // 1 minute
            showCenterNotification(`✨ ${multiplier}x LUCK EVENT ACTIVATED! ✨`, '#ffaa00', 3000);
            updateEventBonuses();
        }
        
        function adminStopLuckEvent() {
            if (gameState.luckEvent) {
                gameState.luckEvent.active = false;
                showNotification('Admin: Luck event stopped!', 'var(--warning)');
                updateEventBonuses();
            }
        }
        
        function adminUnlockPotions() {
            gameState.potionsUnlocked = true;
            showNotification('🧪 Admin: Potions system unlocked early!', 'var(--accent-primary)');
            updatePotionsDisplay();
        }
        
        function adminGiveSkillPoints(amount) {
            gameState.skillPoints += amount;
            showNotification(`✅ Admin: +${amount} Skill Points!`, 'var(--accent-primary)');
            updateSkillsDisplay();
            saveGame(true);
        }
        
        function adminGiveGems(amount) {
            gameState.gems += amount;
            showNotification(`💎 Admin: +${amount} Gems!`, 'var(--accent-primary)');
            updateGachaDisplay();
            saveGame(true);
        }
        
        function adminClearInventory() {
            if (!confirm('Clear entire inventory?')) return;
            gameState.inventory = {};
            gameState.totalValue = 0;
            gameState.flexedItem = null;
            updateStats();
            updateInventory();
            showNotification('Admin: Inventory cleared!', 'var(--warning)');
        }
        
        function adminDuplicateInventory() {
            let duplicatedItems = 0;
            for (const [key, item] of Object.entries(gameState.inventory)) {
                if (item.count > 0) {
                    const originalCount = item.count;
                    item.count *= 2;
                    gameState.totalValue += item.value * originalCount;
                    duplicatedItems += originalCount;
                }
            }
            updateStats();
            updateInventory();
            showNotification(`Admin: Duplicated ${duplicatedItems} items!`, 'var(--success)');
        }
        
        function adminUnlockAllAchievements() {
            achievements.forEach(achievement => {
                if (!gameState.achievements[achievement.id]) {
                    gameState.achievements[achievement.id] = true;
                }
            });
            checkAchievements();
            showNotification('Admin: All achievements unlocked!', 'var(--accent-gold)');
        }
        
        function adminResetAchievements() {
            if (!confirm('Reset all achievements?')) return;
            gameState.achievements = {};
            checkAchievements();
            showNotification('Admin: Achievements reset!', 'var(--warning)');
        }
        
        function adminSetSpins(amount) {
            gameState.totalSpins = amount;
            updateStats();
            checkAchievements();
            showNotification(`Admin: Set spins to ${formatNumber(amount)}!`, 'var(--accent-primary)');
        }
        
        function adminAddRebirths(amount) {
            gameState.rebirths += amount;
            gameState.permanentLuckBoost += (amount * 2.0);
            updateStats();
            updateRebirthDisplay();
            showNotification(`Admin: Added ${amount} rebirth(s)!`, 'var(--accent-gold)');
        }
        
        function adminSetTradeWins(amount) {
            gameState.tradeWins = amount;
            updateStats();
            checkAchievements();
            showNotification(`Admin: Set trade wins to ${formatNumber(amount)}!`, 'var(--accent-primary)');
        }
        
        function adminCompleteEverything() {
            if (!confirm('This will max out upgrades, battle pass, money, and unlock achievements. Continue?')) return;
            
            // Max upgrades
            for (const key in gameState.upgrades) {
                gameState.upgrades[key] = upgradeData[key].maxLevel;
            }
            gameState.luckMultiplier = 1.0 + (upgradeData.luckBoost.maxLevel * 0.1);
            
            // Max battle pass
            gameState.battlePassXP = battlePassTiers[battlePassTiers.length - 1].xpRequired;
            
            // Add money
            gameState.money += 100000000;
            
            // Unlock achievements
            achievements.forEach(achievement => {
                gameState.achievements[achievement.id] = true;
            });
            
            updateStats();
            updateBattlePass();
            initUpgrades();
            checkAchievements();
            
            showNotification('Admin: Everything completed!', 'var(--accent-gold)');
        }
        
        function adminResetGame() {
            if (confirm('Are you SURE you want to reset all progress? This cannot be undone!')) {
                if (confirm('Last chance! Reset everything?')) {
                    localStorage.removeItem('rngTraderSave');
                    location.reload();
                }
            }
        }
        
        function updateEventBonuses() {
            const bonusesDiv = document.getElementById('eventBonuses');
            let activeEvents = [];
            
            if (gameState.christmasEvent) {
                const timeLeft = gameState.christmasEventEnd ? Math.max(0, Math.floor((gameState.christmasEventEnd - new Date()) / 1000)) : 300;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                activeEvents.push(`
                    <div class="stat-card">
                        <div class="stat-label">🎄 Holiday Luck</div>
                        <div class="stat-value" style="color: var(--success);">+15% Holiday Items</div>
                        <div class="stat-label" style="margin-top: 5px;">Time: ${minutes}:${seconds.toString().padStart(2, '0')}</div>
                    </div>
                `);
            }
            
            if (gameState.specialEvent) {
                const timeLeft = Math.max(0, Math.floor((gameState.specialEventEnd - Date.now()) / 1000));
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                const eventNames = { 
                    disco: '🪩 Disco', 
                    galactic: '🌌 Galactic', 
                    glitch: '⚡ Glitch', 
                    fullmoon: '🌕 Full Moon', 
                    bloodmoon: '🔴 Blood Moon',
                    admin: '🔴 Admin Access'
                };
                const eventColors = {
                    disco: '#ff00ff',
                    galactic: '#4B0082',
                    glitch: '#00ff00',
                    fullmoon: '#f0f0f0',
                    bloodmoon: '#8B0000',
                    admin: '#ff0000'
                };
                activeEvents.push(`
                    <div class="stat-card">
                        <div class="stat-label">${eventNames[gameState.specialEvent]} Event</div>
                        <div class="stat-value" style="color: ${eventColors[gameState.specialEvent]};">Special Items! 40%</div>
                        <div class="stat-label" style="margin-top: 5px;">Time: ${minutes}:${seconds.toString().padStart(2, '0')}</div>
                    </div>
                `);
            }
            
            if (gameState.weatherEvent) {
                const timeLeft = Math.max(0, Math.floor((gameState.weatherEventEnd - Date.now()) / 1000));
                const eventNames = { cloudy: '☁️ Cloudy', rainy: '🌧️ Rainy', storming: '⛈️ Storming' };
                activeEvents.push(`
                    <div class="stat-card">
                        <div class="stat-label">${eventNames[gameState.weatherEvent]} Event</div>
                        <div class="stat-value" style="color: var(--accent-primary);">Weather Items! 30%</div>
                        <div class="stat-label" style="margin-top: 5px;">Time: ${timeLeft}s</div>
                    </div>
                `);
            }
            
            if (activeEvents.length > 0) {
                bonusesDiv.innerHTML = activeEvents.join('');
            } else {
                const now = new Date();
                const currentMinute = now.getMinutes();
                const currentHour = now.getHours();
                
                // Calculate next event
                let nextEventText = '';
                if (currentMinute < 15) {
                    nextEventText = `🪩 Disco in ${15 - currentMinute} min`;
                } else if (currentMinute < 20) {
                    nextEventText = `🌕 Full Moon in ${20 - currentMinute} min`;
                } else if (currentMinute < 30) {
                    nextEventText = `🌌 Galactic in ${30 - currentMinute} min`;
                } else if (currentMinute < 45) {
                    nextEventText = `⚡ Glitch in ${45 - currentMinute} min`;
                } else if (currentMinute < 50) {
                    nextEventText = `🔴 Blood Moon in ${50 - currentMinute} min`;
                } else {
                    nextEventText = `🎄 Christmas in ${60 - currentMinute} min`;
                }
                
                bonusesDiv.innerHTML = `
                    <p style="color: var(--text-secondary);">No active event bonuses</p>
                    <p style="color: var(--accent-gold); margin-top: 10px; font-weight: bold;">Next: ${nextEventText}</p>
                    <p style="color: var(--text-secondary); margin-top: 5px; font-size: 0.9rem;">Weather events happen randomly</p>
                `;
            }
        }
        
        function triggerRandomEvent() {
            const events = [
                { name: 'Lucky Streak!', effect: () => { gameState.luckMultiplier += 0.2; }, message: 'Luck increased by 0.2x!' },
                { name: 'Mysterious Trader', effect: () => { gameState.money += 5000; }, message: 'A mysterious trader gave you $5,000!' },
                { name: 'Item Duplication', effect: () => {
                    const keys = Object.keys(gameState.inventory).filter(k => gameState.inventory[k].count > 0);
                    if (keys.length > 0) {
                        const key = keys[Math.floor(Math.random() * keys.length)];
                        gameState.inventory[key].count++;
                        gameState.totalValue += gameState.inventory[key].value;
                    }
                }, message: 'A random item was duplicated!' }
            ];
            
            const event = events[Math.floor(Math.random() * events.length)];
            event.effect();
            showNotification(`🎉 ${event.name}: ${event.message}`, 'var(--accent-gold)');
            updateStats();
            updateInventory();
        }
        
        function showNotification(message, color) {
            // Check settings before showing certain notifications
            if (message.includes('wants to trade') && !gameState.settings.showTradeNotifications) return;
            if (message.includes('expired') && !gameState.settings.showExpiredNotifications) return;
            if (message.includes('You got:') && !gameState.settings.showSpinResults) return;
            if (message.includes('Achievement') && !gameState.settings.showAchievementNotifications) return;
            if (message.includes('Random Event') && !gameState.settings.showRandomEvents) return;
            
            // Add to queue
            gameState.notificationQueue.push({ message, color });
            
            // Process queue if not already processing
            if (!gameState.isShowingNotification) {
                processNotificationQueue();
            }
        }
        
        function processNotificationQueue() {
            if (gameState.notificationQueue.length === 0) {
                gameState.isShowingNotification = false;
                return;
            }
            
            gameState.isShowingNotification = true;
            const { message, color } = gameState.notificationQueue.shift();
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.borderColor = color;
            notification.innerHTML = `<strong style="color: ${color};">${message}</strong>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.5s ease-out reverse';
                setTimeout(() => {
                    notification.remove();
                    // Process next notification after a small delay
                    setTimeout(() => processNotificationQueue(), 200);
                }, 500);
            }, 2000); // Reduced from 3000 to 2000 for faster queue processing
        }
        
        function showCenterNotification(message, color, duration = 5000) {
            // Create center notification that lasts longer and is more prominent
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-dark);
                border: 3px solid ${color};
                border-radius: 15px;
                padding: 30px 50px;
                z-index: 10000;
                font-size: 2rem;
                font-weight: bold;
                color: ${color};
                text-align: center;
                box-shadow: 0 0 30px ${color}, 0 0 60px ${color};
                animation: pulse 1s infinite;
            `;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.5s ease-out';
                setTimeout(() => notification.remove(), 500);
            }, duration);
        }
        
        function unlockAdmin() {
            gameState.adminUnlocked = true;
            // Show the admin toggle button
            document.getElementById('showAdminBtn').style.display = 'inline-block';
            showCenterNotification('🔓 ADMIN PANEL UNLOCKED! 🔓\nClick "Admin Panel" button to access.', '#ff0000', 5000);
        }
        
        function showCodesPanel() {
            document.getElementById('codesPanel').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('showCodesBtn').className = 'btn btn-accept';
            document.getElementById('showAdminBtn').className = 'btn btn-decline';
        }
        
        function showAdminPanel() {
            if (!gameState.adminUnlocked) {
                showNotification('🔒 Admin panel is locked! Redeem the admin code first.', 'var(--warning)');
                return;
            }
            document.getElementById('codesPanel').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('showCodesBtn').className = 'btn btn-decline';
            document.getElementById('showAdminBtn').className = 'btn btn-accept';
        }
        
        // ===== CODE REDEMPTION SYSTEM =====
        
        const rewardCodes = {
            'WasHereForAbuse': {
                name: 'Early Adopter',
                reward: () => {
                    const etherealRarity = rarities.find(r => r.name === 'Ethereal');
                    if (etherealRarity) {
                        const itemName = generateItemName(etherealRarity);
                        addItemToInventory(itemName, etherealRarity);
                        return `🎁 You received: ${itemName} (Ethereal)!`;
                    }
                    return '❌ Error giving reward';
                }
            },
            'RNG_GODLY': {
                name: 'Divine Pet',
                reward: () => {
                    // Give a special legendary pet
                    if (!gameState.pets) gameState.pets = [];
                    if (!gameState.petLevels) gameState.petLevels = {};
                    
                    // Check if they already have the Divine Dragon
                    const divineDragonId = 'divine_dragon';
                    if (!gameState.pets.includes(divineDragonId)) {
                        gameState.pets.push(divineDragonId);
                        gameState.petLevels[divineDragonId] = 1;
                        // Also make it active
                        gameState.activePet = divineDragonId;
                        return '🐉 You received: Divine Dragon Pet! (+15% Luck Forever!)';
                    }
                    return '⚠️ You already have the Divine Dragon!';
                }
            },
            'LUCKY_START': {
                name: 'Lucky Beginner',
                reward: () => {
                    // Give permanent luck boost
                    gameState.permanentLuckBoost += 0.5;
                    // Give some money
                    gameState.money += 100000;
                    return '✨ +0.5x Permanent Luck & $100,000!';
                }
            },
            'MEGA_BOOST': {
                name: 'Mega Starter Pack',
                reward: () => {
                    // Give multiple high-tier items
                    let items = [];
                    const rarityNames = ['Primordial', 'Omega', 'Supreme'];
                    rarityNames.forEach(rarityName => {
                        const rarity = rarities.find(r => r.name === rarityName);
                        if (rarity) {
                            const itemName = generateItemName(rarity);
                            addItemToInventory(itemName, rarity);
                            items.push(itemName);
                        }
                    });
                    return `🎁 You received 3 legendary items: ${items.join(', ')}!`;
                }
            },
            'MONEY_RAIN': {
                name: 'Money Shower',
                reward: () => {
                    gameState.money += 5000000;
                    gameState.lifetimeMoneyEarned += 5000000;
                    return '💰 You received $5,000,000!';
                }
            },
            'ULTIMATE_POWER': {
                name: 'Power Boost',
                reward: () => {
                    // Boost several upgrades
                    gameState.upgrades.luckBoost = Math.min((gameState.upgrades.luckBoost || 0) + 5, upgradeData.luckBoost.maxLevel);
                    gameState.upgrades.valueBoost = Math.min((gameState.upgrades.valueBoost || 0) + 5, upgradeData.valueBoost.maxLevel);
                    gameState.upgrades.rarityBoost = Math.min((gameState.upgrades.rarityBoost || 0) + 3, upgradeData.rarityBoost.maxLevel);
                    updateEventBonuses();
                    return '⚡ +5 Luck Boost, +5 Value Boost, +3 Rarity Boost upgrades!';
                }
            },
            'RnG_AdmIn': {
                name: 'Admin Access',
                reward: () => {
                    unlockAdmin();
                    return '🔓 Admin Panel Unlocked!';
                }
            },
            'EXCLUSIVE_ADMIN': {
                name: 'Admin Item Drop',
                reward: () => {
                    const adminRarity = rarities.find(r => r.name === 'Admin');
                    if (adminRarity) {
                        const itemName = generateItemName(adminRarity);
                        addItemToInventory(itemName, adminRarity);
                        return `🔴 ADMIN ITEM! You got: ${itemName}!`;
                    }
                    return '❌ Error giving reward';
                }
            },
            'PRIMEVAL_POWER': {
                name: 'Ancient Force',
                reward: () => {
                    const primevalRarity = rarities.find(r => r.name === 'Primeval');
                    if (primevalRarity) {
                        const itemName = generateItemName(primevalRarity);
                        addItemToInventory(itemName, primevalRarity);
                        return `🦖 PRIMEVAL! You got: ${itemName}!`;
                    }
                    return '❌ Error giving reward';
                }
            },
            'QUANTUM_REALM': {
                name: 'Quantum Superposition',
                reward: () => {
                    // Give 2 items that change rarities!
                    const items = [];
                    ['Quantum', 'Dimensional'].forEach(rarityName => {
                        const rarity = rarities.find(r => r.name === rarityName);
                        if (rarity) {
                            const itemName = generateItemName(rarity);
                            addItemToInventory(itemName, rarity);
                            items.push(`${itemName} (${rarityName})`);
                        }
                    });
                    return `⚛️ QUANTUM ITEMS! You got: ${items.join(' and ')}!`;
                }
            },
            'INFINITY_BREAKER': {
                name: 'Beyond Limits',
                reward: () => {
                    // Give permanent luck boost + Limitless item
                    gameState.permanentLuckBoost += 1.0;
                    const limitlessRarity = rarities.find(r => r.name === 'Limitless');
                    if (limitlessRarity) {
                        const itemName = generateItemName(limitlessRarity);
                        addItemToInventory(itemName, limitlessRarity);
                        return `♾️ +1.0x Permanent Luck & ${itemName} (Limitless)!`;
                    }
                    return '♾️ +1.0x Permanent Luck!';
                }
            },
            'TRIPLE_OMEGA': {
                name: 'Trinity Pack',
                reward: () => {
                    // Give 3 Omega items
                    const omegaRarity = rarities.find(r => r.name === 'Omega');
                    const items = [];
                    if (omegaRarity) {
                        for (let i = 0; i < 3; i++) {
                            const itemName = generateItemName(omegaRarity);
                            addItemToInventory(itemName, omegaRarity);
                            items.push(itemName);
                        }
                        return `🎁 3x OMEGA! You got: ${items.join(', ')}!`;
                    }
                    return '❌ Error giving reward';
                }
            },
            'BOSS_SLAYER': {
                name: 'Boss Hunter Pack',
                reward: () => {
                    // Give $50M, reduce ALL boss cooldowns to 0
                    gameState.money += 50000000;
                    Object.keys(gameState.bosses).forEach(bossId => {
                        if (gameState.bosses[bossId]) {
                            gameState.bosses[bossId].lastFought = 0;
                        }
                    });
                    return '💰 $50M + All boss cooldowns reset!';
                }
            },
            'PET_MASTER_PRO': {
                name: 'Pet Collector',
                reward: () => {
                    // Give 3 random pets
                    if (!gameState.pets) gameState.pets = [];
                    if (!gameState.petLevels) gameState.petLevels = {};
                    
                    const ownedPets = new Set(gameState.pets);
                    const availablePetsNotOwned = availablePets.filter(p => !ownedPets.has(p.id));
                    
                    const newPets = [];
                    for (let i = 0; i < 3 && availablePetsNotOwned.length > 0; i++) {
                        const randomPet = availablePetsNotOwned[Math.floor(Math.random() * availablePetsNotOwned.length)];
                        gameState.pets.push(randomPet.id);
                        gameState.petLevels[randomPet.id] = 1;
                        newPets.push(randomPet.name);
                        availablePetsNotOwned.splice(availablePetsNotOwned.indexOf(randomPet), 1);
                    }
                    
                    updatePetsDisplay();
                    return `🐾 3 NEW PETS! You got: ${newPets.join(', ')}!`;
                }
            },
            'ARTIFACT_MASTER': {
                name: 'Artifact Cache',
                reward: () => {
                    // Give 2 random artifacts
                    if (!gameState.artifacts) gameState.artifacts = [];
                    
                    const artifactIds = ['ancient_coin', 'lucky_clover', 'rabbits_foot', 'fortune_crystal', 'celestial_amulet'];
                    const unownedArtifacts = artifactIds.filter(id => !gameState.artifacts.includes(id));
                    
                    const newArtifacts = [];
                    for (let i = 0; i < 2 && unownedArtifacts.length > 0; i++) {
                        const randomArtifact = unownedArtifacts[Math.floor(Math.random() * unownedArtifacts.length)];
                        gameState.artifacts.push(randomArtifact);
                        newArtifacts.push(randomArtifact.replace(/_/g, ' '));
                        unownedArtifacts.splice(unownedArtifacts.indexOf(randomArtifact), 1);
                    }
                    
                    return `💎 2 ARTIFACTS! You got: ${newArtifacts.join(' and ')}!`;
                }
            },
            'DIMENSION_WALKER': {
                name: 'Dimensional Traveler',
                reward: () => {
                    // Give items from 3 different high-tier rarities
                    const items = [];
                    ['Hyperversal', 'Outerversal', 'The Source'].forEach(rarityName => {
                        const rarity = rarities.find(r => r.name === rarityName);
                        if (rarity) {
                            const itemName = generateItemName(rarity);
                            addItemToInventory(itemName, rarity);
                            items.push(`${itemName} (${rarityName})`);
                        }
                    });
                    return `🌌 3 ULTRA-RARE ITEMS! ${items.join(', ')}!`;
                }
            },
            'BEYOND_LIMITS': {
                name: 'Transcendent Power',
                reward: () => {
                    const beyondRarity = rarities.find(r => r.name === 'Beyond Infinity');
                    if (beyondRarity) {
                        const itemName = generateItemName(beyondRarity);
                        addItemToInventory(itemName, beyondRarity);
                        return `♾️ BEYOND INFINITY! You got: ${itemName}!`;
                    }
                    return '❌ Error giving reward';
                }
            },
            'DUNGEON_MASTER_PRO': {
                name: 'Ultimate Explorer',
                reward: () => {
                    gameState.money += 100000000; // $100M
                    // Unlock all dungeons
                    if (!gameState.dungeons) gameState.dungeons = { unlocked: [] };
                    gameState.dungeons.unlocked = ['dark_forest', 'crystal_caves', 'ancient_ruins', 'volcanic_depths', 'frozen_citadel'];
                    return '🗺️ $100M + 5 Dungeons Unlocked!';
                }
            },
            'ARTIFACT_COLLECTOR': {
                name: 'Artifact Hunter',
                reward: () => {
                    // Give 5 random artifacts
                    const artifacts = ['luck_charm', 'golden_ring', 'magic_crystal', 'ancient_coin', 'mystic_amulet'];
                    artifacts.forEach(id => {
                        if (!gameState.artifacts.includes(id)) {
                            gameState.artifacts.push(id);
                        }
                    });
                    return '💎 5 Artifacts Added to Collection!';
                }
            },
            'PET_PARADISE': {
                name: 'Pet Collector',
                reward: () => {
                    // Give 5 random pets
                    const petIds = ['lucky_cat', 'money_dog', 'golden_bird', 'mystic_fox', 'shadow_wolf'];
                    petIds.forEach(id => {
                        if (!gameState.pets.includes(id)) {
                            gameState.pets.push(id);
                            gameState.petLevels[id] = 1;
                        }
                    });
                    return '🐾 5 Pets Added to Collection!';
                }
            },
            'MEGA_MULTIPLIER': {
                name: 'Luck Overdrive',
                reward: () => {
                    gameState.permanentLuckBoost += 2.0;
                    gameState.luckMultiplier += 5.0;
                    updateEventBonuses();
                    return '✨ +2.0x Permanent Luck + +5.0x Temporary Luck!';
                }
            },
            'BILLIONAIRE_STATUS': {
                name: 'Ultimate Wealth',
                reward: () => {
                    gameState.money += 1000000000; // $1B
                    gameState.lifetimeMoneyEarned += 1000000000;
                    return '💰 YOU RECEIVED $1,000,000,000!';
                }
            },
            'CELESTIAL_BLESSING': {
                name: 'Divine Grace',
                reward: () => {
                    const items = [];
                    ['Celestial Prime', 'The Eternal', 'The Source'].forEach(rarityName => {
                        const rarity = rarities.find(r => r.name === rarityName);
                        if (rarity) {
                            const itemName = generateItemName(rarity);
                            addItemToInventory(itemName, rarity);
                            items.push(`${itemName} (${rarityName})`);
                        }
                    });
                    return `🌟 3 CELESTIAL ITEMS! ${items.join(', ')}!`;
                }
            },
            'POTION_STARTER': {
                name: 'Alchemist Gift',
                reward: () => {
                    // Unlock potions early + give starter potions
                    gameState.potionsUnlocked = true;
                    gameState.money += 50000000; // $50M for buying potions
                    return '🧪 Potions Unlocked + $50M for Alchemy!';
                }
            },
            'ULTIMATE_CHAMPION': {
                name: 'Supreme Reward',
                reward: () => {
                    // The ultimate code - gives everything!
                    gameState.money += 5000000000; // $5B
                    gameState.permanentLuckBoost += 5.0;
                    // Give 3 Admin items
                    const adminRarity = rarities.find(r => r.name === 'Admin');
                    const items = [];
                    for (let i = 0; i < 3; i++) {
                        const itemName = generateItemName(adminRarity);
                        addItemToInventory(itemName, adminRarity);
                        items.push(itemName);
                    }
                    return `🏆 ULTIMATE REWARD! $5B + 5.0x Luck + 3 ADMIN ITEMS: ${items.join(', ')}!`;
                }
            },
            'SPEEDRUN_MASTER': {
                name: 'Speed Demon',
                reward: () => {
                    gameState.upgrades.spinSpeed = Math.min((gameState.upgrades.spinSpeed || 0) + 10, upgradeData.spinSpeed.maxLevel);
                    gameState.money += 25000000;
                    return '⚡ +10 Speed upgrades + $25M!';
                }
            },
            'TRIPLE_THREAT': {
                name: 'Triple Power',
                reward: () => {
                    gameState.permanentLuckBoost += 1.0;
                    gameState.money += 100000000;
                    // Give 3 Primordial items
                    const items = [];
                    for (let i = 0; i < 3; i++) {
                        const rarity = rarities.find(r => r.name === 'Primordial');
                        const itemName = generateItemName(rarity);
                        addItemToInventory(itemName, rarity);
                        items.push(itemName);
                    }
                    return `⚡ +1x Luck + $100M + 3 Primordial Items!`;
                }
            },
            'PRESTIGE_BOOST': {
                name: 'Prestige Power',
                reward: () => {
                    if (!gameState.prestigeLevel) gameState.prestigeLevel = 0;
                    gameState.prestigeLevel += 5;
                    updatePrestigeDisplay();
                    return '⭐ +5 Prestige Levels! Massive bonuses!';
                }
            },
            'ARTIFACT_HUNTER': {
                name: 'Legendary Collector',
                reward: () => {
                    // Give all basic artifacts
                    const artifacts = ['luck_charm', 'golden_ring', 'magic_crystal', 'ancient_coin', 'mystic_amulet', 'crystal_orb', 'enchanted_stone', 'blessed_talisman'];
                    artifacts.forEach(id => {
                        if (!gameState.artifacts.includes(id)) {
                            gameState.artifacts.push(id);
                        }
                    });
                    return '💎 8 Artifacts Added! Massive stat boost!';
                }
            },
            'PET_ARMY': {
                name: 'Pet Legion',
                reward: () => {
                    // Give 10 random pets
                    const allPets = ['lucky_cat', 'money_dog', 'golden_bird', 'mystic_fox', 'shadow_wolf', 'cosmic_dragon', 'phoenix_fire', 'crystal_turtle', 'storm_eagle', 'fortune_panda'];
                    allPets.forEach(id => {
                        if (!gameState.pets.includes(id)) {
                            gameState.pets.push(id);
                            gameState.petLevels[id] = 5; // Start at level 5!
                        }
                    });
                    return '🐾 10 Pets Added at Level 5!';
                }
            },
            'BOSS_CRUSHER': {
                name: 'Boss Destroyer',
                reward: () => {
                    gameState.money += 250000000;
                    // Unlock all bosses
                    if (gameState.bosses) {
                        Object.keys(gameState.bosses).forEach(key => {
                            gameState.bosses[key].defeated = true;
                            gameState.bosses[key].lastFought = 0;
                        });
                    }
                    return '👹 $250M + All Bosses Unlocked & Cooldowns Reset!';
                }
            },
            'QUEST_COMPLETE': {
                name: 'Quest Master',
                reward: () => {
                    gameState.xp += 50000;
                    gameState.money += 50000000;
                    return '📜 +50,000 XP + $50M Quest Reward!';
                }
            },
            'LUCKY_SEVEN': {
                name: 'Lucky Number',
                reward: () => {
                    gameState.permanentLuckBoost += 7.0;
                    gameState.money += 777777777;
                    return '🍀 +7x Permanent Luck + $777,777,777!';
                }
            },
            'COLLECTION_MASTER': {
                name: 'Complete Collector',
                reward: () => {
                    // Complete all collections
                    gameState.collectionBonuses = {
                        discoComplete: true,
                        galacticComplete: true,
                        glitchComplete: true,
                        fullmoonComplete: true,
                        bloodmoonComplete: true,
                        weatherComplete: true,
                        christmasComplete: true
                    };
                    return '🎨 ALL COLLECTIONS COMPLETED! Massive bonuses unlocked!';
                }
            },
            'INFINITE_POWER': {
                name: 'Infinite Force',
                reward: () => {
                    const infinityRarity = rarities.find(r => r.name === 'Infinite Absolute');
                    const items = [];
                    for (let i = 0; i < 5; i++) {
                        const itemName = generateItemName(infinityRarity);
                        addItemToInventory(itemName, infinityRarity);
                        items.push(itemName);
                    }
                    return `♾️ 5 INFINITE ABSOLUTE ITEMS! ${items.join(', ')}`;
                }
            },
            'OMEGA_STRIKE': {
                name: 'Omega Assault',
                reward: () => {
                    const omegaRarity = rarities.find(r => r.name === 'Omega');
                    const items = [];
                    for (let i = 0; i < 10; i++) {
                        const itemName = generateItemName(omegaRarity);
                        addItemToInventory(itemName, omegaRarity);
                        items.push(itemName);
                    }
                    gameState.money += 500000000;
                    return `🔱 10 OMEGA ITEMS + $500M! ${items.slice(0,3).join(', ')} and more!`;
                }
            },
            'MYTHIC_TREASURE': {
                name: 'Mythic Vault',
                reward: () => {
                    const rarityNames = ['Mythical', 'Supreme', 'Divine', 'Primordial', 'Ethereal'];
                    const items = [];
                    rarityNames.forEach(rarityName => {
                        for (let i = 0; i < 2; i++) {
                            const rarity = rarities.find(r => r.name === rarityName);
                            if (rarity) {
                                const itemName = generateItemName(rarity);
                                addItemToInventory(itemName, rarity);
                                items.push(rarityName);
                            }
                        }
                    });
                    return `🏺 10 MYTHIC ITEMS! 2x each: ${rarityNames.join(', ')}!`;
                }
            },
            'TIME_TRAVELER': {
                name: 'Time Master',
                reward: () => {
                    // Reset all cooldowns
                    if (gameState.bosses) {
                        Object.keys(gameState.bosses).forEach(key => {
                            gameState.bosses[key].lastFought = 0;
                        });
                    }
                    if (gameState.dungeons) {
                        gameState.dungeons.cooldowns = {};
                    }
                    gameState.money += 100000000;
                    return '⏰ ALL COOLDOWNS RESET + $100M!';
                }
            },
            'VAULT_BREAKER': {
                name: 'Vault Access',
                reward: () => {
                    gameState.money += 10000000000; // $10B
                    gameState.lifetimeMoneyEarned += 10000000000;
                    return '💰 VAULT OPENED! +$10,000,000,000!';
                }
            },
            'DOUBLE_TROUBLE': {
                name: 'Double Everything',
                reward: () => {
                    gameState.money *= 2;
                    gameState.permanentLuckBoost *= 2;
                    return '✨ DOUBLED YOUR MONEY & PERMANENT LUCK!';
                }
            },
            'PRESTIGE_X10': {
                name: 'Mega Prestige',
                reward: () => {
                    if (!gameState.prestigeLevel) gameState.prestigeLevel = 0;
                    gameState.prestigeLevel += 10;
                    gameState.money += 1000000000;
                    updatePrestigeDisplay();
                    return '⭐ +10 PRESTIGE LEVELS + $1B!';
                }
            },
            'GODMODE_ACTIVATED': {
                name: 'God Mode',
                reward: () => {
                    gameState.permanentLuckBoost += 10.0;
                    gameState.money += 5000000000;
                    // Max all upgrades
                    Object.keys(upgradeData).forEach(upgradeId => {
                        gameState.upgrades[upgradeId] = upgradeData[upgradeId].maxLevel;
                    });
                    updateEventBonuses();
                    return '👁️ GOD MODE! +10x Luck + $5B + MAX UPGRADES!';
                }
            },
            'PRIMEVAL_HOARD': {
                name: 'Ancient Treasure',
                reward: () => {
                    const items = [];
                    ['Primeval', 'Celestial Prime', 'Quantum'].forEach(rarityName => {
                        for (let i = 0; i < 3; i++) {
                            const rarity = rarities.find(r => r.name === rarityName);
                            if (rarity) {
                                const itemName = generateItemName(rarity);
                                addItemToInventory(itemName, rarity);
                                items.push(rarityName);
                            }
                        }
                    });
                    return `🦖 9 ANCIENT ITEMS! 3x Primeval, Celestial Prime, Quantum!`;
                }
            },
            'POTION_FACTORY': {
                name: 'Alchemist Supreme',
                reward: () => {
                    gameState.potionsUnlocked = true;
                    gameState.money += 500000000;
                    gameState.permanentLuckBoost += 2.0;
                    return '🧪 POTIONS UNLOCKED + $500M + 2x Luck!';
                }
            },
            'DUNGEON_LEGEND': {
                name: 'Dungeon Conqueror',
                reward: () => {
                    gameState.money += 1000000000;
                    // Unlock ALL dungeons
                    if (!gameState.dungeons) gameState.dungeons = { unlocked: [], stats: {} };
                    gameState.dungeons.unlocked = ['dark_forest', 'crystal_caves', 'ancient_ruins', 'volcanic_depths', 'frozen_citadel', 'shadow_realm', 'celestial_tower', 'the_abyss', 'infinity_nexus', 'primordial_void'];
                    return '🗺️ $1B + ALL 10 DUNGEONS UNLOCKED!';
                }
            },
            'ADMIN_OVERRIDE': {
                name: 'Admin Authority',
                reward: () => {
                    unlockAdmin();
                    gameState.potionsUnlocked = true;
                    const adminRarity = rarities.find(r => r.name === 'Admin');
                    const items = [];
                    for (let i = 0; i < 5; i++) {
                        const itemName = generateItemName(adminRarity);
                        addItemToInventory(itemName, adminRarity);
                        items.push(itemName);
                    }
                    return `🔴 ADMIN UNLOCKED + POTIONS + 5 ADMIN ITEMS!`;
                }
            },
            'BEYOND_REALITY': {
                name: 'Reality Breaker',
                reward: () => {
                    const items = [];
                    ['Beyond Infinity', 'The Absolute Infinity', 'The Source', 'The Eternal'].forEach(rarityName => {
                        const rarity = rarities.find(r => r.name === rarityName);
                        if (rarity) {
                            const itemName = generateItemName(rarity);
                            addItemToInventory(itemName, rarity);
                            items.push(`${itemName} (${rarityName})`);
                        }
                    });
                    return `🌌 4 REALITY-BREAKING ITEMS! ${items.join(', ')}!`;
                }
            },
            'ULTIMATE_STACK': {
                name: 'Stack Master',
                reward: () => {
                    gameState.permanentLuckBoost += 15.0;
                    gameState.money += 10000000000; // $10B
                    // Give 10 random ultra-rare items
                    const ultraRares = ['Primeval', 'Celestial Prime', 'Quantum', 'Dimensional', 'Hyperversal', 'Outerversal', 'The Source', 'The Eternal', 'Admin', 'Beyond Infinity'];
                    ultraRares.forEach(rarityName => {
                        const rarity = rarities.find(r => r.name === rarityName);
                        if (rarity) {
                            const itemName = generateItemName(rarity);
                            addItemToInventory(itemName, rarity);
                        }
                    });
                    return `💥 +15x LUCK + $10B + 10 ULTRA-RARES!`;
                }
            },
            'Shaw': {
                name: 'Shaw\'s Legacy',
                reward: () => {
                    const shawRarity = rarities.find(r => r.name === 'Shaw');
                    if (shawRarity) {
                        // Give the exact item "Shaw" - no random generation!
                        addItemToInventory('Shaw', shawRarity);
                        return `⭐ SHAW! The legendary item "Shaw" has been added to your inventory! (Code-Only Exclusive!)`;
                    }
                    return '❌ Error giving reward';
                }
            }
        };
        
        function redeemCode() {
            const codeInput = document.getElementById('codeInput');
            const code = codeInput.value.trim();
            
            if (!code) {
                showNotification('❌ Please enter a code!', 'var(--danger)');
                return;
            }
            
            // Check if code exists
            if (!rewardCodes[code]) {
                showNotification('❌ Invalid code!', 'var(--danger)');
                playSound('error');
                codeInput.value = '';
                return;
            }
            
            // Check if already redeemed
            if (!gameState.redeemedCodes) gameState.redeemedCodes = [];
            if (gameState.redeemedCodes.includes(code)) {
                showNotification('⚠️ Code already redeemed!', 'var(--warning)');
                playSound('error');
                codeInput.value = '';
                return;
            }
            
            // Redeem the code
            const codeData = rewardCodes[code];
            const rewardMessage = codeData.reward();
            
            // Mark as redeemed
            gameState.redeemedCodes.push(code);
            
            // Show success
            showCenterNotification(`✅ CODE REDEEMED!\n${codeData.name}\n${rewardMessage}`, '#00ff00', 6000);
            playSound('achievement');
            
            // Update display
            updateRedeemedCodesList();
            updateStats();
            updateInventory();
            saveGame(true);
            
            // Clear input
            codeInput.value = '';
        }
        
        function updateRedeemedCodesList() {
            const container = document.getElementById('redeemedCodesContainer');
            if (!container) return;
            
            if (!gameState.redeemedCodes || gameState.redeemedCodes.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No codes redeemed yet...</p>';
                return;
            }
            
            container.innerHTML = gameState.redeemedCodes.map(code => {
                const codeData = rewardCodes[code];
                return `
                    <div style="padding: 10px; margin: 5px 0; background: var(--bg-dark); border-left: 3px solid var(--accent-gold); border-radius: 5px;">
                        <strong style="color: var(--accent-gold);">${code}</strong>
                        <span style="color: var(--text-secondary); margin-left: 10px;">${codeData ? codeData.name : 'Unknown'}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Update list on load
        // Codes list will be initialized in main DOMContentLoaded
        
        
        function updateSettings() {
            gameState.settings.soundEffects = document.getElementById('settingSoundEffects').checked;
            gameState.settings.showTradeNotifications = document.getElementById('settingTradeNotif').checked;
            gameState.settings.showExpiredNotifications = document.getElementById('settingExpiredNotif').checked;
            gameState.settings.showSpinResults = document.getElementById('settingSpinNotif').checked;
            gameState.settings.showAchievementNotifications = document.getElementById('settingAchievementNotif').checked;
            gameState.settings.showRandomEvents = document.getElementById('settingEventNotif').checked;
            gameState.settings.showAutoSaveNotifications = document.getElementById('settingAutoSaveNotif').checked;
            gameState.settings.showPityNotifications = document.getElementById('settingPityNotif').checked;
            gameState.settings.showFusionNotifications = document.getElementById('settingFusionNotif').checked;
            gameState.settings.showCollectionNotifications = document.getElementById('settingCollectionNotif').checked;
            gameState.settings.confirmSell = document.getElementById('settingConfirmSell').checked;
            gameState.settings.animations = document.getElementById('settingAnimations').checked;
            gameState.settings.compactMode = document.getElementById('settingCompactMode').checked;
            gameState.settings.showValue = document.getElementById('settingShowValue').checked;
            gameState.settings.autoSaveInterval = parseInt(document.getElementById('settingAutoSaveInterval').value);
            showNotification('Settings saved!', 'var(--success)');
        }
        
        function updateRebirthDisplay() {
            const rebirthLevel = gameState.rebirths || 0;
            document.getElementById('rebirthCount').textContent = rebirthLevel;
            document.getElementById('permanentLuck').textContent = gameState.permanentLuckBoost.toFixed(1) + 'x';
            
            // Show next rebirth requirements
            const moneyRequired = Math.floor(1000000 * Math.pow(2, Math.min(rebirthLevel, 20)));
            let requiredRarityIndex = 5 + Math.floor(rebirthLevel / 5);
            requiredRarityIndex = Math.min(requiredRarityIndex, rarities.length - 1);
            const requiredRarity = rarities[requiredRarityIndex];
            
            // Calculate next rebirth bonus
            let luckBonus = 2.0;
            if (rebirthLevel >= 10) luckBonus += 1.0;
            if (rebirthLevel >= 25) luckBonus += 2.0;
            if (rebirthLevel >= 50) luckBonus += 5.0;
            
            const reqDisplay = document.getElementById('rebirthRequirements');
            if (reqDisplay) {
                reqDisplay.innerHTML = `
                    <p style="color: var(--accent-gold);">Next Rebirth Requirements:</p>
                    <p style="color: var(--text-secondary);">💰 Money: $${formatNumber(moneyRequired)}</p>
                    <p style="color: ${requiredRarity.color};">✨ Item: ${requiredRarity.name}+ rarity</p>
                    <p style="color: var(--success);">🎁 Reward: +${luckBonus}x permanent luck</p>
                `;
            }
        }
        
        function performRebirth() {
            // Calculate rebirth requirements based on current rebirth count
            const rebirthLevel = gameState.rebirths || 0;
            
            // Scaling money requirement
            const moneyRequired = Math.floor(1000000 * Math.pow(2, Math.min(rebirthLevel, 20))); // Caps at 2^20 multiplier
            
            // Scaling rarity requirement
            let requiredRarityIndex = 5 + Math.floor(rebirthLevel / 5); // Mythic at 0, increases every 5 rebirths
            requiredRarityIndex = Math.min(requiredRarityIndex, rarities.length - 1);
            const requiredRarity = rarities[requiredRarityIndex];
            
            // Check money requirement
            if (gameState.money < moneyRequired) {
                showNotification(`Need $${formatNumber(moneyRequired)} to rebirth!`, 'var(--danger)');
                return;
            }
            
            // Check for required rarity item
            const hasRequiredRarity = Object.keys(gameState.inventory).some(key => {
                const item = gameState.inventory[key];
                if (item.count === 0) return false;
                const rarityIndex = rarities.findIndex(r => r.name === item.rarity);
                return rarityIndex >= requiredRarityIndex;
            });
            
            if (!hasRequiredRarity) {
                showNotification(`Need at least 1 ${requiredRarity.name} (or higher) item to rebirth!`, 'var(--danger)');
                return;
            }
            
            // Confirm rebirth
            if (!confirm(`Rebirth #${rebirthLevel + 1}\n\nCost: $${formatNumber(moneyRequired)}\nRequired: ${requiredRarity.name}+ item\n\nYou will lose ALL progress except achievements!\n\nContinue?`)) {
                return;
            }
            
            // Calculate rebirth rewards
            let luckBonus = 2.0; // Base luck bonus
            
            // Scaling bonuses for higher rebirths
            if (rebirthLevel >= 10) luckBonus += 1.0;
            if (rebirthLevel >= 25) luckBonus += 2.0;
            if (rebirthLevel >= 50) luckBonus += 5.0;
            
            // Perform rebirth
            gameState.rebirths++;
            gameState.permanentLuckBoost += luckBonus;
            
            // Reset everything except achievements, rebirths, and permanent luck
            const savedAchievements = { ...gameState.achievements };
            const savedRebirths = gameState.rebirths;
            const savedPermanentLuck = gameState.permanentLuckBoost;
            const savedSettings = { ...gameState.settings };
            const savedAdminUnlocked = gameState.adminUnlocked;
            const savedQuestsCompleted = gameState.questsCompleted || 0;
            const savedDailyStreak = gameState.dailyStreak || 0;
            const savedWeeklyQuestsCompleted = gameState.weeklyQuestsCompleted || 0;
            
            // Clear inventory
            gameState.inventory = {};
            gameState.totalValue = 0;
            gameState.money = 0;
            gameState.totalSpins = 0;
            gameState.luckMultiplier = 1.0; // Start fresh at 1.0, permanent luck applies separately
            gameState.tradeWins = 0;
            gameState.tradeLosses = 0;
            gameState.flexedItem = null;
            gameState.battlePassTier = 0;
            gameState.battlePassXP = 0;
            gameState.claimedBPTiers = [];
            gameState.enchantmentTarget = null;
            gameState.activeTrades = [];
            gameState.activeQuests = [];
            gameState.completedQuests = [];
            gameState.lastQuestRefresh = 0;
            gameState.shopPurchases = 0;
            gameState.upgrades = {
                spinSpeed: 0,
                popularity: 0,
                luckBoost: 0,
                autoSpin: 0,
                tradeInsight: 0,
                valueBoost: 0,
                craftingMastery: 0,
                enchantPower: 0,
                multiSpin: 0,
                shopDiscount: 0,
                rarityBoost: 0,
                eventLuck: 0,
                xpBoost: 0,
                sellPrice: 0,
                questSpeed: 0,
                mysteryBox: 0
            };
            gameState.craftCount = 0;
            gameState.enchantSuccess = 0;
            gameState.enchantFails = 0;
            
            // Restore what shouldn't be reset
            gameState.achievements = savedAchievements;
            gameState.rebirths = savedRebirths;
            gameState.permanentLuckBoost = savedPermanentLuck;
            gameState.settings = savedSettings;
            gameState.adminUnlocked = savedAdminUnlocked;
            gameState.questsCompleted = savedQuestsCompleted;
            gameState.dailyStreak = savedDailyStreak;
            gameState.weeklyQuestsCompleted = savedWeeklyQuestsCompleted;
            
            // Refresh quests
            refreshQuests();
            
            // Update all displays
            updateStats();
            updateInventory();
            updateBattlePass();
            updateRebirthDisplay();
            updateQuestDisplay();
            checkAchievements();
            
            showNotification(`🎉 REBIRTH #${gameState.rebirths} COMPLETE! Permanent luck is now ${gameState.permanentLuckBoost.toFixed(1)}x! (+${luckBonus}x this rebirth) 🎉`, 'var(--accent-gold)');
        }
        
        function initBattlePass() {
            const tiersDiv = document.getElementById('bpTiers');
            tiersDiv.innerHTML = '';
            
            battlePassTiers.forEach(tier => {
                const unlocked = gameState.battlePassXP >= tier.xpRequired;
                
                const tierDiv = document.createElement('div');
                tierDiv.className = 'battlepass-tier' + (unlocked ? ' unlocked' : '');
                tierDiv.innerHTML = `
                    <div>
                        <h3 style="color: var(--accent-primary);">Tier ${tier.tier}</h3>
                        <p style="color: var(--text-secondary);">${formatNumber(tier.xpRequired)} XP Required</p>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px;">Current: ${formatNumber(gameState.battlePassXP)} XP</p>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.5rem;">${unlocked ? '✅' : '🔒'}</div>
                        <div style="color: var(--accent-gold); font-weight: bold;">${tier.reward}</div>
                    </div>
                `;
                tiersDiv.appendChild(tierDiv);
            });
        }
        
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            const tabElement = document.getElementById(tabName);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            // Highlight the corresponding button if event is available
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            } else {
                // Find and activate the button for this tab when called programmatically
                const buttons = document.querySelectorAll('.tab-button');
                buttons.forEach(btn => {
                    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${tabName}'`)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Close mobile menu when tab is selected
            closeMobileMenu();
            
            if (tabName === 'inventory') updateInventory();
            if (tabName === 'shop') initShop();
            if (tabName === 'upgrades') initUpgrades();
            if (tabName === 'trading') {
                // Trading tab is now automatically populated
            }
            if (tabName === 'crafting') {
                document.getElementById('craftingGrid').innerHTML = '';
                initCrafting();
            }
            if (tabName === 'enchanting') {
                updateEnchantInventory();
            }
            if (tabName === 'quests') {
                updateQuestDisplay();
            }
            if (tabName === 'fusion') {
                updateFusionInventory();
                updateFusionSlots();
            }
            if (tabName === 'statistics') {
                gameState.statisticsViewed = true;
                updateStatistics();
                checkAchievements();
            }
            if (tabName === 'collections') {
                updateCollectionsDisplay();
            }
            if (tabName === 'settings') {
                // Load current settings
                document.getElementById('settingSoundEffects').checked = gameState.settings.soundEffects !== false;
                document.getElementById('settingTradeNotif').checked = gameState.settings.showTradeNotifications;
                document.getElementById('settingExpiredNotif').checked = gameState.settings.showExpiredNotifications;
                document.getElementById('settingSpinNotif').checked = gameState.settings.showSpinResults;
                document.getElementById('settingAchievementNotif').checked = gameState.settings.showAchievementNotifications;
                document.getElementById('settingEventNotif').checked = gameState.settings.showRandomEvents;
                document.getElementById('settingAutoSaveNotif').checked = gameState.settings.showAutoSaveNotifications;
                document.getElementById('settingPityNotif').checked = gameState.settings.showPityNotifications !== false;
                document.getElementById('settingFusionNotif').checked = gameState.settings.showFusionNotifications !== false;
                document.getElementById('settingCollectionNotif').checked = gameState.settings.showCollectionNotifications !== false;
                document.getElementById('settingConfirmSell').checked = gameState.settings.confirmSell || false;
                document.getElementById('settingAnimations').checked = gameState.settings.animations !== false;
                document.getElementById('settingCompactMode').checked = gameState.settings.compactMode || false;
                document.getElementById('settingShowValue').checked = gameState.settings.showValue !== false;
                document.getElementById('settingAutoSaveInterval').value = gameState.settings.autoSaveInterval || 60;
            }
            if (tabName === 'rebirth') {
                updateRebirthDisplay();
            }
            if (tabName === 'dailies') {
                generateDailyChallenges();
                updateDailyChallengesDisplay();
                updateAchievementPointsDisplay();
            }
            if (tabName === 'achievementshop') {
                updateAchievementShopDisplay();
                updateAchievementPointsDisplay();
            }
            if (tabName === 'pets') {
                updatePetsDisplay();
            }
            if (tabName === 'prestige') {
                updatePrestigeDisplay();
            }
            if (tabName === 'bosses') {
                updateBossesDisplay();
            }
            if (tabName === 'dungeons') {
                updateDungeonsDisplay();
            }
            if (tabName === 'artifacts') {
                updateArtifactsDisplay();
            }
            if (tabName === 'potions') {
                updatePotionsDisplay();
            }
            if (tabName === 'skills') {
                updateSkillsDisplay();
            }
            if (tabName === 'leaderboard') {
                updateLeaderboardDisplay();
            }
            if (tabName === 'guild') {
                updateGuildDisplay();
            }
            if (tabName === 'gacha') {
                updateGachaDisplay();
            }
            if (tabName === 'themes') {
                updateThemesDisplay();
            }
            if (tabName === 'titles') {
                updateTitlesDisplay();
            }
            if (tabName === 'admin') {
                if (gameState.adminUnlocked) {
                    document.getElementById('codesPanel').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                } else {
                    document.getElementById('codesPanel').style.display = 'block';
                    document.getElementById('adminPanel').style.display = 'none';
                }
            }
        }
        
        // ===== MOBILE SUPPORT FUNCTIONS =====
        
        function toggleMobileMenu() {
            const tabNav = document.getElementById('tabNav');
            const btn = document.getElementById('mobileMenuBtn');
            
            if (tabNav.classList.contains('mobile-open')) {
                closeMobileMenu();
            } else {
                openMobileMenu();
            }
        }
        
        function openMobileMenu() {
            const tabNav = document.getElementById('tabNav');
            const btn = document.getElementById('mobileMenuBtn');
            tabNav.classList.add('mobile-open');
            btn.textContent = '✕';
        }
        
        function closeMobileMenu() {
            const tabNav = document.getElementById('tabNav');
            const btn = document.getElementById('mobileMenuBtn');
            tabNav.classList.remove('mobile-open');
            btn.textContent = '☰';
        }
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const tabNav = document.getElementById('tabNav');
            const btn = document.getElementById('mobileMenuBtn');
            
            if (tabNav && btn && tabNav.classList.contains('mobile-open')) {
                if (!tabNav.contains(e.target) && !btn.contains(e.target)) {
                    closeMobileMenu();
                }
            }
        });
        
        // Swipe gestures for mobile navigation
        let touchStartX = 0;
        let touchEndX = 0;
        
        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });
        
        function handleSwipe() {
            const swipeThreshold = 100; // Minimum distance for swipe
            const tabNav = document.getElementById('tabNav');
            
            if (touchEndX < touchStartX - swipeThreshold) {
                // Swipe left - close menu
                closeMobileMenu();
            }
            
            if (touchEndX > touchStartX + swipeThreshold && touchStartX < 50) {
                // Swipe right from left edge - open menu
                openMobileMenu();
            }
        }
        
        // Detect mobile device
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   window.innerWidth <= 768;
        }
        
        // Vibration feedback helper
        function vibrate(duration = 10) {
            if (navigator.vibrate) {
                navigator.vibrate(duration);
            }
        }
        
        // Prevent zoom on double-tap for specific elements
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Adjust UI for mobile on load
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                closeMobileMenu();
            }
        });
        
        // ===== TUTORIAL SYSTEM =====
        
        const tutorialSteps = [
            {
                title: "Welcome to RNG Trader!",
                message: "Click the 🎰 Spin button to get your first item!",
                tab: "spin",
                highlight: null
            },
            {
                title: "Check Your Inventory",
                message: "Great! Now go to the 🎒 Inventory tab to see your items.",
                tab: "inventory",
                highlight: null
            },
            {
                title: "Visit the Shop",
                message: "You can buy items with money in the 🏪 Shop tab!",
                tab: "shop",
                highlight: null
            },
            {
                title: "Upgrade Your Game",
                message: "Permanent upgrades are in the ⬆️ Upgrades tab!",
                tab: "upgrades",
                highlight: null
            },
            {
                title: "You're Ready!",
                message: "Explore trading, crafting, achievements, and more! Have fun! 🎉",
                tab: null,
                highlight: null
            }
        ];
        
        function startTutorial() {
            if (gameState.tutorialComplete || gameState.tutorialSkipped) return;
            gameState.tutorialStep = 0;
            showTutorialStep();
        }
        
        function showTutorialStep() {
            if (gameState.tutorialStep >= tutorialSteps.length) {
                gameState.tutorialComplete = true;
                closeTutorialModal();
                showNotification('🎉 Tutorial Complete! Enjoy the game!', 'var(--success)');
                return;
            }
            
            const step = tutorialSteps[gameState.tutorialStep];
            const modal = document.createElement('div');
            modal.id = 'tutorialModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `
                <div style="background: var(--bg-medium); padding: 30px; border-radius: 15px; max-width: 500px; width: 100%; border: 3px solid var(--accent-primary); box-shadow: 0 0 30px var(--accent-primary);">
                    <h2 style="color: var(--accent-primary); margin-bottom: 15px;">📚 Tutorial (${gameState.tutorialStep + 1}/${tutorialSteps.length})</h2>
                    <h3 style="color: var(--accent-gold); margin-bottom: 15px;">${step.title}</h3>
                    <p style="color: var(--text-primary); font-size: 1.1rem; margin: 20px 0; line-height: 1.6;">${step.message}</p>
                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button onclick="nextTutorialStep()" class="btn btn-accept" style="flex: 1; padding: 15px; font-size: 1.1rem;">
                            ${gameState.tutorialStep === tutorialSteps.length - 1 ? '🎉 Finish' : 'Next ➡️'}
                        </button>
                        <button onclick="skipTutorial()" class="btn btn-decline" style="padding: 15px;">Skip</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Auto-switch to relevant tab
            if (step.tab) {
                setTimeout(() => switchTab(step.tab), 500);
            }
        }
        
        function nextTutorialStep() {
            gameState.tutorialStep++;
            closeTutorialModal();
            setTimeout(showTutorialStep, 300);
        }
        
        function skipTutorial() {
            gameState.tutorialSkipped = true;
            closeTutorialModal();
            showNotification('Tutorial skipped. You can restart it in Settings!', 'var(--text-secondary)');
        }
        
        function closeTutorialModal() {
            const modal = document.getElementById('tutorialModal');
            if (modal) modal.remove();
        }
        
        function resetTutorial() {
            gameState.tutorialStep = 0;
            gameState.tutorialComplete = false;
            gameState.tutorialSkipped = false;
            startTutorial();
        }
        
        // ===== DAILY CHALLENGES SYSTEM =====
        
        const dailyChallengeTemplates = [
            { id: 'spin50', name: 'Spin Master', desc: 'Spin 50 items', goal: 50, type: 'spins', reward: { money: 25000, points: 3 } },
            { id: 'spin100', name: 'Spin Grinder', desc: 'Spin 100 items', goal: 100, type: 'spins', reward: { money: 60000, points: 5 } },
            { id: 'trade10', name: 'Trader', desc: 'Win 10 trades', goal: 10, type: 'tradeWins', reward: { money: 20000, points: 4 } },
            { id: 'trade25', name: 'Trade Expert', desc: 'Win 25 trades', goal: 25, type: 'tradeWins', reward: { money: 50000, points: 7 } },
            { id: 'craft5', name: 'Crafter', desc: 'Craft 5 items', goal: 5, type: 'crafts', reward: { money: 15000, points: 3 } },
            { id: 'craft15', name: 'Master Crafter', desc: 'Craft 15 items', goal: 15, type: 'crafts', reward: { money: 40000, points: 6 } },
            { id: 'money100k', name: 'Money Maker', desc: 'Earn $100,000', goal: 100000, type: 'moneyEarned', reward: { money: 30000, points: 4 } },
            { id: 'money500k', name: 'Big Earner', desc: 'Earn $500,000', goal: 500000, type: 'moneyEarned', reward: { money: 100000, points: 8 } },
            { id: 'legendary3', name: 'Legend Hunter', desc: 'Get 3 Legendary+ items', goal: 3, type: 'legendaryItems', reward: { money: 50000, points: 10 } },
            { id: 'rare20', name: 'Rare Collector', desc: 'Get 20 Rare+ items', goal: 20, type: 'rareItems', reward: { money: 35000, points: 5 } }
        ];
        
        function generateDailyChallenges() {
            // Check if need to reset (daily at midnight)
            const now = Date.now();
            const lastReset = gameState.lastDailyChallengeReset || 0;
            const dayInMs = 86400000;
            
            if (now - lastReset < dayInMs && gameState.dailyChallenges.length > 0) {
                return; // Not time to reset yet
            }
            
            // Generate 3 random challenges
            const shuffled = [...dailyChallengeTemplates].sort(() => Math.random() - 0.5);
            gameState.dailyChallenges = shuffled.slice(0, 3).map(template => ({
                ...template,
                progress: 0,
                completed: false
            }));
            
            gameState.dailyChallengesCompleted = [];
            gameState.lastDailyChallengeReset = now;
            
            showNotification('📅 New Daily Challenges available!', 'var(--accent-primary)');
        }
        
        function updateDailyChallengeProgress(type, amount = 1) {
            if (!gameState.dailyChallenges) return;
            
            for (let challenge of gameState.dailyChallenges) {
                if (challenge.type === type && !challenge.completed) {
                    challenge.progress += amount;
                    
                    if (challenge.progress >= challenge.goal) {
                        challenge.progress = challenge.goal;
                        // Will be claimed manually
                    }
                }
            }
        }
        
        function claimDailyChallenge(index) {
            const challenge = gameState.dailyChallenges[index];
            if (!challenge || challenge.completed || challenge.progress < challenge.goal) {
                showNotification('❌ Challenge not complete!', 'var(--danger)');
                return;
            }
            
            challenge.completed = true;
            gameState.money += challenge.reward.money;
            gameState.achievementPoints += challenge.reward.points;
            
            showNotification(`✅ ${challenge.name} Complete! +$${formatNumber(challenge.reward.money)} +${challenge.reward.points} Points!`, 'var(--success)');
            updateDailyChallengesDisplay();
            updateAchievementPointsDisplay();
        }
        
        function updateDailyChallengesDisplay() {
            const container = document.getElementById('dailyChallengesContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!gameState.dailyChallenges || gameState.dailyChallenges.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Generating challenges...</p>';
                generateDailyChallenges();
                setTimeout(updateDailyChallengesDisplay, 100);
                return;
            }
            
            gameState.dailyChallenges.forEach((challenge, index) => {
                const progress = Math.min(challenge.progress, challenge.goal);
                const percent = (progress / challenge.goal * 100).toFixed(0);
                const isComplete = challenge.progress >= challenge.goal;
                const isClaimed = challenge.completed;
                
                const card = document.createElement('div');
                card.className = 'recipe-card';
                card.style.border = isClaimed ? '2px solid var(--success)' : isComplete ? '2px solid var(--accent-gold)' : '';
                card.innerHTML = `
                    <h3 style="color: var(--accent-primary);">${challenge.name}</h3>
                    <p style="color: var(--text-secondary); margin: 10px 0;">${challenge.desc}</p>
                    <div class="progress-bar" style="margin: 15px 0;">
                        <div class="progress-fill" style="width: ${percent}%; background: ${isClaimed ? 'var(--success)' : 'var(--accent-gold)'};">
                            ${progress} / ${challenge.goal}
                        </div>
                    </div>
                    <div style="margin: 10px 0; color: var(--accent-gold);">
                        Rewards: $${formatNumber(challenge.reward.money)} + ${challenge.reward.points} Points
                    </div>
                    <button class="btn ${isClaimed ? 'btn-decline' : isComplete ? 'btn-accept' : 'btn-decline'}" 
                            onclick="claimDailyChallenge(${index})" 
                            ${isClaimed || !isComplete ? 'disabled' : ''}
                            style="${isClaimed || !isComplete ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        ${isClaimed ? '✅ Claimed' : isComplete ? '🎁 Claim Reward' : '🔒 Incomplete'}
                    </button>
                `;
                container.appendChild(card);
            });
        }
        
        // ===== ACHIEVEMENT SHOP SYSTEM =====
        
        const achievementShopItems = [
            { id: 'perm_luck_1', name: 'Lucky Charm I', desc: '+5% Permanent Luck', cost: 10, bonus: { type: 'luck', value: 0.05 } },
            { id: 'perm_luck_2', name: 'Lucky Charm II', desc: '+10% Permanent Luck', cost: 25, bonus: { type: 'luck', value: 0.10 }, requires: 'perm_luck_1' },
            { id: 'perm_luck_3', name: 'Lucky Charm III', desc: '+20% Permanent Luck', cost: 50, bonus: { type: 'luck', value: 0.20 }, requires: 'perm_luck_2' },
            { id: 'auto_spin_boost', name: 'Speed Boost', desc: '2x Auto-Spin Speed', cost: 30, bonus: { type: 'autoSpinSpeed', value: 2 } },
            { id: 'pity_reduction', name: 'Pity Helper', desc: 'Pity at 80 instead of 100', cost: 40, bonus: { type: 'pityReduction', value: 20 } },
            { id: 'starting_money', name: 'Rich Start', desc: 'Start with $50k on Rebirth', cost: 20, bonus: { type: 'startMoney', value: 50000 } },
            { id: 'xp_boost', name: 'XP Boost', desc: '+50% Battle Pass XP', cost: 35, bonus: { type: 'xpBoost', value: 0.5 } },
            { id: 'pet_slot_1', name: 'Pet Slot', desc: 'Unlock pet system', cost: 15, bonus: { type: 'petSlot', value: 1 } }
        ];
        
        function updateAchievementShopDisplay() {
            const container = document.getElementById('achievementShopContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            achievementShopItems.forEach(item => {
                const owned = gameState.achievementShopPurchases[item.id] || false;
                const canAfford = gameState.achievementPoints >= item.cost;
                const meetsRequirement = !item.requires || gameState.achievementShopPurchases[item.requires];
                const canBuy = !owned && canAfford && meetsRequirement;
                
                const card = document.createElement('div');
                card.className = 'recipe-card';
                card.style.border = owned ? '2px solid var(--success)' : '';
                card.innerHTML = `
                    <h3 style="color: ${owned ? 'var(--success)' : 'var(--accent-gold)'};">${item.name}</h3>
                    <p style="color: var(--text-secondary); margin: 10px 0;">${item.desc}</p>
                    ${item.requires && !owned ? `<p style="color: var(--warning); font-size: 0.85rem;">Requires: ${achievementShopItems.find(i => i.id === item.requires)?.name}</p>` : ''}
                    <div style="margin: 15px 0; font-size: 1.2rem; color: var(--accent-gold);">
                        💰 ${item.cost} Points
                    </div>
                    <button class="btn ${owned ? 'btn-decline' : canBuy ? 'btn-accept' : 'btn-decline'}" 
                            onclick="purchaseAchievementShopItem('${item.id}')" 
                            ${!canBuy ? 'disabled' : ''}
                            style="${!canBuy ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        ${owned ? '✅ Owned' : !meetsRequirement ? '🔒 Locked' : !canAfford ? '❌ Too Expensive' : '💳 Purchase'}
                    </button>
                `;
                container.appendChild(card);
            });
        }
        
        function purchaseAchievementShopItem(itemId) {
            const item = achievementShopItems.find(i => i.id === itemId);
            if (!item) return;
            
            if (gameState.achievementShopPurchases[itemId]) {
                showNotification('Already owned!', 'var(--warning)');
                return;
            }
            
            if (item.requires && !gameState.achievementShopPurchases[item.requires]) {
                showNotification('Missing requirement!', 'var(--danger)');
                return;
            }
            
            if (gameState.achievementPoints < item.cost) {
                showNotification('Not enough points!', 'var(--danger)');
                return;
            }
            
            gameState.achievementPoints -= item.cost;
            gameState.achievementShopPurchases[itemId] = true;
            
            // Apply bonus
            applyAchievementShopBonus(item);
            
            showNotification(`✅ Purchased ${item.name}!`, 'var(--success)');
            updateAchievementShopDisplay();
            updateAchievementPointsDisplay();
        }
        
        function applyAchievementShopBonus(item) {
            if (item.bonus.type === 'luck') {
                gameState.luckMultiplier += item.bonus.value;
            } else if (item.bonus.type === 'pityReduction') {
                gameState.pityThreshold = 80;
            }
            // Other bonuses applied when checked
            updateStats();
        }
        
        function updateAchievementPointsDisplay() {
            const displays = [
                document.getElementById('achievementPointsDisplay'),
                document.getElementById('achievementPointsShopDisplay')
            ];
            displays.forEach(display => {
                if (display) display.textContent = gameState.achievementPoints || 0;
            });
        }
        
        // Award achievement points when achievements are unlocked
        function awardAchievementPoints(achievementId) {
            // Award 2 points per achievement
            gameState.achievementPoints = (gameState.achievementPoints || 0) + 2;
            updateAchievementPointsDisplay();
        }
        
        // ===== PET SYSTEM =====
        
        const availablePets = [
            { id: 'lucky_dragon', name: '🐉 Lucky Dragon', rarity: 'Legendary', bonus: { type: 'luck', value: 0.10 }, cost: 100000 },
            { id: 'trade_cat', name: '🐱 Trade Cat', rarity: 'Rare', bonus: { type: 'tradeBonus', value: 0.15 }, cost: 50000 },
            { id: 'wise_owl', name: '🦉 Wise Owl', rarity: 'Epic', bonus: { type: 'craftDiscount', value: 0.05 }, cost: 75000 },
            { id: 'loyal_dog', name: '🐕 Loyal Dog', rarity: 'Common', bonus: { type: 'allStats', value: 0.05 }, cost: 25000 },
            { id: 'rainbow_unicorn', name: '🦄 Rainbow Unicorn', rarity: 'Mythic', bonus: { type: 'rareChance', value: 2 }, cost: 150000 },
            { id: 'ancient_turtle', name: '🐢 Ancient Turtle', rarity: 'Epic', bonus: { type: 'pityBoost', value: 0.20 }, cost: 80000 },
            { id: 'mystic_fox', name: '🦊 Mystic Fox', rarity: 'Legendary', bonus: { type: 'fusionLuck', value: 2 }, cost: 120000 },
            { id: 'golden_phoenix', name: '🦅 Golden Phoenix', rarity: 'Exotic', bonus: { type: 'luck', value: 0.15 }, cost: 200000 },
            { id: 'space_monkey', name: '🐒 Space Monkey', rarity: 'Rare', bonus: { type: 'xpBoost', value: 0.25 }, cost: 60000 },
            { id: 'crystal_butterfly', name: '🦋 Crystal Butterfly', rarity: 'Epic', bonus: { type: 'valueBoost', value: 0.10 }, cost: 90000 },
            { id: 'shadow_wolf', name: '🐺 Shadow Wolf', rarity: 'Mythic', bonus: { type: 'enchantPower', value: 0.20 }, cost: 175000 },
            { id: 'cosmic_squid', name: '🦑 Cosmic Squid', rarity: 'Celestial', bonus: { type: 'multiSpin', value: 0.10 }, cost: 250000 },
            { id: 'thunder_lion', name: '🦁 Thunder Lion', rarity: 'Divine', bonus: { type: 'allStats', value: 0.10 }, cost: 300000 },
            { id: 'void_raven', name: '🦅 Void Raven', rarity: 'Cosmic', bonus: { type: 'luck', value: 0.25 }, cost: 500000 },
            { id: 'eternal_serpent', name: '🐍 Eternal Serpent', rarity: 'Infinite', bonus: { type: 'allStats', value: 0.15 }, cost: 750000 },
            { id: 'divine_dragon', name: '🐲 Divine Dragon', rarity: '🔥 CODE EXCLUSIVE', bonus: { type: 'luck', value: 0.15 }, cost: 999999999 }, // Special pet from RNG_GODLY code
            { id: 'admin_sentinel', name: '🔴 Admin Sentinel', rarity: 'Admin', bonus: { type: 'adminPower', value: 0.30 }, cost: 5000000 },
            { id: 'primeval_beast', name: '🦖 Primeval Beast', rarity: 'Primeval', bonus: { type: 'ancientPower', value: 0.25 }, cost: 10000000 },
            { id: 'quantum_cat', name: '😺 Quantum Cat', rarity: 'Quantum', bonus: { type: 'superposition', value: 0.20 }, cost: 15000000 },
            { id: 'celestial_angel', name: '👼 Celestial Angel', rarity: 'Celestial Prime', bonus: { type: 'divineBlessing', value: 0.35 }, cost: 25000000 },
            { id: 'dimensional_spider', name: '🕷️ Dimensional Spider', rarity: 'Dimensional', bonus: { type: 'multiverse', value: 0.28 }, cost: 30000000 },
            { id: 'omega_phoenix', name: '🔥 Omega Phoenix', rarity: 'Omega', bonus: { type: 'rebirth', value: 0.40 }, cost: 50000000 },
            { id: 'supreme_tiger', name: '🐯 Supreme Tiger', rarity: 'Supreme', bonus: { type: 'dominance', value: 0.50 }, cost: 100000000 },
            { id: 'godlike_leviathan', name: '🐋 Godlike Leviathan', rarity: 'Godlike', bonus: { type: 'omnipotence', value: 0.60 }, cost: 250000000 }
        ];
        
        function updatePetsDisplay() {
            const container = document.getElementById('petsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            availablePets.forEach(pet => {
                const owned = gameState.pets.includes(pet.id);
                const isActive = gameState.activePet === pet.id;
                const level = gameState.petLevels[pet.id] || 1;
                const canBuy = !owned && gameState.money >= pet.cost;
                
                const card = document.createElement('div');
                card.className = 'recipe-card';
                card.style.border = isActive ? '3px solid var(--accent-gold)' : owned ? '2px solid var(--success)' : '';
                card.innerHTML = `
                    <div style="font-size: 3rem; margin: 10px 0;">${pet.name.split(' ')[0]}</div>
                    <h3 style="color: ${isActive ? 'var(--accent-gold)' : 'var(--accent-primary)'};">${pet.name.split(' ').slice(1).join(' ')}</h3>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">${pet.rarity}</p>
                    <div style="margin: 10px 0; color: var(--success);">
                        ${getBonusDescription(pet.bonus)}
                    </div>
                    ${owned ? `<p style="color: var(--accent-gold);">Level ${level}</p>` : ''}
                    <div style="margin: 10px 0;">
                        ${owned ? 
                            `<button class="btn ${isActive ? 'btn-decline' : 'btn-accept'}" onclick="equipPet('${pet.id}')" style="width: 100%; margin-bottom: 5px;">
                                ${isActive ? '✅ Equipped' : '🔄 Equip'}
                            </button>` :
                            `<button class="btn btn-accept" onclick="buyPet('${pet.id}')" ${!canBuy ? 'disabled' : ''} style="width: 100%; ${!canBuy ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                💰 Buy ($${formatNumber(pet.cost)})
                            </button>`
                        }
                    </div>
                `;
                container.appendChild(card);
            });
            
            updateActivePetDisplay();
        }
        
        function getBonusDescription(bonus) {
            switch (bonus.type) {
                case 'luck': return `+${(bonus.value * 100).toFixed(0)}% Luck`;
                case 'tradeBonus': return `+${(bonus.value * 100).toFixed(0)}% Trade Win Chance`;
                case 'craftDiscount': return `-${(bonus.value * 100).toFixed(0)}% Craft Cost`;
                case 'allStats': return `+${(bonus.value * 100).toFixed(0)}% All Stats`;
                case 'rareChance': return `${bonus.value}x Rare Item Chance`;
                case 'pityBoost': return `+${(bonus.value * 100).toFixed(0)}% Pity Progress`;
                case 'fusionLuck': return `${bonus.value}x Fusion Luck`;
                case 'adminPower': return `+${(bonus.value * 100).toFixed(0)}% Admin Power (All Stats + Rare Drops)`;
                case 'ancientPower': return `+${(bonus.value * 100).toFixed(0)}% Ancient Power (Luck + Value)`;
                case 'superposition': return `+${(bonus.value * 100).toFixed(0)}% Quantum Superposition (Random Boosts)`;
                case 'divineBlessing': return `+${(bonus.value * 100).toFixed(0)}% Divine Blessing (Luck + XP)`;
                case 'multiverse': return `+${(bonus.value * 100).toFixed(0)}% Multiverse Access (All Stats)`;
                case 'rebirth': return `+${(bonus.value * 100).toFixed(0)}% Phoenix Rebirth (Resurrection Power)`;
                case 'dominance': return `+${(bonus.value * 100).toFixed(0)}% Supreme Dominance (Overwhelming Power)`;
                case 'omnipotence': return `+${(bonus.value * 100).toFixed(0)}% Godlike Omnipotence (Ultimate Power)`;
                default: return 'Special Bonus';
            }
        }
        
        function buyPet(petId) {
            const pet = availablePets.find(p => p.id === petId);
            if (!pet) return;
            
            if (gameState.pets.includes(petId)) {
                showNotification('Already owned!', 'var(--warning)');
                return;
            }
            
            if (gameState.money < pet.cost) {
                showNotification('Not enough money!', 'var(--danger)');
                return;
            }
            
            gameState.money -= pet.cost;
            gameState.pets.push(petId);
            gameState.petLevels[petId] = 1;
            gameState.petXP[petId] = 0;
            
            // Auto-equip if first pet
            if (!gameState.activePet) {
                gameState.activePet = petId;
                applyPetBonus(pet);
            }
            
            showNotification(`🎉 Pet acquired: ${pet.name}!`, 'var(--success)');
            updatePetsDisplay();
            updateStats();
        }
        
        function equipPet(petId) {
            const pet = availablePets.find(p => p.id === petId);
            if (!pet || !gameState.pets.includes(petId)) return;
            
            // Remove old pet bonus
            if (gameState.activePet) {
                const oldPet = availablePets.find(p => p.id === gameState.activePet);
                if (oldPet) removePetBonus(oldPet);
            }
            
            // Equip new pet
            gameState.activePet = petId;
            applyPetBonus(pet);
            
            showNotification(`${pet.name} equipped!`, 'var(--success)');
            updatePetsDisplay();
            updateStats();
        }
        
        function applyPetBonus(pet) {
            if (pet.bonus.type === 'luck') {
                gameState.luckMultiplier += pet.bonus.value;
            }
            // Other bonuses checked when needed
        }
        
        function removePetBonus(pet) {
            if (pet.bonus.type === 'luck') {
                gameState.luckMultiplier -= pet.bonus.value;
            }
        }
        
        function updateActivePetDisplay() {
            const activePet = gameState.activePet ? availablePets.find(p => p.id === gameState.activePet) : null;
            
            const displays = {
                icon: document.getElementById('activePetDisplay'),
                name: document.getElementById('activePetName'),
                bonus: document.getElementById('activePetBonus'),
                level: document.getElementById('activePetLevel')
            };
            
            if (activePet) {
                if (displays.icon) displays.icon.textContent = activePet.name.split(' ')[0];
                if (displays.name) displays.name.textContent = activePet.name.split(' ').slice(1).join(' ');
                if (displays.bonus) displays.bonus.textContent = getBonusDescription(activePet.bonus);
                if (displays.level) displays.level.textContent = `Level ${gameState.petLevels[activePet.id] || 1}`;
            } else {
                if (displays.icon) displays.icon.textContent = '❓';
                if (displays.name) displays.name.textContent = 'No pet equipped';
                if (displays.bonus) displays.bonus.textContent = 'Buy a pet to get bonuses!';
                if (displays.level) displays.level.textContent = 'Level: 0';
            }
        }
        
        // ===== PRESTIGE SYSTEM =====
        
        const prestigeShopItems = [
            { id: 'start_2x_luck', name: 'Lucky Start', desc: 'Start with 2x Luck', cost: 5 },
            { id: 'start_autospin', name: 'Auto Start', desc: 'Start with Auto-Spin', cost: 10 },
            { id: 'start_100k', name: 'Rich Start', desc: 'Start with $100,000', cost: 8 },
            { id: 'keep_pets', name: 'Pet Keeper', desc: 'Keep all pets on Prestige', cost: 15 },
            { id: 'double_points', name: 'Point Doubler', desc: '2x Achievement Points', cost: 20 }
        ];
        
        function updatePrestigeDisplay() {
            if (!document.getElementById('prestigeLevelDisplay')) return;
            
            document.getElementById('prestigeLevelDisplay').textContent = gameState.prestigeLevel || 0;
            document.getElementById('prestigePointsDisplay').textContent = gameState.prestigePoints || 0;
            
            // Check requirements
            const hasRebirths = (gameState.rebirths || 0) >= 10;
            const hasMoney = gameState.money >= 1000000000; // 1 billion
            const hasPrimordial = Object.values(gameState.inventory).some(item => {
                const rarityIndex = rarities.findIndex(r => r.name === item.rarity);
                return rarityIndex >= 13 && item.count > 0; // Primordial is index 13
            });
            
            document.getElementById('prestigeRebirthReq').textContent = hasRebirths ? '✅ Met' : '❌ Not met';
            document.getElementById('prestigeRebirthReq').style.color = hasRebirths ? 'var(--success)' : 'var(--danger)';
            
            document.getElementById('prestigeMoneyReq').textContent = hasMoney ? '✅ Met' : '❌ Not met';
            document.getElementById('prestigeMoneyReq').style.color = hasMoney ? 'var(--success)' : 'var(--danger)';
            
            document.getElementById('prestigeItemReq').textContent = hasPrimordial ? '✅ Met' : '❌ Not met';
            document.getElementById('prestigeItemReq').style.color = hasPrimordial ? 'var(--success)' : 'var(--danger)';
            
            const canPrestige = hasRebirths && hasMoney && hasPrimordial;
            const button = document.getElementById('prestigeButton');
            button.disabled = !canPrestige;
            button.style.opacity = canPrestige ? '1' : '0.5';
            button.style.cursor = canPrestige ? 'pointer' : 'not-allowed';
            
            updatePrestigeShopDisplay();
        }
        
        function updatePrestigeShopDisplay() {
            const container = document.getElementById('prestigeShopContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            prestigeShopItems.forEach(item => {
                const owned = gameState.prestigeShopPurchases[item.id] || false;
                const canBuy = !owned && (gameState.prestigePoints >= item.cost);
                
                const card = document.createElement('div');
                card.className = 'recipe-card';
                card.style.border = owned ? '2px solid var(--accent-gold)' : '';
                card.innerHTML = `
                    <h3 style="color: var(--accent-gold);">${item.name}</h3>
                    <p style="color: var(--text-secondary); margin: 10px 0;">${item.desc}</p>
                    <div style="margin: 15px 0; font-size: 1.2rem; color: var(--accent-primary);">
                        ⭐ ${item.cost} Points
                    </div>
                    <button class="btn ${owned ? 'btn-decline' : canBuy ? 'btn-accept' : 'btn-decline'}" 
                            onclick="buyPrestigeItem('${item.id}')" 
                            ${!canBuy ? 'disabled' : ''}
                            style="${!canBuy ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        ${owned ? '✅ Owned' : canBuy ? '💳 Purchase' : '🔒 Locked'}
                    </button>
                `;
                container.appendChild(card);
            });
        }
        
        function buyPrestigeItem(itemId) {
            const item = prestigeShopItems.find(i => i.id === itemId);
            if (!item) return;
            
            if (gameState.prestigeShopPurchases[itemId]) {
                showNotification('Already owned!', 'var(--warning)');
                return;
            }
            
            if (gameState.prestigePoints < item.cost) {
                showNotification('Not enough prestige points!', 'var(--danger)');
                return;
            }
            
            gameState.prestigePoints -= item.cost;
            gameState.prestigeShopPurchases[itemId] = true;
            
            showNotification(`⭐ Purchased: ${item.name}!`, 'var(--success)');
            updatePrestigeDisplay();
        }
        
        function performPrestige() {
            const hasRebirths = (gameState.rebirths || 0) >= 10;
            const hasMoney = gameState.money >= 1000000000;
            const hasPrimordial = Object.values(gameState.inventory).some(item => {
                const rarityIndex = rarities.findIndex(r => r.name === item.rarity);
                return rarityIndex >= 13 && item.count > 0; // Primordial is index 13
            });
            
            if (!hasRebirths || !hasMoney || !hasPrimordial) {
                showNotification('❌ Requirements not met!', 'var(--danger)');
                return;
            }
            
            if (!confirm(`⭐ PRESTIGE ⭐\n\nThis will reset EVERYTHING except:\n- Prestige Points\n- Prestige Shop\n- Pets (if you bought Pet Keeper)\n\nYou will gain ${5 + (gameState.prestigeLevel || 0)} Prestige Points.\n\nContinue?`)) {
                return;
            }
            
            // Calculate prestige points
            const pointsGained = 5 + (gameState.prestigeLevel || 0);
            
            // Save what we keep
            const keepPets = gameState.prestigeShopPurchases.keep_pets;
            const savedPets = keepPets ? [...gameState.pets] : [];
            const savedActivePet = keepPets ? gameState.activePet : null;
            const savedPetLevels = keepPets ? {...gameState.petLevels} : {};
            const savedPrestigePoints = (gameState.prestigePoints || 0) + pointsGained;
            const savedPrestigeLevel = (gameState.prestigeLevel || 0) + 1;
            const savedPrestigeShop = {...gameState.prestigeShopPurchases};
            
            // Reset most of game state
            Object.assign(gameState, {
                inventory: {},
                totalValue: 0,
                money: gameState.prestigeShopPurchases.start_100k ? 100000 : 0,
                totalSpins: 0,
                luckMultiplier: gameState.prestigeShopPurchases.start_2x_luck ? 2.0 : 1.0,
                tradeWins: 0,
                tradeLosses: 0,
                battlePassXP: 0,
                battlePassTier: 0,
                achievements: {},
                upgrades: {
                    spinSpeed: 0,
                    popularity: 0,
                    luckBoost: 0,
                    autoSpin: gameState.prestigeShopPurchases.start_autospin ? 1 : 0,
                    tradeInsight: 0,
                    valueBoost: 0,
                    craftingMastery: 0,
                    enchantPower: 0,
                    multiSpin: 0,
                    shopDiscount: 0,
                    rarityBoost: 0,
                    eventLuck: 0,
                    xpBoost: 0,
                    sellPrice: 0,
                    questSpeed: 0,
                    mysteryBox: 0,
                    autoFusion: 0
                },
                rebirths: 0,
                permanentLuckBoost: 1.0,
                craftCount: 0,
                enchantSuccess: 0,
                enchantFails: 0,
                fusionCount: 0,
                itemsFromEvents: 0,
                lifetimeMoneyEarned: 0,
                lifetimeMoneySpent: 0,
                biggestTradeWin: 0,
                biggestTradeLoss: 0,
                rarityCounts: {},
                pityCounter: 0,
                collectionBonuses: {
                    discoComplete: false,
                    galacticComplete: false,
                    glitchComplete: false,
                    fullmoonComplete: false,
                    bloodmoonComplete: false,
                    weatherComplete: false,
                    christmasComplete: false
                },
                rarityMilestones: {},
                achievementPoints: 0,
                achievementShopPurchases: {},
                dailyChallenges: [],
                dailyChallengesCompleted: [],
                favoriteItems: [],
                pets: savedPets,
                activePet: savedActivePet,
                petLevels: savedPetLevels,
                prestigeLevel: savedPrestigeLevel,
                prestigePoints: savedPrestigePoints,
                prestigeShopPurchases: savedPrestigeShop
            });
            
            showNotification(`⭐ PRESTIGE COMPLETE! Level ${savedPrestigeLevel}! +${pointsGained} Points!`, 'var(--success)');
            
            // Refresh everything
            updateStats();
            updateInventory();
            initAchievements();
            updatePrestigeDisplay();
            updatePetsDisplay();
            switchTab('prestige');
            saveGame();
        }
        
        // ===== FEATURE 1: EXPORT/IMPORT SAVES =====
        
        function exportSaveData() {
            try {
                const saveData = JSON.stringify(gameState);
                const encoded = btoa(saveData);
                
                // Create a modal to show the code
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
                modal.innerHTML = `
                    <div style="background: var(--bg-medium); padding: 30px; border-radius: 15px; max-width: 600px; width: 100%; border: 2px solid var(--accent-primary);">
                        <h2 style="color: var(--accent-primary); margin-bottom: 20px;">📤 Export Save Code</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">Copy this code to backup your progress:</p>
                        <textarea id="saveCodeExport" readonly style="width: 100%; height: 150px; padding: 15px; background: var(--bg-dark); color: var(--text-primary); border: 2px solid var(--accent-primary); border-radius: 8px; font-family: monospace; font-size: 0.85rem; resize: none;">${encoded}</textarea>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="copyExportCode()" class="btn btn-accept" style="flex: 1;">📋 Copy to Clipboard</button>
                            <button onclick="closeModal()" class="btn btn-decline" style="flex: 1;">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.onclick = (e) => { if (e.target === modal) closeModal(); };
                window.currentModal = modal;
                
                // Auto-select text
                setTimeout(() => {
                    document.getElementById('saveCodeExport').select();
                }, 100);
            } catch (error) {
                showNotification('❌ Error exporting save!', 'var(--danger)');
                console.error('Export error:', error);
            }
        }
        
        function showImportDialog() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `
                <div style="background: var(--bg-medium); padding: 30px; border-radius: 15px; max-width: 600px; width: 100%; border: 2px solid var(--accent-primary);">
                    <h2 style="color: var(--accent-primary); margin-bottom: 20px;">📥 Import Save Code</h2>
                    <p style="color: var(--warning); margin-bottom: 15px;">⚠️ This will OVERWRITE your current progress!</p>
                    <textarea id="saveCodeImport" placeholder="Paste your save code here..." style="width: 100%; height: 150px; padding: 15px; background: var(--bg-dark); color: var(--text-primary); border: 2px solid var(--accent-primary); border-radius: 8px; font-family: monospace; font-size: 0.85rem; resize: none;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="importSaveData()" class="btn btn-accept" style="flex: 1;">✅ Import</button>
                        <button onclick="closeModal()" class="btn btn-decline" style="flex: 1;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };
            window.currentModal = modal;
        }
        
        function importSaveData() {
            const code = document.getElementById('saveCodeImport').value.trim();
            if (!code) {
                showNotification('❌ Please paste a save code!', 'var(--danger)');
                return;
            }
            
            try {
                const decoded = atob(code);
                const loadedState = JSON.parse(decoded);
                
                // Validate it's actually a save file
                if (!loadedState.inventory || !loadedState.money === undefined) {
                    showNotification('❌ Invalid save code!', 'var(--danger)');
                    return;
                }
                
                // Load the save
                Object.assign(gameState, loadedState);
                
                // Ensure backward compatibility
                if (gameState.favoriteItems === undefined) gameState.favoriteItems = [];
                
                closeModal();
                showNotification('✅ Save imported successfully!', 'var(--success)');
                
                // Refresh display
                updateStats();
                updateInventory();
                initAchievements();
                updateRebirthDisplay();
                
                // Auto-save the imported state
                saveGame();
            } catch (error) {
                showNotification('❌ Error importing save!', 'var(--danger)');
                console.error('Import error:', error);
            }
        }
        
        function copyExportCode() {
            const textarea = document.getElementById('saveCodeExport');
            textarea.select();
            document.execCommand('copy');
            showNotification('📋 Copied to clipboard!', 'var(--success)');
        }
        
        function closeModal() {
            if (window.currentModal) {
                window.currentModal.remove();
                window.currentModal = null;
            }
        }
        
        // ===== FEATURE 2: BULK SELL BY RARITY =====
        
        function bulkSellByRarity() {
            const raritySelect = document.getElementById('bulkSellRarity');
            const selectedRarity = raritySelect.value;
            
            if (!selectedRarity) {
                showNotification('❌ Please select a rarity!', 'var(--danger)');
                return;
            }
            
            // Get confirmation
            if (!gameState.settings || gameState.settings.confirmSell !== false) {
                if (!confirm(`Sell ALL ${selectedRarity} items for 70% value?`)) {
                    return;
                }
            }
            
            let soldCount = 0;
            let totalMoney = 0;
            
            // Sell all items of this rarity (except favorited)
            for (const [key, item] of Object.entries(gameState.inventory)) {
                if (item.rarity === selectedRarity && item.count > 0) {
                    // Skip if favorited
                    if (gameState.favoriteItems && gameState.favoriteItems.includes(key)) {
                        continue;
                    }
                    
                    let sellMultiplier = 0.7;
                    
                    // Check for Money Multi enchantment
                    if (item.enchantments && item.enchantments.includes('Money Multi')) {
                        sellMultiplier += 0.2;
                    }
                    
                    const sellPrice = Math.floor(item.value * sellMultiplier * item.count);
                    gameState.money += sellPrice;
                    gameState.lifetimeMoneyEarned += sellPrice;
                    gameState.totalValue -= item.value * item.count;
                    totalMoney += sellPrice;
                    soldCount += item.count;
                    item.count = 0;
                }
            }
            
            if (soldCount > 0) {
                showNotification(`💰 Sold ${soldCount} ${selectedRarity} items for $${formatNumber(totalMoney)}!`, 'var(--success)');
                playSound('coin');
                updateStats();
                updateInventory();
            } else {
                showNotification(`No ${selectedRarity} items to sell!`, 'var(--text-secondary)');
            }
        }
        
        function sellAllNonFavorited() {
            // Get confirmation
            if (!gameState.settings || gameState.settings.confirmSell !== false) {
                if (!confirm('Sell ALL non-favorited items for 70% value?')) {
                    return;
                }
            }
            
            let soldCount = 0;
            let totalMoney = 0;
            
            // Sell all items that are NOT favorited
            for (const [key, item] of Object.entries(gameState.inventory)) {
                if (item.count > 0) {
                    // Skip if favorited
                    if (gameState.favoriteItems && gameState.favoriteItems.includes(key)) {
                        continue;
                    }
                    
                    let sellMultiplier = 0.7;
                    
                    // Check for Money Multi enchantment
                    if (item.enchantments && item.enchantments.includes('Money Multi')) {
                        sellMultiplier += 0.2;
                    }
                    
                    const sellPrice = Math.floor(item.value * sellMultiplier * item.count);
                    gameState.money += sellPrice;
                    gameState.lifetimeMoneyEarned += sellPrice;
                    gameState.totalValue -= item.value * item.count;
                    totalMoney += sellPrice;
                    soldCount += item.count;
                    item.count = 0;
                }
            }
            
            if (soldCount > 0) {
                showNotification(`💰 Sold ${soldCount} non-favorited items for $${formatNumber(totalMoney)}!`, 'var(--success)');
                playSound('coin');
                updateStats();
                updateInventory();
            } else {
                showNotification('No non-favorited items to sell!', 'var(--text-secondary)');
            }
        }
        
        function favoriteAllByRarity() {
            const minRarity = prompt('Favorite all items of which rarity and above?\n\nOptions:\n0 = Common\n1 = Uncommon\n2 = Rare\n3 = Epic\n4 = Legendary\n5 = Mythic\n6 = Exotic\n7 = Celestial\n8 = Divine\n9 = Cosmic\n10 = Infinite\n11 = Transcendent\n12 = Ethereal\n13 = Primordial+', '4');
            
            if (minRarity === null) return;
            
            const minIndex = parseInt(minRarity);
            if (isNaN(minIndex) || minIndex < 0 || minIndex >= rarities.length) {
                showNotification('❌ Invalid rarity index!', 'var(--danger)');
                return;
            }
            
            if (!gameState.favoriteItems) gameState.favoriteItems = [];
            
            let favoritedCount = 0;
            
            for (const [key, item] of Object.entries(gameState.inventory)) {
                if (item.count > 0) {
                    const itemRarityIndex = rarities.findIndex(r => r.name === item.rarity);
                    if (itemRarityIndex >= minIndex && !gameState.favoriteItems.includes(key)) {
                        gameState.favoriteItems.push(key);
                        favoritedCount++;
                    }
                }
            }
            
            if (favoritedCount > 0) {
                showNotification(`⭐ Favorited ${favoritedCount} items (${rarities[minIndex].name}+)!`, 'var(--accent-gold)');
                playSound('success');
                updateInventory();
            } else {
                showNotification('No new items to favorite!', 'var(--text-secondary)');
            }
        }
        
        function unfavoriteAll() {
            if (!gameState.favoriteItems || gameState.favoriteItems.length === 0) {
                showNotification('No favorited items!', 'var(--text-secondary)');
                return;
            }
            
            if (!confirm('Remove all favorites?')) {
                return;
            }
            
            const count = gameState.favoriteItems.length;
            gameState.favoriteItems = [];
            
            showNotification(`✖️ Removed ${count} favorites!`, 'var(--warning)');
            playSound('button');
            updateInventory();
        }
        
        // ===== FEATURE 3: CRAFT MAX =====
        
        function craftMax(recipeName) {
            const recipe = recipes.find(r => r.name === recipeName);
            if (!recipe) return;
            
            // Calculate max possible crafts
            let maxCrafts = Infinity;
            
            for (const [rarity, requiredCount] of Object.entries(recipe.requires)) {
                const availableItems = Object.values(gameState.inventory).filter(item => 
                    item.rarity === rarity && item.count > 0
                );
                const availableCount = availableItems.reduce((sum, item) => sum + item.count, 0);
                const possibleCrafts = Math.floor(availableCount / requiredCount);
                maxCrafts = Math.min(maxCrafts, possibleCrafts);
            }
            
            if (maxCrafts === 0 || maxCrafts === Infinity) {
                showNotification('❌ Not enough materials!', 'var(--danger)');
                return;
            }
            
            // Confirm if crafting more than 10
            if (maxCrafts > 10) {
                if (!confirm(`Craft ${maxCrafts}x ${recipeName}?`)) {
                    return;
                }
            }
            
            // Perform crafts
            for (let i = 0; i < maxCrafts; i++) {
                craftItem(recipeName, true); // Pass true to skip notifications
            }
            
            showNotification(`🔨 Crafted ${maxCrafts}x ${recipeName}!`, 'var(--success)');
            updateStats();
            updateInventory();
            
            // Refresh crafting grid
            document.getElementById('craftingGrid').innerHTML = '';
            initCrafting();
        }
        
        // ===== FEATURE 4: FAVORITE ITEMS =====
        
        function toggleFavorite(itemKey) {
            if (!gameState.favoriteItems) gameState.favoriteItems = [];
            
            const index = gameState.favoriteItems.indexOf(itemKey);
            if (index === -1) {
                gameState.favoriteItems.push(itemKey);
                showNotification(`⭐ ${itemKey} favorited (protected from selling)`, 'var(--accent-gold)');
            } else {
                gameState.favoriteItems.splice(index, 1);
                showNotification(`Unfavorited ${itemKey}`, 'var(--text-secondary)');
            }
            
            updateInventory();
        }
        
        // ===== FEATURE 5: CONFIRMATION DIALOGS =====
        // This is integrated into existing functions via checks
        
        // Initialize game
        // Try to auto-load save file on startup
        const hasSaveFile = localStorage.getItem('rngTraderSave');
        if (hasSaveFile) {
            try {
                const data = JSON.parse(hasSaveFile);
                gameState.inventory = data.inventory || {};
                gameState.totalValue = data.totalValue || 0;
                gameState.money = data.money || 0;
                gameState.totalSpins = data.totalSpins || 0;
                gameState.luckMultiplier = data.luckMultiplier || 1.0;
                gameState.tradeWins = data.tradeWins || 0;
                gameState.tradeLosses = data.tradeLosses || 0;
                gameState.battlePassXP = data.battlePassXP || 0;
                gameState.achievements = data.achievements || {};
                gameState.upgrades = data.upgrades || {
                    spinSpeed: 0,
                    popularity: 0,
                    luckBoost: 0,
                    autoSpin: 0,
                    tradeInsight: 0,
                    valueBoost: 0,
                    craftingMastery: 0,
                    enchantPower: 0,
                    multiSpin: 0,
                    shopDiscount: 0,
                    rarityBoost: 0
                };
                // Ensure new upgrades exist in old saves
                if (gameState.upgrades.valueBoost === undefined) gameState.upgrades.valueBoost = 0;
                if (gameState.upgrades.craftingMastery === undefined) gameState.upgrades.craftingMastery = 0;
                if (gameState.upgrades.enchantPower === undefined) gameState.upgrades.enchantPower = 0;
                if (gameState.upgrades.multiSpin === undefined) gameState.upgrades.multiSpin = 0;
                if (gameState.upgrades.shopDiscount === undefined) gameState.upgrades.shopDiscount = 0;
                if (gameState.upgrades.rarityBoost === undefined) gameState.upgrades.rarityBoost = 0;
                if (gameState.upgrades.eventLuck === undefined) gameState.upgrades.eventLuck = 0;
                if (gameState.upgrades.xpBoost === undefined) gameState.upgrades.xpBoost = 0;
                if (gameState.upgrades.sellPrice === undefined) gameState.upgrades.sellPrice = 0;
                if (gameState.upgrades.questSpeed === undefined) gameState.upgrades.questSpeed = 0;
                if (gameState.upgrades.mysteryBox === undefined) gameState.upgrades.mysteryBox = 0;
                if (gameState.specialEventIsAdmin === undefined) gameState.specialEventIsAdmin = false;
                
                // Backwards compatibility for new features
                if (gameState.pityCounter === undefined) gameState.pityCounter = 0;
                if (gameState.pityThreshold === undefined) gameState.pityThreshold = 100;
                if (gameState.pityTriggered === undefined) gameState.pityTriggered = 0;
                if (gameState.lastLoginDate === undefined) gameState.lastLoginDate = null;
                if (gameState.loginStreak === undefined) gameState.loginStreak = 0;
                if (gameState.totalLogins === undefined) gameState.totalLogins = 0;
                if (gameState.loginRewardsClaimed === undefined) gameState.loginRewardsClaimed = [];
                if (gameState.lifetimeMoneyEarned === undefined) gameState.lifetimeMoneyEarned = 0;
                if (gameState.lifetimeMoneySpent === undefined) gameState.lifetimeMoneySpent = 0;
                if (gameState.biggestTradeWin === undefined) gameState.biggestTradeWin = 0;
                if (gameState.biggestTradeLoss === undefined) gameState.biggestTradeLoss = 0;
                if (gameState.rarityCounts === undefined) gameState.rarityCounts = {};
                if (gameState.itemsFromEvents === undefined) gameState.itemsFromEvents = 0;
                if (gameState.craftCount === undefined) gameState.craftCount = 0;
                if (gameState.enchantSuccess === undefined) gameState.enchantSuccess = 0;
                if (gameState.enchantFails === undefined) gameState.enchantFails = 0;
                if (gameState.fusionCount === undefined) gameState.fusionCount = 0;
                if (gameState.statisticsViewed === undefined) gameState.statisticsViewed = false;
                if (gameState.collectionBonuses === undefined) gameState.collectionBonuses = {discoComplete:false,galacticComplete:false,glitchComplete:false,fullmoonComplete:false,bloodmoonComplete:false,weatherComplete:false,christmasComplete:false};
                if (gameState.rarityMilestones === undefined) gameState.rarityMilestones = {};
                if (gameState.upgrades.autoFusion === undefined) gameState.upgrades.autoFusion = 0;
                if (gameState.notificationQueue === undefined) gameState.notificationQueue = [];
                if (gameState.isShowingNotification === undefined) gameState.isShowingNotification = false;
                
                gameState.rebirths = data.rebirths || 0;
                gameState.permanentLuckBoost = data.permanentLuckBoost || 1.0;
                gameState.settings = data.settings || {
                    soundEffects: true,
                    showTradeNotifications: true,
                    showExpiredNotifications: true,
                    showSpinResults: true,
                    showAchievementNotifications: true,
                    showRandomEvents: true,
                    showAutoSaveNotifications: false
                };
                // Ensure new setting exists in old saves
                if (gameState.settings.soundEffects === undefined) {
                    gameState.settings.soundEffects = true;
                }
                if (gameState.settings.showAutoSaveNotifications === undefined) {
                    gameState.settings.showAutoSaveNotifications = false;
                }
                gameState.craftCount = data.craftCount || 0;
                gameState.enchantSuccess = data.enchantSuccess || 0;
                gameState.enchantFails = data.enchantFails || 0;
                gameState.adminUnlocked = data.adminUnlocked || false;
                gameState.questsCompleted = data.questsCompleted || 0;
                gameState.dailyStreak = data.dailyStreak || 0;
                gameState.weeklyQuestsCompleted = data.weeklyQuestsCompleted || 0;
                gameState.shopPurchases = data.shopPurchases || 0;
                gameState.activeQuests = data.activeQuests || [];
                gameState.completedQuests = data.completedQuests || [];
                gameState.lastQuestRefresh = data.lastQuestRefresh || 0;
                gameState.claimedBPTiers = data.claimedBPTiers || [];
            } catch (error) {
                console.error('Auto-load failed:', error);
            }
        }
        
        // Ensure new features exist (backward compatibility)
        if (gameState.favoriteItems === undefined) gameState.favoriteItems = [];
        if (gameState.inventorySort === undefined) gameState.inventorySort = 'rarity';
        if (gameState.inventoryFilter === undefined) gameState.inventoryFilter = 'all';
        if (gameState.tutorialStep === undefined) gameState.tutorialStep = 0;
        if (gameState.tutorialComplete === undefined) gameState.tutorialComplete = false;
        if (gameState.tutorialSkipped === undefined) gameState.tutorialSkipped = false;
        if (gameState.dailyChallenges === undefined) gameState.dailyChallenges = [];
        if (gameState.dailyChallengesCompleted === undefined) gameState.dailyChallengesCompleted = [];
        if (gameState.lastDailyChallengeReset === undefined) gameState.lastDailyChallengeReset = 0;
        if (gameState.achievementPoints === undefined) gameState.achievementPoints = 0;
        if (gameState.achievementShopPurchases === undefined) gameState.achievementShopPurchases = {};
        if (gameState.pets === undefined) gameState.pets = [];
        if (gameState.activePet === undefined) gameState.activePet = null;
        if (gameState.petLevels === undefined) gameState.petLevels = {};
        if (gameState.petXP === undefined) gameState.petXP = {};
        if (gameState.prestigeLevel === undefined) gameState.prestigeLevel = 0;
        if (gameState.prestigePoints === undefined) gameState.prestigePoints = 0;
        if (gameState.prestigeShopPurchases === undefined) gameState.prestigeShopPurchases = {};
        
        // Initialize when DOM is ready
        // Game initialization will happen in main DOMContentLoaded at end of script
        
        
        // Initialize new systems
        generateDailyChallenges();
        updateAchievementPointsDisplay();
        
        // Start tutorial for new players
        if (!gameState.tutorialComplete && !gameState.tutorialSkipped && gameState.totalSpins === 0) {
            setTimeout(() => startTutorial(), 1000);
        }
        
        // Mobile welcome message
        if (isMobileDevice() && !localStorage.getItem('mobileWelcomeShown')) {
            setTimeout(() => {
                showNotification('📱 Mobile Controls: Tap to flex, Long-press to sell! Swipe from left edge to open menu.', 'var(--accent-primary)');
                localStorage.setItem('mobileWelcomeShown', 'true');
            }, 2000);
        }
        
        // Start auto-spin if unlocked
        if (gameState.upgrades.autoSpin > 0) {
            startAutoSpin();
        }
        
        // Check for Christmas events every minute
        setInterval(checkChristmasEvent, 60000);
        checkChristmasEvent();
        
        // Check for Weather events every 30 seconds
        setInterval(checkWeatherEvents, 30000);
        checkWeatherEvents();
        
        // Check for Special events every 10 seconds
        setInterval(checkSpecialEvents, 10000);
        checkSpecialEvents();
        
        // Update event timers every second
        setInterval(() => {
            if (gameState.christmasEvent || gameState.weatherEvent || gameState.specialEvent) {
                updateEventBonuses();
            }
        }, 1000);
        
        // Check for quest refresh every minute
        setInterval(() => {
            refreshQuests();
        }, 60000);
        
        // ===== BOSS BATTLES SYSTEM =====
        
        const bossesData = [
            {
                id: 'money_goblin',
                name: '💰 Money Goblin',
                emoji: '💰',
                description: 'A greedy goblin hoarding gold',
                difficulty: 'Beginner',
                cost: 100000,
                maxHP: 1000,
                rewards: {
                    moneyMin: 500000,
                    moneyMax: 1000000,
                    items: ['Rare', 'Epic']
                },
                color: '#ffd700'
            },
            {
                id: 'slot_demon',
                name: '🎰 Slot Demon',
                emoji: '🎰',
                description: 'Corrupted luck incarnate',
                difficulty: 'Easy',
                cost: 500000,
                maxHP: 2500,
                rewards: {
                    moneyMin: 1000000,
                    moneyMax: 2500000,
                    items: ['Legendary'],
                    crates: 3
                },
                color: '#ff1493'
            },
            {
                id: 'rarity_dragon',
                name: '🔮 Rarity Dragon',
                emoji: '🔮',
                description: 'Guardian of rare treasures',
                difficulty: 'Medium',
                cost: 1000000,
                maxHP: 5000,
                rewards: {
                    moneyMin: 3000000,
                    moneyMax: 7000000,
                    items: ['Divine'],
                    guaranteed: 'Divine'
                },
                color: '#ffd700'
            },
            {
                id: 'xp_phantom',
                name: '👻 XP Phantom',
                emoji: '👻',
                description: 'Spirit of endless grinding',
                difficulty: 'Medium',
                cost: 2000000,
                maxHP: 7500,
                rewards: {
                    moneyMin: 5000000,
                    moneyMax: 10000000,
                    battlePassTiers: 10
                },
                color: '#9370db'
            },
            {
                id: 'pet_master',
                name: '🐉 Pet Master',
                emoji: '🐉',
                description: 'Tamer of legendary beasts',
                difficulty: 'Hard',
                cost: 5000000,
                maxHP: 10000,
                rewards: {
                    moneyMin: 10000000,
                    moneyMax: 20000000,
                    randomPet: true
                },
                color: '#ff4500'
            },
            {
                id: 'time_keeper',
                name: '⏰ Time Keeper',
                emoji: '⏰',
                description: 'Master of temporal power',
                difficulty: 'Hard',
                cost: 10000000,
                maxHP: 15000,
                rewards: {
                    moneyMin: 20000000,
                    moneyMax: 40000000,
                    speedBoost: 3600
                },
                color: '#00ced1'
            },
            {
                id: 'artifact_guardian',
                name: '💎 Artifact Guardian',
                emoji: '💎',
                description: 'Protector of ancient relics',
                difficulty: 'Very Hard',
                cost: 25000000,
                maxHP: 25000,
                rewards: {
                    moneyMin: 50000000,
                    moneyMax: 100000000,
                    randomArtifact: true
                },
                color: '#ff1493'
            },
            {
                id: 'cosmic_horror',
                name: '🌌 Cosmic Horror',
                emoji: '🌌',
                description: 'Being from beyond reality',
                difficulty: 'Extreme',
                cost: 50000000,
                maxHP: 50000,
                rewards: {
                    moneyMin: 100000000,
                    moneyMax: 250000000,
                    items: ['Cosmic', 'Infinite'],
                    guaranteed: 'Cosmic'
                },
                color: '#4b0082'
            },
            {
                id: 'prestige_king',
                name: '👑 Prestige King',
                emoji: '👑',
                description: 'Ruler of the prestiged realm',
                difficulty: 'Extreme',
                cost: 100000000,
                maxHP: 100000,
                rewards: {
                    moneyMin: 250000000,
                    moneyMax: 500000000,
                    prestigePoints: 5
                },
                color: '#ffd700'
            },
            {
                id: 'primordial_titan',
                name: '🔥 Primordial Titan',
                emoji: '🔥',
                description: 'Ancient force of creation',
                difficulty: 'IMPOSSIBLE',
                cost: 500000000,
                maxHP: 500000,
                rewards: {
                    moneyMin: 1000000000,
                    moneyMax: 2000000000,
                    items: ['Primordial', 'Omega'],
                    guaranteed: 'Primordial',
                    randomArtifact: true
                },
                color: '#ff0000'
            }
        ];
        
        function initializeBossState() {
            if (!gameState.bosses) {
                gameState.bosses = {};
            }
            
            // Initialize each boss individually if missing
            bossesData.forEach(boss => {
                if (!gameState.bosses[boss.id]) {
                    gameState.bosses[boss.id] = {
                        defeated: 0,
                        lastFought: 0,
                        currentHP: boss.maxHP,
                        inBattle: false
                    };
                }
            });
            
            if (!gameState.bossStats) {
                gameState.bossStats = {
                    totalDefeated: 0,
                    totalDamage: 0,
                    bestReward: 0
                };
            }
        }
        
        function updateBossesDisplay() {
            initializeBossState();
            
            const container = document.getElementById('bossesContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Update stats
            document.getElementById('totalBossesDefeated').textContent = gameState.bossStats.totalDefeated || 0;
            document.getElementById('totalBossDamage').textContent = formatNumber(gameState.bossStats.totalDamage || 0);
            document.getElementById('bestBossReward').textContent = '$' + formatNumber(gameState.bossStats.bestReward || 0);
            
            bossesData.forEach(boss => {
                const bossState = gameState.bosses[boss.id];
                const canFight = gameState.money >= boss.cost;
                const onCooldown = bossState.lastFought > 0 && (Date.now() - bossState.lastFought) < 86400000; // 24 hours
                
                const card = document.createElement('div');
                card.className = 'recipe-card';
                card.style.border = `3px solid ${boss.color}`;
                card.style.background = `linear-gradient(135deg, var(--bg-medium), ${boss.color}22)`;
                
                card.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 10px;">${boss.emoji}</div>
                        <h3 style="color: ${boss.color}; margin: 10px 0;">${boss.name}</h3>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px;">${boss.description}</div>
                        <div style="display: inline-block; padding: 4px 12px; background: ${boss.color}33; border-radius: 12px; font-size: 0.85rem; font-weight: bold; color: ${boss.color}; margin: 5px 0;">
                            ${boss.difficulty}
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; padding: 15px; background: var(--bg-dark); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary);">💪 HP:</span>
                            <span style="color: var(--danger); font-weight: bold;">${formatNumber(boss.maxHP)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary);">💰 Entry Cost:</span>
                            <span style="color: var(--accent-gold); font-weight: bold;">$${formatNumber(boss.cost)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">🏆 Defeated:</span>
                            <span style="color: var(--success); font-weight: bold;">${bossState.defeated}x</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-dark); padding: 12px; border-radius: 8px; margin: 15px 0;">
                        <div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 8px;">🎁 Rewards:</div>
                        <div style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.6;">
                            ${boss.rewards.moneyMin ? `💰 $${formatNumber(boss.rewards.moneyMin)} - $${formatNumber(boss.rewards.moneyMax)}<br>` : ''}
                            ${boss.rewards.guaranteed ? `✨ Guaranteed ${boss.rewards.guaranteed} item<br>` : ''}
                            ${boss.rewards.battlePassTiers ? `📊 +${boss.rewards.battlePassTiers} Battle Pass Tiers<br>` : ''}
                            ${boss.rewards.randomPet ? `🐉 Random Pet<br>` : ''}
                            ${boss.rewards.randomArtifact ? `💎 Random Artifact<br>` : ''}
                            ${boss.rewards.prestigePoints ? `⭐ +${boss.rewards.prestigePoints} Prestige Points<br>` : ''}
                            ${boss.rewards.crates ? `📦 ${boss.rewards.crates} Legendary Crates<br>` : ''}
                        </div>
                    </div>
                    
                    ${onCooldown ? `
                        <div style="text-align: center; padding: 10px; background: var(--warning)33; border-radius: 8px; color: var(--warning); margin-bottom: 10px;">
                            ⏰ On Cooldown - Wait 24h
                        </div>
                    ` : ''}
                    
                    <button class="btn ${canFight && !onCooldown ? 'btn-accept' : 'btn-decline'}" 
                            onclick="startBossFight('${boss.id}')" 
                            ${!canFight || onCooldown ? 'disabled' : ''}
                            style="width: 100%; padding: 15px; font-size: 1.1rem; ${!canFight || onCooldown ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        ${!canFight ? '❌ Not Enough Money' : onCooldown ? '⏰ On Cooldown' : '⚔️ FIGHT BOSS'}
                    </button>
                `;
                
                container.appendChild(card);
            });
        }
        
        // Boss fight game state
        let bossGameState = {
            active: false,
            bossId: null,
            playerPosition: 50, // 0-100 (percentage on the bar)
            bossPosition: 50,
            holdingButton: false,
            bossAttacking: false,
            attackDirection: null,
            attackEndTime: 0,
            lastBossMove: 0,
            lastBossAttack: 0,
            lastDamageTick: 0,
            totalDamage: 0
        };
        
        function startBossFight(bossId) {
            initializeBossState();
            const boss = bossesData.find(b => b.id === bossId);
            if (!boss) return;
            
            const bossState = gameState.bosses[bossId];
            
            // Check cooldown
            if (bossState.lastFought > 0 && (Date.now() - bossState.lastFought) < 86400000) {
                showNotification('⏰ This boss is on cooldown! Wait 24 hours.', 'var(--warning)');
                return;
            }
            
            // Check cost
            if (gameState.money < boss.cost) {
                showNotification(`❌ Need $${formatNumber(boss.cost)} to fight this boss!`, 'var(--danger)');
                return;
            }
            
            // Pay cost
            gameState.money -= boss.cost;
            playSound('coin');
            
            // Reset boss HP
            bossState.currentHP = boss.maxHP;
            bossState.inBattle = true;
            
            // Initialize game state
            bossGameState = {
                active: true,
                bossId: bossId,
                playerPosition: 20, // Start at bottom
                bossPosition: 80, // Boss starts at top
                holdingButton: false,
                bossAttacking: false,
                attackDirection: null,
                attackEndTime: 0,
                lastBossMove: Date.now(),
                lastBossAttack: Date.now(),
                lastDamageTick: Date.now(),
                totalDamage: 0
            };
            
            playSound('boss_appear');
            showNotification(`👹 ${boss.name} appears! HOLD to move up and get near the boss to attack!`, boss.color);
            
            // Create boss fight modal
            const modal = document.createElement('div');
            modal.id = 'bossFightModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.95);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: var(--bg-dark);
                padding: 30px;
                border-radius: 15px;
                border: 3px solid ${boss.color};
                max-width: 800px;
                width: 90%;
                text-align: center;
            `;
            
            content.innerHTML = `
                <div style="font-size: 6rem; margin-bottom: 20px; animation: boss-float 2s ease-in-out infinite;" id="bossEmoji">${boss.emoji}</div>
                <h2 style="color: ${boss.color}; margin-bottom: 10px;">${boss.name}</h2>
                <div style="color: var(--text-secondary); margin-bottom: 20px;">${boss.difficulty} - ${boss.description}</div>
                
                <!-- Boss HP Bar -->
                <div style="margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: var(--text-secondary);">Boss HP:</span>
                        <span style="color: var(--danger); font-weight: bold;" id="bossHPText">${formatNumber(bossState.currentHP)} / ${formatNumber(boss.maxHP)}</span>
                    </div>
                    <div class="progress-bar" style="height: 30px; background: var(--bg-medium);">
                        <div class="progress-fill" id="bossHPBar" style="width: 100%; background: linear-gradient(90deg, var(--danger), var(--warning)); transition: width 0.3s;">
                            <span style="font-weight: bold;">100%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Battle Arena -->
                <div style="margin: 30px 0; padding: 20px; background: var(--bg-light); border-radius: 10px; border: 2px solid ${boss.color};">
                    <div style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                        ⚠️ HOLD button to move UP | RELEASE to fall DOWN<br>
                        💥 Get NEAR the boss (within 15%) to deal damage!
                    </div>
                    
                    <!-- Vertical Battle Bar -->
                    <div style="position: relative; width: 100px; height: 400px; margin: 20px auto; background: linear-gradient(to bottom, #ff0000 0%, #ffff00 50%, #00ff00 100%); border-radius: 10px; border: 3px solid white; overflow: visible;">
                        <!-- Boss Marker -->
                        <div id="bossMarker" style="position: absolute; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; transition: top 0.2s; text-shadow: 0 0 10px ${boss.color}; z-index: 3; top: 20%;">
                            👹
                        </div>
                        
                        <!-- Player Marker -->
                        <div id="playerMarker" style="position: absolute; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; transition: top 0.2s; text-shadow: 0 0 10px #00ff00; z-index: 3; top: 80%;">
                            ⚔️
                        </div>
                        
                        <!-- Damage Zone Indicator -->
                        <div id="damageZone" style="position: absolute; left: 50%; transform: translate(-50%, -50%); width: 120px; height: 80px; border: 3px dashed #ffff00; border-radius: 50%; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 2;"></div>
                        
                        <!-- Position Labels -->
                        <div style="position: absolute; left: 110px; top: 0; color: white; font-weight: bold; text-shadow: 2px 2px 4px black;">100%<br>TOP</div>
                        <div style="position: absolute; left: 110px; top: 50%; transform: translateY(-50%); color: white; font-weight: bold; text-shadow: 2px 2px 4px black;">50%</div>
                        <div style="position: absolute; left: 110px; bottom: 0; color: white; font-weight: bold; text-shadow: 2px 2px 4px black;">0%<br>FALL</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px;">
                        <div>
                            <div style="color: var(--danger); font-size: 0.9rem; margin-bottom: 5px;">Boss</div>
                            <div id="bossPositionText" style="color: ${boss.color}; font-size: 1.3rem; font-weight: bold;">80%</div>
                        </div>
                        <div>
                            <div style="color: var(--warning); font-size: 0.9rem; margin-bottom: 5px;">Distance</div>
                            <div id="distanceText" style="color: #ffff00; font-size: 1.3rem; font-weight: bold;">60%</div>
                        </div>
                        <div>
                            <div style="color: var(--success); font-size: 0.9rem; margin-bottom: 5px;">You</div>
                            <div id="playerPositionText" style="color: #00ff00; font-size: 1.3rem; font-weight: bold;">20%</div>
                        </div>
                    </div>
                    
                    <div id="damageIndicator" style="margin-top: 15px; padding: 10px; background: var(--success); color: white; border-radius: 5px; font-weight: bold; display: none; animation: pulse 0.5s infinite;">
                        💥 DEALING DAMAGE! 💥
                    </div>
                    
                    <div id="attackWarning" style="margin-top: 15px; padding: 10px; background: var(--danger); color: white; border-radius: 5px; font-weight: bold; display: none; animation: pulse 0.5s infinite;">
                        ⚠️ BOSS IS ATTACKING! ⚠️
                    </div>
                </div>
                
                <!-- Attack Button -->
                <button class="btn btn-accept" id="attackButton" style="width: 100%; padding: 30px; font-size: 1.5rem; margin-top: 20px; user-select: none; touch-action: none;">
                    ⬆️ HOLD TO MOVE UP! ⬆️
                </button>
                
                <div style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem;">
                    HOLD = Move Up | RELEASE = Fall Down | Stay near boss to attack!
                </div>
                
                <button class="btn btn-decline" onclick="forfeitBossFight()" style="width: 100%; padding: 15px; font-size: 1rem; margin-top: 10px;">
                    🏳️ Forfeit Battle
                </button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Add event listeners for attack button
            const attackBtn = document.getElementById('attackButton');
            attackBtn.addEventListener('mousedown', () => { bossGameState.holdingButton = true; });
            attackBtn.addEventListener('mouseup', () => { bossGameState.holdingButton = false; });
            attackBtn.addEventListener('mouseleave', () => { bossGameState.holdingButton = false; });
            attackBtn.addEventListener('touchstart', (e) => { e.preventDefault(); bossGameState.holdingButton = true; });
            attackBtn.addEventListener('touchend', (e) => { e.preventDefault(); bossGameState.holdingButton = false; });
            
            // Start game loop
            bossGameLoop();
        }
        
        function bossGameLoop() {
            if (!bossGameState.active) return;
            
            const boss = bossesData.find(b => b.id === bossGameState.bossId);
            const bossState = gameState.bosses[bossGameState.bossId];
            if (!boss || !bossState || !bossState.inBattle) return;
            
            const now = Date.now();
            const deltaTime = 16; // Assume 60 FPS
            
            // Get boss attack pattern based on difficulty
            const attackPattern = getBossAttackPattern(boss.difficulty);
            
            // PLAYER MOVEMENT: Hold = UP, Release = DOWN
            if (bossGameState.holdingButton) {
                // Move up when holding
                bossGameState.playerPosition = Math.min(100, bossGameState.playerPosition + 1.5);
            } else {
                // Fall down when not holding (gravity)
                bossGameState.playerPosition = Math.max(0, bossGameState.playerPosition - 0.8);
            }
            
            // BOSS MOVEMENT (AI)
            if (!bossGameState.bossAttacking && now - bossGameState.lastBossMove > attackPattern.moveInterval) {
                bossGameState.lastBossMove = now;
                
                // Boss moves randomly, trying to avoid player
                const distance = Math.abs(bossGameState.bossPosition - bossGameState.playerPosition);
                
                if (distance < 20) {
                    // Too close! Boss tries to move away
                    if (bossGameState.playerPosition < bossGameState.bossPosition) {
                        bossGameState.bossPosition = Math.min(100, bossGameState.bossPosition + attackPattern.moveSpeed);
                    } else {
                        bossGameState.bossPosition = Math.max(30, bossGameState.bossPosition - attackPattern.moveSpeed);
                    }
                } else {
                    // Random movement in upper area
                    const randomMove = (Math.random() - 0.5) * attackPattern.moveSpeed * 2;
                    bossGameState.bossPosition = Math.max(30, Math.min(100, bossGameState.bossPosition + randomMove));
                }
            }
            
            // BOSS ATTACKS
            if (!bossGameState.bossAttacking && now - bossGameState.lastBossAttack > attackPattern.attackInterval) {
                bossGameState.lastBossAttack = now;
                bossGameState.bossAttacking = true;
                bossGameState.attackDirection = Math.random() < 0.5 ? 'down' : 'teleport';
                bossGameState.attackEndTime = now + 2000; // 2 second attack
                
                document.getElementById('attackWarning').style.display = 'block';
                playSound('boss_attack');
            }
            
            // HANDLE ACTIVE BOSS ATTACK
            if (bossGameState.bossAttacking) {
                if (now < bossGameState.attackEndTime) {
                    if (bossGameState.attackDirection === 'down') {
                        // Push player down
                        bossGameState.playerPosition = Math.max(0, bossGameState.playerPosition - attackPattern.attackPower);
                    } else if (bossGameState.attackDirection === 'teleport') {
                        // Boss teleports to different position
                        bossGameState.bossPosition = 30 + Math.random() * 60;
                    }
                } else {
                    bossGameState.bossAttacking = false;
                    document.getElementById('attackWarning').style.display = 'none';
                }
            }
            
            // PROXIMITY-BASED DAMAGE
            const distance = Math.abs(bossGameState.bossPosition - bossGameState.playerPosition);
            const damageRange = 15; // Within 15% = dealing damage
            
            if (distance <= damageRange && now - bossGameState.lastDamageTick > 100) { // Damage every 100ms
                bossGameState.lastDamageTick = now;
                
                // Calculate damage based on proximity (closer = more damage)
                const proximityMultiplier = 1 - (distance / damageRange); // 1.0 at 0 distance, 0.0 at max range
                const baseDamage = 50; // Base damage per tick
                const damage = Math.floor(baseDamage * proximityMultiplier * (attackPattern.damageMultiplier || 1));
                
                bossState.currentHP = Math.max(0, bossState.currentHP - damage);
                bossGameState.totalDamage += damage;
                
                // Show damage indicator
                document.getElementById('damageIndicator').style.display = 'block';
                document.getElementById('damageZone').style.opacity = '0.5';
                document.getElementById('damageZone').style.top = ((100 - bossGameState.bossPosition) / 100 * 400) + 'px';
                
                playSound('boss_hit');
            } else {
                document.getElementById('damageIndicator').style.display = 'none';
                document.getElementById('damageZone').style.opacity = '0';
            }
            
            // UPDATE VISUALS
            updateBossGameVisuals(boss, bossState, distance);
            
            // CHECK WIN/LOSE CONDITIONS
            if (bossState.currentHP <= 0) {
                bossGameState.active = false;
                defeatBoss(bossGameState.bossId);
                return;
            }
            
            if (bossGameState.playerPosition <= 0) {
                bossGameState.active = false;
                loseBossFight(bossGameState.bossId);
                return;
            }
            
            // Continue game loop
            requestAnimationFrame(bossGameLoop);
        }
        
        function getBossAttackPattern(difficulty) {
            const patterns = {
                'Beginner': {
                    moveInterval: 2000,
                    moveSpeed: 3,
                    attackInterval: 8000,
                    attackPower: 1.5,
                    damageMultiplier: 1.0
                },
                'Easy': {
                    moveInterval: 1500,
                    moveSpeed: 4,
                    attackInterval: 7000,
                    attackPower: 2.0,
                    damageMultiplier: 0.9
                },
                'Medium': {
                    moveInterval: 1000,
                    moveSpeed: 5,
                    attackInterval: 6000,
                    attackPower: 2.5,
                    damageMultiplier: 0.8
                },
                'Hard': {
                    moveInterval: 800,
                    moveSpeed: 6,
                    attackInterval: 5000,
                    attackPower: 3.0,
                    damageMultiplier: 0.7
                },
                'Very Hard': {
                    moveInterval: 600,
                    moveSpeed: 7,
                    attackInterval: 4000,
                    attackPower: 3.5,
                    damageMultiplier: 0.6
                },
                'Extreme': {
                    moveInterval: 400,
                    moveSpeed: 8,
                    attackInterval: 3000,
                    attackPower: 4.0,
                    damageMultiplier: 0.5
                },
                'IMPOSSIBLE': {
                    moveInterval: 300,
                    moveSpeed: 10,
                    attackInterval: 2500,
                    attackPower: 5.0,
                    damageMultiplier: 0.4
                }
            };
            
            return patterns[difficulty] || patterns['Beginner'];
        }
        
        function updateBossGameVisuals(boss, bossState, distance) {
            // Update markers (VERTICAL - top is 100%, bottom is 0%)
            const bossMarker = document.getElementById('bossMarker');
            const playerMarker = document.getElementById('playerMarker');
            
            // Convert percentage to pixel position (inverted: 100% = top, 0% = bottom)
            const bossTop = ((100 - bossGameState.bossPosition) / 100) * 400;
            const playerTop = ((100 - bossGameState.playerPosition) / 100) * 400;
            
            if (bossMarker) bossMarker.style.top = bossTop + 'px';
            if (playerMarker) playerMarker.style.top = playerTop + 'px';
            
            // Update position text
            const bossPos = document.getElementById('bossPositionText');
            const playerPos = document.getElementById('playerPositionText');
            const distanceText = document.getElementById('distanceText');
            
            if (bossPos) bossPos.textContent = Math.floor(bossGameState.bossPosition) + '%';
            if (playerPos) playerPos.textContent = Math.floor(bossGameState.playerPosition) + '%';
            if (distanceText) {
                distanceText.textContent = Math.floor(distance) + '%';
                if (distance <= 15) {
                    distanceText.style.color = '#00ff00';
                    distanceText.textContent = '💥 ' + Math.floor(distance) + '%';
                } else {
                    distanceText.style.color = '#ffff00';
                }
            }
            
            // Update boss HP bar
            const hpPercent = (bossState.currentHP / boss.maxHP) * 100;
            const hpBar = document.getElementById('bossHPBar');
            const hpText = document.getElementById('bossHPText');
            if (hpBar) {
                hpBar.style.width = hpPercent + '%';
                hpBar.innerHTML = `<span style="font-weight: bold;">${Math.floor(hpPercent)}%</span>`;
            }
            if (hpText) {
                hpText.textContent = `${formatNumber(bossState.currentHP)} / ${formatNumber(boss.maxHP)}`;
            }
            
            // Shake boss emoji when taking damage
            const emoji = document.getElementById('bossEmoji');
            if (emoji && distance <= 15) {
                emoji.style.animation = 'boss-shake 0.1s infinite';
            } else if (emoji) {
                emoji.style.animation = 'boss-float 2s ease-in-out infinite';
            }
        }
        
        function forfeitBossFight() {
            if (confirm('Are you sure you want to forfeit this battle? You will lose your entry fee!')) {
                bossGameState.active = false;
                const bossState = gameState.bosses[bossGameState.bossId];
                if (bossState) {
                    bossState.inBattle = false;
                }
                closeBossFight();
                showNotification('❌ Battle forfeited!', 'var(--danger)');
            }
        }
        
        function loseBossFight(bossId) {
            const boss = bossesData.find(b => b.id === bossId);
            const bossState = gameState.bosses[bossId];
            
            bossState.inBattle = false;
            bossState.lastFought = Date.now();
            
            playSound('error');
            showCenterNotification(`💀 DEFEATED BY ${boss.name}! 💀\n\nThe boss was too powerful!\nTry again in 24 hours.`, '#ff0000', 5000);
            
            setTimeout(() => {
                closeBossFight();
                updateBossesDisplay();
                updateStats();
            }, 3000);
        }
        
        function attackBoss(bossId) {
            // Legacy function - kept for compatibility but unused in new minigame
            console.log('Legacy attackBoss called - minigame is now active');
        }
        
        function defeatBoss(bossId) {
            const boss = bossesData.find(b => b.id === bossId);
            const bossState = gameState.bosses[bossId];
            
            bossState.inBattle = false;
            bossState.defeated++;
            bossState.lastFought = Date.now();
            
            gameState.bossStats.totalDefeated++;
            
            playSound('boss_defeated');
            
            // Calculate rewards
            const moneyReward = Math.floor(Math.random() * (boss.rewards.moneyMax - boss.rewards.moneyMin + 1)) + boss.rewards.moneyMin;
            gameState.money += moneyReward;
            
            if (moneyReward > gameState.bossStats.bestReward) {
                gameState.bossStats.bestReward = moneyReward;
            }
            
            let rewardText = `💰 $${formatNumber(moneyReward)}`;
            
            // Give item rewards
            if (boss.rewards.guaranteed) {
                const guaranteedRarity = rarities.find(r => r.name === boss.rewards.guaranteed);
                const itemName = generateItemName(guaranteedRarity);
                addItemToInventory(itemName, guaranteedRarity);
                rewardText += `<br>✨ ${itemName} (${boss.rewards.guaranteed})`;
            }
            
            // Battle pass tiers
            if (boss.rewards.battlePassTiers) {
                gameState.battlePassTier = Math.min(50, (gameState.battlePassTier || 0) + boss.rewards.battlePassTiers);
                rewardText += `<br>📊 +${boss.rewards.battlePassTiers} Battle Pass Tiers`;
            }
            
            // Random pet
            if (boss.rewards.randomPet) {
                const availablePetsNotOwned = availablePets.filter(p => !gameState.pets.includes(p.id));
                if (availablePetsNotOwned.length > 0) {
                    const randomPet = availablePetsNotOwned[Math.floor(Math.random() * availablePetsNotOwned.length)];
                    gameState.pets.push(randomPet.id);
                    gameState.petLevels[randomPet.id] = 1;
                    rewardText += `<br>🐉 ${randomPet.name}`;
                }
            }
            
            // Prestige points
            if (boss.rewards.prestigePoints) {
                gameState.prestigePoints = (gameState.prestigePoints || 0) + boss.rewards.prestigePoints;
                rewardText += `<br>⭐ +${boss.rewards.prestigePoints} Prestige Points`;
            }
            
            // Random artifact
            if (boss.rewards.randomArtifact) {
                const unownedArtifacts = artifactsData.filter(a => !gameState.artifacts || !gameState.artifacts.includes(a.id));
                if (unownedArtifacts.length > 0) {
                    const randomArtifact = unownedArtifacts[Math.floor(Math.random() * unownedArtifacts.length)];
                    if (!gameState.artifacts) gameState.artifacts = [];
                    gameState.artifacts.push(randomArtifact.id);
                    rewardText += `<br>💎 ${randomArtifact.name}`;
                    playSound('artifact');
                }
            }
            
            // Close modal and show rewards
            const modal = document.getElementById('bossFightModal');
            if (modal) {
                modal.innerHTML = `
                    <div style="background: var(--bg-dark); padding: 40px; border-radius: 15px; border: 3px solid var(--accent-gold); max-width: 600px; width: 90%; text-align: center; margin: auto;">
                        <div style="font-size: 8rem; margin-bottom: 20px;">🏆</div>
                        <h2 style="color: var(--accent-gold); margin-bottom: 20px;">VICTORY!</h2>
                        <div style="font-size: 1.2rem; color: var(--text-primary); margin-bottom: 30px;">
                            You defeated ${boss.name}!
                        </div>
                        <div style="background: var(--bg-medium); padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 15px; font-size: 1.1rem;">🎁 Rewards:</div>
                            <div style="color: var(--text-primary); line-height: 2; font-size: 1.1rem;">${rewardText}</div>
                        </div>
                        <button class="btn btn-accept" onclick="closeBossFight()" style="width: 100%; padding: 15px; font-size: 1.2rem;">
                            ✨ CLAIM REWARDS
                        </button>
                    </div>
                `;
            }
            
            updateStats();
            updateBossesDisplay();
            checkAchievements();
        }
        
        function closeBossFight() {
            const modal = document.getElementById('bossFightModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ===== ARTIFACTS SYSTEM =====
        
        const artifactsData = [
            // Tier 1 - Common ($1M)
            { id: 'lucky_coin', name: '🪙 Lucky Coin', tier: 1, cost: 1000000, bonus: { type: 'luck', value: 0.10 }, description: '+10% permanent luck' },
            { id: 'time_crystal', name: '⏱️ Time Crystal', tier: 1, cost: 1000000, bonus: { type: 'autoSpinSpeed', value: 1.5 }, description: 'Auto-spin 1.5x faster' },
            { id: 'extra_pouch', name: '📦 Extra Pouch', tier: 1, cost: 1000000, bonus: { type: 'inventorySlots', value: 25 }, description: '+25 inventory slots' },
            
            // Tier 2 - Rare ($5M)
            { id: 'loaded_dice', name: '🎲 Loaded Dice', tier: 2, cost: 5000000, bonus: { type: 'doubleSpin', value: 0.05 }, description: '5% chance for double spin' },
            { id: 'golden_goose', name: '💰 Golden Goose', tier: 2, cost: 5000000, bonus: { type: 'sellValue', value: 2 }, description: '2x sell value' },
            { id: 'skill_tome', name: '📚 Skill Tome', tier: 2, cost: 5000000, bonus: { type: 'xpGain', value: 2 }, description: '2x XP gain' },
            
            // Tier 3 - Epic ($25M)
            { id: 'royal_crown', name: '👑 Royal Crown', tier: 3, cost: 25000000, bonus: { type: 'allStats', value: 0.25 }, description: '+25% all stats' },
            { id: 'crystal_ball', name: '🔮 Crystal Ball', tier: 3, cost: 25000000, bonus: { type: 'seeNext', value: 1 }, description: 'See next spin rarity' },
            { id: 'philosophers_stone', name: '⚗️ Philosopher\'s Stone', tier: 3, cost: 25000000, bonus: { type: 'freeCrafting', value: 1 }, description: 'Free crafting forever' },
            
            // Tier 4 - Legendary ($100M)
            { id: 'wishing_star', name: '🌟 Wishing Star', tier: 4, cost: 100000000, bonus: { type: 'reSpinDaily', value: 1 }, description: 'Re-spin once per day' },
            { id: 'hourglass_ages', name: '⏳ Hourglass of Ages', tier: 4, cost: 100000000, bonus: { type: 'timeFreeze', value: 0.05 }, description: '5% chance for 10 free spins' },
            { id: 'eternal_diamond', name: '💎 Eternal Diamond', tier: 4, cost: 100000000, bonus: { type: 'noValueDecay', value: 1 }, description: 'Items never lose value' },
            
            // Tier 5 - Mythic (Boss Drops)
            { id: 'dragons_hoard', name: '🐉 Dragon\'s Hoard', tier: 5, cost: 0, bonus: { type: 'moneyMultiplier', value: 3 }, description: '3x money from all sources', bossOnly: true },
            { id: 'mask_of_fate', name: '🎭 Mask of Fate', tier: 5, cost: 0, bonus: { type: 'guaranteeNextTier', value: 1 }, description: 'Guarantee next rarity tier', bossOnly: true },
            { id: 'infinity_stone', name: '♾️ Infinity Stone', tier: 5, cost: 0, bonus: { type: 'bonusMultiplier', value: 0.50 }, description: 'All bonuses +50%', bossOnly: true }
        ];
        
        function initializeArtifactsState() {
            if (!gameState.artifacts) {
                gameState.artifacts = [];
            }
        }
        
        function updateArtifactsDisplay() {
            initializeArtifactsState();
            
            const container = document.getElementById('artifactsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Update stats
            document.getElementById('artifactsOwned').textContent = gameState.artifacts.length;
            const totalPower = calculateTotalArtifactPower();
            document.getElementById('totalArtifactPower').textContent = totalPower.toFixed(0) + '%';
            
            // Group by tier
            const tiers = [
                { name: 'Tier 1 - Common Artifacts', tier: 1, color: 'var(--rarity-common)' },
                { name: 'Tier 2 - Rare Artifacts', tier: 2, color: 'var(--rarity-rare)' },
                { name: 'Tier 3 - Epic Artifacts', tier: 3, color: 'var(--rarity-epic)' },
                { name: 'Tier 4 - Legendary Artifacts', tier: 4, color: 'var(--rarity-legendary)' },
                { name: 'Tier 5 - Mythic Artifacts (Boss Drops)', tier: 5, color: 'var(--rarity-mythic)' }
            ];
            
            tiers.forEach(tierInfo => {
                const tierArtifacts = artifactsData.filter(a => a.tier === tierInfo.tier);
                
                const tierSection = document.createElement('div');
                tierSection.style.marginBottom = '30px';
                
                const tierHeader = document.createElement('h3');
                tierHeader.style.color = tierInfo.color;
                tierHeader.style.marginBottom = '15px';
                tierHeader.textContent = tierInfo.name;
                tierSection.appendChild(tierHeader);
                
                const tierGrid = document.createElement('div');
                tierGrid.style.display = 'grid';
                tierGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
                tierGrid.style.gap = '15px';
                
                tierArtifacts.forEach(artifact => {
                    const owned = gameState.artifacts.includes(artifact.id);
                    const canBuy = !artifact.bossOnly && gameState.money >= artifact.cost && !owned;
                    
                    const card = document.createElement('div');
                    card.className = 'recipe-card';
                    card.style.border = owned ? `3px solid ${tierInfo.color}` : '2px solid var(--bg-medium)';
                    card.style.opacity = owned ? '1' : '0.7';
                    
                    card.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div style="font-size: 3rem;">${artifact.name.split(' ')[0]}</div>
                            <div style="flex: 1;">
                                <h4 style="color: ${tierInfo.color}; margin: 0 0 5px 0;">${artifact.name.substring(3)}</h4>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">${artifact.description}</div>
                            </div>
                        </div>
                        
                        ${!artifact.bossOnly ? `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-dark); border-radius: 8px; margin-bottom: 15px;">
                                <span style="color: var(--text-secondary);">Cost:</span>
                                <span style="color: var(--accent-gold); font-weight: bold; font-size: 1.1rem;">$${formatNumber(artifact.cost)}</span>
                            </div>
                        ` : `
                            <div style="padding: 12px; background: var(--danger)33; border-radius: 8px; margin-bottom: 15px; text-align: center; color: var(--danger);">
                                🏆 Boss Drop Only
                            </div>
                        `}
                        
                        ${owned ? `
                            <div style="text-align: center; padding: 15px; background: ${tierInfo.color}33; border-radius: 8px; color: ${tierInfo.color}; font-weight: bold;">
                                ✅ OWNED - Bonus Active!
                            </div>
                        ` : artifact.bossOnly ? `
                            <div style="text-align: center; padding: 15px; background: var(--bg-dark); border-radius: 8px; color: var(--text-secondary);">
                                Defeat bosses to unlock
                            </div>
                        ` : `
                            <button class="btn ${canBuy ? 'btn-accept' : 'btn-decline'}" 
                                    onclick="buyArtifact('${artifact.id}')" 
                                    ${!canBuy ? 'disabled' : ''}
                                    style="width: 100%; padding: 12px; ${!canBuy ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                ${!canBuy ? '🔒 Locked' : '💎 Purchase'}
                            </button>
                        `}
                    `;
                    
                    tierGrid.appendChild(card);
                });
                
                tierSection.appendChild(tierGrid);
                container.appendChild(tierSection);
            });
        }
        
        function buyArtifact(artifactId) {
            initializeArtifactsState();
            
            const artifact = artifactsData.find(a => a.id === artifactId);
            if (!artifact) return;
            
            if (artifact.bossOnly) {
                showNotification('❌ This artifact can only be obtained from boss drops!', 'var(--danger)');
                return;
            }
            
            if (gameState.artifacts.includes(artifactId)) {
                showNotification('✅ You already own this artifact!', 'var(--warning)');
                return;
            }
            
            if (gameState.money < artifact.cost) {
                showNotification(`❌ Need $${formatNumber(artifact.cost)} to purchase this artifact!`, 'var(--danger)');
                return;
            }
            
            // Purchase artifact
            gameState.money -= artifact.cost;
            gameState.artifacts.push(artifactId);
            
            playSound('artifact');
            showNotification(`💎 Artifact Acquired: ${artifact.name}!`, 'var(--accent-gold)');
            
            updateStats();
            updateArtifactsDisplay();
            checkAchievements();
        }
        
        function calculateTotalArtifactPower() {
            if (!gameState.artifacts || gameState.artifacts.length === 0) return 0;
            
            let totalPower = 0;
            gameState.artifacts.forEach(artifactId => {
                const artifact = artifactsData.find(a => a.id === artifactId);
                if (artifact) {
                    // Calculate "power" as a percentage
                    if (artifact.bonus.type === 'luck') totalPower += artifact.bonus.value * 100;
                    if (artifact.bonus.type === 'allStats') totalPower += artifact.bonus.value * 100;
                    if (artifact.bonus.type === 'sellValue') totalPower += (artifact.bonus.value - 1) * 100;
                    if (artifact.bonus.type === 'xpGain') totalPower += (artifact.bonus.value - 1) * 100;
                    if (artifact.bonus.type === 'moneyMultiplier') totalPower += (artifact.bonus.value - 1) * 100;
                    if (artifact.bonus.type === 'bonusMultiplier') totalPower += artifact.bonus.value * 100;
                    if (artifact.bonus.type === 'doubleSpin') totalPower += artifact.bonus.value * 100;
                    if (artifact.bonus.type === 'autoSpinSpeed') totalPower += (artifact.bonus.value - 1) * 50;
                    // Special artifacts count as 25 power
                    if (['seeNext', 'freeCrafting', 'reSpinDaily', 'guaranteeNextTier', 'noValueDecay', 'timeFreeze'].includes(artifact.bonus.type)) {
                        totalPower += 25;
                    }
                }
            });
            
            return totalPower;
        }
        
        function getArtifactBonus(bonusType) {
            if (!gameState.artifacts) return 0;
            
            let total = 0;
            gameState.artifacts.forEach(artifactId => {
                const artifact = artifactsData.find(a => a.id === artifactId);
                if (artifact && artifact.bonus.type === bonusType) {
                    total += artifact.bonus.value;
                }
            });
            
            return total;
        }
        
        function hasArtifact(artifactId) {
            return gameState.artifacts && gameState.artifacts.includes(artifactId);
        }
        
        // ===== DUNGEON EXPLORATION SYSTEM =====
        
        const dungeonsData = [
            {
                id: 'dark_forest',
                name: '🌲 Dark Forest',
                emoji: '🌲',
                description: 'A mysterious forest filled with ancient trees and hidden dangers',
                difficulty: 'Easy',
                color: '#228b22',
                unlockCost: 0,
                entryCost: 5000,
                duration: 30, // seconds
                minRarityIndex: 0, // Common
                maxRarityIndex: 7, // Celestial
                moneyReward: [10000, 50000],
                encounterChance: 0.6,
                treasureChance: 0.3,
                encounters: ['🐺 Wolf', '🕷️ Spider', '🦇 Bat', '🐍 Snake', '🧟 Zombie']
            },
            {
                id: 'crystal_caves',
                name: '💎 Crystal Caves',
                emoji: '💎',
                description: 'Sparkling caves with valuable crystals and territorial creatures',
                difficulty: 'Medium',
                color: '#4169e1',
                unlockCost: 50000,
                entryCost: 25000,
                duration: 45,
                minRarityIndex: 3, // Epic
                maxRarityIndex: 12, // Ethereal
                moneyReward: [50000, 200000],
                encounterChance: 0.7,
                treasureChance: 0.4,
                encounters: ['🦂 Crystal Scorpion', '⛏️ Corrupted Miner', '💎 Living Crystal', '🐉 Cave Drake', '👻 Lost Soul']
            },
            {
                id: 'ancient_ruins',
                name: '🏛️ Ancient Ruins',
                emoji: '🏛️',
                description: 'Crumbling ruins of a forgotten civilization, guarded by ancient magic',
                difficulty: 'Hard',
                color: '#8b4513',
                unlockCost: 250000,
                entryCost: 100000,
                duration: 60,
                minRarityIndex: 8, // Divine
                maxRarityIndex: 18, // Multiversal
                moneyReward: [200000, 1000000],
                encounterChance: 0.75,
                treasureChance: 0.5,
                encounters: ['⚔️ Ancient Guardian', '📜 Cursed Scroll', '🗿 Stone Golem', '👻 Spectral Warrior', '🔮 Rune Keeper']
            },
            {
                id: 'volcanic_depths',
                name: '🌋 Volcanic Depths',
                emoji: '🌋',
                description: 'Scorching depths of an active volcano, home to fire elementals',
                difficulty: 'Very Hard',
                color: '#ff4500',
                unlockCost: 1000000,
                entryCost: 500000,
                duration: 75,
                minRarityIndex: 13, // Primordial
                maxRarityIndex: 25, // Boundless
                moneyReward: [1000000, 5000000],
                encounterChance: 0.8,
                treasureChance: 0.6,
                encounters: ['🔥 Fire Elemental', '🐉 Magma Dragon', '⚒️ Lava Titan', '💀 Inferno Demon', '🌋 Volcanic Beast']
            },
            {
                id: 'frozen_citadel',
                name: '❄️ Frozen Citadel',
                emoji: '❄️',
                description: 'An icy fortress frozen in time, protected by frost magic',
                difficulty: 'Extreme',
                color: '#00bfff',
                unlockCost: 5000000,
                entryCost: 2500000,
                duration: 90,
                minRarityIndex: 20, // Infinite Absolute
                maxRarityIndex: 32, // Impossible
                moneyReward: [5000000, 25000000],
                encounterChance: 0.85,
                treasureChance: 0.7,
                encounters: ['❄️ Ice Elemental', '🧊 Frost Giant', '⛄ Frozen Guardian', '🐺 Winter Wolf', '👑 Ice Queen']
            },
            {
                id: 'shadow_realm',
                name: '🌑 Shadow Realm',
                emoji: '🌑',
                description: 'A dark dimension where shadows come to life',
                difficulty: 'Master',
                color: '#4b0082',
                unlockCost: 25000000,
                entryCost: 10000000,
                duration: 120,
                minRarityIndex: 27, // Admin
                maxRarityIndex: 40, // True Infinity
                moneyReward: [25000000, 100000000],
                encounterChance: 0.9,
                treasureChance: 0.75,
                encounters: ['🌑 Shadow Beast', '👤 Dark Doppelganger', '🕳️ Void Entity', '💀 Death Knight', '👁️ Eye of Darkness']
            },
            {
                id: 'celestial_tower',
                name: '🌟 Celestial Tower',
                emoji: '🌟',
                description: 'A tower that reaches into the heavens, home to angelic guardians',
                difficulty: 'Legendary',
                color: '#ffd700',
                unlockCost: 100000000,
                entryCost: 50000000,
                duration: 150,
                minRarityIndex: 35, // Void
                maxRarityIndex: 48, // Outerversal
                moneyReward: [100000000, 500000000],
                encounterChance: 0.95,
                treasureChance: 0.8,
                encounters: ['👼 Fallen Angel', '⚡ Lightning Elemental', '🌟 Star Guardian', '🔱 Divine Sentinel', '☁️ Cloud Titan']
            },
            {
                id: 'abyss',
                name: '⚫ The Abyss',
                emoji: '⚫',
                description: 'An endless void where reality breaks down',
                difficulty: 'Mythic',
                color: '#000000',
                unlockCost: 500000000,
                entryCost: 250000000,
                duration: 180,
                minRarityIndex: 42, // Primeval
                maxRarityIndex: 53, // Metaphysical
                moneyReward: [500000000, 2000000000],
                encounterChance: 1.0,
                treasureChance: 0.85,
                encounters: ['⚫ Abyss Spawn', '🌀 Void Dragon', '💀 Eldritch Horror', '🕳️ Reality Tear', '👁️ Cosmic Eye']
            },
            {
                id: 'infinity_nexus',
                name: '♾️ Infinity Nexus',
                emoji: '♾️',
                description: 'The center of all existence, where infinite possibilities converge',
                difficulty: 'Impossible',
                color: '#ffffff',
                unlockCost: 2000000000,
                entryCost: 1000000000,
                duration: 240,
                minRarityIndex: 50, // Abstract
                maxRarityIndex: 57, // Beyond Infinity
                moneyReward: [2000000000, 10000000000],
                encounterChance: 1.0,
                treasureChance: 0.9,
                encounters: ['♾️ Infinite Being', '🌌 Galaxy Devourer', '⚛️ Quantum Entity', '🔮 Omniscient Orb', '👁️ All-Seeing Eye']
            },
            {
                id: 'primordial_void',
                name: '🌌 Primordial Void',
                emoji: '🌌',
                description: 'The birthplace of creation itself, before time began',
                difficulty: 'ULTIMATE',
                color: '#8a2be2',
                unlockCost: 10000000000,
                entryCost: 5000000000,
                duration: 300,
                minRarityIndex: 54, // The Source
                maxRarityIndex: 57, // Beyond Infinity
                moneyReward: [10000000000, 50000000000],
                encounterChance: 1.0,
                treasureChance: 1.0,
                encounters: ['🌌 Primordial Entity', '✨ Creation Itself', '⚡ Big Bang', '🕳️ The First Void', '👁️ The Watcher']
            }
        ];
        
        function initializeDungeonState() {
            if (!gameState.dungeons) {
                gameState.dungeons = {
                    unlocked: ['dark_forest'], // First dungeon unlocked by default
                    stats: {
                        cleared: 0,
                        enemiesDefeated: 0,
                        treasureFound: 0,
                        totalLoot: 0
                    },
                    activeExpedition: null,
                    cooldowns: {}
                };
            }
        }
        
        function updateDungeonsDisplay() {
            initializeDungeonState();
            
            const container = document.getElementById('dungeonsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Update stats
            document.getElementById('dungeonsCleared').textContent = gameState.dungeons.stats.cleared || 0;
            document.getElementById('enemiesDefeated').textContent = gameState.dungeons.stats.enemiesDefeated || 0;
            document.getElementById('treasureFound').textContent = gameState.dungeons.stats.treasureFound || 0;
            document.getElementById('totalDungeonLoot').textContent = formatNumber(gameState.dungeons.stats.totalLoot || 0);
            
            dungeonsData.forEach(dungeon => {
                const isUnlocked = gameState.dungeons.unlocked.includes(dungeon.id);
                const canAffordUnlock = gameState.money >= dungeon.unlockCost;
                const canAffordEntry = gameState.money >= dungeon.entryCost;
                const onCooldown = gameState.dungeons.cooldowns[dungeon.id] && (Date.now() - gameState.dungeons.cooldowns[dungeon.id]) < 300000; // 5 min cooldown
                
                const card = document.createElement('div');
                card.className = 'recipe-card';
                card.style.border = `3px solid ${dungeon.color}`;
                card.style.opacity = isUnlocked ? '1' : '0.6';
                card.style.background = `linear-gradient(135deg, var(--bg-medium), ${dungeon.color}22)`;
                
                const minRarity = rarities[dungeon.minRarityIndex];
                const maxRarity = rarities[dungeon.maxRarityIndex];
                
                card.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 10px;">${dungeon.emoji}</div>
                        <h3 style="color: ${dungeon.color}; margin: 10px 0;">${dungeon.name}</h3>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">${dungeon.description}</div>
                        <div style="display: inline-block; padding: 4px 12px; background: ${dungeon.color}33; border-radius: 12px; font-size: 0.85rem; font-weight: bold; color: ${dungeon.color}; margin: 5px 0;">
                            ${dungeon.difficulty}
                        </div>
                    </div>
                    
                    ${isUnlocked ? `
                        <div style="margin: 15px 0; padding: 15px; background: var(--bg-dark); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary);">⏱️ Duration:</span>
                                <span style="color: var(--accent-primary); font-weight: bold;">${dungeon.duration}s</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary);">💰 Entry Cost:</span>
                                <span style="color: var(--accent-gold); font-weight: bold;">$${formatNumber(dungeon.entryCost)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary);">🎁 Money Reward:</span>
                                <span style="color: var(--success); font-weight: bold;">$${formatNumber(dungeon.moneyReward[0])} - $${formatNumber(dungeon.moneyReward[1])}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">✨ Loot Range:</span>
                                <span style="font-weight: bold;">
                                    <span style="color: ${minRarity.color};">${minRarity.name}</span> → <span style="color: ${maxRarity.color};">${maxRarity.name}</span>
                                </span>
                            </div>
                        </div>
                        
                        <div style="background: var(--bg-dark); padding: 12px; border-radius: 8px; margin: 15px 0;">
                            <div style="color: var(--warning); font-weight: bold; margin-bottom: 8px;">⚠️ Encounter Rate: ${Math.round(dungeon.encounterChance * 100)}%</div>
                            <div style="color: var(--accent-gold); font-weight: bold;">💎 Treasure Rate: ${Math.round(dungeon.treasureChance * 100)}%</div>
                        </div>
                        
                        ${onCooldown ? `
                            <div style="text-align: center; padding: 10px; background: var(--warning)33; border-radius: 8px; color: var(--warning); margin-bottom: 10px;">
                                ⏰ On Cooldown (5 min)
                            </div>
                        ` : ''}
                        
                        <button class="btn ${canAffordEntry && !onCooldown && !gameState.dungeons.activeExpedition ? 'btn-accept' : 'btn-decline'}" 
                                onclick="startDungeonExpedition('${dungeon.id}')" 
                                ${!canAffordEntry || onCooldown || gameState.dungeons.activeExpedition ? 'disabled' : ''}
                                style="width: 100%; padding: 15px; font-size: 1.1rem; ${!canAffordEntry || onCooldown || gameState.dungeons.activeExpedition ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            ${!canAffordEntry ? '❌ Not Enough Money' : onCooldown ? '⏰ On Cooldown' : gameState.dungeons.activeExpedition ? '🎯 Expedition Active' : '⚔️ START EXPEDITION'}
                        </button>
                    ` : `
                        <div style="margin: 15px 0; padding: 15px; background: var(--bg-dark); border-radius: 8px; text-align: center;">
                            <div style="color: var(--warning); font-weight: bold; margin-bottom: 10px;">🔒 LOCKED</div>
                            <div style="color: var(--text-secondary); margin-bottom: 10px;">Unlock Cost: $${formatNumber(dungeon.unlockCost)}</div>
                            <button class="btn ${canAffordUnlock ? 'btn-accept' : 'btn-decline'}" 
                                    onclick="unlockDungeon('${dungeon.id}')" 
                                    ${!canAffordUnlock ? 'disabled' : ''}
                                    style="width: 100%; padding: 12px; ${!canAffordUnlock ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                ${canAffordUnlock ? '🔓 UNLOCK DUNGEON' : '❌ Not Enough Money'}
                            </button>
                        </div>
                    `}
                `;
                
                container.appendChild(card);
            });
        }
        
        function unlockDungeon(dungeonId) {
            initializeDungeonState();
            
            const dungeon = dungeonsData.find(d => d.id === dungeonId);
            if (!dungeon) return;
            
            if (gameState.money < dungeon.unlockCost) {
                showNotification('❌ Not enough money to unlock!', 'var(--danger)');
                return;
            }
            
            if (gameState.dungeons.unlocked.includes(dungeonId)) {
                showNotification('⚠️ Dungeon already unlocked!', 'var(--warning)');
                return;
            }
            
            gameState.money -= dungeon.unlockCost;
            gameState.dungeons.unlocked.push(dungeonId);
            
            updateStats();
            updateDungeonsDisplay();
            
            showNotification(`🗺️ ${dungeon.name} unlocked!`, dungeon.color);
            playSound('achievement');
        }
        
        function startDungeonExpedition(dungeonId) {
            initializeDungeonState();
            
            const dungeon = dungeonsData.find(d => d.id === dungeonId);
            if (!dungeon) return;
            
            // Check if already on expedition
            if (gameState.dungeons.activeExpedition) {
                showNotification('⚠️ Already on an expedition!', 'var(--warning)');
                return;
            }
            
            // Check cooldown
            if (gameState.dungeons.cooldowns[dungeonId] && (Date.now() - gameState.dungeons.cooldowns[dungeonId]) < 300000) {
                showNotification('⏰ Dungeon is on cooldown!', 'var(--warning)');
                return;
            }
            
            // Check money
            if (gameState.money < dungeon.entryCost) {
                showNotification('❌ Not enough money for entry!', 'var(--danger)');
                return;
            }
            
            // Pay entry cost
            gameState.money -= dungeon.entryCost;
            updateStats();
            
            // Start expedition
            gameState.dungeons.activeExpedition = {
                dungeonId: dungeonId,
                startTime: Date.now(),
                duration: dungeon.duration * 1000,
                encounters: [],
                treasures: [],
                progress: 0
            };
            
            // Show expedition UI
            showActiveExpedition();
            updateDungeonsDisplay();
            
            // Start expedition progress
            runDungeonExpedition(dungeon);
            
            showNotification(`⚔️ Entering ${dungeon.name}!`, dungeon.color);
            playSound('boss_appear');
        }
        
        function showActiveExpedition() {
            const expeditionDiv = document.getElementById('activeExpedition');
            if (!expeditionDiv) return;
            
            expeditionDiv.style.display = 'block';
            updateExpeditionDisplay();
        }
        
        function hideActiveExpedition() {
            const expeditionDiv = document.getElementById('activeExpedition');
            if (expeditionDiv) {
                expeditionDiv.style.display = 'none';
            }
        }
        
        function updateExpeditionDisplay() {
            if (!gameState.dungeons.activeExpedition) {
                hideActiveExpedition();
                return;
            }
            
            const expedition = gameState.dungeons.activeExpedition;
            const dungeon = dungeonsData.find(d => d.id === expedition.dungeonId);
            if (!dungeon) return;
            
            const elapsed = Date.now() - expedition.startTime;
            const progress = Math.min(100, (elapsed / expedition.duration) * 100);
            const timeLeft = Math.max(0, Math.ceil((expedition.duration - elapsed) / 1000));
            
            const content = document.getElementById('expeditionContent');
            if (!content) return;
            
            content.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: ${dungeon.color}; font-weight: bold; font-size: 1.2rem;">${dungeon.emoji} ${dungeon.name}</span>
                        <span style="color: var(--accent-gold); font-weight: bold;">⏱️ ${timeLeft}s</span>
                    </div>
                    <div class="progress-bar" style="height: 25px;">
                        <div class="progress-fill" style="width: ${progress}%; background: linear-gradient(90deg, ${dungeon.color}, var(--success));">
                            <span style="font-weight: bold;">${Math.round(progress)}%</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="background: var(--bg-medium); padding: 10px; border-radius: 8px;">
                        <div style="color: var(--danger); font-weight: bold; margin-bottom: 5px;">⚔️ Encounters</div>
                        <div style="color: var(--text-primary); font-size: 1.4rem; font-weight: bold;">${expedition.encounters.length}</div>
                    </div>
                    <div style="background: var(--bg-medium); padding: 10px; border-radius: 8px;">
                        <div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 5px;">💎 Treasures</div>
                        <div style="color: var(--text-primary); font-size: 1.4rem; font-weight: bold;">${expedition.treasures.length}</div>
                    </div>
                </div>
                
                ${expedition.encounters.length > 0 ? `
                    <div style="margin-top: 15px; padding: 10px; background: var(--danger)22; border-radius: 8px; border-left: 4px solid var(--danger);">
                        <div style="color: var(--danger); font-weight: bold; margin-bottom: 5px;">⚔️ Recent Encounter:</div>
                        <div style="color: var(--text-secondary);">${expedition.encounters[expedition.encounters.length - 1]}</div>
                    </div>
                ` : ''}
                
                ${expedition.treasures.length > 0 ? `
                    <div style="margin-top: 15px; padding: 10px; background: var(--accent-gold)22; border-radius: 8px; border-left: 4px solid var(--accent-gold);">
                        <div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 5px;">💎 Recent Treasure:</div>
                        <div>${expedition.treasures[expedition.treasures.length - 1]}</div>
                    </div>
                ` : ''}
            `;
        }
        
        function runDungeonExpedition(dungeon) {
            const expedition = gameState.dungeons.activeExpedition;
            if (!expedition) return;
            
            const updateInterval = 3000; // Check every 3 seconds
            const totalUpdates = Math.floor(dungeon.duration * 1000 / updateInterval);
            let currentUpdate = 0;
            
            const expeditionTimer = setInterval(() => {
                if (!gameState.dungeons.activeExpedition || gameState.dungeons.activeExpedition.dungeonId !== dungeon.id) {
                    clearInterval(expeditionTimer);
                    return;
                }
                
                currentUpdate++;
                
                // Random encounter
                if (Math.random() < dungeon.encounterChance) {
                    const encounter = dungeon.encounters[Math.floor(Math.random() * dungeon.encounters.length)];
                    expedition.encounters.push(encounter);
                    showNotification(`⚔️ Encountered: ${encounter}!`, 'var(--danger)');
                    playSound('boss_hit');
                    gameState.dungeons.stats.enemiesDefeated++;
                }
                
                // Random treasure
                if (Math.random() < dungeon.treasureChance) {
                    const rarityIndex = Math.floor(Math.random() * (dungeon.maxRarityIndex - dungeon.minRarityIndex + 1)) + dungeon.minRarityIndex;
                    const rarity = rarities[rarityIndex];
                    const itemName = generateItemName(rarity);
                    
                    expedition.treasures.push(`<span style="color: ${rarity.color};">${itemName}</span>`);
                    addItemToInventory(itemName, rarity);
                    
                    showNotification(`💎 Found treasure: ${itemName}!`, rarity.color);
                    playSound('rare');
                    gameState.dungeons.stats.treasureFound++;
                }
                
                updateExpeditionDisplay();
                
                // Check if complete
                if (currentUpdate >= totalUpdates || Date.now() >= expedition.startTime + expedition.duration) {
                    clearInterval(expeditionTimer);
                    completeDungeonExpedition(dungeon);
                }
            }, updateInterval);
        }
        
        function completeDungeonExpedition(dungeon) {
            const expedition = gameState.dungeons.activeExpedition;
            if (!expedition) return;
            
            // Calculate rewards
            const moneyReward = Math.floor(Math.random() * (dungeon.moneyReward[1] - dungeon.moneyReward[0])) + dungeon.moneyReward[0];
            gameState.money += moneyReward;
            
            // Update stats
            gameState.dungeons.stats.cleared++;
            gameState.dungeons.stats.totalLoot += moneyReward;
            
            // Set cooldown
            gameState.dungeons.cooldowns[dungeon.id] = Date.now();
            
            // Show completion notification
            showCenterNotification(
                `🎉 ${dungeon.name} Completed!
                
💰 Money: $${formatNumber(moneyReward)}
⚔️ Encounters: ${expedition.encounters.length}
💎 Treasures: ${expedition.treasures.length}`,
                dungeon.color,
                8000
            );
            
            playSound('boss_defeated');
            
            // Clear expedition
            gameState.dungeons.activeExpedition = null;
            
            // Update displays
            updateStats();
            updateInventory();
            updateDungeonsDisplay();
            hideActiveExpedition();
        }
        
        // ===== POTIONS SYSTEM =====
        
        const potionsData = [
            // LUCK POTIONS
            { id: 'minor_luck', name: '🍀 Minor Luck Potion', category: 'Luck', cost: 10000, duration: 300000, effect: { type: 'luck', value: 1.5 }, color: '#90EE90', description: 'Increases luck by 1.5x for 5 minutes' },
            { id: 'luck_brew', name: '✨ Luck Brew', category: 'Luck', cost: 50000, duration: 600000, effect: { type: 'luck', value: 2.0 }, color: '#FFD700', description: 'Increases luck by 2x for 10 minutes' },
            { id: 'major_luck', name: '🌟 Major Luck Potion', category: 'Luck', cost: 250000, duration: 900000, effect: { type: 'luck', value: 3.0 }, color: '#FFA500', description: 'Increases luck by 3x for 15 minutes' },
            { id: 'supreme_luck', name: '⭐ Supreme Luck Elixir', category: 'Luck', cost: 5000000, duration: 1800000, effect: { type: 'luck', value: 5.0 }, color: '#FF1493', description: 'Increases luck by 5x for 30 minutes' },
            { id: 'divine_fortune', name: '👑 Divine Fortune', category: 'Luck', cost: 50000000, duration: 3600000, effect: { type: 'luck', value: 10.0 }, color: '#8A2BE2', description: 'Increases luck by 10x for 1 hour!' },
            
            // MONEY POTIONS
            { id: 'coin_doubler', name: '💰 Coin Doubler', category: 'Money', cost: 25000, duration: 300000, effect: { type: 'money', value: 2.0 }, color: '#FFD700', description: 'Doubles all money gains for 5 minutes' },
            { id: 'wealth_potion', name: '💵 Wealth Potion', category: 'Money', cost: 100000, duration: 600000, effect: { type: 'money', value: 3.0 }, color: '#00FF00', description: 'Triples money gains for 10 minutes' },
            { id: 'money_multiplier', name: '💸 Money Multiplier', category: 'Money', cost: 1000000, duration: 1800000, effect: { type: 'money', value: 5.0 }, color: '#32CD32', description: '5x money gains for 30 minutes' },
            { id: 'golden_elixir', name: '🏆 Golden Elixir', category: 'Money', cost: 25000000, duration: 3600000, effect: { type: 'money', value: 10.0 }, color: '#FFD700', description: '10x money gains for 1 hour!' },
            
            // SPEED POTIONS
            { id: 'haste_potion', name: '⚡ Haste Potion', category: 'Speed', cost: 15000, duration: 300000, effect: { type: 'speed', value: 2.0 }, color: '#00FFFF', description: 'Doubles spin speed for 5 minutes' },
            { id: 'swift_brew', name: '💨 Swift Brew', category: 'Speed', cost: 75000, duration: 900000, effect: { type: 'speed', value: 3.0 }, color: '#87CEEB', description: '3x spin speed for 15 minutes' },
            { id: 'time_warp', name: '⏰ Time Warp Potion', category: 'Speed', cost: 2000000, duration: 1800000, effect: { type: 'speed', value: 5.0 }, color: '#4169E1', description: '5x spin speed for 30 minutes' },
            
            // VALUE POTIONS
            { id: 'value_boost', name: '💎 Value Boost', category: 'Value', cost: 50000, duration: 600000, effect: { type: 'value', value: 2.0 }, color: '#FF69B4', description: 'Doubles item values for 10 minutes' },
            { id: 'treasure_finder', name: '🔍 Treasure Finder', category: 'Value', cost: 500000, duration: 1800000, effect: { type: 'value', value: 3.0 }, color: '#DA70D6', description: '3x item values for 30 minutes' },
            
            // XP POTIONS
            { id: 'xp_boost', name: '📈 XP Boost', category: 'XP', cost: 30000, duration: 600000, effect: { type: 'xp', value: 2.0 }, color: '#9370DB', description: 'Doubles XP gains for 10 minutes' },
            { id: 'wisdom_potion', name: '🧠 Wisdom Potion', category: 'XP', cost: 200000, duration: 1800000, effect: { type: 'xp', value: 3.0 }, color: '#BA55D3', description: '3x XP gains for 30 minutes' },
            
            // POWER POTIONS (Multiple effects)
            { id: 'power_surge', name: '⚡ Power Surge', category: 'Power', cost: 500000, duration: 600000, effect: { type: 'multi', values: { luck: 2.0, money: 2.0, speed: 2.0 } }, color: '#FF4500', description: '2x Luck, Money, and Speed for 10 min' },
            { id: 'omnipotent_elixir', name: '🌌 Omnipotent Elixir', category: 'Power', cost: 10000000, duration: 1800000, effect: { type: 'multi', values: { luck: 3.0, money: 3.0, value: 3.0, speed: 3.0 } }, color: '#FF00FF', description: '3x ALL STATS for 30 minutes!' },
            { id: 'godlike_brew', name: '👁️ Godlike Brew', category: 'Power', cost: 100000000, duration: 3600000, effect: { type: 'multi', values: { luck: 5.0, money: 5.0, value: 5.0, speed: 5.0, xp: 5.0 } }, color: '#FFD700', description: '5x EVERYTHING for 1 HOUR!!!' },
            
            // SPECIAL POTIONS
            { id: 'time_extension', name: '⏳ Time Extension', category: 'Special', cost: 5000000, duration: 0, effect: { type: 'extend', value: 2.0 }, color: '#40E0D0', description: 'Doubles duration of all active potions' },
            { id: 'pity_reset', name: '🎰 Pity Reset Potion', category: 'Special', cost: 1000000, duration: 0, effect: { type: 'pity_reset', value: 1 }, color: '#FF6347', description: 'Resets pity counter to 0 (instant rare!)' },
            { id: 'dungeon_cooldown', name: '🗺️ Cooldown Clear', category: 'Special', cost: 10000000, duration: 0, effect: { type: 'cooldown_clear', value: 1 }, color: '#20B2AA', description: 'Clears all dungeon cooldowns' },
            { id: 'boss_refresh', name: '👹 Boss Refresh', category: 'Special', cost: 15000000, duration: 0, effect: { type: 'boss_refresh', value: 1 }, color: '#DC143C', description: 'Clears all boss cooldowns' },
            { id: 'guaranteed_admin', name: '🔴 Admin Guarantee', category: 'Special', cost: 500000000, duration: 60000, effect: { type: 'guaranteed_rarity', value: 27 }, color: '#FF0000', description: 'Next spin guaranteed Admin rarity!' },
            { id: 'infinity_potion', name: '♾️ Infinity Potion', category: 'Ultimate', cost: 10000000000, duration: 7200000, effect: { type: 'multi', values: { luck: 20.0, money: 20.0, value: 20.0, speed: 10.0, xp: 10.0 } }, color: '#FFFFFF', description: 'ULTIMATE POWER: 20x everything for 2 HOURS!' }
        ];
        
        function initializePotionsState() {
            if (!gameState.potions) {
                gameState.potions = {
                    owned: [],
                    active: [],
                    consumed: 0
                };
            }
            if (gameState.potionsUnlocked === undefined) {
                // Check if unlock date has passed
                const unlockDate = new Date('2025-12-12T00:00:00');
                const now = new Date();
                gameState.potionsUnlocked = now >= unlockDate;
            }
        }
        
        function checkPotionsUnlockDate() {
            const unlockDate = new Date('2025-12-12T00:00:00');
            const now = new Date();
            
            if (now >= unlockDate && !gameState.potionsUnlocked) {
                gameState.potionsUnlocked = true;
                showCenterNotification('🧪 POTIONS SYSTEM UNLOCKED! 🧪', 'var(--accent-primary)', 5000);
                playSound('achievement');
            }
            
            // Update countdown
            if (!gameState.potionsUnlocked) {
                const timeLeft = unlockDate - now;
                if (timeLeft > 0) {
                    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    
                    const countdownEl = document.getElementById('potionsCountdown');
                    if (countdownEl) {
                        countdownEl.textContent = `⏰ ${days}d ${hours}h ${minutes}m ${seconds}s`;
                    }
                }
            }
        }
        
        function updatePotionsDisplay() {
            initializePotionsState();
            
            const lockedMsg = document.getElementById('potionsLockedMessage');
            const unlockedContent = document.getElementById('potionsUnlockedContent');
            
            if (!lockedMsg || !unlockedContent) return;
            
            if (gameState.potionsUnlocked) {
                lockedMsg.style.display = 'none';
                unlockedContent.style.display = 'block';
                
                // Update stats
                document.getElementById('potionsOwned').textContent = gameState.potions.owned.length;
                document.getElementById('activeEffects').textContent = gameState.potions.active.length;
                document.getElementById('potionsConsumed').textContent = gameState.potions.consumed;
                
                // Update active potions display
                updateActivePotionsDisplay();
                
                // Render potions
                const container = document.getElementById('potionsContainer');
                if (!container) return;
                container.innerHTML = '';
                
                // Group by category
                const categories = ['Luck', 'Money', 'Speed', 'Value', 'XP', 'Power', 'Special', 'Ultimate'];
                
                categories.forEach(category => {
                    const categoryPotions = potionsData.filter(p => p.category === category);
                    if (categoryPotions.length === 0) return;
                    
                    const categoryDiv = document.createElement('div');
                    categoryDiv.style.marginBottom = '30px';
                    categoryDiv.style.gridColumn = '1 / -1';
                    
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.style.color = 'var(--accent-primary)';
                    categoryHeader.style.marginBottom = '15px';
                    categoryHeader.textContent = `${category} Potions`;
                    categoryDiv.appendChild(categoryHeader);
                    
                    const grid = document.createElement('div');
                    grid.style.display = 'grid';
                    grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(350px, 1fr))';
                    grid.style.gap = '15px';
                    
                    categoryPotions.forEach(potion => {
                        const isActive = gameState.potions.active.some(p => p.id === potion.id);
                        const canAfford = gameState.money >= potion.cost;
                        
                        const card = document.createElement('div');
                        card.className = 'recipe-card';
                        card.style.border = `3px solid ${potion.color}`;
                        card.style.background = `linear-gradient(135deg, var(--bg-medium), ${potion.color}22)`;
                        
                        const durationText = potion.duration === 0 ? 'Instant' : 
                                           potion.duration < 60000 ? `${potion.duration/1000}s` :
                                           potion.duration < 3600000 ? `${potion.duration/60000}min` :
                                           `${potion.duration/3600000}hr`;
                        
                        card.innerHTML = `
                            <div style="text-align: center; margin-bottom: 15px;">
                                <div style="font-size: 3rem; margin-bottom: 10px;">${potion.name.split(' ')[0]}</div>
                                <h3 style="color: ${potion.color}; margin: 10px 0;">${potion.name.substring(3)}</h3>
                                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">${potion.description}</div>
                                <div style="display: inline-block; padding: 4px 12px; background: ${potion.color}33; border-radius: 12px; font-size: 0.85rem; font-weight: bold; color: ${potion.color};">
                                    ${category}
                                </div>
                            </div>
                            
                            <div style="background: var(--bg-dark); padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary);">💰 Cost:</span>
                                    <span style="color: var(--accent-gold); font-weight: bold;">$${formatNumber(potion.cost)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">⏱️ Duration:</span>
                                    <span style="color: var(--accent-primary); font-weight: bold;">${durationText}</span>
                                </div>
                            </div>
                            
                            ${isActive ? `
                                <div style="text-align: center; padding: 15px; background: ${potion.color}33; border-radius: 8px; color: ${potion.color}; font-weight: bold; margin-bottom: 10px;">
                                    ✅ ACTIVE
                                </div>
                            ` : ''}
                            
                            <button class="btn ${canAfford ? 'btn-accept' : 'btn-decline'}" 
                                    onclick="buyAndUsePotion('${potion.id}')" 
                                    ${!canAfford || isActive ? 'disabled' : ''}
                                    style="width: 100%; padding: 15px; font-size: 1.1rem; ${!canAfford || isActive ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                ${isActive ? '⏳ Active' : !canAfford ? '❌ Too Expensive' : '🧪 USE POTION'}
                            </button>
                        `;
                        
                        grid.appendChild(card);
                    });
                    
                    categoryDiv.appendChild(grid);
                    container.appendChild(categoryDiv);
                });
            } else {
                lockedMsg.style.display = 'block';
                unlockedContent.style.display = 'none';
            }
        }
        
        function buyAndUsePotion(potionId) {
            initializePotionsState();
            
            const potion = potionsData.find(p => p.id === potionId);
            if (!potion) return;
            
            // Check if already active
            if (gameState.potions.active.some(p => p.id === potionId)) {
                showNotification('⚠️ This potion is already active!', 'var(--warning)');
                return;
            }
            
            // Check money
            if (gameState.money < potion.cost) {
                showNotification('❌ Not enough money!', 'var(--danger)');
                return;
            }
            
            // Pay cost
            gameState.money -= potion.cost;
            gameState.lifetimeMoneySpent += potion.cost;
            
            // Apply effect
            applyPotionEffect(potion);
            
            // Track
            gameState.potions.consumed++;
            
            // Update
            updateStats();
            updatePotionsDisplay();
            
            showNotification(`🧪 Used ${potion.name}!`, potion.color);
            playSound('success');
        }
        
        function applyPotionEffect(potion) {
            if (potion.effect.type === 'extend') {
                // Time extension - doubles all active potion durations
                gameState.potions.active.forEach(active => {
                    const remaining = active.endTime - Date.now();
                    active.endTime = Date.now() + (remaining * 2);
                });
                showNotification('⏳ All potion durations doubled!', potion.color);
                updateActivePotionsDisplay();
            } else if (potion.effect.type === 'pity_reset') {
                gameState.pityCounter = 0;
                showNotification('🎰 Pity counter reset! Next rare incoming!', potion.color);
            } else if (potion.effect.type === 'cooldown_clear') {
                if (gameState.dungeons) {
                    gameState.dungeons.cooldowns = {};
                }
                showNotification('🗺️ All dungeon cooldowns cleared!', potion.color);
                updateDungeonsDisplay();
            } else if (potion.effect.type === 'boss_refresh') {
                if (gameState.bosses) {
                    Object.keys(gameState.bosses).forEach(key => {
                        gameState.bosses[key].lastFought = 0;
                    });
                }
                showNotification('👹 All boss cooldowns cleared!', potion.color);
                updateBossesDisplay();
            } else if (potion.effect.type === 'guaranteed_rarity') {
                // Set next spin to guaranteed rarity
                gameState.guaranteedNextRarity = potion.effect.value;
                setTimeout(() => {
                    delete gameState.guaranteedNextRarity;
                }, potion.duration);
                showNotification('🔴 Next spin GUARANTEED Admin!', potion.color);
            } else if (potion.duration > 0) {
                // Add to active potions
                gameState.potions.active.push({
                    id: potion.id,
                    startTime: Date.now(),
                    endTime: Date.now() + potion.duration,
                    effect: potion.effect
                });
                
                // Apply bonuses immediately
                applyPotionBonuses();
            }
        }
        
        function applyPotionBonuses() {
            // Recalculate all bonuses from active potions
            updateEventBonuses();
        }
        
        function updateActivePotionsDisplay() {
            const container = document.getElementById('activePotionsDisplay');
            if (!container) return;
            
            if (gameState.potions.active.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '<h3 style="color: var(--success); margin-bottom: 15px;">⚡ Active Potions</h3>';
            
            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
            grid.style.gap = '15px';
            
            gameState.potions.active.forEach(active => {
                const potion = potionsData.find(p => p.id === active.id);
                if (!potion) return;
                
                const timeLeft = Math.max(0, active.endTime - Date.now());
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                
                const card = document.createElement('div');
                card.style.background = `linear-gradient(135deg, ${potion.color}22, var(--bg-dark))`;
                card.style.padding = '15px';
                card.style.borderRadius = '8px';
                card.style.border = `2px solid ${potion.color}`;
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: bold; color: ${potion.color};">${potion.name}</span>
                        <span style="color: var(--success); font-weight: bold;">${minutes}:${seconds.toString().padStart(2, '0')}</span>
                    </div>
                    <div class="progress-bar" style="height: 8px;">
                        <div class="progress-fill" style="width: ${(timeLeft / potion.duration) * 100}%; background: ${potion.color};"></div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            container.appendChild(grid);
        }
        
        function checkPotionExpiry() {
            if (!gameState.potions) return;
            
            const now = Date.now();
            const expired = [];
            
            gameState.potions.active = gameState.potions.active.filter(potion => {
                if (potion.endTime <= now) {
                    expired.push(potion);
                    return false;
                }
                return true;
            });
            
            if (expired.length > 0) {
                expired.forEach(exp => {
                    const potion = potionsData.find(p => p.id === exp.id);
                    if (potion) {
                        showNotification(`⏰ ${potion.name} expired!`, 'var(--warning)');
                    }
                });
                
                // Recalculate bonuses
                applyPotionBonuses();
                updateActivePotionsDisplay();
                updatePotionsDisplay();
            }
        }
        
        function getPotionBonus(type) {
            if (!gameState.potions || !gameState.potions.active) return 1.0;
            
            let totalBonus = 1.0;
            
            gameState.potions.active.forEach(active => {
                if (active.effect.type === type) {
                    totalBonus *= active.effect.value;
                } else if (active.effect.type === 'multi' && active.effect.values[type]) {
                    totalBonus *= active.effect.values[type];
                }
            });
            
            return totalBonus;
        }
        
        // Check potions every second
        setInterval(() => {
            checkPotionExpiry();
            updateActivePotionsDisplay();
            checkPotionsUnlockDate();
        }, 1000);
        
        // ===== NEW SYSTEMS (SKILLS, LEADERBOARD, GUILD, GACHA, THEMES, TITLES) =====
        
        const FEATURES_UNLOCK_DATE = new Date('2025-12-12T00:00:00');
        
        // SKILLS SYSTEM DATA
        const skillTreesData = {
            wealth: {
                name: '💰 Wealth Tree',
                color: '#ffd700',
                skills: [
                    { id: 'wealth1', name: 'Midas Touch', cost: 1, bonus: { type: 'money', value: 1.1 }, desc: '+10% money per spin' },
                    { id: 'wealth2', name: 'Golden Aura', cost: 2, bonus: { type: 'value', value: 1.15 }, desc: '+15% item value' },
                    { id: 'wealth3', name: 'Treasury', cost: 3, bonus: { type: 'idle', value: 0.01 }, desc: '+1% money per minute idle' },
                    { id: 'wealth4', name: 'Wealth Beyond', cost: 5, bonus: { type: 'money', value: 2.0 }, desc: 'Double all money gains' }
                ]
            },
            luck: {
                name: '🍀 Luck Tree',
                color: '#00ff00',
                skills: [
                    { id: 'luck1', name: 'Four Leaf', cost: 1, bonus: { type: 'luck', value: 0.5 }, desc: '+0.5x luck' },
                    { id: 'luck2', name: 'Rabbit Foot', cost: 2, bonus: { type: 'rare', value: 1.05 }, desc: '+5% rare chance' },
                    { id: 'luck3', name: 'Fortune', cost: 3, bonus: { type: 'luck', value: 1.0 }, desc: '+1x luck' },
                    { id: 'luck4', name: 'Destiny', cost: 5, bonus: { type: 'luck', value: 2.0 }, desc: '+2x luck' }
                ]
            },
            speed: {
                name: '⚡ Speed Tree',
                color: '#00ffff',
                skills: [
                    { id: 'speed1', name: 'Haste', cost: 1, bonus: { type: 'speed', value: 1.2 }, desc: '+20% spin speed' },
                    { id: 'speed2', name: 'Swift', cost: 2, bonus: { type: 'cooldown', value: 0.9 }, desc: '-10% cooldowns' },
                    { id: 'speed3', name: 'Time Warp', cost: 3, bonus: { type: 'speed', value: 1.5 }, desc: '+50% speed' },
                    { id: 'speed4', name: 'Instant', cost: 5, bonus: { type: 'speed', value: 2.0 }, desc: 'Double speed' }
                ]
            }
        };
        
        // GUILDS DATA (Offline - fake guilds with bonuses)
        const guildsData = [
            { id: 'dragons', name: '🐉 Dragon Slayers', bonus: { luck: 0.15, money: 0.1 }, level: 25, members: 42, desc: 'Elite guild of dragon hunters' },
            { id: 'fortune', name: '🍀 Fortune Seekers', bonus: { luck: 0.25, value: 0.15 }, level: 30, members: 58, desc: 'Masters of luck and fortune' },
            { id: 'wealth', name: '💰 Wealth Hoarders', bonus: { money: 0.3, value: 0.2 }, level: 28, members: 51, desc: 'Richest guild in the realm' },
            { id: 'speed', name: '⚡ Speed Runners', bonus: { speed: 0.4, luck: 0.1 }, level: 22, members: 38, desc: 'Fastest spinners alive' },
            { id: 'elite', name: '👑 Elite Masters', bonus: { luck: 0.2, money: 0.2, value: 0.15 }, level: 35, members: 67, desc: 'The best of the best' }
        ];
        
        // GACHA BANNERS DATA
        const gachaBannersData = {
            current: {
                name: 'Legendary Treasures',
                featured: ['Legendary', 'Mythic', 'Exotic'],
                rateUp: 2.0,
                cost: 100,
                pityAt: 50,
                desc: '2x chance for Legendary+ items!'
            }
        };
        
        // THEMES DATA
        const themesData = [
            { id: 'default', name: '🌙 Default Dark', unlocked: true, colors: { primary: '#6366f1', bg: '#1a1a2e' } },
            { id: 'light', name: '☀️ Light Mode', unlocked: false, colors: { primary: '#3b82f6', bg: '#f0f0f0' } },
            { id: 'ocean', name: '🌊 Ocean Blue', unlocked: false, colors: { primary: '#0ea5e9', bg: '#0c4a6e' } },
            { id: 'forest', name: '🌲 Forest Green', unlocked: false, colors: { primary: '#10b981', bg: '#064e3b' } },
            { id: 'sunset', name: '🌅 Sunset Orange', unlocked: false, colors: { primary: '#f59e0b', bg: '#78350f' } },
            { id: 'galaxy', name: '🌌 Galaxy Purple', unlocked: false, colors: { primary: '#a855f7', bg: '#581c87' } }
        ];
        
        // TITLES DATA
        const titlesData = [
            { id: 'beginner', name: 'Beginner', emoji: '🌱', requirement: { type: 'start' }, unlocked: true },
            { id: 'millionaire', name: 'Millionaire', emoji: '💰', requirement: { type: 'money', value: 1000000 }, unlocked: false },
            { id: 'billionaire', name: 'Billionaire', emoji: '💎', requirement: { type: 'money', value: 1000000000 }, unlocked: false },
            { id: 'lucky', name: 'The Lucky One', emoji: '🍀', requirement: { type: 'luck', value: 100 }, unlocked: false },
            { id: 'collector', name: 'Collector', emoji: '🎁', requirement: { type: 'items', value: 1000 }, unlocked: false },
            { id: 'master', name: 'Dungeon Master', emoji: '🗺️', requirement: { type: 'dungeons', value: 100 }, unlocked: false },
            { id: 'shaw', name: 'Shaw Holder', emoji: '⭐', requirement: { type: 'shaw' }, unlocked: false },
            { id: 'prestige', name: 'Prestige King', emoji: '👑', requirement: { type: 'prestige', value: 10 }, unlocked: false }
        ];
        
        // INITIALIZE ALL NEW SYSTEMS
        function initializeNewSystems() {
            initializeSkillsState();
            initializeLeaderboardState();
            initializeGuildState();
            initializeGachaState();
            initializeThemesState();
            initializeTitlesState();
        }
        
        function initializeSkillsState() {
            if (gameState.skillsUnlocked === undefined) {
                const now = new Date();
                gameState.skillsUnlocked = now >= FEATURES_UNLOCK_DATE;
            }
            if (!gameState.skillsPurchased) gameState.skillsPurchased = {};
            if (gameState.skillPoints === undefined) gameState.skillPoints = 0;
        }
        
        function initializeLeaderboardState() {
            if (gameState.leaderboardUnlocked === undefined) {
                const now = new Date();
                gameState.leaderboardUnlocked = now >= FEATURES_UNLOCK_DATE;
            }
        }
        
        function initializeGuildState() {
            if (gameState.guildUnlocked === undefined) {
                const now = new Date();
                gameState.guildUnlocked = now >= FEATURES_UNLOCK_DATE;
            }
            if (gameState.currentGuild === undefined) gameState.currentGuild = null;
        }
        
        function initializeGachaState() {
            if (gameState.gachaUnlocked === undefined) {
                const now = new Date();
                gameState.gachaUnlocked = now >= FEATURES_UNLOCK_DATE;
            }
            if (gameState.gems === undefined) gameState.gems = 100; // Start with 100 gems
            if (gameState.gachaPity === undefined) gameState.gachaPity = 0;
        }
        
        function initializeThemesState() {
            if (gameState.themesUnlocked === undefined) {
                const now = new Date();
                gameState.themesUnlocked = now >= FEATURES_UNLOCK_DATE;
            }
            if (!gameState.unlockedThemes) gameState.unlockedThemes = ['default'];
            if (!gameState.currentTheme) gameState.currentTheme = 'default';
        }
        
        function initializeTitlesState() {
            if (gameState.titlesUnlocked === undefined) {
                const now = new Date();
                gameState.titlesUnlocked = now >= FEATURES_UNLOCK_DATE;
            }
            if (!gameState.unlockedTitles) gameState.unlockedTitles = [];
            if (gameState.currentTitle === undefined) gameState.currentTitle = null;
            checkTitleUnlocks(); // Check on init
        }
        
        // CHECK UNLOCK DATES (Similar to potions)
        function checkNewSystemsUnlock() {
            const now = new Date();
            const features = ['skills', 'leaderboard', 'guild', 'gacha', 'themes', 'titles'];
            
            features.forEach(feature => {
                const unlockKey = `${feature}Unlocked`;
                if (now >= FEATURES_UNLOCK_DATE && !gameState[unlockKey]) {
                    gameState[unlockKey] = true;
                    showCenterNotification(`🎉 ${feature.toUpperCase()} UNLOCKED! 🎉`, 'var(--accent-primary)', 5000);
                    playSound('achievement');
                }
                
                // Update countdown
                if (!gameState[unlockKey]) {
                    const timeLeft = FEATURES_UNLOCK_DATE - now;
                    if (timeLeft > 0) {
                        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                        
                        const countdownEl = document.getElementById(`${feature}Countdown`);
                        if (countdownEl) {
                            countdownEl.textContent = `⏰ ${days}d ${hours}h ${minutes}m ${seconds}s`;
                        }
                    }
                }
            });
        }
        
        // SKILLS SYSTEM FUNCTIONS
        function updateSkillsDisplay() {
            const locked = document.getElementById('skillsLockedMessage');
            const content = document.getElementById('skillsContent');
            
            if (!gameState.skillsUnlocked) {
                locked.style.display = 'block';
                content.style.display = 'none';
                return;
            }
            
            locked.style.display = 'none';
            content.style.display = 'block';
            
            document.getElementById('skillPointsDisplay').textContent = gameState.skillPoints;
            
            const container = document.getElementById('skillTreesContainer');
            container.innerHTML = '';
            
            Object.entries(skillTreesData).forEach(([treeId, tree]) => {
                const treeDiv = document.createElement('div');
                treeDiv.style.cssText = 'margin: 20px 0; padding: 20px; background: var(--bg-dark); border-radius: 10px; border: 2px solid ' + tree.color;
                
                let html = `<h3 style="color: ${tree.color}">${tree.name}</h3><div style="margin-top: 15px;">`;
                
                tree.skills.forEach(skill => {
                    const purchased = gameState.skillsPurchased[skill.id] || false;
                    const canAfford = gameState.skillPoints >= skill.cost;
                    
                    html += `
                        <div style="padding: 15px; margin: 10px 0; background: var(--bg-medium); border-radius: 8px; border-left: 4px solid ${tree.color};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; color: ${purchased ? '#00ff00' : 'var(--text-primary)'};">${skill.name} ${purchased ? '✅' : ''}</h4>
                                    <p style="margin: 5px 0; color: var(--text-secondary);">${skill.desc}</p>
                                </div>
                                <button class="btn ${purchased ? 'btn-decline' : (canAfford ? 'btn-accept' : 'btn-decline')}" 
                                        onclick="purchaseSkill('${skill.id}')" 
                                        ${purchased ? 'disabled' : ''} 
                                        style="min-width: 100px;">
                                    ${purchased ? 'Owned' : `${skill.cost} SP`}
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                treeDiv.innerHTML = html;
                container.appendChild(treeDiv);
            });
        }
        
        function purchaseSkill(skillId) {
            if (gameState.skillsPurchased[skillId]) {
                showNotification('❌ Skill already purchased!', 'var(--warning)');
                return;
            }
            
            // Find skill
            let skill = null;
            for (const tree of Object.values(skillTreesData)) {
                skill = tree.skills.find(s => s.id === skillId);
                if (skill) break;
            }
            
            if (!skill) return;
            
            if (gameState.skillPoints < skill.cost) {
                showNotification('❌ Not enough skill points!', 'var(--danger)');
                return;
            }
            
            gameState.skillPoints -= skill.cost;
            gameState.skillsPurchased[skillId] = true;
            
            showNotification(`✅ Purchased: ${skill.name}!`, 'var(--accent-primary)');
            playSound('trade');
            updateSkillsDisplay();
            saveGame(true);
        }
        
        function getSkillBonus(type) {
            let bonus = 0;
            for (const tree of Object.values(skillTreesData)) {
                for (const skill of tree.skills) {
                    if (gameState.skillsPurchased[skill.id] && skill.bonus.type === type) {
                        bonus += skill.bonus.value;
                    }
                }
            }
            return bonus;
        }
        
        // LEADERBOARD SYSTEM
        function generateFakeLeaderboard(category) {
            const names = ['DragonSlayer', 'LuckMaster', 'RNGKing', 'ShawHunter', 'WealthLord', 'SpinGoddess', 'FortuneSeeker', 'RarityCollector', 'EpicGamer', 'ProTrader'];
            const leaderboard = [];
            
            for (let i = 0; i < 10; i++) {
                let value;
                switch(category) {
                    case 'money':
                        value = Math.floor(Math.random() * 10000000000) + 1000000000;
                        break;
                    case 'luck':
                        value = Math.floor(Math.random() * 500) + 100;
                        break;
                    case 'items':
                        value = Math.floor(Math.random() * 5000) + 500;
                        break;
                    case 'prestige':
                        value = Math.floor(Math.random() * 50) + 10;
                        break;
                }
                
                leaderboard.push({
                    rank: i + 1,
                    name: names[i],
                    value: value
                });
            }
            
            // Sort by value
            leaderboard.sort((a, b) => b.value - a.value);
            leaderboard.forEach((entry, idx) => entry.rank = idx + 1);
            
            return leaderboard;
        }
        
        function switchLeaderboardCategory(category) {
            const leaderboard = generateFakeLeaderboard(category);
            const display = document.getElementById('leaderboardDisplay');
            
            let categoryName, icon, formatter;
            switch(category) {
                case 'money':
                    categoryName = 'Richest Players';
                    icon = '💰';
                    formatter = (v) => '$' + formatNumber(v);
                    break;
                case 'luck':
                    categoryName = 'Luckiest Players';
                    icon = '🍀';
                    formatter = (v) => v + 'x Luck';
                    break;
                case 'items':
                    categoryName = 'Most Items';
                    icon = '🎁';
                    formatter = (v) => v + ' Items';
                    break;
                case 'prestige':
                    categoryName = 'Highest Prestige';
                    icon = '⭐';
                    formatter = (v) => 'Level ' + v;
                    break;
            }
            
            let html = `<h3>${icon} ${categoryName}</h3><div style="margin-top: 20px;">`;
            
            leaderboard.forEach(entry => {
                html += `
                    <div style="padding: 15px; margin: 10px 0; background: var(--bg-dark); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="font-size: 1.5rem; font-weight: bold; color: ${entry.rank === 1 ? '#ffd700' : entry.rank === 2 ? '#c0c0c0' : entry.rank === 3 ? '#cd7f32' : 'var(--text-secondary)'};">
                                #${entry.rank}
                            </span>
                            <span style="font-size: 1.1rem;">${entry.name}</span>
                        </div>
                        <span style="font-size: 1.1rem; color: var(--accent-gold); font-weight: bold;">
                            ${formatter(entry.value)}
                        </span>
                    </div>
                `;
            });
            
            html += '</div>';
            display.innerHTML = html;
        }
        
        function updateLeaderboardDisplay() {
            const locked = document.getElementById('leaderboardLockedMessage');
            const content = document.getElementById('leaderboardContent');
            
            if (!gameState.leaderboardUnlocked) {
                locked.style.display = 'block';
                content.style.display = 'none';
                return;
            }
            
            locked.style.display = 'none';
            content.style.display = 'block';
            
            switchLeaderboardCategory('money'); // Default
        }
        
        // GUILD SYSTEM
        function updateGuildDisplay() {
            const locked = document.getElementById('guildLockedMessage');
            const content = document.getElementById('guildContent');
            
            if (!gameState.guildUnlocked) {
                locked.style.display = 'block';
                content.style.display = 'none';
                return;
            }
            
            locked.style.display = 'none';
            content.style.display = 'block';
            
            const noGuild = document.getElementById('noGuildPanel');
            const inGuild = document.getElementById('inGuildPanel');
            
            if (!gameState.currentGuild) {
                noGuild.style.display = 'block';
                inGuild.style.display = 'none';
                
                const container = document.getElementById('availableGuildsContainer');
                container.innerHTML = '<div class="crafting-grid">';
                
                guildsData.forEach(guild => {
                    const bonusText = Object.entries(guild.bonus).map(([k, v]) => `${k}: +${(v*100).toFixed(0)}%`).join(', ');
                    container.innerHTML += `
                        <div class="recipe-card">
                            <h3>${guild.name}</h3>
                            <p style="color: var(--text-secondary); margin: 10px 0;">${guild.desc}</p>
                            <p style="margin: 10px 0;">Level: ${guild.level} | Members: ${guild.members}</p>
                            <p style="color: var(--accent-gold); margin: 10px 0; font-weight: bold;">${bonusText}</p>
                            <button class="btn btn-accept" onclick="joinGuild('${guild.id}')">Join Guild</button>
                        </div>
                    `;
                });
                
                container.innerHTML += '</div>';
            } else {
                noGuild.style.display = 'none';
                inGuild.style.display = 'block';
                
                const guild = guildsData.find(g => g.id === gameState.currentGuild);
                if (guild) {
                    document.getElementById('guildNameDisplay').textContent = guild.name;
                    const bonusText = Object.entries(guild.bonus).map(([k, v]) => `${k}: +${(v*100).toFixed(0)}%`).join(', ');
                    document.getElementById('guildStatsContainer').innerHTML = `
                        <p style="color: var(--text-secondary);">${guild.desc}</p>
                        <p style="margin: 10px 0;">Level: ${guild.level} | Members: ${guild.members}</p>
                        <div style="padding: 20px; background: var(--bg-dark); border-radius: 8px; margin: 20px 0;">
                            <h3 style="color: var(--accent-gold);">Guild Bonuses</h3>
                            <p style="margin-top: 10px; font-size: 1.1rem;">${bonusText}</p>
                        </div>
                    `;
                }
            }
        }
        
        function joinGuild(guildId) {
            gameState.currentGuild = guildId;
            const guild = guildsData.find(g => g.id === guildId);
            showNotification(`✅ Joined ${guild.name}!`, 'var(--accent-primary)');
            playSound('achievement');
            updateGuildDisplay();
            saveGame(true);
        }
        
        function leaveGuild() {
            gameState.currentGuild = null;
            showNotification('👋 Left guild!', 'var(--warning)');
            updateGuildDisplay();
            saveGame(true);
        }
        
        function getGuildBonus(type) {
            if (!gameState.currentGuild) return 0;
            const guild = guildsData.find(g => g.id === gameState.currentGuild);
            return guild && guild.bonus[type] ? guild.bonus[type] : 0;
        }
        
        // GACHA SYSTEM
        function updateGachaDisplay() {
            const locked = document.getElementById('gachaLockedMessage');
            const content = document.getElementById('gachaContent');
            
            if (!gameState.gachaUnlocked) {
                locked.style.display = 'block';
                content.style.display = 'none';
                return;
            }
            
            locked.style.display = 'none';
            content.style.display = 'block';
            
            document.getElementById('gemsDisplay').textContent = gameState.gems;
            
            const banner = gachaBannersData.current;
            const container = document.getElementById('currentBannerContainer');
            container.innerHTML = `
                <div style="padding: 30px; background: linear-gradient(135deg, var(--bg-dark) 0%, var(--accent-primary) 100%); border-radius: 15px; text-align: center;">
                    <h2 style="margin: 0 0 15px 0;">🎲 ${banner.name}</h2>
                    <p style="font-size: 1.1rem; margin: 10px 0;">${banner.desc}</p>
                    <p style="color: var(--accent-gold); margin: 15px 0;">Featured: ${banner.featured.join(', ')}</p>
                    <p style="color: var(--text-secondary); margin: 10px 0;">Pity: ${gameState.gachaPity}/${banner.pityAt}</p>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-accept" onclick="pullGacha(1)" style="margin: 5px; padding: 15px 30px;">Pull x1 (${banner.cost} gems)</button>
                        <button class="btn btn-accept" onclick="pullGacha(10)" style="margin: 5px; padding: 15px 30px;">Pull x10 (${banner.cost * 10} gems)</button>
                    </div>
                </div>
            `;
        }
        
        function pullGacha(count) {
            const banner = gachaBannersData.current;
            const cost = banner.cost * count;
            
            if (gameState.gems < cost) {
                showNotification('❌ Not enough gems!', 'var(--danger)');
                return;
            }
            
            gameState.gems -= cost;
            
            for (let i = 0; i < count; i++) {
                gameState.gachaPity++;
                
                // Check pity
                if (gameState.gachaPity >= banner.pityAt) {
                    gameState.gachaPity = 0;
                    // Give featured item
                    const featuredRarity = rarities.find(r => banner.featured.includes(r.name));
                    if (featuredRarity) {
                        const itemName = generateItemName(featuredRarity);
                        addItemToInventory(itemName, featuredRarity);
                        showCenterNotification(`🎲 GACHA PITY! ${itemName}!`, 'var(--accent-gold)', 5000);
                    }
                } else {
                    // Normal pull with rate up
                    const rng = Math.random();
                    const selectedRarity = selectRarityForGacha(rng, banner.rateUp, banner.featured);
                    const itemName = generateItemName(selectedRarity);
                    addItemToInventory(itemName, selectedRarity);
                }
            }
            
            playSound('trade');
            showNotification(`🎲 Pulled ${count} time(s)!`, 'var(--accent-primary)');
            updateGachaDisplay();
            updateInventory();
            saveGame(true);
        }
        
        function selectRarityForGacha(rng, rateUp, featured) {
            // Similar to normal spin but with rate up for featured
            for (let i = rarities.length - 1; i >= 0; i--) {
                const rarity = rarities[i];
                let chance = rarity.chance;
                
                // Apply rate up if featured
                if (featured.includes(rarity.name)) {
                    chance *= rateUp;
                }
                
                if (rng < chance) {
                    return rarity;
                }
            }
            return rarities[0]; // Common as fallback
        }
        
        // THEMES SYSTEM
        function updateThemesDisplay() {
            const locked = document.getElementById('themesLockedMessage');
            const content = document.getElementById('themesContent');
            
            if (!gameState.themesUnlocked) {
                locked.style.display = 'block';
                content.style.display = 'none';
                return;
            }
            
            locked.style.display = 'none';
            content.style.display = 'block';
            
            const container = document.getElementById('themesContainer');
            container.innerHTML = '<div class="crafting-grid">';
            
            themesData.forEach(theme => {
                const unlocked = gameState.unlockedThemes.includes(theme.id);
                const current = gameState.currentTheme === theme.id;
                
                container.innerHTML += `
                    <div class="recipe-card" style="border: 3px solid ${current ? 'var(--accent-gold)' : 'var(--bg-dark)'};">
                        <h3>${theme.name}</h3>
                        <div style="width: 100%; height: 60px; background: ${theme.colors.bg}; border-radius: 8px; margin: 10px 0; border: 2px solid ${theme.colors.primary};"></div>
                        <button class="btn ${current ? 'btn-decline' : 'btn-accept'}" 
                                onclick="applyTheme('${theme.id}')" 
                                ${!unlocked ? 'disabled' : ''}>
                            ${current ? 'Active' : unlocked ? 'Apply' : 'Locked'}
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML += '</div>';
        }
        
        function applyTheme(themeId) {
            const theme = themesData.find(t => t.id === themeId);
            if (!theme || !gameState.unlockedThemes.includes(themeId)) {
                showNotification('❌ Theme not unlocked!', 'var(--danger)');
                return;
            }
            
            gameState.currentTheme = themeId;
            
            // Apply CSS variables (basic implementation)
            document.documentElement.style.setProperty('--accent-primary', theme.colors.primary);
            // Note: Full theme implementation would require more CSS variables
            
            showNotification(`✅ Applied ${theme.name}!`, 'var(--accent-primary)');
            updateThemesDisplay();
            saveGame(true);
        }
        
        // TITLES SYSTEM
        function updateTitlesDisplay() {
            const locked = document.getElementById('titlesLockedMessage');
            const content = document.getElementById('titlesContent');
            
            if (!gameState.titlesUnlocked) {
                locked.style.display = 'block';
                content.style.display = 'none';
                return;
            }
            
            locked.style.display = 'none';
            content.style.display = 'block';
            
            document.getElementById('currentTitleDisplay').textContent = gameState.currentTitle || 'None';
            
            const container = document.getElementById('titlesListContainer');
            container.innerHTML = '<div class="crafting-grid">';
            
            titlesData.forEach(title => {
                const unlocked = gameState.unlockedTitles.includes(title.id);
                const current = gameState.currentTitle === title.id;
                
                let reqText = '';
                switch(title.requirement.type) {
                    case 'start': reqText = 'Automatic'; break;
                    case 'money': reqText = `Have $${formatNumber(title.requirement.value)}`; break;
                    case 'luck': reqText = `Have ${title.requirement.value}x luck`; break;
                    case 'items': reqText = `Own ${title.requirement.value} items`; break;
                    case 'dungeons': reqText = `Clear ${title.requirement.value} dungeons`; break;
                    case 'prestige': reqText = `Reach prestige ${title.requirement.value}`; break;
                    case 'shaw': reqText = 'Own Shaw item'; break;
                }
                
                container.innerHTML += `
                    <div class="recipe-card" style="border: 3px solid ${current ? 'var(--accent-gold)' : unlocked ? 'var(--accent-primary)' : 'var(--bg-dark)'};">
                        <h3>${title.emoji} ${title.name}</h3>
                        <p style="color: var(--text-secondary); margin: 10px 0; font-size: 0.9rem;">${reqText}</p>
                        <button class="btn ${current ? 'btn-decline' : unlocked ? 'btn-accept' : 'btn-decline'}" 
                                onclick="equipTitle('${title.id}')" 
                                ${!unlocked ? 'disabled' : ''}>
                            ${current ? 'Equipped' : unlocked ? 'Equip' : 'Locked'}
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML += '</div>';
        }
        
        function equipTitle(titleId) {
            if (!gameState.unlockedTitles.includes(titleId)) {
                showNotification('❌ Title not unlocked!', 'var(--danger)');
                return;
            }
            
            gameState.currentTitle = titleId;
            const title = titlesData.find(t => t.id === titleId);
            showNotification(`✅ Equipped: ${title.emoji} ${title.name}!`, 'var(--accent-primary)');
            updateTitlesDisplay();
            saveGame(true);
        }
        
        function checkTitleUnlocks() {
            titlesData.forEach(title => {
                if (gameState.unlockedTitles.includes(title.id)) return;
                
                let unlocked = false;
                switch(title.requirement.type) {
                    case 'start':
                        unlocked = true;
                        break;
                    case 'money':
                        unlocked = gameState.money >= title.requirement.value;
                        break;
                    case 'luck':
                        unlocked = gameState.luckMultiplier >= title.requirement.value;
                        break;
                    case 'items':
                        unlocked = Object.values(gameState.inventory).reduce((sum, items) => sum + items.length, 0) >= title.requirement.value;
                        break;
                    case 'prestige':
                        unlocked = gameState.prestigeLevel >= title.requirement.value;
                        break;
                    case 'shaw':
                        unlocked = Object.keys(gameState.inventory).some(key => key.includes('Shaw'));
                        break;
                }
                
                if (unlocked) {
                    gameState.unlockedTitles.push(title.id);
                    showCenterNotification(`🏅 Title Unlocked: ${title.emoji} ${title.name}!`, 'var(--accent-gold)', 5000);
                    playSound('achievement');
                }
            });
        }
        
        // ADMIN FUNCTIONS FOR NEW SYSTEMS
        function adminUnlockAllNewSystems() {
            gameState.skillsUnlocked = true;
            gameState.leaderboardUnlocked = true;
            gameState.guildUnlocked = true;
            gameState.gachaUnlocked = true;
            gameState.themesUnlocked = true;
            gameState.titlesUnlocked = true;
            
            showCenterNotification('🔓 ALL NEW SYSTEMS UNLOCKED! 🔓', 'var(--accent-primary)', 5000);
            saveGame(true);
        }
        
        // Check new systems every second
        setInterval(() => {
            checkNewSystemsUnlock();
        }, 1000);
        
        // ===== SOUND EFFECTS SYSTEM =====
        
        let audioContext;
        let audioContextResumed = false;
        
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.warn('Web Audio API not supported:', e);
            audioContext = null;
        }
        
        // Auto-resume audioContext on first user interaction (browser requirement)
        function resumeAudioContext() {
            if (audioContext && audioContext.state === 'suspended' && !audioContextResumed) {
                audioContext.resume().then(() => {
                    audioContextResumed = true;
                    console.log('Audio enabled - sounds will now play!');
                }).catch(err => {
                    console.warn('Could not resume audio:', err);
                });
            }
        }
        
        // Listen for any user interaction to enable audio
        ['click', 'keydown', 'touchstart'].forEach(eventType => {
            document.addEventListener(eventType, resumeAudioContext, { once: true });
        });
        
        const soundEffects = {
            coin: { frequency: 800, duration: 0.1, type: 'sine' },
            spin: { frequency: 400, duration: 0.15, type: 'sawtooth' },
            rare: { frequency: 600, duration: 0.3, type: 'square', slide: 900 },
            ultra_rare: { frequency: 400, duration: 0.5, type: 'sine', slide: 1200 },
            achievement: { frequency: 523.25, duration: 0.4, type: 'sine', chord: [659.25, 783.99] },
            success: { frequency: 650, duration: 0.2, type: 'sine' },
            error: { frequency: 200, duration: 0.2, type: 'sawtooth' },
            button: { frequency: 300, duration: 0.05, type: 'sine' },
            fusion: { frequency: 500, duration: 0.4, type: 'triangle', slide: 800 },
            boss_appear: { frequency: 150, duration: 0.6, type: 'sawtooth', slide: 300 },
            boss_hit: { frequency: 100, duration: 0.2, type: 'square' },
            boss_defeated: { frequency: 400, duration: 0.6, type: 'sine', chord: [500, 600, 800] },
            artifact: { frequency: 800, duration: 0.8, type: 'sine', chord: [1000, 1200, 1600] }
        };
        
        function playSound(soundName) {
            if (!audioContext) return;
            if (!gameState.settings || gameState.settings.soundEffects === false) return;
            
            // Auto-resume if needed (browsers require user interaction first)
            if (audioContext.state === 'suspended') {
                resumeAudioContext();
                return; // Skip this sound, will work on next interaction
            }
            
            try {
                const sound = soundEffects[soundName];
                if (!sound) return;
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = sound.type;
                oscillator.frequency.value = sound.frequency;
                
                // Frequency slide for special effects
                if (sound.slide) {
                    oscillator.frequency.exponentialRampToValueAtTime(
                        sound.slide,
                        audioContext.currentTime + sound.duration
                    );
                }
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + sound.duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + sound.duration);
                
                // Play chord if specified
                if (sound.chord) {
                    sound.chord.forEach((freq, i) => {
                        setTimeout(() => {
                            const chordOsc = audioContext.createOscillator();
                            const chordGain = audioContext.createGain();
                            
                            chordOsc.connect(chordGain);
                            chordGain.connect(audioContext.destination);
                            
                            chordOsc.type = 'sine';
                            chordOsc.frequency.value = freq;
                            
                            chordGain.gain.setValueAtTime(0.2, audioContext.currentTime);
                            chordGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + sound.duration * 0.8);
                            
                            chordOsc.start(audioContext.currentTime);
                            chordOsc.stop(audioContext.currentTime + sound.duration * 0.8);
                        }, i * 50);
                    });
                }
            } catch (e) {
                console.log('Sound playback failed:', e);
            }
        }
        
        // ===== KEYBOARD SHORTCUTS =====
        
        document.addEventListener('keydown', (e) => {
            // Don't trigger shortcuts when typing in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            // Prevent default for shortcuts we're using
            const shortcutKeys = ['Space', ' ', '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 's', 'S', 'i', 'I', 'b', 'B', 'a', 'A', 'p', 'P', 'r', 'R', 'Escape'];
            if (shortcutKeys.includes(e.key)) {
                e.preventDefault();
            }
            
            switch(e.key) {
                // Space - Spin
                case ' ':
                case 'Space':
                    spinItem();
                    break;
                
                // Number keys - Switch tabs
                case '1':
                    switchTab('inventory');
                    break;
                case '2':
                    switchTab('shop');
                    break;
                case '3':
                    switchTab('trades');
                    break;
                case '4':
                    switchTab('craft');
                    break;
                case '5':
                    switchTab('enchant');
                    break;
                case '6':
                    switchTab('fusion');
                    break;
                case '7':
                    switchTab('collections');
                    break;
                case '8':
                    switchTab('quests');
                    break;
                case '9':
                    switchTab('achievements');
                    break;
                case '0':
                    switchTab('settings');
                    break;
                
                // Letter shortcuts
                case 's':
                case 'S':
                    switchTab('shop');
                    break;
                case 'i':
                case 'I':
                    switchTab('inventory');
                    break;
                case 'b':
                case 'B':
                    switchTab('bosses');
                    break;
                case 'a':
                case 'A':
                    switchTab('artifacts');
                    break;
                case 'p':
                case 'P':
                    switchTab('prestige');
                    break;
                case 'r':
                case 'R':
                    switchTab('rebirth');
                    break;
                
                // Escape - Close modals
                case 'Escape':
                    closeBossFight();
                    break;
            }
        });
        
        // ===== TIMED SPECIAL EVENTS SYSTEM =====
        
        const timedEvents = [
            // December 8, 2025 - Evening Session (8 PM)
            { date: '2025-12-8', time: '20:00:00', action: 'message', message: 'Early Bird?', color: '#ffaa00', duration: 7000 },
            { date: '2025-12-8', time: '20:01:00', action: 'event', eventType: 'bloodmoon', message: '🔴 BLOOD MOON EVENT!' },
            { date: '2025-12-8', time: '20:02:00', action: 'luckEvent', multiplier: 6, message: '✨ 6x LUCK EVENT!' },
            { date: '2025-12-8', time: '20:03:00', action: 'message', message: 'Ok See yalls in 40 minutes', color: '#66ccff', duration: 8000 },
            { date: '2025-12-8', time: '20:04:00', action: 'luckEvent', multiplier: 4, message: '✨ 4x LUCK EVENT!' },
            { date: '2025-12-8', time: '20:05:00', action: 'event', eventType: 'disco', message: '🪩 DISCO EVENT!' },
            { date: '2025-12-8', time: '20:06:00', action: 'event', eventType: 'nuclear', message: '☢️ NUCLEAR EVENT!' },
            { date: '2025-12-8', time: '20:07:00', action: 'message', message: 'welcome everyone', color: '#00ff00', duration: 7000 },
            { date: '2025-12-8', time: '20:07:30', action: 'event', eventType: 'admin', message: '🔴 ADMIN EVENT!' },
            { date: '2025-12-8', time: '20:08:00', action: 'message', message: 'we have alot planned for fridays update', color: '#ff00ff', duration: 8000 },
            { date: '2025-12-8', time: '20:09:00', action: 'message', message: 'Yalls know what yalls want', color: '#ffaa00', duration: 7000 },
            { date: '2025-12-8', time: '20:10:00', action: 'giveItem', rarity: 'Omega', message: '🎁 FREE OMEGA!' },
            { date: '2025-12-8', time: '20:11:00', action: 'event', eventType: 'glitch', message: '⚡ GLITCH EVENT!' },
            { date: '2025-12-8', time: '20:12:00', action: 'message', message: 'We added new items to these events', color: '#00ffaa', duration: 8000 },
            { date: '2025-12-8', time: '20:12:30', action: 'event', eventType: 'volcanic', message: '🌋 VOLCANIC EVENT!' },
            { date: '2025-12-8', time: '20:13:00', action: 'luckEvent', multiplier: 8, message: '✨ 8x LUCK EVENT!' },
            { date: '2025-12-8', time: '20:14:00', action: 'message', message: 'Ok fine heres a Supreme', color: '#ffe66d', duration: 7000 },
            { date: '2025-12-8', time: '20:15:00', action: 'giveItem', rarity: 'Supreme', message: '🎁 FREE SUPREME!' },
            { date: '2025-12-8', time: '20:16:00', action: 'event', eventType: 'goldenrain', message: '💰 GOLDEN RAIN EVENT!' },
            { date: '2025-12-8', time: '20:17:00', action: 'message', message: 'for now ima go eat', color: '#ff6666', duration: 7000 },
            { date: '2025-12-8', time: '20:18:00', action: 'event', eventType: 'bloodmoon', message: '🔴 BLOOD MOON EVENT!' },
            { date: '2025-12-8', time: '20:18:30', action: 'message', message: 'For the real ones heres a Universal', color: '#00ffaa', duration: 8000 },
            { date: '2025-12-8', time: '20:19:00', action: 'giveItem', rarity: 'Universal', message: '🎁 FREE UNIVERSAL!' },
            
            // December 9, 2025 - Morning Session (11 AM)
            { date: '2025-12-9', time: '10:59:45', action: 'message', message: 'Early Bird?', color: '#ffaa00', duration: 7000 },
            { date: '2025-12-9', time: '11:00:00', action: 'event', eventType: 'bloodmoon', message: '🔴 BLOOD MOON EVENT!' },
            { date: '2025-12-9', time: '11:00:30', action: 'luckEvent', multiplier: 6, message: '✨ 6x LUCK EVENT!' },
            { date: '2025-12-9', time: '11:01:00', action: 'message', message: 'Ok See yalls in 40 minutes', color: '#66ccff', duration: 8000 },
            { date: '2025-12-9', time: '11:38:45', action: 'luckEvent', multiplier: 4, message: '✨ 4x LUCK EVENT!' },
            { date: '2025-12-9', time: '11:39:00', action: 'event', eventType: 'disco', message: '🪩 DISCO EVENT!' },
            { date: '2025-12-9', time: '11:40:00', action: 'event', eventType: 'nuclear', message: '☢️ NUCLEAR EVENT!' },
            { date: '2025-12-9', time: '11:40:15', action: 'message', message: 'welcome everyone', color: '#00ff00', duration: 7000 },
            { date: '2025-12-9', time: '11:40:22', action: 'event', eventType: 'admin', message: '🔴 ADMIN EVENT!' },
            { date: '2025-12-9', time: '11:40:30', action: 'message', message: 'we have alot planned for fridays update', color: '#ff00ff', duration: 8000 },
            { date: '2025-12-9', time: '11:41:00', action: 'message', message: 'Yalls know what yalls want', color: '#ffaa00', duration: 7000 },
            { date: '2025-12-9', time: '11:42:00', action: 'giveItem', rarity: 'Omega', message: '🎁 FREE OMEGA!' },
            { date: '2025-12-9', time: '11:42:15', action: 'event', eventType: 'glitch', message: '⚡ GLITCH EVENT!' },
            { date: '2025-12-9', time: '11:42:30', action: 'message', message: 'We added new items to these events', color: '#00ffaa', duration: 8000 },
            { date: '2025-12-9', time: '11:43:00', action: 'event', eventType: 'volcanic', message: '🌋 VOLCANIC EVENT!' },
            { date: '2025-12-9', time: '11:43:45', action: 'luckEvent', multiplier: 8, message: '✨ 8x LUCK EVENT!' },
            { date: '2025-12-9', time: '11:45:00', action: 'message', message: 'Ok fine heres a Supreme', color: '#ffe66d', duration: 7000 },
            { date: '2025-12-9', time: '11:46:00', action: 'giveItem', rarity: 'Supreme', message: '🎁 FREE SUPREME!' },
            { date: '2025-12-9', time: '11:48:00', action: 'event', eventType: 'goldenrain', message: '💰 GOLDEN RAIN EVENT!' },
            { date: '2025-12-9', time: '11:49:00', action: 'message', message: 'for now ima go eat', color: '#ff6666', duration: 7000 },
            { date: '2025-12-9', time: '11:50:00', action: 'event', eventType: 'bloodmoon', message: '🔴 BLOOD MOON EVENT!' },
            { date: '2025-12-9', time: '11:55:00', action: 'message', message: 'For the real ones heres a Universal', color: '#00ffaa', duration: 8000 },
            { date: '2025-12-9', time: '11:56:00', action: 'giveItem', rarity: 'Universal', message: '🎁 FREE UNIVERSAL!' },
            
            
            // December 11, 2025 - Same as Dec 9
            { date: '2025-12-11', time: '10:59:45', action: 'message', message: 'Early Bird?', color: '#ffaa00', duration: 7000 },
            { date: '2025-12-11', time: '11:00:00', action: 'event', eventType: 'bloodmoon', message: '🔴 BLOOD MOON EVENT!' },
            { date: '2025-12-11', time: '11:00:30', action: 'luckEvent', multiplier: 6, message: '✨ 6x LUCK EVENT!' },
            { date: '2025-12-11', time: '11:01:00', action: 'message', message: 'Ok See yalls in 40 minutes', color: '#66ccff', duration: 8000 },
            { date: '2025-12-11', time: '11:38:45', action: 'luckEvent', multiplier: 4, message: '✨ 4x LUCK EVENT!' },
            { date: '2025-12-11', time: '11:39:00', action: 'event', eventType: 'disco', message: '🪩 DISCO EVENT!' },
            { date: '2025-12-11', time: '11:40:00', action: 'event', eventType: 'nuclear', message: '☢️ NUCLEAR EVENT!' },
            { date: '2025-12-11', time: '11:40:15', action: 'message', message: 'welcome everyone', color: '#00ff00', duration: 7000 },
            { date: '2025-12-11', time: '11:40:22', action: 'event', eventType: 'admin', message: '🔴 ADMIN EVENT!' },
            { date: '2025-12-11', time: '11:40:30', action: 'message', message: 'we have alot planned for fridays update', color: '#ff00ff', duration: 8000 },
            { date: '2025-12-11', time: '11:41:00', action: 'message', message: 'Yalls know what yalls want', color: '#ffaa00', duration: 7000 },
            { date: '2025-12-11', time: '11:42:00', action: 'giveItem', rarity: 'Omega', message: '🎁 FREE OMEGA!' },
            { date: '2025-12-11', time: '11:42:15', action: 'event', eventType: 'glitch', message: '⚡ GLITCH EVENT!' },
            { date: '2025-12-11', time: '11:42:30', action: 'message', message: 'We added new items to these events', color: '#00ffaa', duration: 8000 },
            { date: '2025-12-11', time: '11:43:00', action: 'event', eventType: 'volcanic', message: '🌋 VOLCANIC EVENT!' },
            { date: '2025-12-11', time: '11:43:45', action: 'luckEvent', multiplier: 8, message: '✨ 8x LUCK EVENT!' },
            { date: '2025-12-11', time: '11:45:00', action: 'message', message: 'Ok fine heres a Supreme', color: '#ffe66d', duration: 7000 },
            { date: '2025-12-11', time: '11:46:00', action: 'giveItem', rarity: 'Supreme', message: '🎁 FREE SUPREME!' },
            { date: '2025-12-11', time: '11:48:00', action: 'event', eventType: 'goldenrain', message: '💰 GOLDEN RAIN EVENT!' },
            { date: '2025-12-11', time: '11:49:00', action: 'message', message: 'for now ima go eat', color: '#ff6666', duration: 7000 },
            { date: '2025-12-11', time: '11:50:00', action: 'event', eventType: 'bloodmoon', message: '🔴 BLOOD MOON EVENT!' },
            { date: '2025-12-11', time: '11:55:00', action: 'message', message: 'For the real ones heres a Universal', color: '#00ffaa', duration: 8000 },
            { date: '2025-12-11', time: '11:56:00', action: 'giveItem', rarity: 'Universal', message: '🎁 FREE UNIVERSAL!' }
        ];
        
        // Track which events have been triggered today
        if (!gameState.triggeredTimedEvents) {
            gameState.triggeredTimedEvents = {};
        }
        
        function checkTimedEvents() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const currentTime = `${hours}:${minutes}:${seconds}`;
            
            // Fixed: Ensure month is padded for consistent matching
            const month = now.getMonth() + 1; // getMonth() returns 0-11
            const day = now.getDate();
            const currentDate = `${now.getFullYear()}-${month}-${day}`;
            const todayKey = `${now.getFullYear()}-${month}-${day}`;
            
            // Debug logging (can be removed later)
            if (seconds === '00') { // Log once per minute
                console.log(`[Event Check] Current: ${currentDate} ${currentTime}`);
            }
            
            // Reset triggered events at midnight
            if (!gameState.triggeredTimedEvents[todayKey]) {
                gameState.triggeredTimedEvents = { [todayKey]: [] };
            }
            
            timedEvents.forEach(event => {
                // Match events by date and time
                if (event.date === currentDate && event.time === currentTime) {
                    const eventKey = `${event.date}-${event.time}`;
                    
                    console.log(`[Event Match] Found: ${event.action} at ${event.time}`);
                    
                    // Check if hasn't been triggered yet today
                    if (!gameState.triggeredTimedEvents[todayKey].includes(eventKey)) {
                        // Mark as triggered
                        gameState.triggeredTimedEvents[todayKey].push(eventKey);
                        
                        console.log(`[Event Trigger] Executing: ${event.action}`);
                        
                        // Execute the event action
                        switch(event.action) {
                            case 'event':
                                startSpecialEvent(event.eventType);
                                showCenterNotification(event.message, 'var(--accent-gold)', 5000);
                                playSound('achievement');
                                break;
                                
                            case 'message':
                                showCenterNotification(`📢 ${event.message}`, event.color || 'var(--accent-primary)', event.duration || 5000);
                                playSound('button');
                                break;
                                
                            case 'luckEvent':
                                adminSetLuckEvent(event.multiplier);
                                showCenterNotification(`✨ ${event.multiplier}x LUCK EVENT! ✨`, '#ffaa00', 5000);
                                break;
                                
                            case 'giveItem':
                                const itemRarity = rarities.find(r => r.name === event.rarity);
                                if (itemRarity) {
                                    const itemName = generateItemName(itemRarity);
                                    addItemToInventory(itemName, itemRarity);
                                    showCenterNotification(`🎁 FREE ${event.rarity.toUpperCase()}! You got ${itemName}!`, itemRarity.color, 6000);
                                    playSound('ultra_rare');
                                    updateInventory();
                                }
                                break;
                                
                            case 'giveMoney':
                                gameState.money += event.amount;
                                showCenterNotification(event.message, 'var(--accent-gold)', 5000);
                                playSound('coin');
                                updateStats();
                                break;
                        }
                    }
                }
            });
        }
        
        // Check timed events every second for precise timing
        setInterval(checkTimedEvents, 1000);
        // Also check immediately on load
        checkTimedEvents();
        
        // Initialize on page load (when all data is available)
        window.addEventListener('DOMContentLoaded', () => {
            // Core initialization
            updateStats();
            initAchievements();
            initBattlePass();
            updateEventBonuses();
            startAutoTrading();
            updateRebirthDisplay();
            refreshQuests();
            updateQuestDisplay();
            checkDailyLogin();
            updateStatistics();
            
            // Boss, Dungeon, Potions & Artifact initialization
            initializeBossState();
            initializeDungeonState();
            initializePotionsState();
            initializeArtifactsState();
            updateBossesDisplay();
            updateDungeonsDisplay();
            updatePotionsDisplay();
            updateArtifactsDisplay();
            updatePetsDisplay();
            
            // NEW SYSTEMS initialization
            initializeNewSystems();
            updateSkillsDisplay();
            updateLeaderboardDisplay();
            updateGuildDisplay();
            updateGachaDisplay();
            updateThemesDisplay();
            updateTitlesDisplay();
            
            // Codes list
            updateRedeemedCodesList();
            
            // Show admin button if already unlocked
            if (gameState.adminUnlocked) {
                document.getElementById('showAdminBtn').style.display = 'inline-block';
            }
        });
        
        // Auto-save every 30 seconds
        setInterval(() => {
            saveGame(true); // Pass true to indicate auto-save
        }, 30000);
        
        // ===== GLOBAL ERROR HANDLER =====
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Game Error:', {message, source, lineno, colno, error});
            // Try to save game before potential crash
            try {
                saveGame(true);
            } catch(e) {
                console.error('Failed to save on error:', e);
            }
            // Don't suppress the error
            return false;
        };
        
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
</body>
</html>